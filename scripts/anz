#!/bin/bash
set -euo pipefail

# å½©è‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

has_cmd() { command -v "$1" >/dev/null 2>&1; }

# æ£€æŸ¥æ˜¯å¦æœ‰ --help æˆ– -h å‚æ•°
has_help() {
  for arg in "$@"; do
    if [[ "$arg" == "--help" || "$arg" == "-h" ]]; then
      return 0
    fi
  done
  return 1
}

run_with_timeout() {
  local seconds="$1"; shift
  if has_cmd timeout; then
    timeout "$seconds" "$@"
  elif has_cmd gtimeout; then
    gtimeout "$seconds" "$@"
  else
    "$@"
  fi
}

clean_project() {
  echo -e "${GREEN}ğŸ§¹ å¼€å§‹æ¸…ç†é¡¹ç›®...${NC}"
  
  # 1. æ¸…ç©ºæ•°æ®åº“
  echo -e "${BLUE}1. æ¸…ç©º Isar æ•°æ®åº“...${NC}"
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS - æ£€æŸ¥æ–°æ—§ä¸¤ä¸ªå¯èƒ½çš„è·¯å¾„
    NEW_DB_PATH="$HOME/Library/Containers/com.granoflow.app/Data/Library/Application Support"
    OLD_DB_PATH="$HOME/Library/Containers/com.example.granoflow/Data/Library/Application Support"
    
    DB_FOUND=false
    
    # æ¸…ç†æ–°è·¯å¾„
    if [ -d "$NEW_DB_PATH" ]; then
      echo -e "${YELLOW}  - æ¸…ç†æ•°æ®åº“: com.granoflow.app${NC}"
      rm -rf "$NEW_DB_PATH"/*
      DB_FOUND=true
    fi
    
    # æ¸…ç†æ—§è·¯å¾„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -d "$OLD_DB_PATH" ]; then
      echo -e "${YELLOW}  - æ¸…ç†æ—§æ•°æ®åº“: com.example.granoflow${NC}"
      rm -rf "$OLD_DB_PATH"/*
      DB_FOUND=true
    fi
    
    if [ "$DB_FOUND" = true ]; then
      echo -e "${GREEN}âœ… æ•°æ®åº“å·²æ¸…ç©ºï¼Œä¸‹æ¬¡å¯åŠ¨å°†é‡æ–°å¯¼å…¥ç§å­æ•°æ®${NC}"
    else
      echo -e "${YELLOW}  âš ï¸  æœªæ‰¾åˆ°æ•°æ®åº“ï¼ˆå¯èƒ½å°šæœªè¿è¡Œè¿‡åº”ç”¨ï¼‰${NC}"
    fi
  elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    DB_PATH="$HOME/.local/share/granoflow"
    if [ -d "$DB_PATH" ]; then
      echo -e "${YELLOW}  - æ¸…ç†æ•°æ®åº“: $DB_PATH${NC}"
      rm -rf "$DB_PATH"/*
      echo -e "${GREEN}âœ… æ•°æ®åº“å·²æ¸…ç©º${NC}"
    else
      echo -e "${YELLOW}  âš ï¸  æœªæ‰¾åˆ°æ•°æ®åº“ï¼ˆå¯èƒ½å°šæœªè¿è¡Œè¿‡åº”ç”¨ï¼‰${NC}"
    fi
  fi
  
  # 2. flutter clean
  echo -e "${BLUE}2. æ‰§è¡Œ flutter clean...${NC}"
  run_with_timeout 60 flutter clean
  echo -e "${GREEN}âœ… flutter clean å®Œæˆ${NC}"
  
  # 3. åˆ é™¤æ„å»ºç›¸å…³çš„æ–‡ä»¶å¤¹ï¼ˆä¿ç•™é…ç½®æ–‡ä»¶ï¼‰
  echo -e "${BLUE}3. åˆ é™¤æ„å»ºç›¸å…³æ–‡ä»¶å¤¹...${NC}"
  
  # åˆ é™¤ build æ–‡ä»¶å¤¹
  if [ -d "build" ]; then
    echo -e "${YELLOW}  - åˆ é™¤ build/ æ–‡ä»¶å¤¹${NC}"
    rm -rf build
  fi
  
  # åˆ é™¤ .dart_tool æ–‡ä»¶å¤¹
  if [ -d ".dart_tool" ]; then
    echo -e "${YELLOW}  - åˆ é™¤ .dart_tool/ æ–‡ä»¶å¤¹${NC}"
    rm -rf .dart_tool
  fi
  
  # åˆ é™¤å„å¹³å°çš„æ„å»ºæ–‡ä»¶å¤¹ï¼ˆä¿ç•™é…ç½®æ–‡ä»¶ï¼‰
  for platform in macos android ios linux web windows; do
    if [ -d "$platform" ]; then
      # åªåˆ é™¤æ„å»ºç›¸å…³çš„å­æ–‡ä»¶å¤¹ï¼Œä¿ç•™é…ç½®æ–‡ä»¶
      if [ -d "$platform/build" ]; then
        echo -e "${YELLOW}  - åˆ é™¤ $platform/build/ æ–‡ä»¶å¤¹${NC}"
        rm -rf "$platform/build"
      fi
      if [ -d "$platform/.dart_tool" ]; then
        echo -e "${YELLOW}  - åˆ é™¤ $platform/.dart_tool/ æ–‡ä»¶å¤¹${NC}"
        rm -rf "$platform/.dart_tool"
      fi
    fi
  done
  
  echo -e "${GREEN}âœ… æ„å»ºæ–‡ä»¶å¤¹æ¸…ç†å®Œæˆ${NC}"
  
  # 4. flutter gen-l10n
  echo -e "${BLUE}4. ç”Ÿæˆæœ¬åœ°åŒ–æ–‡ä»¶...${NC}"
  run_with_timeout 60 flutter gen-l10n
  echo -e "${GREEN}âœ… æœ¬åœ°åŒ–æ–‡ä»¶ç”Ÿæˆå®Œæˆ${NC}"
  
  # 5. flutter pub get
  echo -e "${BLUE}5. è·å–ä¾èµ–åŒ…...${NC}"
  run_with_timeout 120 flutter pub get
  echo -e "${GREEN}âœ… ä¾èµ–åŒ…è·å–å®Œæˆ${NC}"
  
  # 6. flutter analyze
  echo -e "${BLUE}6. æ‰§è¡Œä»£ç åˆ†æ...${NC}"
  run_with_timeout 120 flutter analyze
  echo -e "${GREEN}âœ… ä»£ç åˆ†æå®Œæˆ${NC}"
  
  echo -e "${GREEN}ğŸ‰ é¡¹ç›®æ¸…ç†å’Œé‡å»ºå®Œæˆï¼${NC}"
}

build_aab() {
  echo -e "${GREEN}ğŸ“¦ å¼€å§‹æ„å»º Android App Bundle (AAB)...${NC}"
  
  # æ£€æŸ¥æ˜¯å¦æœ‰å¯†é’¥æ–‡ä»¶
  if [ ! -f "android/app/keystore.properties" ]; then
    echo -e "${YELLOW}âš  æœªæ‰¾åˆ°å¯†é’¥æ–‡ä»¶ android/app/keystore.properties${NC}"
    echo -e "${BLUE}â„¹ å°†ä½¿ç”¨è°ƒè¯•ç­¾åæ„å»º AAB${NC}"
  fi
  
  # æ„å»º AAB
  echo -e "${BLUE}æ‰§è¡Œ flutter build appbundle --release...${NC}"
  run_with_timeout 300 flutter build appbundle --release
  
  if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ… AAB æ„å»ºæˆåŠŸï¼${NC}"
    echo -e "${BLUE}ğŸ“ AAB æ–‡ä»¶ä½ç½®: build/app/outputs/bundle/release/app-release.aab${NC}"
    
    # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
    local aab_file="build/app/outputs/bundle/release/app-release.aab"
    if [ -f "$aab_file" ]; then
      local file_size=$(ls -lh "$aab_file" | awk '{print $5}')
      echo -e "${BLUE}ğŸ“Š æ–‡ä»¶å¤§å°: $file_size${NC}"
    fi
  else
    echo -e "${RED}âŒ AAB æ„å»ºå¤±è´¥${NC}"
    exit 1
  fi
}

generate_icons_all() {
  echo -e "${GREEN}ğŸ¨ å¼€å§‹ç”Ÿæˆæ‰€æœ‰å¹³å°å›¾æ ‡...${NC}"
  
  if ! has_cmd python3; then
    echo -e "${RED}âŒ éœ€è¦ Python 3 ç¯å¢ƒ${NC}"
    return 1
  fi
  
  if [ ! -f "assets/logo/granostack-logo-transparent.png" ]; then
    echo -e "${RED}âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: assets/logo/granostack-logo-transparent.png${NC}"
    return 1
  fi
  
  echo -e "${BLUE}æ‰§è¡Œ: python3 scripts/anz_modules/icons/generate.py${NC}"
  run_with_timeout 120 python3 scripts/anz_modules/icons/generate.py
  
  if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ… æ‰€æœ‰å¹³å°å›¾æ ‡ç”ŸæˆæˆåŠŸï¼${NC}"
  else
    echo -e "${RED}âŒ å›¾æ ‡ç”Ÿæˆå¤±è´¥${NC}"
    return 1
  fi
}

run_yaml_tests_all() {
  if has_help "$@"; then
    show_yaml_test_help
    return 0
  fi

  local timeout_seconds=600
  echo -e "${BLUE}è¿è¡Œ YAML ä¸€è‡´æ€§æµ‹è¯•è„šæœ¬...${NC}"
  run_with_timeout "$timeout_seconds" bash "$ROOT_DIR/scripts/devtools/run_yaml_tests.sh" "$@"
}

install_hooks() {
  if has_help "$@"; then
    show_hooks_install_help
    return 0
  fi

  echo -e "${BLUE}é…ç½®æœ¬åœ° Git hooks ...${NC}"
  bash "$ROOT_DIR/scripts/devtools/setup_hooks.sh"
}

show_main_help() {
  cat << EOF
GranoFlow é¡¹ç›®ç®¡ç†è„šæœ¬

ç”¨æ³•: $(basename "$0") <å‘½ä»¤> [é€‰é¡¹]

é¡¹ç›®ç®¡ç†å‘½ä»¤ï¼š
  clean           æ¸…ç†é¡¹ç›®å¹¶é‡å»º
  build:aab       æ„å»º Android App Bundle (AAB) æ–‡ä»¶
  hooks:install   é…ç½®/æ›´æ–° Git hooksï¼ˆpre-commit / pre-pushï¼‰

å›¾æ ‡ç”Ÿæˆå‘½ä»¤ï¼š
  icons:generate       ç”Ÿæˆæ‰€æœ‰å¹³å°çš„åº”ç”¨å›¾æ ‡

æ–‡æ¡£ç”Ÿæˆå‘½ä»¤ï¼š
  yaml:create        åŸºäºæ¨¡æ¿åˆ›å»ºå•ä¸ª architecture YAML æ–‡æ¡£
  yaml:create:all    æ‰¹é‡é‡æ–°ç”Ÿæˆæ‰€æœ‰å…­å¤§æ ¸å¿ƒç±»å‹çš„ YAML æ–‡æ¡£
  yaml:test          è¿è¡Œ YAML ä¸€è‡´æ€§æµ‹è¯•ï¼ˆæ”¯æŒ schema/fields/refs/sync ç»†ç²’åº¦é€‰é¡¹ï¼‰

ä½¿ç”¨ '$(basename "$0") <å‘½ä»¤> --help' æŸ¥çœ‹å…·ä½“å‘½ä»¤çš„è¯¦ç»†ç”¨æ³•
EOF
}

# æ˜¾ç¤º yaml å­å‘½ä»¤å¸®åŠ©
show_yaml_help() {
  cat << 'YAML_HELP'
Usage: scripts/anz yaml:create --file FILEPATH --type TYPE [--from DART_FILE]

Description:
  åŸºäº Dart æ–‡ä»¶åˆ†ææˆ–æ¨¡æ¿åˆ›å»º architecture YAML æ–‡æ¡£ï¼›è‡ªåŠ¨æå–ç±»ä¿¡æ¯ã€ä¾èµ–ã€i18n é”®å’Œè®¾è®¡ä»¤ç‰Œã€‚

Arguments:
  --file FILEPATH     ç›®æ ‡ YAML æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰
  --type TYPE         æ–‡æ¡£ç±»å‹ï¼šwidget|page|model|provider|repository|service
  --from DART_FILE    [å¯é€‰] æº Dart æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè‡ªåŠ¨æå–ä¿¡æ¯

Examples:
  # ä» Dart æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆ YAMLï¼ˆæ¨èï¼‰
  scripts/anz yaml:create --file documents/architecture/widgets/modern_tag.yaml --type widget --from lib/presentation/widgets/modern_tag.dart
  
  # ä»…ä»æ¨¡æ¿åˆ›å»ºç©º YAMLï¼ˆéœ€æ‰‹åŠ¨å¡«å……ï¼‰
  scripts/anz yaml:create --file documents/architecture/widgets/new_widget.yaml --type widget

Note:
  - ä½¿ç”¨ --from å‚æ•°å¯è‡ªåŠ¨åˆ†æ Dart æ–‡ä»¶å¹¶å¡«å…… YAML å­—æ®µ
  - åˆ›å»ºåä¼šè‡ªåŠ¨è¿è¡Œ Linter æ ¡éªŒï¼Œå¦‚æœ‰é—®é¢˜éœ€ä¿®æ­£åå†æäº¤
YAML_HELP
}

show_yaml_test_help() {
  cat << 'YAML_TEST_HELP'
Usage: scripts/anz yaml:test [--all|--schema|--fields|--refs|--sync] [-v|--verbose]

Description:
  è¿è¡Œ YAML æ¶æ„æ–‡æ¡£çš„ä¸€è‡´æ€§æµ‹è¯•å¥—ä»¶ã€‚é»˜è®¤æ‰§è¡Œå…¨éƒ¨æµ‹è¯•ï¼Œå¯é€šè¿‡é€‰é¡¹ä»…è¿è¡Œç‰¹å®šç±»åˆ«ã€‚

Options:
  --all        è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆé»˜è®¤ï¼‰
  --schema     ä»…éªŒè¯ schema çº¦æŸï¼ˆå­—æ®µå­˜åœ¨ã€ç±»å‹æ­£ç¡®ç­‰ï¼‰
  --fields     ä»…éªŒè¯å­—æ®µå®Œæ•´æ€§ï¼ˆå¿…å¡«å­—æ®µã€å¼•ç”¨å­—æ®µç­‰ï¼‰
  --refs       ä»…éªŒè¯è·¨æ–‡æ¡£å¼•ç”¨ä¸€è‡´æ€§ï¼ˆcalls/called_by ç­‰ï¼‰
  --sync       ä»…éªŒè¯ YAML ä¸ä»£ç å®ç°çš„åŒæ­¥æƒ…å†µ
  -v,--verbose é€šè¿‡ç»™ Flutter æµ‹è¯•å¢åŠ  --verbose è¾“å‡º
  -h,--help    æ˜¾ç¤ºæ­¤å¸®åŠ©

Examples:
  scripts/anz yaml:test                # è¿è¡Œå…¨éƒ¨æµ‹è¯•
  scripts/anz yaml:test --schema       # ä»…è¿è¡Œ schema éªŒè¯
  scripts/anz yaml:test --sync -v      # åŒæ­¥éªŒè¯å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
YAML_TEST_HELP
}

show_hooks_install_help() {
  cat << 'HOOKS_HELP'
Usage: scripts/anz hooks:install

Description:
  é…ç½®é¡¹ç›®çš„ Git hooksï¼ˆpre-commit ä¸ pre-pushï¼‰ï¼Œç¡®ä¿åœ¨æäº¤/æ¨é€å‰è‡ªåŠ¨æ‰§è¡Œæ ¼å¼åŒ–ã€åˆ†æä¸ YAML æ ¡éªŒã€‚

Actions:
  - è®¾ç½® git config core.hooksPath=scripts/git-hooks
  - ä¸º pre-commitã€pre-push è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™

Examples:
  scripts/anz hooks:install            # å®‰è£…æˆ–æ›´æ–°æœ¬åœ° Git hooks
HOOKS_HELP
}

# æ˜¾ç¤º yaml:create:all å¸®åŠ©
show_yaml_create_all_help() {
  cat << 'YAML_ALL_HELP'
Usage: scripts/anz yaml:create:all [--dry-run] [--no-backup]

Description:
  æ‰¹é‡é‡æ–°ç”Ÿæˆæ‰€æœ‰å…­å¤§æ ¸å¿ƒç±»å‹çš„ architecture YAML æ–‡æ¡£ã€‚
  
  ä¼šæ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆä»¥ä¸‹ç›®å½•ï¼š
  - documents/architecture/models/
  - documents/architecture/pages/
  - documents/architecture/widgets/
  - documents/architecture/providers/
  - documents/architecture/repositories/
  - documents/architecture/services/

Options:
  --dry-run          æ¨¡æ‹Ÿè¿è¡Œï¼Œä¸å®é™…ä¿®æ”¹æ–‡ä»¶
  --no-backup        ä¸åˆ›å»ºå¤‡ä»½ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

Examples:
  # å®Œæ•´é‡æ–°ç”Ÿæˆæ‰€æœ‰æ–‡æ¡£ï¼ˆæ¨èï¼Œä¼šè‡ªåŠ¨å¤‡ä»½ï¼‰
  scripts/anz yaml:create:all
  
  # æ¨¡æ‹Ÿè¿è¡Œï¼ŒæŸ¥çœ‹ä¼šç”Ÿæˆå“ªäº›æ–‡ä»¶
  scripts/anz yaml:create:all --dry-run
  
  # ä¸åˆ›å»ºå¤‡ä»½ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
  scripts/anz yaml:create:all --no-backup

Safety:
  - é»˜è®¤ä¼šå°† documents/architecture é‡å‘½åä¸º documents/architecture-yymmdd-hhmmss
  - ç„¶åé‡æ–°åˆ›å»º documents/architecture ç›®å½•å¹¶ç”Ÿæˆæ‰€æœ‰ YAML
  - routers.yaml ä¼šè¢«è‡ªåŠ¨ä¿ç•™å¹¶æ¢å¤ï¼ˆä½œä¸ºè·¯ç”±åœ°å›¾çš„ç‰¹æ®Šæƒ…å†µï¼‰
  - å»ºè®®å…ˆè¿è¡Œ --dry-run æŸ¥çœ‹å½±å“èŒƒå›´
  - è¿è¡Œåä¼šè‡ªåŠ¨æ‰§è¡Œ architecture_linter.py æ ¡éªŒ
  - æ¨èåœ¨å¹²å‡€çš„ git å·¥ä½œæ ‘ä¸­æ‰§è¡Œ

Note:
  æ­¤å‘½ä»¤è®¾è®¡ä¸ºç»å¸¸æ‰§è¡Œï¼Œç¡®ä¿ YAML æ–‡æ¡£ä¸ä»£ç ä¿æŒåŒæ­¥ã€‚
  ä»…ä¸ºå…­å¤§æ ¸å¿ƒç±»å‹ç”Ÿæˆæ–‡æ¡£ï¼ˆä¸åŒ…æ‹¬ Constants/Config/Theme/Enums ç­‰ï¼‰ã€‚
  routers.yaml ä½œä¸ºå…¨å±€è·¯ç”±åœ°å›¾ä¼šè¢«ä¿ç•™ã€‚
YAML_ALL_HELP
}

# ä¸»é€»è¾‘
main() {
  # å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºä¸»å¸®åŠ©
  if [[ $# -eq 0 ]]; then
    show_main_help
    exit 0
  fi

  # å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ --help æˆ– -hï¼Œæ˜¾ç¤ºä¸»å¸®åŠ©
  if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    show_main_help
    exit 0
  fi

  # å¤„ç†å­å‘½ä»¤
  case "$1" in
    clean) 
      if has_help "$@"; then
        echo "clean å‘½ä»¤ï¼šæ¸…ç†é¡¹ç›®å¹¶é‡å»ºï¼ˆæ¸…ç©ºæ•°æ®åº“ + flutter clean + åˆ é™¤æ„å»ºæ–‡ä»¶å¤¹ + gen-l10n + pub get + analyzeï¼‰"
        exit 0
      fi
      clean_project ;;
      
    build:aab) 
      if has_help "$@"; then
        echo "build:aab å‘½ä»¤ï¼šæ„å»º Android App Bundle (AAB) æ–‡ä»¶"
        exit 0
      fi
      build_aab ;;
      
    icons:generate) 
      if has_help "$@"; then
        echo "icons:generate å‘½ä»¤ï¼šç”Ÿæˆæ‰€æœ‰å¹³å°çš„åº”ç”¨å›¾æ ‡ï¼ˆmacOSã€iOSã€Androidï¼‰"
        exit 0
      fi
      generate_icons_all ;;

    hooks:install)
      shift
      install_hooks "$@" ;;
      
    yaml:create:all)
      # ç›´æ¥å¤„ç† yaml:create:all æ ¼å¼
      shift
      if has_help "$@"; then
        show_yaml_create_all_help
        exit 0
      fi
      # è°ƒç”¨ Python è„šæœ¬ï¼ˆå¤ç”¨ yaml_generator.py çš„é€»è¾‘ï¼‰
      if ! has_cmd python3; then
        echo -e "${RED}éœ€è¦ Python 3 ç¯å¢ƒ${NC}"
        exit 1
      fi
      echo -e "${BLUE}æ‰¹é‡ç”Ÿæˆ Architecture YAML æ–‡æ¡£...${NC}"
      python3 "$ROOT_DIR/scripts/anz_modules/architecture/yaml_create_all.py" "$@"
      ;;
      
    yaml:create)
      # ç›´æ¥å¤„ç† yaml:create æ ¼å¼
      shift
      if has_help "$@"; then
        show_yaml_help
        exit 0
      fi
      # è§£æå‚æ•°
      FILE=""; TYPE=""; FROM=""
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --file) FILE="$2"; shift 2;;
          --type) TYPE="$2"; shift 2;;
          --from) FROM="$2"; shift 2;;
          *) echo -e "${RED}æœªçŸ¥å‚æ•°: $1${NC}"; echo "ä½¿ç”¨ --help æŸ¥çœ‹ç”¨æ³•"; exit 1;;
        esac
      done
      if [[ -z "$FILE" || -z "$TYPE" ]]; then
        echo -e "${RED}--file ä¸ --type å¿…å¡«${NC}"; echo "ä½¿ç”¨ --help æŸ¥çœ‹ç”¨æ³•"; exit 1
      fi
      
      # å¦‚æœæä¾›äº† --from å‚æ•°ï¼Œä½¿ç”¨ yaml_generator.py ç”Ÿæˆ
      if [[ -n "$FROM" ]]; then
        if [[ ! -f "$FROM" ]]; then
          echo -e "${RED}æº Dart æ–‡ä»¶ä¸å­˜åœ¨: $FROM${NC}"; exit 1
        fi
        if ! has_cmd python3; then
          echo -e "${RED}éœ€è¦ Python 3 ç¯å¢ƒ${NC}"; exit 1
        fi
        echo -e "${BLUE}åˆ†æ Dart æ–‡ä»¶: $FROM${NC}"
        mkdir -p "$(dirname "$FILE")"
        python3 "$ROOT_DIR/scripts/anz_modules/architecture/yaml_generator.py" "$FROM" "$FILE" "$TYPE"
      else
        # å¦åˆ™ä½¿ç”¨æ¨¡æ¿å¤åˆ¶
        case "$TYPE" in
          widget) TEMPLATE="$ROOT_DIR/documents/templates/widget_template.yaml";;
          page) TEMPLATE="$ROOT_DIR/documents/templates/page_template.yaml";;
          model) TEMPLATE="$ROOT_DIR/documents/templates/model_template.yaml";;
          provider) TEMPLATE="$ROOT_DIR/documents/templates/provider_template.yaml";;
          repository) TEMPLATE="$ROOT_DIR/documents/templates/repository_template.yaml";;
          service) TEMPLATE="$ROOT_DIR/documents/templates/service_template.yaml";;
          *) echo -e "${RED}æœªçŸ¥ type: $TYPE${NC}"; exit 1;;
        esac
        if [[ ! -f "$TEMPLATE" ]]; then
          echo -e "${RED}æ¨¡æ¿ä¸å­˜åœ¨: $TEMPLATE${NC}"; exit 1
        fi
        mkdir -p "$(dirname "$FILE")"
        cp "$TEMPLATE" "$FILE"
        echo -e "${GREEN}[anz] Created from template: $FILE${NC}"
      fi
      
      # è¿è¡Œæ‰¹é‡è¡¥é½å’Œ Linter
      if has_cmd python3; then
        python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_bulk_update.py" >/dev/null || true
        python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_linter.py" --files "$FILE" || { echo -e "${YELLOW}[anz] Linter è­¦å‘Šï¼šè¯·ä¿®æ­£ä¸Šè¿°é—®é¢˜åå†æäº¤${NC}"; exit 1; }
      fi
      ;;
      
    yaml)
      if has_help "$@" || [[ $# -eq 1 ]]; then
        show_yaml_help
        exit 0
      fi
      # å¤„ç† yaml:create å­å‘½ä»¤
      shift
      case "$1" in
        create)
          shift
          # æ£€æŸ¥ --help å‚æ•°
          if [[ "${1:-}" == "--help" ]]; then
            show_yaml_help
            exit 0
          fi
          # è§£æå‚æ•°
          FILE=""; TYPE=""; FROM=""
          while [[ $# -gt 0 ]]; do
            case "$1" in
              --file) FILE="$2"; shift 2;;
              --type) TYPE="$2"; shift 2;;
              --from) FROM="$2"; shift 2;;
              *) echo -e "${RED}æœªçŸ¥å‚æ•°: $1${NC}"; echo "ä½¿ç”¨ --help æŸ¥çœ‹ç”¨æ³•"; exit 1;;
            esac
          done
          if [[ -z "$FILE" || -z "$TYPE" ]]; then
            echo -e "${RED}--file ä¸ --type å¿…å¡«${NC}"; echo "ä½¿ç”¨ --help æŸ¥çœ‹ç”¨æ³•"; exit 1
          fi
          
          # å¦‚æœæä¾›äº† --from å‚æ•°ï¼Œä½¿ç”¨ yaml_generator.py ç”Ÿæˆ
          if [[ -n "$FROM" ]]; then
            if [[ ! -f "$FROM" ]]; then
              echo -e "${RED}æº Dart æ–‡ä»¶ä¸å­˜åœ¨: $FROM${NC}"; exit 1
            fi
            if ! has_cmd python3; then
              echo -e "${RED}éœ€è¦ Python 3 ç¯å¢ƒ${NC}"; exit 1
            fi
            echo -e "${BLUE}åˆ†æ Dart æ–‡ä»¶: $FROM${NC}"
            mkdir -p "$(dirname "$FILE")"
            python3 "$ROOT_DIR/scripts/anz_modules/architecture/yaml_generator.py" "$FROM" "$FILE" "$TYPE"
          else
            # å¦åˆ™ä½¿ç”¨æ¨¡æ¿å¤åˆ¶
            case "$TYPE" in
              widget) TEMPLATE="$ROOT_DIR/documents/templates/widget_template.yaml";;
              page) TEMPLATE="$ROOT_DIR/documents/templates/page_template.yaml";;
              model) TEMPLATE="$ROOT_DIR/documents/templates/model_template.yaml";;
              provider) TEMPLATE="$ROOT_DIR/documents/templates/provider_template.yaml";;
              repository) TEMPLATE="$ROOT_DIR/documents/templates/repository_template.yaml";;
              service) TEMPLATE="$ROOT_DIR/documents/templates/service_template.yaml";;
              *) echo -e "${RED}æœªçŸ¥ type: $TYPE${NC}"; exit 1;;
            esac
            if [[ ! -f "$TEMPLATE" ]]; then
              echo -e "${RED}æ¨¡æ¿ä¸å­˜åœ¨: $TEMPLATE${NC}"; exit 1
            fi
            mkdir -p "$(dirname "$FILE")"
            cp "$TEMPLATE" "$FILE"
            echo -e "${GREEN}[anz] Created from template: $FILE${NC}"
          fi
          
          # è¿è¡Œæ‰¹é‡è¡¥é½å’Œ Linter
          if has_cmd python3; then
            python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_bulk_update.py" >/dev/null || true
            python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_linter.py" --files "$FILE" || { echo -e "${YELLOW}[anz] Linter è­¦å‘Šï¼šè¯·ä¿®æ­£ä¸Šè¿°é—®é¢˜åå†æäº¤${NC}"; exit 1; }
          fi
          ;;
        *)
          echo "æœªçŸ¥çš„ yaml å­å‘½ä»¤: $1"
          show_yaml_help
          exit 1
          ;;
      esac
      ;;

    yaml:test)
      shift
      run_yaml_tests_all "$@" ;;
      
    *)
      echo "æœªçŸ¥å‘½ä»¤: $1"
      show_main_help
      exit 1
      ;;
  esac
}

# è°ƒç”¨ä¸»å‡½æ•°
main "$@"
