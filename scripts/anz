#!/bin/bash
set -euo pipefail

# 彩色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

# ===== 核心工具函数 =====

has_cmd() { command -v "$1" >/dev/null 2>&1; }

# 检查是否有 --help 或 -h 参数
has_help() {
  for arg in "$@"; do
    if [[ "$arg" == "--help" || "$arg" == "-h" ]]; then
      return 0
    fi
  done
  return 1
}

run_with_timeout() {
  local seconds="$1"; shift
  if has_cmd timeout; then
    timeout "$seconds" "$@"
  elif has_cmd gtimeout; then
    gtimeout "$seconds" "$@"
  else
    "$@"
  fi
}

# ===== 加载模块 =====

# 加载构建模块
source "$ROOT_DIR/scripts/anz_modules/build.sh"

# 加载设备管理模块
source "$ROOT_DIR/scripts/anz_modules/device.sh"

# 加载运行命令模块
source "$ROOT_DIR/scripts/anz_modules/run.sh"

# 加载帮助函数模块
source "$ROOT_DIR/scripts/anz_modules/help.sh"

# 加载诊断模块
source "$ROOT_DIR/scripts/anz_modules/diagnose.sh"

# ===== 主函数 =====

main() {
  # 如果没有参数，显示主帮助
  if [[ $# -eq 0 ]]; then
    show_main_help
    exit 0
  fi

  # 如果第一个参数是 --help 或 -h，显示主帮助
  if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    show_main_help
    exit 0
  fi

  # 处理子命令
  case "$1" in
    clean) 
      if has_help "$@"; then
        echo "clean 命令：清理项目并重建（清空数据库 + flutter clean + 删除构建文件夹 + gen-l10n + pub get + analyze）"
        exit 0
      fi
      clean_project ;;
      
    build:aab) 
      if has_help "$@"; then
        echo "build:aab 命令：构建 Android App Bundle (AAB) 文件"
        exit 0
      fi
      build_aab ;;
      
    icons:generate) 
      if has_help "$@"; then
        echo "icons:generate 命令：生成所有平台的应用图标（macOS、iOS、Android）"
        exit 0
      fi
      generate_icons_all ;;

    hooks:install)
      shift
      install_hooks "$@" ;;
      
    yaml:create:all)
      # 直接处理 yaml:create:all 格式
      shift
      if has_help "$@"; then
        show_yaml_create_all_help
        exit 0
      fi
      # 调用 Python 脚本（复用 yaml_generator.py 的逻辑）
      if ! has_cmd python3; then
        echo -e "${RED}需要 Python 3 环境${NC}"
        exit 1
      fi
      echo -e "${BLUE}批量生成 Architecture YAML 文档...${NC}"
      python3 "$ROOT_DIR/scripts/anz_modules/architecture/yaml_create_all.py" "$@"
      ;;
      
    yaml:create)
      # 直接处理 yaml:create 格式
      shift
      if has_help "$@"; then
        show_yaml_help
        exit 0
      fi
      # 解析参数
      FILE=""; TYPE=""; FROM=""
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --file) FILE="$2"; shift 2;;
          --type) TYPE="$2"; shift 2;;
          --from) FROM="$2"; shift 2;;
          *) echo -e "${RED}未知参数: $1${NC}"; echo "使用 --help 查看用法"; exit 1;;
        esac
      done
      if [[ -z "$FILE" || -z "$TYPE" ]]; then
        echo -e "${RED}--file 与 --type 必填${NC}"; echo "使用 --help 查看用法"; exit 1
      fi
      
      # 如果提供了 --from 参数，使用 yaml_generator.py 生成
      if [[ -n "$FROM" ]]; then
        if [[ ! -f "$FROM" ]]; then
          echo -e "${RED}源 Dart 文件不存在: $FROM${NC}"; exit 1
        fi
        if ! has_cmd python3; then
          echo -e "${RED}需要 Python 3 环境${NC}"; exit 1
        fi
        echo -e "${BLUE}分析 Dart 文件: $FROM${NC}"
        mkdir -p "$(dirname "$FILE")"
        python3 "$ROOT_DIR/scripts/anz_modules/architecture/yaml_generator.py" "$FROM" "$FILE" "$TYPE"
      else
        # 否则使用模板复制
        case "$TYPE" in
          widget) TEMPLATE="$ROOT_DIR/documents/templates/widget_template.yaml";;
          page) TEMPLATE="$ROOT_DIR/documents/templates/page_template.yaml";;
          model) TEMPLATE="$ROOT_DIR/documents/templates/model_template.yaml";;
          provider) TEMPLATE="$ROOT_DIR/documents/templates/provider_template.yaml";;
          repository) TEMPLATE="$ROOT_DIR/documents/templates/repository_template.yaml";;
          service) TEMPLATE="$ROOT_DIR/documents/templates/service_template.yaml";;
          *) echo -e "${RED}未知 type: $TYPE${NC}"; exit 1;;
        esac
        if [[ ! -f "$TEMPLATE" ]]; then
          echo -e "${RED}模板不存在: $TEMPLATE${NC}"; exit 1
        fi
        mkdir -p "$(dirname "$FILE")"
        cp "$TEMPLATE" "$FILE"
        echo -e "${GREEN}[anz] Created from template: $FILE${NC}"
      fi
      
      # 运行批量补齐和 Linter
      if has_cmd python3; then
        python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_bulk_update.py" >/dev/null || true
        python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_linter.py" --files "$FILE" || { echo -e "${YELLOW}[anz] Linter 警告：请修正上述问题后再提交${NC}"; exit 1; }
      fi
      ;;
      
    yaml)
      if has_help "$@" || [[ $# -eq 1 ]]; then
        show_yaml_help
        exit 0
      fi
      # 处理 yaml:create 子命令
      shift
      case "$1" in
        create)
          shift
          # 检查 --help 参数
          if [[ "${1:-}" == "--help" ]]; then
            show_yaml_help
            exit 0
          fi
          # 解析参数
          FILE=""; TYPE=""; FROM=""
          while [[ $# -gt 0 ]]; do
            case "$1" in
              --file) FILE="$2"; shift 2;;
              --type) TYPE="$2"; shift 2;;
              --from) FROM="$2"; shift 2;;
              *) echo -e "${RED}未知参数: $1${NC}"; echo "使用 --help 查看用法"; exit 1;;
            esac
          done
          if [[ -z "$FILE" || -z "$TYPE" ]]; then
            echo -e "${RED}--file 与 --type 必填${NC}"; echo "使用 --help 查看用法"; exit 1
          fi
          
          # 如果提供了 --from 参数，使用 yaml_generator.py 生成
          if [[ -n "$FROM" ]]; then
            if [[ ! -f "$FROM" ]]; then
              echo -e "${RED}源 Dart 文件不存在: $FROM${NC}"; exit 1
            fi
            if ! has_cmd python3; then
              echo -e "${RED}需要 Python 3 环境${NC}"; exit 1
            fi
            echo -e "${BLUE}分析 Dart 文件: $FROM${NC}"
            mkdir -p "$(dirname "$FILE")"
            python3 "$ROOT_DIR/scripts/anz_modules/architecture/yaml_generator.py" "$FROM" "$FILE" "$TYPE"
          else
            # 否则使用模板复制
            case "$TYPE" in
              widget) TEMPLATE="$ROOT_DIR/documents/templates/widget_template.yaml";;
              page) TEMPLATE="$ROOT_DIR/documents/templates/page_template.yaml";;
              model) TEMPLATE="$ROOT_DIR/documents/templates/model_template.yaml";;
              provider) TEMPLATE="$ROOT_DIR/documents/templates/provider_template.yaml";;
              repository) TEMPLATE="$ROOT_DIR/documents/templates/repository_template.yaml";;
              service) TEMPLATE="$ROOT_DIR/documents/templates/service_template.yaml";;
              *) echo -e "${RED}未知 type: $TYPE${NC}"; exit 1;;
            esac
            if [[ ! -f "$TEMPLATE" ]]; then
              echo -e "${RED}模板不存在: $TEMPLATE${NC}"; exit 1
            fi
            mkdir -p "$(dirname "$FILE")"
            cp "$TEMPLATE" "$FILE"
            echo -e "${GREEN}[anz] Created from template: $FILE${NC}"
          fi
          
          # 运行批量补齐和 Linter
          if has_cmd python3; then
            python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_bulk_update.py" >/dev/null || true
            python3 "$ROOT_DIR/scripts/anz_modules/architecture/architecture_linter.py" --files "$FILE" || { echo -e "${YELLOW}[anz] Linter 警告：请修正上述问题后再提交${NC}"; exit 1; }
          fi
          ;;
        *)
          echo "未知的 yaml 子命令: $1"
          show_yaml_help
          exit 1
          ;;
      esac
      ;;

    yaml:test)
      shift
      run_yaml_tests_all "$@" ;;
      
    test)
      # 并行执行 test/ 下所有 *_test.dart，吞掉中间输出，仅输出进度与最终摘要
      if ! has_cmd python3; then
        echo -e "${RED}需要 Python 3 环境${NC}"
        exit 1
      fi
      python3 "$ROOT_DIR/scripts/anz_modules/test/unit_test.py" ;;
    
    test:drag)
      # 运行拖拽集成测试 100 次（随机坐标测试）
      if ! has_cmd python3; then
        echo -e "${RED}需要 Python 3 环境${NC}"
        exit 1
      fi
      python3 "$ROOT_DIR/scripts/anz_modules/test/drag_test.py" ;;
    
    refactor)
      # 检查哪些文件和方法需要重构
      if ! has_cmd python3; then
        echo -e "${RED}需要 Python 3 环境${NC}"
        exit 1
      fi
      python3 "$ROOT_DIR/scripts/anz_modules/refactor/check.py" ;;
    
    run:android)
      if has_help "$@"; then
        echo "run:android: 在 Android 手机上运行应用（Pixel 6, 6.4\", 1080 x 2400）"
        exit 0
      fi
      run_android ;;
    
    run:tablet)
      if has_help "$@"; then
        echo "run:tablet: 在 Android 平板上运行应用（Pixel Tablet, 10.2\", 2560 x 1600）"
        exit 0
      fi
      run_tablet ;;
    
    run:iphone)
      if has_help "$@"; then
        echo "run:iphone: 在 iPhone 上运行应用（iPhone 16 Pro, 6.3\", 1290 x 2796）"
        exit 0
      fi
      run_iphone ;;
    
    run:ipad)
      if has_help "$@"; then
        echo "run:ipad: 在 iPad 上运行应用（iPad Pro 11\", 11\", 2388 x 1668）"
        exit 0
      fi
      run_ipad ;;
    
    run:macos)
      if has_help "$@"; then
        echo "run:macos: 在 macOS 上运行应用（桌面应用）"
        exit 0
      fi
      run_macos ;;
    
    diagnose:16kb)
      if has_help "$@"; then
        echo "diagnose:16kb: 运行16KB页面大小兼容性诊断，检查Flutter版本、引擎、ELF对齐、依赖版本和构建配置"
        exit 0
      fi
      diagnose_16kb ;;
      
    *)
      echo "未知命令: $1"
      show_main_help
      exit 1
      ;;
  esac
}

# 调用主函数
main "$@"
