#!/bin/sh
# pre-push: å…¨é‡é—¨ç¦ï¼ˆæœ¬åœ°çŸ­è·‘ï¼‰
set +e  # ä¸´æ—¶ç¦ç”¨é”™è¯¯é€€å‡ºï¼Œä»¥ä¾¿æ•èŽ·æµ‹è¯•ç»“æžœ

echo "[pre-push] flutter analyze ..."
flutter analyze
ANALYZE_EXIT=$?
if [ $ANALYZE_EXIT -ne 0 ]; then
  exit $ANALYZE_EXIT
fi

echo "[pre-push] YAML ä¸€è‡´æ€§æµ‹è¯• ..."
# è¿è¡Œ YAML æµ‹è¯•ï¼Œæ•èŽ·è¾“å‡ºå’Œé€€å‡ºç 
TEMP_OUTPUT=$(mktemp)
flutter test test/yaml/ 2>&1 | tee "$TEMP_OUTPUT"
TEST_EXIT=${PIPESTATUS[0]}

# å¦‚æžœæµ‹è¯•å¤±è´¥ï¼Œè¾“å‡ºç»Ÿè®¡ä¿¡æ¯
if [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "ðŸ“Š YAML ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥ç»Ÿè®¡"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  
  # æå–å—å½±å“çš„ YAML æ–‡ä»¶
  AFFECTED_FILES=$(grep -o 'documents/architecture/[^:[:space:]]*\.yaml' "$TEMP_OUTPUT" 2>/dev/null | sort -u || true)
  if [ -n "$AFFECTED_FILES" ]; then
    echo "ðŸ“ å—å½±å“çš„ YAML æ–‡ä»¶ï¼š"
    echo "$AFFECTED_FILES" | while read -r file; do
      echo "  - $file"
    done
    echo ""
  fi
  
  # æå–å¤±è´¥æµ‹è¯•çš„åç§°å’Œé—®é¢˜
  FAILED_COUNT=$(grep -c "âœ–\|FAILED\|å¤±è´¥" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  if [ "$FAILED_COUNT" != "0" ]; then
    echo "âŒ å¤±è´¥æµ‹è¯•æ•°é‡: $FAILED_COUNT"
    echo ""
    
    # æå–å¤±è´¥æµ‹è¯•çš„è¯¦ç»†ä¿¡æ¯
    echo "ðŸ“‹ å¤±è´¥æµ‹è¯•åˆ—è¡¨ï¼š"
    grep -E "test.*\(|âœ–|FAILED|å¤±è´¥|âŒ" "$TEMP_OUTPUT" 2>/dev/null | head -30 | while read -r line; do
      echo "  $line"
    done
    echo ""
  fi
  
  # æå–æ–‡ä»¶çº§åˆ«çš„é—®é¢˜æ‘˜è¦ï¼ˆæŒ‰æ–‡ä»¶åˆ†ç»„ï¼‰
  echo "ðŸ“„ æŒ‰æ–‡ä»¶åˆ†ç»„çš„é—®é¢˜æ‘˜è¦ï¼š"
  
  # æå–æ‰€æœ‰æ¶‰åŠ YAML æ–‡ä»¶çš„å¤±è´¥è¡Œ
  YAML_ERRORS=$(grep -E "documents/architecture/[^[:space:]]*\.yaml" "$TEMP_OUTPUT" 2>/dev/null | grep -E "âŒ|FAILED|å¤±è´¥" || true)
  
  if [ -n "$YAML_ERRORS" ]; then
    # æŒ‰æ–‡ä»¶åˆ†ç»„ç»Ÿè®¡
    echo "$YAML_ERRORS" | awk -F: '{files[$1]++} END {for (f in files) print "  " f ": " files[f] " é¡¹é—®é¢˜"}' | sort
    echo ""
    
    # æ˜¾ç¤ºæ¯ä¸ªæ–‡ä»¶çš„å…·ä½“é—®é¢˜ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰5ä¸ªæ–‡ä»¶ï¼‰
    FILE_LIST=$(echo "$YAML_ERRORS" | grep -oE "documents/architecture/[^[:space:]]*\.yaml" | sort -u | head -5)
    for file in $FILE_LIST; do
      echo "  ðŸ“„ $file:"
      echo "$YAML_ERRORS" | grep "$file" | head -3 | sed 's/^/    â€¢ /'
      echo ""
    done
  else
    echo "  ï¼ˆæœªæ‰¾åˆ°æŒ‰æ–‡ä»¶åˆ†ç»„çš„é”™è¯¯ä¿¡æ¯ï¼‰"
    echo ""
  fi
  
  # æå–å…·ä½“çš„é”™è¯¯æ¶ˆæ¯ç±»åž‹
  echo "ðŸ” é”™è¯¯ç±»åž‹ç»Ÿè®¡ï¼š"
  
  FILE_PATH_ERRORS=$(grep -c "file_path.*ä¸å­˜åœ¨\|æŒ‡å‘ä¸å­˜åœ¨çš„æ–‡ä»¶" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  CLASS_NAME_ERRORS=$(grep -c "ç±»å.*ä¸ä¸€è‡´\|class name.*match" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  TYPE_ERRORS=$(grep -c "ç±»åž‹.*ä¸åŒ¹é…\|type.*match" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  FIELD_ERRORS=$(grep -c "ç¼ºå°‘.*å­—æ®µ\|missing.*field" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  
  if [ "$FILE_PATH_ERRORS" != "0" ]; then
    echo "  â€¢ file_path é—®é¢˜: $FILE_PATH_ERRORS é¡¹"
  fi
  if [ "$CLASS_NAME_ERRORS" != "0" ]; then
    echo "  â€¢ ç±»åä¸ä¸€è‡´: $CLASS_NAME_ERRORS é¡¹"
  fi
  if [ "$TYPE_ERRORS" != "0" ]; then
    echo "  â€¢ ç±»åž‹ä¸åŒ¹é…: $TYPE_ERRORS é¡¹"
  fi
  if [ "$FIELD_ERRORS" != "0" ]; then
    echo "  â€¢ ç¼ºå°‘å­—æ®µ: $FIELD_ERRORS é¡¹"
  fi
  
  if [ "$FILE_PATH_ERRORS" = "0" ] && [ "$CLASS_NAME_ERRORS" = "0" ] && [ "$TYPE_ERRORS" = "0" ] && [ "$FIELD_ERRORS" = "0" ]; then
    echo "  ï¼ˆæ— æ³•è‡ªåŠ¨åˆ†ç±»é”™è¯¯ç±»åž‹ï¼‰"
  fi
  echo ""
  
  echo "ðŸ’¡ æç¤ºï¼šæŸ¥çœ‹ä¸Šæ–¹å®Œæ•´è¾“å‡ºä»¥èŽ·å–æ‰€æœ‰å¤±è´¥è¯¦æƒ…"
  echo "   å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹æ›´å¤šä¿¡æ¯ï¼š"
  echo "   - æŸ¥çœ‹å®Œæ•´çš„æµ‹è¯•è¾“å‡ºï¼ˆä¸Šæ–¹ï¼‰"
  echo "   - è¿è¡Œ: flutter test test/yaml/ --reporter=expanded"
  echo ""
  
  rm -f "$TEMP_OUTPUT"
  exit $TEST_EXIT
fi

rm -f "$TEMP_OUTPUT"
set -e  # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º

echo "[pre-push] flutter test (unit+widget) ..."
flutter test --exclude-tags=yaml

echo "[pre-push] integration tests (if any) ..."
if [ -d integration_test ]; then
  flutter test integration_test || true
fi

# æž¶æž„æ–‡æ¡£å…¨é‡æ ¡éªŒï¼ˆå¦‚éœ€ï¼Œå¯ä»¥æ”¾æ¾åˆ°ä»…å˜æ›´ï¼‰
if [ -d documents/architecture ]; then
  echo "[pre-push] Lint all architecture docs ..."
  FILES=$(ls documents/architecture/**/*.yaml 2>/dev/null || ls documents/architecture/*.yaml 2>/dev/null || true)
  if [ -n "$FILES" ]; then
    python3 scripts/anz_modules/architecture/architecture_linter.py --files $FILES
  fi
fi

exit 0
