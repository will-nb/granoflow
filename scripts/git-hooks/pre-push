#!/bin/sh
# pre-push: 全量门禁（本地短跑）
set +e  # 临时禁用错误退出，以便捕获测试结果

echo "[pre-push] flutter analyze ..."
flutter analyze
ANALYZE_EXIT=$?
if [ $ANALYZE_EXIT -ne 0 ]; then
  exit $ANALYZE_EXIT
fi

set -e  # 重新启用错误退出

echo "[pre-push] flutter test (unit+widget) ..."
flutter test --exclude-tags=yaml

echo "[pre-push] integration tests (if any) ..."
if [ -d integration_test ]; then
  flutter test integration_test || true
fi

# 架构文档全量校验（如需，可以放松到仅变更）
if [ -d documents/architecture ]; then
  echo "[pre-push] Lint all architecture docs ..."
  FILES=$(ls documents/architecture/**/*.yaml 2>/dev/null || ls documents/architecture/*.yaml 2>/dev/null || true)
  if [ -n "$FILES" ]; then
    python3 scripts/anz_modules/architecture/architecture_linter.py --files $FILES
  fi
fi

exit 0
