#!/bin/sh
# pre-push: å…¨é‡é—¨ç¦ï¼ˆæœ¬åœ°çŸ­è·‘ï¼‰
set +e  # ä¸´æ—¶ç¦ç”¨é”™è¯¯é€€å‡ºï¼Œä»¥ä¾¿æ•èŽ·æµ‹è¯•ç»“æžœ

echo "[pre-push] flutter analyze ..."
flutter analyze
ANALYZE_EXIT=$?
if [ $ANALYZE_EXIT -ne 0 ]; then
  exit $ANALYZE_EXIT
fi

echo "[pre-push] YAML ä¸€è‡´æ€§æµ‹è¯• ..."
# è¿è¡Œ YAML æµ‹è¯•ï¼Œæ•èŽ·è¾“å‡ºå’Œé€€å‡ºç 
TEMP_OUTPUT=$(mktemp)
flutter test test/yaml/ 2>&1 | tee "$TEMP_OUTPUT"
TEST_EXIT=${PIPESTATUS[0]}

# å¦‚æžœæµ‹è¯•å¤±è´¥ï¼Œè¾“å‡ºç»Ÿè®¡ä¿¡æ¯
if [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "ðŸ“Š YAML ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥ç»Ÿè®¡"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  
  # æå–å—å½±å“çš„ YAML æ–‡ä»¶
  AFFECTED_FILES=$(grep -o 'documents/architecture/[^:[:space:]]*\.yaml' "$TEMP_OUTPUT" 2>/dev/null | sort -u || true)
  if [ -n "$AFFECTED_FILES" ]; then
    echo "ðŸ“ å—å½±å“çš„ YAML æ–‡ä»¶ï¼š"
    echo "$AFFECTED_FILES" | while read -r file; do
      echo "  - $file"
    done
    echo ""
  fi
  
  # æå–å¤±è´¥æµ‹è¯•çš„åç§°å’Œé—®é¢˜
  FAILED_COUNT=$(grep -c "âœ–\|FAILED\|å¤±è´¥" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  if [ "$FAILED_COUNT" != "0" ]; then
    echo "âŒ å¤±è´¥æµ‹è¯•æ•°é‡: $FAILED_COUNT"
    echo ""
    
    # æå–å¤±è´¥æµ‹è¯•çš„è¯¦ç»†ä¿¡æ¯
    echo "ðŸ“‹ å¤±è´¥æµ‹è¯•åˆ—è¡¨ï¼š"
    grep -E "test.*\(|âœ–|FAILED|å¤±è´¥|âŒ" "$TEMP_OUTPUT" 2>/dev/null | head -30 | while read -r line; do
      echo "  $line"
    done
    echo ""
  fi
  
  # æå–æ–‡ä»¶çº§åˆ«çš„é—®é¢˜æ‘˜è¦
  echo "ðŸ“„ æ–‡ä»¶çº§åˆ«é—®é¢˜æ‘˜è¦ï¼š"
  grep -E "documents/architecture/.*\.yaml.*âŒ|documents/architecture/.*\.yaml.*å¤±è´¥" "$TEMP_OUTPUT" 2>/dev/null | head -20 | while read -r line; do
    echo "  $line"
  done
  echo ""
  
  echo "ðŸ’¡ æç¤ºï¼šæŸ¥çœ‹ä¸Šæ–¹å®Œæ•´è¾“å‡ºä»¥èŽ·å–æ‰€æœ‰å¤±è´¥è¯¦æƒ…"
  echo "   å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹æ›´å¤šä¿¡æ¯ï¼š"
  echo "   - æŸ¥çœ‹å®Œæ•´çš„æµ‹è¯•è¾“å‡ºï¼ˆä¸Šæ–¹ï¼‰"
  echo "   - è¿è¡Œ: flutter test test/yaml/ --reporter=expanded"
  echo ""
  
  rm -f "$TEMP_OUTPUT"
  exit $TEST_EXIT
fi

rm -f "$TEMP_OUTPUT"
set -e  # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º

echo "[pre-push] flutter test (unit+widget) ..."
flutter test --exclude-tags=yaml

echo "[pre-push] integration tests (if any) ..."
if [ -d integration_test ]; then
  flutter test integration_test || true
fi

# æž¶æž„æ–‡æ¡£å…¨é‡æ ¡éªŒï¼ˆå¦‚éœ€ï¼Œå¯ä»¥æ”¾æ¾åˆ°ä»…å˜æ›´ï¼‰
if [ -d documents/architecture ]; then
  echo "[pre-push] Lint all architecture docs ..."
  FILES=$(ls documents/architecture/**/*.yaml 2>/dev/null || ls documents/architecture/*.yaml 2>/dev/null || true)
  if [ -n "$FILES" ]; then
    python3 scripts/anz_modules/architecture/architecture_linter.py --files $FILES
  fi
fi

exit 0
