#!/bin/sh
# pre-push: 全量门禁（本地短跑）
set +e  # 临时禁用错误退出，以便捕获测试结果

echo "[pre-push] flutter analyze ..."
flutter analyze
ANALYZE_EXIT=$?
if [ $ANALYZE_EXIT -ne 0 ]; then
  exit $ANALYZE_EXIT
fi

echo "[pre-push] YAML 一致性测试 ..."
# 运行 YAML 测试，捕获输出和退出码
TEMP_OUTPUT=$(mktemp)
flutter test test/yaml/ 2>&1 | tee "$TEMP_OUTPUT"
TEST_EXIT=${PIPESTATUS[0]}

# 如果测试失败，输出统计信息
if [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo "📊 YAML 一致性测试失败统计"
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo ""
  
  # 提取受影响的 YAML 文件
  AFFECTED_FILES=$(grep -o 'documents/architecture/[^:[:space:]]*\.yaml' "$TEMP_OUTPUT" 2>/dev/null | sort -u || true)
  if [ -n "$AFFECTED_FILES" ]; then
    echo "📁 受影响的 YAML 文件："
    echo "$AFFECTED_FILES" | while read -r file; do
      echo "  - $file"
    done
    echo ""
  fi
  
  # 提取失败测试的名称和问题
  FAILED_COUNT=$(grep -c "✖\|FAILED\|失败" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  if [ "$FAILED_COUNT" != "0" ]; then
    echo "❌ 失败测试数量: $FAILED_COUNT"
    echo ""
    
    # 提取失败测试的详细信息
    echo "📋 失败测试列表："
    grep -E "test.*\(|✖|FAILED|失败|❌" "$TEMP_OUTPUT" 2>/dev/null | head -30 | while read -r line; do
      echo "  $line"
    done
    echo ""
  fi
  
  # 提取文件级别的问题摘要（按文件分组）
  echo "📄 按文件分组的问题摘要："
  
  # 提取所有涉及 YAML 文件的失败行
  YAML_ERRORS=$(grep -E "documents/architecture/[^[:space:]]*\.yaml" "$TEMP_OUTPUT" 2>/dev/null | grep -E "❌|FAILED|失败" || true)
  
  if [ -n "$YAML_ERRORS" ]; then
    # 按文件分组统计
    echo "$YAML_ERRORS" | awk -F: '{files[$1]++} END {for (f in files) print "  " f ": " files[f] " 项问题"}' | sort
    echo ""
    
    # 显示每个文件的具体问题（最多显示前5个文件）
    FILE_LIST=$(echo "$YAML_ERRORS" | grep -oE "documents/architecture/[^[:space:]]*\.yaml" | sort -u | head -5)
    for file in $FILE_LIST; do
      echo "  📄 $file:"
      echo "$YAML_ERRORS" | grep "$file" | head -3 | sed 's/^/    • /'
      echo ""
    done
  else
    echo "  （未找到按文件分组的错误信息）"
    echo ""
  fi
  
  # 提取具体的错误消息类型
  echo "🔍 错误类型统计："
  
  FILE_PATH_ERRORS=$(grep -c "file_path.*不存在\|指向不存在的文件" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  CLASS_NAME_ERRORS=$(grep -c "类名.*不一致\|class name.*match" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  TYPE_ERRORS=$(grep -c "类型.*不匹配\|type.*match" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  FIELD_ERRORS=$(grep -c "缺少.*字段\|missing.*field" "$TEMP_OUTPUT" 2>/dev/null || echo "0")
  
  if [ "$FILE_PATH_ERRORS" != "0" ]; then
    echo "  • file_path 问题: $FILE_PATH_ERRORS 项"
  fi
  if [ "$CLASS_NAME_ERRORS" != "0" ]; then
    echo "  • 类名不一致: $CLASS_NAME_ERRORS 项"
  fi
  if [ "$TYPE_ERRORS" != "0" ]; then
    echo "  • 类型不匹配: $TYPE_ERRORS 项"
  fi
  if [ "$FIELD_ERRORS" != "0" ]; then
    echo "  • 缺少字段: $FIELD_ERRORS 项"
  fi
  
  if [ "$FILE_PATH_ERRORS" = "0" ] && [ "$CLASS_NAME_ERRORS" = "0" ] && [ "$TYPE_ERRORS" = "0" ] && [ "$FIELD_ERRORS" = "0" ]; then
    echo "  （无法自动分类错误类型）"
  fi
  echo ""
  
  echo "💡 提示：查看上方完整输出以获取所有失败详情"
  echo "   可以通过以下方式查看更多信息："
  echo "   - 查看完整的测试输出（上方）"
  echo "   - 运行: flutter test test/yaml/ --reporter=expanded"
  echo ""
  
  rm -f "$TEMP_OUTPUT"
  exit $TEST_EXIT
fi

rm -f "$TEMP_OUTPUT"
set -e  # 重新启用错误退出

echo "[pre-push] flutter test (unit+widget) ..."
flutter test --exclude-tags=yaml

echo "[pre-push] integration tests (if any) ..."
if [ -d integration_test ]; then
  flutter test integration_test || true
fi

# 架构文档全量校验（如需，可以放松到仅变更）
if [ -d documents/architecture ]; then
  echo "[pre-push] Lint all architecture docs ..."
  FILES=$(ls documents/architecture/**/*.yaml 2>/dev/null || ls documents/architecture/*.yaml 2>/dev/null || true)
  if [ -n "$FILES" ]; then
    python3 scripts/anz_modules/architecture/architecture_linter.py --files $FILES
  fi
fi

exit 0
