#!/bin/sh
# pre-commit: ç²¾å‡†æ ¡éªŒæœ¬æ¬¡å˜æ›´çš„ architecture YAML ä¸åŸºæœ¬è´¨é‡é—¨ç¦
set -e

# æ”¶é›†å˜æ›´æ–‡ä»¶ï¼ˆstagedï¼‰
CHANGED=$(git diff --cached --name-only)

# æ–‡ä»¶å¤§å°æ£€æŸ¥å‡½æ•°
check_file_size() {
  local file="$1"
  
  # è·³è¿‡ç”Ÿæˆçš„æ–‡ä»¶
  if echo "$file" | grep -q '\.g\.dart$'; then
    return 0
  fi
  
  # åªæ£€æŸ¥ lib ä¸‹çš„ dart æ–‡ä»¶
  if ! echo "$file" | grep -q '^lib/.*\.dart$'; then
    return 0
  fi
  
  local lines=$(wc -l < "$file" 2>/dev/null || echo "0")
  local max_lines=0
  local warning_lines=0
  local file_type=""
  
  # æ ¹æ®æ–‡ä»¶è·¯å¾„åˆ¤æ–­é˜ˆå€¼
  if echo "$file" | grep -q "^lib/presentation/.*\.dart$"; then
    max_lines=500
    warning_lines=400
    file_type="presentation"
  elif echo "$file" | grep -q "^lib/core/\(utils\|providers\|services\|monetization\)/.*\.dart$"; then
    max_lines=400
    warning_lines=300
    file_type="core"
  elif echo "$file" | grep -q "^lib/data/repositories/.*\.dart$"; then
    max_lines=500
    warning_lines=400
    file_type="repository"
  elif [ "$file" = "lib/main.dart" ]; then
    max_lines=100
    warning_lines=80
    file_type="main"
  elif echo "$file" | grep -q "^lib/data/models/.*\.dart$"; then
    max_lines=300
    warning_lines=250
    file_type="model"
  else
    # å…¶ä»– lib ä¸‹çš„ dart æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é˜ˆå€¼
    max_lines=400
    warning_lines=300
    file_type="default"
  fi
  
  # æ£€æŸ¥æ˜¯å¦è¶…è¿‡ç¡¬æ€§é˜ˆå€¼
  if [ "$lines" -gt "$max_lines" ]; then
    echo "âŒ é”™è¯¯: $file è¶…è¿‡æ–‡ä»¶å¤§å°é™åˆ¶ï¼"
    echo "   å½“å‰è¡Œæ•°: $lines è¡Œ"
    echo "   æœ€å¤§å…è®¸: $max_lines è¡Œ ($file_type)"
    echo "   è¶…å‡º: $((lines - max_lines)) è¡Œ"
    echo ""
    echo "   è¯·å…ˆé‡æ„æ­¤æ–‡ä»¶ï¼Œæ‹†åˆ†åå†æäº¤ã€‚"
    echo "   æ‹†åˆ†ç­–ç•¥å‚è€ƒ: documents/project/refactor_rules.yaml"
    return 1
  fi
  
  # æ£€æŸ¥æ˜¯å¦è¶…è¿‡è­¦å‘Šé˜ˆå€¼ï¼ˆåªè­¦å‘Šï¼Œä¸é˜»æ­¢ï¼‰
  if [ "$lines" -gt "$warning_lines" ]; then
    echo "âš ï¸  è­¦å‘Š: $file æ¥è¿‘æ–‡ä»¶å¤§å°é™åˆ¶"
    echo "   å½“å‰è¡Œæ•°: $lines è¡Œ (è­¦å‘Šé˜ˆå€¼: $warning_lines, æœ€å¤§: $max_lines)"
    echo ""
  fi
  
  return 0
}

# 0) æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆåœ¨æ ¼å¼åŒ–ä¹‹å‰ï¼‰
DART_CHANGED=$(echo "$CHANGED" | grep -E '^lib/.*\.dart$' || true)
if [ -n "$DART_CHANGED" ]; then
  echo "[pre-commit] Checking file size limits ..."
  HAS_ERROR=0
  for file in $DART_CHANGED; do
    if [ -f "$file" ]; then
      if ! check_file_size "$file"; then
        HAS_ERROR=1
      fi
    fi
  done
  
  if [ $HAS_ERROR -eq 1 ]; then
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“‹ æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "è¯·å…ˆé‡æ„è¶…è¿‡é™åˆ¶çš„æ–‡ä»¶ï¼Œç„¶åé‡æ–°æäº¤ã€‚"
    echo "è¯¦ç»†è§„åˆ™è¯·å‚è€ƒ: .cursor/rules/00-global.mdc å’Œ documents/project/refactor_rules.yaml"
    echo ""
    exit 1
  fi
  echo "[pre-commit] âœ“ File size check passed"
fi

# 1) Dart æ ¼å¼/åˆ†æï¼ˆä»…å—å½±å“ç›®å½•ï¼‰
if echo "$CHANGED" | grep -E '^lib/|^test/|^integration_test/' >/dev/null 2>&1; then
  echo "[pre-commit] Running dart format (changed only) ..."
  echo "$CHANGED" | grep -E '\.dart$' | xargs -r dart format --line-length 100 >/dev/null
  git add -A

  echo "[pre-commit] Running flutter analyze ..."
  flutter analyze
fi

# 2) æ¶æ„æ–‡æ¡£ Linterï¼ˆç²¾å‡†åˆ°å˜æ›´ï¼‰
ARCH_CHANGED=$(echo "$CHANGED" | grep -E '^documents/architecture/.*\.ya?ml$' || true)
if [ -n "$ARCH_CHANGED" ]; then
  echo "[pre-commit] Lint architecture docs (precise) ..."
  python3 scripts/anz_modules/architecture/architecture_linter.py --files $ARCH_CHANGED
fi

exit 0
