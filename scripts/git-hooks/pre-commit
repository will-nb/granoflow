#!/bin/sh
# pre-commit: ç²¾å‡†æ ¡éªŒæœ¬æ¬¡å˜æ›´çš„ architecture YAML ä¸åŸºæœ¬è´¨é‡é—¨ç¦
set -e

# æ”¶é›†å˜æ›´æ–‡ä»¶ï¼ˆstagedï¼‰
CHANGED=$(git diff --cached --name-only)

# è®¡ç®—æœ‰æ•ˆä»£ç è¡Œæ•°ï¼ˆæ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰çš„ Python å‡½æ•°
count_code_lines() {
  local file="$1"
  python3 - "$file" << 'PYTHON_EOF'
import sys
import re

def remove_comments(content):
    """ç§»é™¤ Dart ä»£ç ä¸­çš„æ³¨é‡Š"""
    result = []
    lines = content.split('\n')
    in_multiline_comment = False
    in_multiline_doc_comment = False
    
    for line in lines:
        i = 0
        in_string = False
        string_char = None
        new_line = []
        
        while i < len(line):
            char = line[i]
            peek = line[i:i+2] if i+2 <= len(line) else ""
            
            # å¤„ç†å­—ç¬¦ä¸²
            if char in ('"', "'") and (i == 0 or line[i-1] != '\\'):
                if not in_string:
                    in_string = True
                    string_char = char
                elif char == string_char:
                    in_string = False
                    string_char = None
                new_line.append(char)
                i += 1
                continue
            
            # åœ¨å­—ç¬¦ä¸²å†…ï¼Œç›´æ¥æ·»åŠ å­—ç¬¦
            if in_string:
                new_line.append(char)
                i += 1
                continue
            
            # å¤„ç†å¤šè¡Œæ³¨é‡Šç»“æŸ
            if in_multiline_comment or in_multiline_doc_comment:
                if peek == '*/':
                    in_multiline_comment = False
                    in_multiline_doc_comment = False
                    i += 2
                    continue
                i += 1
                continue
            
            # å¤„ç†å•è¡Œæ³¨é‡Š //
            if peek == '//' and (i + 2 >= len(line) or line[i+2] != '/'):
                break
            
            # å¤„ç†æ–‡æ¡£æ³¨é‡Š ///
            if i + 3 <= len(line) and line[i:i+3] == '///':
                break
            
            # å¤„ç†å¤šè¡Œæ³¨é‡Šå¼€å§‹ /* æˆ– /**
            if peek == '/*':
                if i + 2 < len(line) and line[i+2] == '*':
                    in_multiline_doc_comment = True
                    i += 3
                else:
                    in_multiline_comment = True
                    i += 2
                continue
            
            new_line.append(char)
            i += 1
        
        cleaned = ''.join(new_line).strip()
        if cleaned or in_multiline_comment or in_multiline_doc_comment:
            result.append(''.join(new_line))
    
    return '\n'.join(result)

def count_code_lines(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        cleaned_content = remove_comments(content)
        lines = cleaned_content.split('\n')
        code_lines = [line for line in lines if line.strip()]
        return len(code_lines)
    except Exception:
        return 0

if __name__ == '__main__':
    file_path = sys.argv[1]
    print(count_code_lines(file_path))
PYTHON_EOF
}

# æ–‡ä»¶å¤§å°æ£€æŸ¥å‡½æ•°
check_file_size() {
  local file="$1"
  
  # è·³è¿‡ç”Ÿæˆçš„æ–‡ä»¶
  if echo "$file" | grep -q '\.g\.dart$'; then
    return 0
  fi
  
  # åªæ£€æŸ¥ lib ä¸‹çš„ dart æ–‡ä»¶
  if ! echo "$file" | grep -q '^lib/.*\.dart$'; then
    return 0
  fi
  
  # ä½¿ç”¨ Python è®¡ç®—æœ‰æ•ˆä»£ç è¡Œæ•°ï¼ˆæ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
  local lines=$(count_code_lines "$file")
  local max_lines=0
  local warning_lines=0
  local file_type=""
  
  # æ ¹æ®æ–‡ä»¶è·¯å¾„åˆ¤æ–­é˜ˆå€¼
  if echo "$file" | grep -q "^lib/presentation/.*\.dart$"; then
    max_lines=500
    warning_lines=400
    file_type="presentation"
  elif echo "$file" | grep -q "^lib/core/\(utils\|providers\|services\|monetization\)/.*\.dart$"; then
    max_lines=400
    warning_lines=300
    file_type="core"
  elif echo "$file" | grep -q "^lib/data/repositories/.*\.dart$"; then
    max_lines=500
    warning_lines=400
    file_type="repository"
  elif [ "$file" = "lib/main.dart" ]; then
    max_lines=100
    warning_lines=80
    file_type="main"
  elif echo "$file" | grep -q "^lib/data/models/.*\.dart$"; then
    max_lines=300
    warning_lines=250
    file_type="model"
  else
    # å…¶ä»– lib ä¸‹çš„ dart æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é˜ˆå€¼
    max_lines=400
    warning_lines=300
    file_type="default"
  fi
  
  # æ£€æŸ¥æ˜¯å¦è¶…è¿‡ç¡¬æ€§é˜ˆå€¼
  if [ "$lines" -gt "$max_lines" ]; then
    echo "âŒ é”™è¯¯: $file è¶…è¿‡æ–‡ä»¶å¤§å°é™åˆ¶ï¼"
    echo "   å½“å‰ä»£ç è¡Œæ•°: $lines è¡Œï¼ˆå·²æ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰"
    echo "   æœ€å¤§å…è®¸: $max_lines è¡Œ ($file_type)"
    echo "   è¶…å‡º: $((lines - max_lines)) è¡Œ"
    echo ""
    echo "   è¯·å…ˆé‡æ„æ­¤æ–‡ä»¶ï¼Œæ‹†åˆ†åå†æäº¤ã€‚"
    echo "   æ‹†åˆ†ç­–ç•¥å‚è€ƒ: documents/project/refactor_rules.yaml"
    return 1
  fi
  
  # æ£€æŸ¥æ˜¯å¦è¶…è¿‡è­¦å‘Šé˜ˆå€¼ï¼ˆåªè­¦å‘Šï¼Œä¸é˜»æ­¢ï¼‰
  if [ "$lines" -gt "$warning_lines" ]; then
    echo "âš ï¸  è­¦å‘Š: $file æ¥è¿‘æ–‡ä»¶å¤§å°é™åˆ¶"
    echo "   å½“å‰ä»£ç è¡Œæ•°: $lines è¡Œï¼ˆå·²æ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰(è­¦å‘Šé˜ˆå€¼: $warning_lines, æœ€å¤§: $max_lines)"
    echo ""
  fi
  
  return 0
}

# 0) æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆåœ¨æ ¼å¼åŒ–ä¹‹å‰ï¼‰
DART_CHANGED=$(echo "$CHANGED" | grep -E '^lib/.*\.dart$' || true)
if [ -n "$DART_CHANGED" ]; then
  echo "[pre-commit] Checking file size limits ..."
  HAS_ERROR=0
  for file in $DART_CHANGED; do
    if [ -f "$file" ]; then
      if ! check_file_size "$file"; then
        HAS_ERROR=1
      fi
    fi
  done
  
  if [ $HAS_ERROR -eq 1 ]; then
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“‹ æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "è¯·å…ˆé‡æ„è¶…è¿‡é™åˆ¶çš„æ–‡ä»¶ï¼Œç„¶åé‡æ–°æäº¤ã€‚"
    echo "è¯¦ç»†è§„åˆ™è¯·å‚è€ƒ: .cursor/rules/00-global.mdc å’Œ documents/project/refactor_rules.yaml"
    echo ""
    exit 1
  fi
  echo "[pre-commit] âœ“ File size check passed"
fi

# 1) Dart æ ¼å¼/åˆ†æï¼ˆä»…å—å½±å“ç›®å½•ï¼‰
if echo "$CHANGED" | grep -E '^lib/|^test/|^integration_test/' >/dev/null 2>&1; then
  echo "[pre-commit] Running dart format (changed only) ..."
  echo "$CHANGED" | grep -E '\.dart$' | xargs -r dart format --line-length 100 >/dev/null
  git add -A

  echo "[pre-commit] Running flutter analyze ..."
  flutter analyze
fi

# 2) æ¶æ„æ–‡æ¡£ Linterï¼ˆç²¾å‡†åˆ°å˜æ›´ï¼‰
ARCH_CHANGED=$(echo "$CHANGED" | grep -E '^documents/architecture/.*\.ya?ml$' || true)
if [ -n "$ARCH_CHANGED" ]; then
  echo "[pre-commit] Lint architecture docs (precise) ..."
  python3 scripts/anz_modules/architecture/architecture_linter.py --files $ARCH_CHANGED
fi

exit 0
