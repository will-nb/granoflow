name: Deploy Android

on:
  workflow_call:
    inputs:
      edition:
        description: 'App edition (lite or pro)'
        required: true
        type: string
      track:
        description: 'Google Play track (internal, alpha, beta, production)'
        required: false
        type: string
        default: 'internal'
  workflow_dispatch:
    inputs:
      edition:
        description: 'App edition (lite or pro)'
        required: true
        type: choice
        options:
          - lite
          - pro
      track:
        description: 'Google Play track'
        required: false
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
        default: 'internal'

jobs:
  deploy:
    name: Deploy Android - ${{ inputs.edition }} to ${{ inputs.track || 'internal' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.edition }}-android-*
          merge-multiple: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Keystore
        if: ${{ inputs.edition == 'lite' || inputs.edition == 'pro' }}
        run: |
          # ä½¿ç”¨ç»Ÿä¸€çš„ keystore æ–‡ä»¶ï¼Œlite å’Œ pro å¯ä»¥å…±ç”¨åŒä¸€ä¸ª keystore
          # å› ä¸ºå®ƒä»¬çš„åŒ…åä¸åŒï¼ˆcom.granoflow.lite å’Œ com.granoflow.proï¼‰ï¼Œä¸ä¼šå†²çª
          # æ³¨æ„ï¼škeystore å®é™…æ˜¯ PKCS12 æ ¼å¼ï¼Œä½†æ–‡ä»¶åé”™è¯¯ä¸º .jksï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ .p12 æ‰©å±•å
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/granoflow-keystore.p12
          cat > android/app/keystore.properties << EOF
          storeFile=granoflow-keystore.p12
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Setup Google Play Service Account
        if: ${{ inputs.edition == 'lite' || inputs.edition == 'pro' }}
        run: |
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" > ${{ runner.temp }}/google-play-service-account.json

      - name: Deploy to Google Play
        if: ${{ inputs.edition == 'lite' || inputs.edition == 'pro' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.granoflow.${{ inputs.edition }}
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: ${{ inputs.track || 'internal' }}
          status: completed
          inAppUpdatePriority: 2
          skipUploadMetadata: true
          skipUploadImages: true
          skipUploadScreenshots: true

      - name: Deploy to Amazon Appstore
        if: ${{ inputs.edition == 'lite' }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°Amazon Appstore..."
          # TODO: å®ç°Amazon Appstoreéƒ¨ç½²
          echo "Amazon Appstoreéƒ¨ç½²åŠŸèƒ½å¾…å®ç°"

      - name: Deploy to Samsung Galaxy Store
        if: ${{ inputs.edition == 'lite' }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°Samsung Galaxy Store..."
          # TODO: å®ç°Samsung Galaxy Storeéƒ¨ç½²
          echo "Samsung Galaxy Storeéƒ¨ç½²åŠŸèƒ½å¾…å®ç°"

      - name: Deploy to Xiaomi App Store
        if: ${{ inputs.edition == 'lite' }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°å°ç±³åº”ç”¨å•†åº—..."
          # TODO: å®ç°å°ç±³åº”ç”¨å•†åº—éƒ¨ç½²
          echo "å°ç±³åº”ç”¨å•†åº—éƒ¨ç½²åŠŸèƒ½å¾…å®ç°"

      - name: Deploy to OPPO App Store
        if: ${{ inputs.edition == 'lite' }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°OPPOåº”ç”¨å•†åº—..."
          # TODO: å®ç°OPPOåº”ç”¨å•†åº—éƒ¨ç½²
          echo "OPPOåº”ç”¨å•†åº—éƒ¨ç½²åŠŸèƒ½å¾…å®ç°"

      - name: Deploy to vivo App Store
        if: ${{ inputs.edition == 'lite' }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°vivoåº”ç”¨å•†åº—..."
          # TODO: å®ç°vivoåº”ç”¨å•†åº—éƒ¨ç½²
          echo "vivoåº”ç”¨å•†åº—éƒ¨ç½²åŠŸèƒ½å¾…å®ç°"

      - name: Deploy to Tencent App Store
        if: ${{ inputs.edition == 'lite' }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°è…¾è®¯åº”ç”¨å®..."
          # TODO: å®ç°è…¾è®¯åº”ç”¨å®éƒ¨ç½²
          echo "è…¾è®¯åº”ç”¨å®éƒ¨ç½²åŠŸèƒ½å¾…å®ç°"

      - name: Deploy to Coolapk
        if: ${{ inputs.edition == 'lite' }}
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°Coolapkï¼ˆé…·å®‰ï¼‰..."
          # TODO: å®ç°Coolapkéƒ¨ç½²
          echo "Coolapkéƒ¨ç½²åŠŸèƒ½å¾…å®ç°"

