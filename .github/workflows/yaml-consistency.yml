name: YAML Consistency Tests

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  FLUTTER_VERSION: '3.35.7'

jobs:
  yaml-consistency:
    name: YAML Consistency Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Get Flutter dependencies
        run: flutter pub get
        
      - name: Verify Flutter installation
        run: flutter doctor
        
      - name: Check YAML files exist
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ YAML æ–‡ä»¶..."
          REQUIRED_FILES=(
            "documents/architecture/widgets/navigation_destinations.yaml"
            "documents/architecture/widgets/drawer_menu.yaml"
            "documents/architecture/widgets/responsive_navigation.yaml"
            "documents/architecture/widgets/main_drawer.yaml"
            "documents/architecture/widgets/page_app_bar.yaml"
            "documents/architecture/widgets/create_task_dialog.yaml"
            "documents/architecture/widgets/widgets.yaml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ å¿…éœ€çš„ YAML æ–‡ä»¶ä¸å­˜åœ¨: $file"
              exit 1
            fi
          done
          
          echo "âœ… æ‰€æœ‰å¿…éœ€çš„ YAML æ–‡ä»¶å­˜åœ¨"
          
      - name: Validate YAML syntax
        run: |
          echo "ğŸ” éªŒè¯ YAML è¯­æ³•..."
          REQUIRED_FILES=(
            "documents/architecture/widgets/navigation_destinations.yaml"
            "documents/architecture/widgets/drawer_menu.yaml"
            "documents/architecture/widgets/responsive_navigation.yaml"
            "documents/architecture/widgets/main_drawer.yaml"
            "documents/architecture/widgets/page_app_bar.yaml"
            "documents/architecture/widgets/create_task_dialog.yaml"
            "documents/architecture/widgets/widgets.yaml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            echo "éªŒè¯ $file..."
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "âŒ YAML è¯­æ³•é”™è¯¯: $file"
              exit 1
            fi
          done
          
          echo "âœ… æ‰€æœ‰ YAML æ–‡ä»¶è¯­æ³•æ­£ç¡®"
          
      - name: Run YAML Documentation Tests
        run: |
          echo "ğŸ“‹ è¿è¡Œ YAML æ–‡æ¡£æµ‹è¯•..."
          flutter test test/documentation/ --reporter=expanded
          
      - name: Generate Test Report
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
          mkdir -p test_reports
          
          # åˆ›å»ºæµ‹è¯•æŠ¥å‘Š
          cat > test_reports/yaml_consistency_report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow": "YAML Consistency Tests",
            "status": "${{ job.status }}",
            "tests": {
              "yaml_documentation": {
                "file": "test/documentation/",
                "status": "completed"
              }
            },
            "yaml_files_checked": [
              "documents/architecture/widgets/navigation_destinations.yaml",
              "documents/architecture/widgets/drawer_menu.yaml",
              "documents/architecture/widgets/responsive_navigation.yaml",
              "documents/architecture/widgets/main_drawer.yaml",
              "documents/architecture/widgets/page_app_bar.yaml",
              "documents/architecture/widgets/create_task_dialog.yaml",
              "documents/architecture/widgets/widgets.yaml"
            ]
          }
          EOF
          
          echo "âœ… æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: test_reports/yaml_consistency_report.json"
          
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: yaml-consistency-report
          path: test_reports/yaml_consistency_report.json
          
      - name: Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('YAML ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥')
            );
            
            const commentBody = `## âŒ YAML ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥
            
            **å·¥ä½œæµ**: YAML Consistency Tests
            **çŠ¶æ€**: å¤±è´¥
            **æ—¶é—´**: ${new Date().toISOString()}
            
            ### å¤±è´¥åŸå› 
            - ä»£ç ä¸ YAML æ–‡æ¡£ä¸ä¸€è‡´
            - è¯·æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶ï¼š
              - \`documents/architecture/widgets/navigation_destinations.yaml\`
              - \`documents/architecture/widgets/drawer_menu.yaml\`
              - \`documents/architecture/widgets/responsive_navigation.yaml\`
              - \`documents/architecture/widgets/main_drawer.yaml\`
              - \`documents/architecture/widgets/page_app_bar.yaml\`
              - \`documents/architecture/widgets/create_task_dialog.yaml\`
              - \`documents/architecture/widgets/widgets.yaml\`
            
            ### ä¿®å¤æ­¥éª¤
            1. æ£€æŸ¥ YAML æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”è¯­æ³•æ­£ç¡®
            2. ç¡®ä¿ä»£ç å®ç°ä¸ YAML æ–‡æ¡£ä¸€è‡´
            3. è¿è¡Œæœ¬åœ°æµ‹è¯•: \`./scripts/run_yaml_tests.sh --all\`
            4. é‡æ–°æäº¤ä»£ç 
            
            ### çº¦æŸè§„åˆ™
            - âœ… å…è®¸å¢åŠ æ–°çš„å›¾æ ‡ã€è·¯ç”±ã€æ–‡æœ¬
            - âŒ ç¦æ­¢å‡å°‘ç°æœ‰çš„å›¾æ ‡ã€è·¯ç”±ã€æ–‡æœ¬
            - âŒ ç¦æ­¢é‡å‘½åç°æœ‰çš„å˜é‡åã€è·¯ç”±åã€å›¾æ ‡å
            - âŒ ç¦æ­¢ä¿®æ”¹ç°æœ‰çš„å›¾æ ‡ã€è·¯ç”±ã€æ–‡æœ¬å®šä¹‰
            - âŒ ç¦æ­¢åˆ é™¤ç°æœ‰çš„ç»„ä»¶å®šä¹‰
            - âŒ ç¦æ­¢åˆ é™¤ç°æœ‰çš„æµ‹è¯•ç”¨ä¾‹
            
            ### å˜æ›´æµç¨‹
            1. å¿…é¡»å…ˆä¿®æ”¹ YAML æ–‡æ¡£
            2. ç„¶åä¿®æ”¹ä»£ç å®ç°
            3. æœ€åè¿è¡Œä¸€è‡´æ€§æµ‹è¯•
            4. æµ‹è¯•é€šè¿‡åæ‰èƒ½æäº¤
            `;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
            
      - name: Success Comment on PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('YAML ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: `## âœ… YAML ä¸€è‡´æ€§æµ‹è¯•é€šè¿‡
                
                **å·¥ä½œæµ**: YAML Consistency Tests
                **çŠ¶æ€**: æˆåŠŸ
                **æ—¶é—´**: ${new Date().toISOString()}
                
                ğŸ‰ æ‰€æœ‰ YAML ä¸€è‡´æ€§æµ‹è¯•é€šè¿‡ï¼ä»£ç ä¸è®¾è®¡æ–‡æ¡£ä¿æŒä¸€è‡´ã€‚
                `
              });
            }
