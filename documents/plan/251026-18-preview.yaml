title: "统一任务展开编辑面板 - Preview"
description: "基于inbox的展开编辑功能提取通用组件，让tasks的展开编辑面板与inbox完全一致"
date: "2025-10-26"
version: "1.0"

overview:
  goal: "统一inbox和tasks的展开编辑面板，确保编辑体验完全一致"
  scope: "只统一展开后的编辑内容，其他功能保持不变"
  benefits:
    - "展开编辑面板完全一致"
    - "代码复用，减少重复"
    - "便于维护和扩展"
    - "统一测试覆盖"

current_state:
  inbox_expanded_panel:
    - "TagPanel组件（基于ChipToggleGroup）"
    - "快速规划功能（Quick Plan）"
    - "标签更新逻辑（_updateTags）"
    - "错误处理（_ErrorBanner）"
    - "标签选项转换（_toChipOptions）"
    - "创建时间显示"
    - "滑动提示文字"
  
  tasks_expanded_panel:
    - "_TagsSection组件（直接使用FilterChip）"
    - "日期设置功能（_DateSection）"
    - "标签切换逻辑（_toggleTag）"
    - "不同的标签处理方式"
    - "分隔线布局"

  unchanged_features:
    - "内联标题编辑（TextField）- 两个页面都保持不变"
    - "展开/收起交互逻辑 - 保持不变"
    - "页面整体布局和结构 - 保持不变"
    - "其他所有现有功能 - 保持不变"

proposed_solution:
  architecture:
    - "提取TagPanel到独立文件"
    - "创建TaskExpandedPanel通用组件"
    - "统一标签处理逻辑"
    - "保持inbox外观完全不变"
    - "让tasks的展开面板与inbox完全一致"
  
  components:
    - name: "TagPanel"
      location: "lib/presentation/widgets/tag_panel.dart"
      description: "标签编辑面板，支持context和priority标签"
      features:
        - "基于ChipToggleGroup实现"
        - "支持单选模式"
        - "统一的标签选项转换"
        - "错误状态处理"
    
    - name: "TaskExpandedPanel"
      location: "lib/presentation/widgets/task_expanded_panel.dart"
      description: "通用任务展开编辑面板"
      features:
        - "可配置的功能模块"
        - "统一的标签编辑（使用TagPanel）"
        - "可选的快速规划功能"
        - "可选的日期设置功能"
        - "统一的错误处理"
        - "统一的布局和间距"
    
    - name: "TaskEditMixin"
      location: "lib/presentation/widgets/task_edit_mixin.dart"
      description: "任务编辑相关的通用方法"
      features:
        - "_updateTags方法"
        - "_toChipOptions方法"
        - "_getTagLabel方法"
        - "错误处理逻辑"

implementation_plan:
  phase_1_extract_components:
    title: "提取基础组件"
    steps:
      - step: "1.1"
        action: "创建TagPanel独立文件"
        files:
          - "lib/presentation/widgets/tag_panel.dart"
        description: "将TagPanel从inbox_page.dart中提取到独立文件"
        
      - step: "1.2"
        action: "创建TaskEditMixin"
        files:
          - "lib/presentation/widgets/task_edit_mixin.dart"
        description: "提取标签处理相关的通用方法"
        
      - step: "1.3"
        action: "创建ErrorBanner组件"
        files:
          - "lib/presentation/widgets/error_banner.dart"
        description: "提取错误提示组件"

  phase_2_create_unified_panel:
    title: "创建统一展开面板"
    steps:
      - step: "2.1"
        action: "创建TaskExpandedPanel组件"
        files:
          - "lib/presentation/widgets/task_expanded_panel.dart"
        description: "创建通用的任务展开编辑面板，支持可配置功能"
        features:
          - "标签编辑（使用TagPanel）"
          - "可选的快速规划功能"
          - "可选的日期设置功能"
          - "统一的错误处理"
          - "统一的布局和间距"
          - "元数据显示（创建时间等）"

  phase_3_refactor_inbox:
    title: "重构inbox使用新组件（外观不变）"
    steps:
      - step: "3.1"
        action: "更新inbox导入"
        files:
          - "lib/presentation/inbox/inbox_page.dart"
        description: "导入新的通用组件"
        
      - step: "3.2"
        action: "替换_ExpandedInboxControls"
        files:
          - "lib/presentation/inbox/inbox_page.dart"
        description: "使用TaskExpandedPanel替换现有实现"
        changes:
          - "移除TagPanel、_updateTags、_toChipOptions等重复代码"
          - "使用TaskExpandedPanel with showQuickPlan: true"
          - "保持inbox外观和功能完全不变"

  phase_4_refactor_tasks:
    title: "重构tasks使用新组件（与inbox一致）"
    steps:
      - step: "4.1"
        action: "更新tasks导入"
        files:
          - "lib/presentation/tasks/task_list_page.dart"
        description: "导入新的通用组件"
        
      - step: "4.2"
        action: "替换_ExpandedTaskControls"
        files:
          - "lib/presentation/tasks/task_list_page.dart"
        description: "使用TaskExpandedPanel替换现有实现"
        changes:
          - "移除_TagsSection组件"
          - "使用TaskExpandedPanel with showDateSection: true"
          - "tasks的展开面板将与inbox完全一致"

  phase_5_testing:
    title: "测试验证"
    steps:
      - step: "5.1"
        action: "运行现有测试"
        command: "flutter test"
        description: "确保重构后所有测试通过"
        
      - step: "5.2"
        action: "手动测试功能"
        description: "验证inbox和tasks的编辑功能正常工作"
        checklist:
          - "inbox标签编辑功能正常"
          - "inbox快速规划功能正常"
          - "tasks标签编辑功能正常"
          - "tasks日期设置功能正常"
          - "两个页面的编辑体验一致"

file_structure:
  new_files:
    - "lib/presentation/widgets/tag_panel.dart"
    - "lib/presentation/widgets/task_expanded_panel.dart"
    - "lib/presentation/widgets/task_edit_mixin.dart"
    - "lib/presentation/widgets/error_banner.dart"
  
  modified_files:
    - "lib/presentation/inbox/inbox_page.dart"
    - "lib/presentation/tasks/task_list_page.dart"

technical_details:
  tag_panel:
    dependencies:
      - "package:flutter/material.dart"
      - "package:flutter_riverpod/flutter_riverpod.dart"
      - "chip_toggle_group.dart"
      - "task_edit_mixin.dart"
    props:
      - "contextOptions: List<ChipToggleOption>"
      - "priorityOptions: List<ChipToggleOption>"
      - "selectedContext: String?"
      - "selectedPriority: String?"
      - "onContextChanged: ValueChanged<String?>"
      - "onPriorityChanged: ValueChanged<String?>"

  task_expanded_panel:
    dependencies:
      - "package:flutter/material.dart"
      - "package:flutter_riverpod/flutter_riverpod.dart"
      - "package:intl/intl.dart"
      - "tag_panel.dart"
      - "task_edit_mixin.dart"
      - "error_banner.dart"
    props:
      - "task: Task"
      - "localeName: String"
      - "showQuickPlan: bool (default: false)"
      - "showDateSection: bool (default: false)"
      - "onQuickPlan: VoidCallback? (optional)"
      - "onDateChanged: ValueChanged<DateTime?>? (optional)"

  task_edit_mixin:
    methods:
      - "updateTags(BuildContext, WidgetRef, int, String?, String?)"
      - "toChipOptions(List<Tag>, String)"
      - "getTagLabel(String)"
      - "handleTagError(BuildContext, String)"

migration_strategy:
  backward_compatibility:
    - "保持所有现有API不变"
    - "保持所有现有功能不变"
    - "保持所有现有UI表现不变"
  
  testing_strategy:
    - "先提取组件，确保inbox功能正常"
    - "再重构tasks，确保功能正常"
    - "最后验证两个页面体验一致"

risk_assessment:
  low_risk:
    - "组件提取是纯重构，不改变功能"
    - "保持现有API和UI表现"
    - "可以逐步迁移，降低风险"
  
  mitigation:
    - "每个阶段都有测试验证"
    - "保持git提交的原子性"
    - "如有问题可以快速回滚"

success_criteria:
  - "inbox和tasks的展开编辑面板完全一致"
  - "inbox外观和功能完全不变"
  - "tasks的标签编辑体验与inbox一致"
  - "代码重复度显著降低"
  - "所有现有测试通过"
  - "用户体验无任何变化（inbox）"
  - "tasks用户体验显著提升（与inbox一致）"

next_steps:
  - "创建TagPanel独立文件"
  - "创建TaskEditMixin"
  - "创建TaskExpandedPanel通用组件"
  - "重构inbox使用新组件（外观不变）"
  - "重构tasks使用新组件（与inbox一致）"
  - "测试验证功能正常"
