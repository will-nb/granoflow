{
  // 回顾页面迭代计划文档
  // 详细描述实现步骤、文件创建、代码结构和技术细节
  // 基于 documents/json5/review/design.json5 设计文档
  
  // ===========================================
  // 1. 迭代概述
  // ===========================================
  iteration: {
    id: "250101-review-page",
    title: "回顾页面实现",
    description: "基于设计文档实现回顾页面，包含开场动画、逐行内容显示、数据统计、文章复制和导出等功能",
    status: "planning",
    estimatedTime: "7-10 days",
    priority: "high",
    basedOnDesign: "documents/json5/review/design.json5",
  },

  // ===========================================
  // 2. 文件创建清单
  // ===========================================
  files: {
    // 服务层 - 数据查询服务
    services: [
      {
        path: "lib/core/services/review_data_service.dart",
        purpose: "回顾页面数据查询服务，封装所有数据查询逻辑",
        action: "create",
        estimatedLines: 400,
        dependencies: [
          "lib/data/repositories/task_repository.dart",
          "lib/data/repositories/project_repository.dart",
          "lib/data/repositories/focus_session_repository.dart",
        ],
        note: "统一管理所有回顾页面的数据查询，便于测试和优化",
      },
    ],
    
    // 数据模型 - 回顾页面数据模型
    models: [
      {
        path: "lib/data/models/review_data.dart",
        purpose: "回顾页面数据模型，包含所有需要显示的数据",
        action: "create",
        estimatedLines: 200,
        dependencies: [
          "lib/data/models/task.dart",
          "lib/data/models/project.dart",
        ],
        note: "包含欢迎信息、统计信息、项目列表、任务信息等所有数据结构",
      },
    ],
    
    // Provider 状态管理
    providers: [
      {
        path: "lib/core/providers/review_providers.dart",
        purpose: "回顾页面状态管理（数据加载、动画状态、内容显示状态）",
        action: "create",
        estimatedLines: 300,
        dependencies: [
          "lib/core/services/review_data_service.dart",
          "lib/data/models/review_data.dart",
        ],
        note: "使用 StateNotifierProvider 管理页面状态",
      },
    ],
    
    // 工具函数
    utils: [
      {
        path: "lib/presentation/review/utils/review_text_generator.dart",
        purpose: "生成完整文章文本的工具函数（用于复制和导出）",
        action: "create",
        estimatedLines: 150,
        dependencies: [
          "lib/data/models/review_data.dart",
        ],
        note: "支持纯文本和 Markdown 格式",
      },
      {
        path: "lib/presentation/review/utils/review_date_formatter.dart",
        purpose: "日期格式化工具函数",
        action: "create",
        estimatedLines: 80,
        dependencies: [],
        note: "统一处理所有日期显示格式（x年x月x日）",
      },
      {
        path: "lib/presentation/review/utils/review_time_formatter.dart",
        purpose: "时间格式化工具函数（分钟、小时等）",
        action: "create",
        estimatedLines: 100,
        dependencies: [],
        note: "人性化时间显示（X分钟、X小时Y分钟、X.X小时）",
      },
    ],
    
    // Widget 组件 - 动画相关
    widgets_animation: [
      {
        path: "lib/presentation/review/widgets/review_opening_animation.dart",
        purpose: "开场动画组件（标签展示与消失）",
        action: "create",
        estimatedLines: 300,
        dependencies: [
          "lib/presentation/widgets/modern_tag.dart",
        ],
        note: "包含标签爆炸效果和滑动动画",
      },
      {
        path: "lib/presentation/review/widgets/explosion_particle_painter.dart",
        purpose: "爆炸粒子效果绘制器（CustomPainter）",
        action: "create",
        estimatedLines: 200,
        dependencies: [],
        note: "实现标签消失时的爆炸粒子效果",
      },
    ],
    
    // Widget 组件 - 内容行组件
    widgets_content: [
      {
        path: "lib/presentation/review/widgets/review_content_line.dart",
        purpose: "回顾内容行组件（基础组件，支持淡入动画）",
        action: "create",
        estimatedLines: 100,
        dependencies: [],
        note: "所有内容行的基础组件，处理淡入动画",
      },
      {
        path: "lib/presentation/review/widgets/review_welcome_line.dart",
        purpose: "欢迎语行组件",
        action: "create",
        estimatedLines: 80,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
          "lib/presentation/review/utils/review_date_formatter.dart",
        ],
      },
      {
        path: "lib/presentation/review/widgets/review_stats_line.dart",
        purpose: "统计信息行组件",
        action: "create",
        estimatedLines: 80,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
        ],
      },
      {
        path: "lib/presentation/review/widgets/review_new_user_hint_line.dart",
        purpose: "新用户提示行组件",
        action: "create",
        estimatedLines: 80,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
        ],
      },
      {
        path: "lib/presentation/review/widgets/review_projects_section.dart",
        purpose: "项目列表区域组件",
        action: "create",
        estimatedLines: 150,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
        ],
      },
      {
        path: "lib/presentation/review/widgets/review_standalone_tasks_line.dart",
        purpose: "独立任务统计行组件",
        action: "create",
        estimatedLines: 100,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
        ],
      },
      {
        path: "lib/presentation/review/widgets/review_longest_task_section.dart",
        purpose: "最长任务区域组件（已完成和归档）",
        action: "create",
        estimatedLines: 250,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
          "lib/presentation/review/utils/review_time_formatter.dart",
        ],
        note: "包含任务信息、分析、子任务列表等",
      },
      {
        path: "lib/presentation/review/widgets/review_most_completed_day_line.dart",
        purpose: "完成根任务最多的一天行组件",
        action: "create",
        estimatedLines: 100,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
          "lib/presentation/review/utils/review_date_formatter.dart",
          "lib/presentation/review/utils/review_time_formatter.dart",
        ],
      },
      {
        path: "lib/presentation/review/widgets/review_closing_line.dart",
        purpose: "结束语行组件",
        action: "create",
        estimatedLines: 60,
        dependencies: [
          "lib/presentation/review/widgets/review_content_line.dart",
        ],
      },
    ],
    
    // Widget 组件 - 操作按钮
    widgets_actions: [
      {
        path: "lib/presentation/review/widgets/review_action_buttons.dart",
        purpose: "文章操作按钮组件（复制、导出）",
        action: "create",
        estimatedLines: 200,
        dependencies: [
          "lib/presentation/review/utils/review_text_generator.dart",
        ],
        note: "包含复制到剪贴板和导出文件功能",
      },
    ],
    
    // Widget 组件 - 状态显示
    widgets_states: [
      {
        path: "lib/presentation/review/widgets/review_loading_state.dart",
        purpose: "加载状态组件",
        action: "create",
        estimatedLines: 60,
        dependencies: [],
        note: "显示加载指示器，使用 CircularProgressIndicator 或 LinearProgressIndicator",
      },
      {
        path: "lib/presentation/review/widgets/review_error_state.dart",
        purpose: "错误状态组件",
        action: "create",
        estimatedLines: 80,
        dependencies: [
          "lib/presentation/widgets/error_banner.dart",
        ],
        note: "显示错误提示，使用 ErrorBanner 组件，支持重试功能",
      },
      {
        path: "lib/presentation/review/widgets/review_empty_state.dart",
        purpose: "空状态组件（可选）",
        action: "create",
        estimatedLines: 100,
        dependencies: [],
        note: "当用户没有任何数据时显示友好的空状态提示",
      },
    ],
    
    // 主页面
    pages: [
      {
        path: "lib/presentation/review/review_page.dart",
        purpose: "回顾页面主组件",
        action: "create",
        estimatedLines: 300,
        dependencies: [
          "所有上述组件文件",
          "lib/core/providers/review_providers.dart",
          "lib/presentation/widgets/gradient_page_scaffold.dart",
          "lib/presentation/widgets/error_banner.dart",
        ],
        note: "整合所有组件，管理页面布局和状态。使用 GradientPageScaffold 提供背景（背景图片 + 渐变叠加）",
      },
    ],
    
    // 测试文件
    tests: [
      {
        path: "test/core/services/review_data_service_test.dart",
        purpose: "回顾数据服务单元测试",
        action: "create",
        estimatedLines: 300,
        dependencies: [],
      },
      {
        path: "test/core/providers/review_providers_test.dart",
        purpose: "回顾页面状态管理单元测试",
        action: "create",
        estimatedLines: 200,
        dependencies: [],
      },
      {
        path: "test/presentation/review/utils/review_text_generator_test.dart",
        purpose: "文本生成工具函数单元测试",
        action: "create",
        estimatedLines: 150,
        dependencies: [],
      },
      {
        path: "test/presentation/review/widgets/review_opening_animation_test.dart",
        purpose: "开场动画组件 Widget 测试",
        action: "create",
        estimatedLines: 150,
        dependencies: [],
      },
      {
        path: "test/presentation/review/review_page_test.dart",
        purpose: "回顾页面 Widget 测试",
        action: "create",
        estimatedLines: 200,
        dependencies: [],
      },
      {
        path: "integration_test/review/review_page_integration_test.dart",
        purpose: "回顾页面集成测试",
        action: "create",
        estimatedLines: 300,
        dependencies: [],
        note: "测试完整的数据流和用户交互",
      },
    ],
  },

  // ===========================================
  // 3. 需要修改的现有文件
  // ===========================================
  modifications: [
    {
      file: "lib/presentation/navigation/app_router.dart",
      purpose: "将 /achievements 路由改为 /review，并更新页面引用",
      changes: [
        "将路由路径从 /achievements 改为 /review",
        "将路由名称从 'achievements' 改为 'review'",
        "将 builder 从 AchievementsPage 改为 ReviewPage",
        "更新导入语句",
      ],
      estimatedLines: 10,
      note: "导航栏已经更新为回顾，这里只需要更新路由配置",
    },
    {
      file: "lib/presentation/achievements/achievements_page.dart",
      purpose: "删除或重命名（如果不再需要）",
      changes: [
        "如果不再需要，删除整个文件",
        "或者重命名为 review_page.dart 并移动到 review 目录",
      ],
      estimatedLines: 0,
      note: "需要确认是否还有其他地方引用此页面",
    },
    {
      file: "lib/data/repositories/focus_session_repository.dart",
      purpose: "添加批量查询方法（优化性能）",
      changes: [
        "添加 totalMinutesForTasks(List<int> taskIds) 方法",
        "一次性查询多个任务的 FocusSession，避免 N+1 查询",
      ],
      estimatedLines: 30,
      note: "这是性能优化的关键，避免多次调用 totalMinutesForTask",
    },
    {
      file: "lib/l10n/app_zh_CN.arb",
      purpose: "添加回顾页面相关的本地化字符串",
      changes: [
        "添加所有回顾页面需要的本地化 key",
        "包括：欢迎语、统计信息、项目列表、任务信息、操作按钮等",
      ],
      estimatedLines: 50,
      note: "需要同时更新其他语言文件（zh_HK, zh, en）",
    },
    {
      file: "lib/l10n/app_zh_HK.arb",
      purpose: "添加回顾页面相关的本地化字符串（繁体中文）",
      changes: [
        "添加所有回顾页面需要的本地化 key（繁体中文）",
      ],
      estimatedLines: 50,
    },
    {
      file: "lib/l10n/app_zh.arb",
      purpose: "添加回顾页面相关的本地化字符串（繁体中文）",
      changes: [
        "添加所有回顾页面需要的本地化 key（繁体中文）",
      ],
      estimatedLines: 50,
    },
    {
      file: "lib/l10n/app_en.arb",
      purpose: "添加回顾页面相关的本地化字符串（英文）",
      changes: [
        "添加所有回顾页面需要的本地化 key（英文）",
      ],
      estimatedLines: 50,
    },
    {
      file: "pubspec.yaml",
      purpose: "添加文件分享依赖（用于导出功能）",
      changes: [
        "添加 share_plus 依赖（用于跨平台文件分享）",
        "确认 assets/images/ 已在 assets 配置中（背景图片）",
      ],
      estimatedLines: 5,
      note: "share_plus 支持 iOS ShareSheet、Android Share Intent 和 Desktop 文件保存对话框",
    },
  ],

  // ===========================================
  // 4. 实现步骤（按顺序）
  // ===========================================
  implementationSteps: [
    {
      step: 1,
      title: "准备阶段：本地化字符串和依赖检查",
      description: "添加本地化字符串，检查依赖",
      tasks: [
        {
          task: "添加文件分享依赖",
          file: "pubspec.yaml",
          action: "添加 share_plus 依赖到 dependencies",
          details: [
            "添加 share_plus: ^7.0.0（或最新版本）",
            "用于跨平台文件分享功能（iOS ShareSheet、Android Share Intent、Desktop 文件保存）",
          ],
        },
        {
          task: "确认背景图片资源已配置",
          file: "pubspec.yaml",
          action: "确认 assets/images/ 已在 assets 配置中",
          note: "背景图片（background.light.png 和 background.dark.png）应该已经配置",
        },
        {
          task: "添加本地化字符串",
          file: "lib/l10n/app_*.arb",
          action: "在所有语言文件中添加回顾页面需要的本地化 key",
          details: [
            "reviewWelcomeMessage: 欢迎您，今天是您使用本app的第{dayCount}天",
            "reviewStatsMessage: 现在，您拥有{projectCount}个项目，{taskCount}个任务",
            "reviewNewUserHint: 您刚刚使用我们的项目不久...",
            "reviewActiveProjectsCountMessage: 其中，正在进行中的项目有{activeProjectCount}个，分别是：",
            "reviewNoProjectsMessage: 您目前还没有创建项目",
            "reviewProjectItemFormat: {projectName}：包含{taskCount}个任务",
            "reviewStandaloneTasksMessage: 您目前有{totalCount}条单独任务...",
            "reviewLongestCompletedTaskMessage: {date}，您遇到了一个非常让您困扰的问题...",
            "reviewLongestCompletedTaskCompletionMessage: 最终，您认真分析和拆分任务...",
            "reviewNoLongCompletedTaskMessage: 恭喜您，您的工作一番风顺...",
            "reviewLongestArchivedTaskMessage: 您明智地决定放弃这个任务...",
            "reviewMostCompletedRootTasksDayMessage: {date}，你有如神助，完成了{taskCount}个任务...",
            "reviewClosingMessage: 今天又是新的一天，让我们继续努力，迎接美好的明天。",
            "reviewCopyButton: 复制文章",
            "reviewExportButton: 导出文章",
            "reviewCopiedMessage: 文章已复制到剪贴板",
            "reviewLabelDaily: 日报",
            "reviewLabelWeekly: 周报",
            "reviewLabelMonthly: 月报",
            "reviewLabelQuarterly: 季报",
            "reviewLabelYearly: 年报",
            "reviewLabelReview: 回顾",
          ],
        },
        {
          task: "运行 flutter pub get",
          command: "flutter pub get",
        },
        {
          task: "运行代码生成（如果需要）",
          command: "flutter pub run build_runner build --delete-conflicting-outputs",
        },
      ],
      estimatedTime: "1 hour",
    },
    
    {
      step: 2,
      title: "数据层：创建数据模型和优化仓库方法",
      description: "创建 ReviewData 模型，优化 FocusSessionRepository",
      tasks: [
        {
          task: "创建 ReviewData 模型",
          file: "lib/data/models/review_data.dart",
          action: "定义所有回顾页面需要的数据结构",
          details: [
            "ReviewData 主类：包含所有数据",
            "ReviewWelcomeData: 欢迎信息（dayCount）",
            "ReviewStatsData: 统计信息（projectCount, taskCount）",
            "ReviewProjectInfo: 项目信息（name, taskCount）",
            "ReviewStandaloneTasksData: 独立任务统计",
            "ReviewLongestTaskInfo: 最长任务信息（已完成和归档）",
            "ReviewMostCompletedDayInfo: 最多完成日信息",
          ],
        },
        {
          task: "优化 FocusSessionRepository",
          file: "lib/data/repositories/focus_session_repository.dart",
          action: "添加批量查询方法 totalMinutesForTasks",
          details: [
            "方法签名：Future<Map<int, int>> totalMinutesForTasks(List<int> taskIds)",
            "一次性查询所有任务的 FocusSession",
            "返回 Map<taskId, totalMinutes>",
            "避免 N+1 查询问题",
          ],
        },
      ],
      estimatedTime: "2 hours",
    },
    
    {
      step: 3,
      title: "服务层：创建 ReviewDataService",
      description: "实现所有数据查询逻辑",
      tasks: [
        {
          task: "创建 ReviewDataService",
          file: "lib/core/services/review_data_service.dart",
          action: "实现所有数据查询方法",
          methods: [
            "Future<ReviewData> loadAllReviewData() - 一次性加载所有数据",
            "Future<int> calculateDayCount() - 计算使用天数",
            "Future<ReviewStatsData> calculateStats() - 计算统计信息",
            "Future<List<ReviewProjectInfo>> getActiveProjects() - 获取活跃项目列表",
            "Future<ReviewStandaloneTasksData> getStandaloneTasks() - 获取独立任务统计",
            "Future<ReviewLongestTaskInfo?> findLongestCompletedTask() - 查找最长已完成任务",
            "Future<ReviewLongestTaskInfo?> findLongestArchivedTask() - 查找最长归档任务",
            "Future<ReviewMostCompletedDayInfo?> findMostCompletedDay() - 查找最多完成日",
          ],
          note: "所有查询都要正确过滤 trashed 状态和只统计根任务（parentId == null）",
        },
        {
          task: "添加 Provider",
          file: "lib/core/providers/service_providers.dart",
          action: "添加 reviewDataServiceProvider",
        },
      ],
      estimatedTime: "4 hours",
    },
    
    {
      step: 4,
      title: "工具函数：创建格式化工具",
      description: "创建日期、时间、文本格式化工具",
      tasks: [
        {
          task: "创建日期格式化工具",
          file: "lib/presentation/review/utils/review_date_formatter.dart",
          action: "实现日期格式化函数",
          functions: [
            "String formatReviewDate(DateTime date) - 格式化为 'x年x月x日'",
            "使用本地化支持",
          ],
        },
        {
          task: "创建时间格式化工具",
          file: "lib/presentation/review/utils/review_time_formatter.dart",
          action: "实现时间格式化函数",
          functions: [
            "String formatMinutes(int minutes) - 人性化显示分钟数",
            "String formatHours(double hours) - 格式化为 'X.X小时'（保留1位小数）",
            "处理边界情况（0分钟、小于60分钟等）",
          ],
        },
        {
          task: "创建文本生成工具",
          file: "lib/presentation/review/utils/review_text_generator.dart",
          action: "实现文章文本生成函数",
          functions: [
            "String generatePlainText(ReviewData data) - 生成纯文本格式",
            "String generateMarkdown(ReviewData data) - 生成 Markdown 格式",
            "处理所有行的拼接和格式化",
          ],
        },
      ],
      estimatedTime: "2 hours",
    },
    
    {
      step: 5,
      title: "状态管理：创建 ReviewProviders",
      description: "实现页面状态管理",
      tasks: [
        {
          task: "创建 ReviewProviders",
          file: "lib/core/providers/review_providers.dart",
          action: "实现状态管理",
          components: [
            "ReviewPageState 类（状态数据模型）",
            "ReviewPageNotifier 类（StateNotifier）",
            "reviewPageProvider（StateNotifierProvider）",
          ],
          state: {
            loading: "bool - 是否正在加载",
            data: "ReviewData? - 所有回顾数据",
            error: "String? - 错误信息",
            animationCompleted: "bool - 开场动画是否完成",
            contentDisplayIndex: "int - 当前显示到第几行",
            allContentDisplayed: "bool - 所有内容是否已显示",
          },
          methods: [
            "loadData() - 加载所有数据",
            "startAnimation() - 开始开场动画",
            "onAnimationComplete() - 动画完成回调",
            "displayNextLine() - 显示下一行内容",
          ],
        },
      ],
      estimatedTime: "2 hours",
    },
    
    {
      step: 6,
      title: "动画组件：实现开场动画",
      description: "实现标签展示与消失动画",
      tasks: [
        {
          task: "创建爆炸粒子绘制器",
          file: "lib/presentation/review/widgets/explosion_particle_painter.dart",
          action: "实现 CustomPainter 绘制粒子效果",
          details: [
            "粒子类：包含 position, velocity, size, color, opacity, lifetime",
            "粒子生成：从标签中心向四周随机方向",
            "粒子动画：位置更新、透明度变化、大小变化",
            "生命周期：0.5秒",
          ],
        },
        {
          task: "创建开场动画组件",
          file: "lib/presentation/review/widgets/review_opening_animation.dart",
          action: "实现完整的动画序列",
          details: [
            "初始状态：显示所有标签（日报、周报、月报、季报、年报、回顾）",
            "动画序列：",
            "  1. 初始展示1秒",
            "  2. 日报爆炸消失，其他标签向左滑动（0.5秒）",
            "  3. 周报爆炸消失，其他标签向左滑动（0.5秒）",
            "  4. 月报爆炸消失，其他标签向左滑动（0.5秒）",
            "  5. 季报爆炸消失，其他标签向左滑动（0.5秒）",
            "  6. 年报爆炸消失，回顾标签向左滑动（0.5秒）",
            "  7. 回顾标签切换到选中状态（0.3秒）",
            "使用 AnimationController 控制动画序列",
            "动画完成后触发回调",
          ],
        },
      ],
      estimatedTime: "4 hours",
    },
    
    {
      step: 7,
      title: "状态组件：实现加载、错误和空状态组件",
      description: "创建状态显示组件",
      tasks: [
        {
          task: "创建加载状态组件",
          file: "lib/presentation/review/widgets/review_loading_state.dart",
          action: "实现加载指示器组件",
          details: [
            "使用 CircularProgressIndicator 或 LinearProgressIndicator",
            "居中显示在页面中央",
            "可以显示加载提示文本（可选）",
          ],
        },
        {
          task: "创建错误状态组件",
          file: "lib/presentation/review/widgets/review_error_state.dart",
          action: "实现错误提示组件",
          details: [
            "使用 ErrorBanner 组件显示错误信息",
            "提供重试按钮（可选）",
            "错误信息要友好明确",
          ],
        },
        {
          task: "创建空状态组件（可选）",
          file: "lib/presentation/review/widgets/review_empty_state.dart",
          action: "实现空状态提示组件",
          details: [
            "当用户没有任何数据时显示",
            "友好的提示文本和图标",
            "引导用户开始使用应用",
          ],
        },
      ],
      estimatedTime: "1 hour",
    },
    
    {
      step: 8,
      title: "内容组件：实现基础内容行组件",
      description: "创建基础内容行组件和各个具体内容行组件",
      tasks: [
        {
          task: "创建基础内容行组件",
          file: "lib/presentation/review/widgets/review_content_line.dart",
          action: "实现支持淡入动画的基础组件",
          details: [
            "支持淡入动画（opacity 0 -> 1）",
            "无滑动效果（直接显示在最终位置）",
            "可配置样式（字体大小、字重、颜色、间距）",
            "使用 AnimatedOpacity 实现淡入效果",
          ],
        },
        {
          task: "创建各个具体内容行组件",
          files: [
            "lib/presentation/review/widgets/review_welcome_line.dart",
            "lib/presentation/review/widgets/review_stats_line.dart",
            "lib/presentation/review/widgets/review_new_user_hint_line.dart",
            "lib/presentation/review/widgets/review_standalone_tasks_line.dart",
            "lib/presentation/review/widgets/review_most_completed_day_line.dart",
            "lib/presentation/review/widgets/review_closing_line.dart",
          ],
          action: "实现各个内容行组件",
          note: "每个组件都基于 review_content_line.dart，传入相应的数据和样式",
        },
      ],
      estimatedTime: "3 hours",
    },
    
    {
      step: 9,
      title: "内容组件：实现复杂内容区域",
      description: "实现项目列表和最长任务区域",
      tasks: [
        {
          task: "创建项目列表组件",
          file: "lib/presentation/review/widgets/review_projects_section.dart",
          action: "实现项目列表显示",
          details: [
            "显示项目数量行",
            "循环显示每个项目（项目名称：包含X个任务）",
            "条件显示：只有当 projectCount > 0 && activeProjectCount > 0 时显示",
            "如果没有项目，显示 '您目前还没有创建项目'",
          ],
        },
        {
          task: "创建最长任务区域组件",
          file: "lib/presentation/review/widgets/review_longest_task_section.dart",
          action: "实现最长任务显示（已完成和归档）",
          details: [
            "已完成任务：",
            "  - 如果 longestCompletedTaskMinutes >= 120：显示任务信息、完成消息、任务分析、子任务列表",
            "  - 否则：显示 '恭喜您，您的工作一番风顺...'",
            "归档任务：",
            "  - 如果 longestArchivedTaskMinutes > 0：显示任务信息和归档消息",
            "条件显示逻辑要正确实现",
          ],
        },
      ],
      estimatedTime: "3 hours",
    },
    
    {
      step: 10,
      title: "操作按钮：实现复制和导出功能",
      description: "实现文章复制和导出功能",
      tasks: [
        {
          task: "创建操作按钮组件",
          file: "lib/presentation/review/widgets/review_action_buttons.dart",
          action: "实现复制和导出按钮",
          details: [
            "复制功能：",
            "  - 使用 Clipboard.setData 复制文章文本",
            "  - 显示 SnackBar 提示 '文章已复制到剪贴板'",
            "导出功能：",
            "  - 支持导出为 .txt 和 .md 格式",
            "  - 使用 share_plus 库实现跨平台文件分享（iOS ShareSheet, Android Share Intent, Desktop 文件保存对话框）",
            "  - 文件命名：回顾_YYYY-MM-DD.{extension}",
            "  - 使用 Share.shareXFiles 方法分享文件",
            "按钮样式：IconButton 或 FloatingActionButton",
            "显示时机：所有内容显示完成后延迟500ms显示",
          ],
        },
      ],
      estimatedTime: "2 hours",
    },
    
    {
      step: 11,
      title: "主页面：整合所有组件",
      description: "创建回顾页面主组件，整合所有功能",
      tasks: [
        {
          task: "创建回顾页面主组件",
          file: "lib/presentation/review/review_page.dart",
          action: "整合所有组件，实现完整页面",
          details: [
            "使用 ConsumerWidget 监听状态",
            "页面背景：",
            "  - 使用 GradientPageScaffold 组件",
            "  - 背景图片：background.light.png（浅色模式）或 background.dark.png（深色模式）",
            "  - 渐变叠加：使用 context.gradients.pageBackground（Ocean Breeze 主题渐变）",
            "  - 渐变透明度：0.6（与现有页面保持一致）",
            "页面结构：",
            "  1. 开场动画区域（顶部）",
            "  2. 内容区域（ScrollView，逐行显示）",
            "  3. 操作按钮（底部固定或浮动）",
            "状态管理：",
            "  - 页面加载时调用 loadData()",
            "  - 开场动画完成后开始逐行显示内容",
            "  - 所有内容显示完成后显示操作按钮",
            "错误处理：",
            "  - 使用 ErrorBanner 组件显示错误信息",
            "  - 提供重试按钮（可选）",
            "加载状态：",
            "  - 使用 CircularProgressIndicator 或 LinearProgressIndicator 显示加载指示器",
            "  - 在页面中央显示，或使用专门的加载状态组件",
            "空状态：",
            "  - 当用户没有任何数据时，显示友好的空状态提示",
            "  - 引导用户开始使用应用",
          ],
        },
        {
          task: "更新路由配置",
          file: "lib/presentation/navigation/app_router.dart",
          action: "将 /achievements 路由改为 /review",
          details: [
            "路径：/achievements -> /review",
            "名称：'achievements' -> 'review'",
            "页面：AchievementsPage -> ReviewPage",
          ],
        },
      ],
      estimatedTime: "3 hours",
    },
    
    {
      step: 12,
      title: "测试：编写单元测试和 Widget 测试",
      description: "为所有功能编写测试",
      tasks: [
        {
          task: "编写 ReviewDataService 单元测试",
          file: "test/core/services/review_data_service_test.dart",
          action: "测试所有数据查询逻辑",
          testCases: [
            "测试 calculateDayCount（有任务、无任务）",
            "测试 calculateStats（各种数据情况）",
            "测试 getActiveProjects（有项目、无项目）",
            "测试 getStandaloneTasks（各种状态统计）",
            "测试 findLongestCompletedTask（有任务、无任务、时间相同）",
            "测试 findLongestArchivedTask",
            "测试 findMostCompletedDay",
            "测试过滤逻辑（trashed、parentId == null）",
          ],
        },
        {
          task: "编写 ReviewProviders 单元测试",
          file: "test/core/providers/review_providers_test.dart",
          action: "测试状态管理逻辑",
          testCases: [
            "测试数据加载",
            "测试动画状态管理",
            "测试内容显示状态管理",
            "测试错误处理",
          ],
        },
        {
          task: "编写工具函数单元测试",
          file: "test/presentation/review/utils/review_text_generator_test.dart",
          action: "测试文本生成逻辑",
        },
        {
          task: "编写 Widget 测试",
          files: [
            "test/presentation/review/widgets/review_opening_animation_test.dart",
            "test/presentation/review/review_page_test.dart",
          ],
          action: "测试组件渲染和交互",
        },
      ],
      estimatedTime: "4 hours",
    },
    
    {
      step: 13,
      title: "集成测试和优化",
      description: "编写集成测试，进行性能优化",
      tasks: [
        {
          task: "编写集成测试",
          file: "integration_test/review/review_page_integration_test.dart",
          action: "测试完整的数据流和用户交互",
          testCases: [
            "测试页面加载和数据显示",
            "测试开场动画序列",
            "测试逐行内容显示",
            "测试复制功能",
            "测试导出功能",
            "测试各种数据边界情况",
          ],
        },
        {
          task: "性能优化",
          action: "检查和优化性能",
          items: [
            "检查数据查询性能（使用批量查询）",
            "优化动画性能（使用 RepaintBoundary）",
            "检查内存泄漏",
            "优化文本生成性能",
          ],
        },
        {
          task: "代码审查和重构",
          action: "代码质量检查",
          items: [
            "运行 flutter analyze",
            "检查代码覆盖率",
            "重构重复代码",
            "优化代码结构",
          ],
        },
      ],
      estimatedTime: "3 hours",
    },
  ],

  // ===========================================
  // 5. 技术细节和注意事项
  // ===========================================
  technicalDetails: {
    // 关键技术决策
    keyDecisions: {
      // 数据查询优化
      dataQueryOptimization: {
        decision: "使用批量查询避免 N+1 问题",
        reason: "需要计算多个任务的时间，逐个查询会导致性能问题",
        implementation: "在 FocusSessionRepository 中添加 totalMinutesForTasks 方法",
      },
      
      // 动画实现方案
      animationImplementation: {
        decision: "使用 CustomPainter 实现爆炸粒子效果",
        reason: "完全控制效果，性能可控，效果细腻",
        alternative: "动画库（Rive/Lottie）或 Widget 动画组合",
      },
      
      // 状态管理方案
      stateManagement: {
        decision: "使用 Riverpod StateNotifierProvider",
        reason: "与项目现有架构一致，便于测试和维护",
        implementation: "ReviewPageNotifier 管理所有页面状态",
      },
      
      // 文本生成方案
      textGeneration: {
        decision: "使用工具函数生成文本，支持纯文本和 Markdown",
        reason: "便于测试和维护，支持多种导出格式",
        implementation: "review_text_generator.dart",
      },
    },
    
    // 代码规范要求
    codeStandards: {
      // 颜色使用
      colorUsage: {
        rule: "所有颜色都必须从主题系统引用，禁止硬编码",
        location: "使用 Theme.of(context).colorScheme",
        example: "Theme.of(context).colorScheme.onSurface",
        forbidden: "Color(0xFF...) 或 '#...' 等硬编码",
      },
      
      // 本地化
      localization: {
        rule: "所有文本都必须使用本地化，禁止硬编码中文",
        location: "lib/l10n/app_*.arb",
        example: "l10n.reviewWelcomeMessage",
        forbidden: "硬编码的 '欢迎您' 等文本",
      },
      
      // 数据过滤
      dataFiltering: {
        rule: "所有数据查询都必须正确过滤 trashed 状态和只统计根任务",
        location: "ReviewDataService 中的所有查询方法",
        requirements: [
          "排除 status == TaskStatus.trashed 的任务和项目",
          "只统计 parentId == null 的根任务",
          "使用统一的过滤逻辑，避免重复代码",
        ],
      },
      
      // 条件显示
      conditionalDisplay: {
        rule: "严格按照设计文档中的条件显示逻辑实现",
        location: "各个内容行组件",
        requirements: [
          "新用户提示：projectCount <= 3 || taskCount <= 300 || dayCount <= 90",
          "项目列表：projectCount > 0 && activeProjectCount > 0",
          "最长已完成任务：longestCompletedTaskMinutes >= 120",
          "最长归档任务：longestArchivedTaskMinutes > 0",
          "最多完成日：mostCompletedRootTasksDate != null && mostCompletedRootTasksCount > 0",
        ],
      },
    },
    
    // 性能考虑
    performance: {
      optimization: [
        "使用批量查询避免 N+1 问题（totalMinutesForTasks）",
        "使用 RepaintBoundary 隔离动画区域",
        "限制粒子数量（8个）",
        "在开场动画期间预加载数据",
        "使用缓存机制（Riverpod 自动缓存）",
        "异步计算，避免阻塞 UI",
      ],
      
      // 数据查询性能
      dataQueryPerformance: {
        concern: "计算最长任务、最多完成日等需要遍历大量数据",
        solutions: [
          "使用数据库索引优化查询（createdAt, endedAt, status）",
          "批量查询 FocusSession，避免多次数据库访问",
          "在内存中计算聚合数据，而不是多次查询数据库",
        ],
      },
    },
    
    // 安全考虑
    security: {
      concerns: [
        "文件导出时确保文件名安全（避免路径遍历）",
        "剪贴板数据不包含敏感信息（只包含用户自己的数据）",
      ],
    },
    
    // 可访问性
    accessibility: {
      recommendations: [
        "为所有文本添加语义化标签（Semantics）",
        "确保动画不会影响屏幕阅读器",
        "考虑添加动画的开关选项（在系统设置中）",
        "为操作按钮添加语义化标签和提示",
        "确保所有交互元素都有适当的语义化描述",
      ],
      implementation: [
        "使用 Semantics 组件包装重要文本和交互元素",
        "为按钮添加 tooltip 和语义化标签",
        "确保屏幕阅读器可以正确读取所有内容",
        "为开场动画添加语义化标签，说明动画目的",
        "为内容行添加适当的语义化层级（heading、paragraph 等）",
      ],
    },
    
    // 响应式设计
    responsiveDesign: {
      recommendations: [
        "确保在不同屏幕尺寸下都能正常显示",
        "使用 Flexible 或 Expanded 处理文本溢出",
        "在小屏幕设备上优化间距和字体大小",
        "测试横屏和竖屏模式",
      ],
      implementation: [
        "使用 MediaQuery 获取屏幕尺寸",
        "根据屏幕宽度调整布局（如操作按钮的排列方式）",
        "确保内容在 ScrollView 中正确滚动",
        "在小屏幕设备上适当减小字体大小和间距",
        "操作按钮在小屏幕上可以垂直排列，大屏幕上水平排列",
      ],
    },
  },

  // ===========================================
  // 6. 依赖关系图
  // ===========================================
  dependencies: {
    // 数据层依赖
    dataLayer: [
      "lib/data/models/task.dart",
      "lib/data/models/project.dart",
      "lib/data/models/review_data.dart",
      "lib/data/repositories/task_repository.dart",
      "lib/data/repositories/project_repository.dart",
      "lib/data/repositories/focus_session_repository.dart",
    ],
    
    // 服务层依赖
    serviceLayer: [
      "lib/core/services/review_data_service.dart",
    ],
    
    // Provider 层依赖
    providerLayer: [
      "lib/core/providers/review_providers.dart",
    ],
    
    // UI 组件层依赖
    uiLayer: [
      "lib/presentation/review/widgets/*.dart",
      "lib/presentation/review/review_page.dart",
      "lib/presentation/widgets/modern_tag.dart",
      "lib/presentation/widgets/gradient_page_scaffold.dart",
      "lib/presentation/widgets/error_banner.dart",
    ],
    
    // 工具层依赖
    utilsLayer: [
      "lib/presentation/review/utils/*.dart",
    ],
    
    // 主题层依赖
    themeLayer: [
      "lib/core/theme/*.dart",
    ],
    
    // 外部依赖
    externalDependencies: [
      "share_plus - 文件分享功能（跨平台）",
      "flutter/services - Clipboard 剪贴板功能",
    ],
  },

  // ===========================================
  // 7. 测试策略和详细测试用例
  // ===========================================
  testing: {
    // 单元测试
    unitTests: [
      {
        file: "test/core/services/review_data_service_test.dart",
        description: "测试回顾数据服务的所有数据查询逻辑",
        testCases: [
          {
            group: "calculateDayCount",
            cases: [
              {
                name: "有任务时计算使用天数",
                test: "创建最早任务 → 调用 calculateDayCount → 验证返回正确的天数",
              },
              {
                name: "无任务时返回1天",
                test: "无任务 → 调用 calculateDayCount → 验证返回1",
              },
            ],
          },
          {
            group: "calculateStats",
            cases: [
              {
                name: "正确统计项目数和任务数",
                test: "创建项目和任务 → 调用 calculateStats → 验证统计正确（排除 trashed，只统计根任务）",
              },
              {
                name: "排除回收站和伪删除",
                test: "创建 trashed 任务 → 调用 calculateStats → 验证不统计 trashed 任务",
              },
              {
                name: "只统计根任务",
                test: "创建根任务和子任务 → 调用 calculateStats → 验证只统计根任务",
              },
            ],
          },
          {
            group: "getActiveProjects",
            cases: [
              {
                name: "正确获取活跃项目列表",
                test: "创建活跃项目 → 调用 getActiveProjects → 验证返回正确的项目列表",
              },
              {
                name: "排除回收站项目",
                test: "创建 trashed 项目 → 调用 getActiveProjects → 验证不包含 trashed 项目",
              },
              {
                name: "只包含 pending 和 doing 状态的项目",
                test: "创建不同状态的项目 → 调用 getActiveProjects → 验证只返回 pending 和 doing 状态的项目",
              },
            ],
          },
          {
            group: "findLongestCompletedTask",
            cases: [
              {
                name: "找到执行时间最长的已完成任务",
                test: "创建多个已完成任务，设置不同的 FocusSession 时间 → 调用 findLongestCompletedTask → 验证返回时间最长的任务",
              },
              {
                name: "时间相同时选择创建时间最早的",
                test: "创建多个时间相同的已完成任务 → 调用 findLongestCompletedTask → 验证返回创建时间最早的任务",
              },
              {
                name: "无已完成任务时返回 null",
                test: "无已完成任务 → 调用 findLongestCompletedTask → 验证返回 null",
              },
            ],
          },
          {
            group: "findMostCompletedDay",
            cases: [
              {
                name: "找到完成根任务最多的一天",
                test: "在不同日期完成多个根任务 → 调用 findMostCompletedDay → 验证返回任务数最多的日期",
              },
              {
                name: "任务数相同时选择总时间最长的日期",
                test: "在不同日期完成相同数量的根任务 → 调用 findMostCompletedDay → 验证返回总时间最长的日期",
              },
              {
                name: "只统计根任务，不统计子任务",
                test: "完成根任务和子任务 → 调用 findMostCompletedDay → 验证只统计根任务",
              },
            ],
          },
        ],
      },
      {
        file: "test/core/providers/review_providers_test.dart",
        description: "测试回顾页面状态管理",
        testCases: [
          {
            group: "数据加载",
            cases: [
              {
                name: "成功加载数据",
                test: "调用 loadData → 验证状态变为 loaded，data 不为 null",
              },
              {
                name: "加载失败时设置错误状态",
                test: "模拟加载失败 → 调用 loadData → 验证 error 不为 null",
              },
            ],
          },
          {
            group: "动画状态",
            cases: [
              {
                name: "动画完成后更新状态",
                test: "调用 onAnimationComplete → 验证 animationCompleted 为 true",
              },
            ],
          },
          {
            group: "内容显示",
            cases: [
              {
                name: "逐行显示内容",
                test: "调用 displayNextLine → 验证 contentDisplayIndex 递增",
              },
              {
                name: "所有内容显示完成后更新状态",
                test: "显示所有行 → 验证 allContentDisplayed 为 true",
              },
            ],
          },
        ],
      },
      {
        file: "test/presentation/review/utils/review_text_generator_test.dart",
        description: "测试文本生成工具函数",
        testCases: [
          {
            group: "generatePlainText",
            cases: [
              {
                name: "生成完整的纯文本文章",
                test: "传入 ReviewData → 调用 generatePlainText → 验证生成正确的文本格式",
              },
              {
                name: "正确处理所有行的拼接",
                test: "传入包含多行的 ReviewData → 调用 generatePlainText → 验证行之间使用换行符分隔",
              },
            ],
          },
          {
            group: "generateMarkdown",
            cases: [
              {
                name: "生成 Markdown 格式文章",
                test: "传入 ReviewData → 调用 generateMarkdown → 验证生成正确的 Markdown 格式",
              },
            ],
          },
        ],
      },
    ],
    
    // Widget 测试
    widgetTests: [
      {
        file: "test/presentation/review/widgets/review_opening_animation_test.dart",
        description: "测试开场动画组件",
        testCases: [
          {
            group: "动画序列",
            cases: [
              {
                name: "初始状态显示所有标签",
                test: "渲染组件 → 验证所有标签都显示",
              },
              {
                name: "标签依次消失",
                test: "等待动画 → 验证标签按顺序消失",
              },
              {
                name: "最终只保留回顾标签",
                test: "等待动画完成 → 验证只有回顾标签显示且为选中状态",
              },
            ],
          },
        ],
      },
      {
        file: "test/presentation/review/review_page_test.dart",
        description: "测试回顾页面主组件",
        testCases: [
          {
            group: "页面渲染",
            cases: [
              {
                name: "加载状态显示加载指示器",
                test: "状态为 loading → 渲染页面 → 验证显示 CircularProgressIndicator",
              },
              {
                name: "错误状态显示错误提示",
                test: "状态为 error → 渲染页面 → 验证显示错误信息",
              },
              {
                name: "数据加载成功后显示内容",
                test: "状态为 loaded → 渲染页面 → 验证显示内容区域",
              },
            ],
          },
          {
            group: "内容显示",
            cases: [
              {
                name: "逐行显示内容",
                test: "数据加载完成 → 等待动画完成 → 验证内容逐行淡入显示",
              },
              {
                name: "条件显示逻辑正确",
                test: "不同数据情况 → 渲染页面 → 验证条件显示逻辑正确",
              },
            ],
          },
          {
            group: "操作按钮",
            cases: [
              {
                name: "所有内容显示完成后显示操作按钮",
                test: "所有内容显示完成 → 等待延迟 → 验证显示操作按钮",
              },
              {
                name: "点击复制按钮复制文章",
                test: "点击复制按钮 → 验证 Clipboard.setData 被调用 → 验证显示 SnackBar",
              },
            ],
          },
        ],
      },
    ],
    
    // 集成测试
    integrationTests: [
      {
        file: "integration_test/review/review_page_integration_test.dart",
        description: "测试完整的数据流和用户交互",
        testCases: [
          {
            group: "完整流程",
            cases: [
              {
                name: "页面加载到内容显示完整流程",
                test: "打开页面 → 验证开场动画播放 → 验证数据加载 → 验证内容逐行显示 → 验证操作按钮显示",
              },
              {
                name: "复制功能完整流程",
                test: "等待所有内容显示 → 点击复制按钮 → 验证文章复制到剪贴板 → 验证显示提示",
              },
              {
                name: "导出功能完整流程",
                test: "等待所有内容显示 → 点击导出按钮 → 验证文件分享对话框显示",
              },
            ],
          },
          {
            group: "边界情况",
            cases: [
              {
                name: "无任务无项目时的显示",
                test: "清空所有数据 → 打开页面 → 验证显示正确的空状态提示",
              },
              {
                name: "新用户提示显示",
                test: "创建少量任务和项目 → 打开页面 → 验证显示新用户提示",
              },
              {
                name: "无最长已完成任务时的显示",
                test: "创建已完成任务但时间都小于2小时 → 打开页面 → 验证显示 '恭喜您，您的工作一番风顺...'",
              },
            ],
          },
        ],
      },
    ],
  },

  // ===========================================
  // 8. 风险点和注意事项
  // ===========================================
  risks: [
    {
      risk: "数据查询性能问题（N+1 查询）",
      mitigation: "使用批量查询方法 totalMinutesForTasks，避免多次调用 totalMinutesForTask",
      priority: "high",
      check: "检查代码中是否有循环调用 totalMinutesForTask 的情况",
      enforcement: "代码审查时强制要求使用批量查询方法",
    },
    {
      risk: "数据过滤逻辑不一致",
      mitigation: "在 ReviewDataService 中统一封装过滤逻辑，所有查询都使用相同的过滤条件",
      priority: "high",
      check: "检查所有查询方法是否正确过滤 trashed 状态和只统计根任务",
      enforcement: "编写测试用例验证过滤逻辑",
    },
    {
      risk: "动画性能问题（低端设备）",
      mitigation: "使用 RepaintBoundary 隔离动画区域，限制粒子数量，考虑在低端设备上简化动画",
      priority: "medium",
      check: "在低端设备上测试动画性能",
      enforcement: "性能测试时检查帧率",
    },
    {
      risk: "条件显示逻辑错误",
      mitigation: "严格按照设计文档实现条件显示逻辑，编写测试用例验证",
      priority: "high",
      check: "测试各种数据组合情况，验证条件显示逻辑正确",
      enforcement: "编写完整的测试用例覆盖所有条件分支",
    },
    {
      risk: "本地化字符串缺失",
      mitigation: "在实现前先添加所有本地化字符串，使用 l10n 生成器验证",
      priority: "medium",
      check: "运行 flutter pub get 后检查是否有本地化错误",
      enforcement: "代码审查时检查所有文本是否使用本地化",
    },
    {
      risk: "文件导出功能在不同平台上的兼容性",
      mitigation: "使用 Flutter 的 share_plus 库，确保跨平台兼容",
      priority: "medium",
      check: "在 iOS、Android、Desktop 平台上测试导出功能",
      enforcement: "集成测试覆盖所有平台",
    },
    {
      risk: "页面背景图片资源缺失或加载失败",
      mitigation: "确认背景图片资源已正确配置在 pubspec.yaml 中，添加资源加载错误处理",
      priority: "low",
      check: "检查 assets/images/ 目录下是否有背景图片文件",
      enforcement: "在代码中添加资源加载错误处理",
    },
    {
      risk: "响应式设计在不同设备上显示异常",
      mitigation: "使用 MediaQuery 和 Flexible/Expanded 处理不同屏幕尺寸，测试多种设备",
      priority: "medium",
      check: "在不同屏幕尺寸的设备上测试页面显示",
      enforcement: "响应式设计测试用例",
    },
  ],

  // ===========================================
  // 9. 验证清单
  // ===========================================
  verification: {
    // 代码质量检查
    codeQuality: [
      "运行 flutter analyze 确保无错误和警告",
      "检查代码覆盖率（目标 ≥80%）",
      "代码审查：检查代码规范、架构设计、性能优化",
      "检查所有颜色使用是否从主题系统引用",
      "检查所有文本是否使用本地化",
    ],
    
    // 功能验证
    functionality: [
      "验证开场动画完整播放（所有标签依次消失）",
      "验证数据加载和显示（所有行都正确显示）",
      "验证条件显示逻辑（各种数据组合情况）",
      "验证复制功能（文章正确复制到剪贴板）",
      "验证导出功能（文件正确生成和分享）",
      "验证边界情况处理（无数据、新用户、无最长任务等）",
      "验证错误处理（数据加载失败、文件导出失败等）",
    ],
    
    // 性能验证
    performance: [
      "验证页面加载时间（目标 < 2秒）",
      "验证数据查询性能（使用批量查询，避免 N+1）",
      "验证动画性能（60fps，无明显卡顿）",
      "检查内存使用（无内存泄漏）",
      "在低端设备上测试性能",
    ],
    
    // 兼容性验证
    compatibility: [
      "测试不同屏幕尺寸（手机、平板）",
      "测试不同系统版本（iOS、Android）",
      "测试不同语言环境（中文简体、繁体、英文）",
      "测试深色模式和浅色模式",
      "测试文件导出在不同平台上的兼容性",
      "测试横屏和竖屏模式",
      "测试背景图片在不同设备上的显示效果",
    ],
    
    // 用户体验验证
    userExperience: [
      "验证动画流畅自然",
      "验证内容显示节奏合适（不会太快或太慢）",
      "验证错误提示友好明确",
      "验证加载状态清晰可见",
      "验证操作反馈及时（复制、导出成功提示）",
    ],
  },
}

