{
  iteration: {
    id: "251110-data-light-db-abstraction",
    title: "数据库轻度抽象与种子导入诊断",
    description: "补全 DatabaseAdapter/ObjectBoxAdapter 封装，针对种子导入任务不可见问题建立统一日志、查询与测试框架，确保导入后的任务可正确展示。",
    status: "planning",
    estimatedTime: "5 days",
    priority: "high",
    basedOnDesign: null,
  },

  files: {
    dataAdapters: [
      {
        path: "lib/data/database/database_adapter.dart",
        purpose: "扩展抽象接口，新增 CRUD、批量写入、计数与结构化错误上下文能力。",
        action: "modify",
        estimatedLines: 80,
        dependencies: [
          "lib/data/database/objectbox_adapter.dart",
          "lib/data/database/query_builder.dart",
        ],
        details: [
          "接口：新增 put/putMany/remove/findById/findAll/count/watchList 等抽象方法，保持 read/writeTransaction 签名不变。",
          "错误上下文：为 DatabaseAdapterException 引入 DatabaseOperationContext（operation、entity、parameters、duration）。",
          "Instrumentation：在接口中预留可选 DatabaseInstrumentation，回调 before/after/failed 钩子。",
          "契约说明：在文档注释中明确事务语义、watchList 的触发规则、count 的一致性要求。",
          "向后兼容：保留旧方法，逐步标记为 @Deprecated 或在实现层转委托新接口。"
        ]
      },
      {
        path: "lib/data/database/objectbox_adapter.dart",
        purpose: "根据官方推荐实践补全事务、QueryBuilder 映射、watchList、批量操作与日志记录。",
        action: "modify",
        estimatedLines: 220,
        dependencies: [
          "lib/data/objectbox/task_entity.dart",
          "lib/data/database/objectbox_query_builder.dart"
        ],
        details: [
          "事务：使用 Store.runInTransaction/Store.runAsync 包装 read/writeTransaction，保证 ObjectBox 原生事务语义。",
          "CRUD：实现 put、putMany、remove、findById、count 等接口；在导入批量写入时走 box.putMany。",
          "监听：基于 box.query(condition).watch(triggerImmediately: true) 实现 watchList，支持节流与停止逻辑。",
          "查询映射：将 DatabaseQueryBuilder 生成的 QueryDescriptor 转换为 ObjectBox Condition，复用扩展后的 DSL。",
          "错误处理：捕获 ObjectBoxException/ObjectBoxError，封装为 DatabaseAdapterException，附带 DatabaseOperationContext。",
          "Instrumentation：注入 DatabaseInstrumentation，记录操作名称、耗时、影响行数，日志落到 lib/core/utils/objectbox_diagnostics.dart。"
        ],
        note: "所有新增方法需要覆盖契约测试，并同步更新 objectbox_adapter_test。"
      },
      {
        path: "lib/data/database/objectbox_query_builder.dart",
        purpose: "改用 ObjectBox 原生 QueryBuilder，支持条件组合、排序、分页以及 describe() 调试输出。",
        action: "modify",
        estimatedLines: 180,
        dependencies: [
          "lib/data/database/query_builder.dart"
        ],
        details: [
          "DSL 映射：支持 FieldCondition/QueryDescriptor，将 filter/sort/limit/offset 转换为 ObjectBox Condition。",
          "排序分页：使用 query.order(property, flags) + offset/limit 实现，兼容升序/降序及多字段排序。",
          "描述输出：提供 describe()/explain() 返回结构化描述（字段、操作、值），用于日志与调试。",
          "缓存策略：避免每次执行时 getAll，改为 query.find()/findFirst()，提升性能。",
          "错误处理：当字段未映射时抛出 DatabaseAdapterException，并在日志输出可识别信息。",
          "测试：扩展对象字段覆盖的单测，确保所有常用字段（任务、项目、标签等）可生成 Condition。"
        ]
      }
    ],
    repositories: [
      {
        path: "lib/data/repositories/base_objectbox_repository.dart",
        purpose: "集中实现通用实体转换、日志、错误处理，供具体仓储继承。",
        action: "create",
        estimatedLines: 150,
        dependencies: [
          "lib/data/database/database_adapter.dart"
        ],
        details: [
          "提供 toEntity()/toModel() 模板方法，子类实现字段映射。",
          "封装常用操作：protected putEntity、findEntity、ensureExists、mapStream 等，统一调用 DatabaseAdapter。",
          "集成 DatabaseInstrumentation：在操作前后调用 instrumentation 钩子，记录仓储名称/方法。",
          "错误包装：捕获 adapter 异常，添加仓储上下文后再抛出。",
          "便捷方法：实现 withRead/withWrite 帮助函数，简化事务调用。"
        ]
      },
      {
        path: "lib/data/repositories/objectbox/objectbox_task_repository.dart",
        purpose: "依赖新的抽象接口补全 list/watch/find 关键方法，支持种子导入后任务展示。",
        action: "modify",
        estimatedLines: 240,
        dependencies: [
          "lib/data/database/objectbox_adapter.dart",
          "lib/data/objectbox/task_entity.dart",
          "lib/data/models/task.dart"
        ],
        details: [
          "查询：实现 listAll、listRoots、listChildren、listSectionTasks，支持分页与排序。",
          "监听：补全 watchInbox、watchSection、watchTasksByProjectId、watchTasksByMilestoneId、watchTaskById。",
          "查找：实现 findById、findByTaskId、findBySlug，并统一使用 QueryBuilder 描述。",
          "状态操作：完善 archiveTask、markStatus、moveTask、clearAllTrashedTasks 等写操作。",
          "导入支持：确保 createTaskWithId、batchUpdate、upsertTasks 逻辑健全，处理日志与关系字段。",
          "调试：在关键路径输出 describe()/instrumentation 信息，方便定位缺失任务原因。",
          "清理：移除 UnimplementedError，若暂无法实现，提供 TODO with issue reference。"
        ]
      },
      {
        path: "lib/core/services/seed_import_service.dart",
        purpose: "接入新的仓储/适配器能力，增强导入后校验与日志，便于定位任务缺失根因。",
        action: "modify",
        estimatedLines: 120,
        dependencies: [
          "lib/data/repositories/task_repository.dart",
          "lib/data/repositories/project_repository.dart"
        ],
        details: [
          "导入前核查：在导入前记录任务/项目数量、版本信息，调用 describe() 输出查询条件。",
          "导入执行：使用新的批量 API（putMany）、事务包装，确保失败回滚。",
          "导入后校验：验证导入数量与种子期望一致，若不一致输出结构化警告并触发重试/回滚。",
          "日志：使用 objectbox_diagnostics 记录每个阶段耗时及受影响实体数。",
          "错误处理：捕获 DatabaseAdapterException，补充 locale/version 信息，提高可观测性。"
        ]
      }
    ],
    diagnostics: [
      {
        path: "lib/core/utils/objectbox_diagnostics.dart",
        purpose: "封装 instrumentation hook、计时器、结构化日志输出。",
        action: "create",
        estimatedLines: 100,
        dependencies: [
          "lib/data/database/database_adapter.dart"
        ],
        details: [
          "定义 DatabaseInstrumentation 接口，提供 onStart/onSuccess/onError 钩子，统一记录操作上下文。",
          "实现 DefaultDatabaseInstrumentation，将日志输出为 JSON Map（operation/entity/count/duration/extra）。",
          "提供 DatabaseOpTimer 帮助类，封装 Stopwatch 与慢查询阈值设定。",
          "支持注入自定义 sink（如 Sentry/Crashlytics）；默认实现通过 debugPrint 输出。",
          "准备 FakeInstrumentation，便于单测断言回调次数和参数。"
        ]
      }
    ],
    tests: [
      {
        path: "test/data/database/objectbox_adapter_test.dart",
        purpose: "验证事务、watchList、错误上下文与 describe() 输出。",
        action: "create",
        estimatedLines: 160,
        dependencies: [
          "lib/data/database/objectbox_adapter.dart",
          "lib/data/database/objectbox_query_builder.dart"
        ],
        details: [
          "writeTransaction：mock Store.runInTransaction，验证回调执行顺序与异常回滚。",
          "watchList：模拟 query.watch，断言 triggerImmediately=true 首次推送及之后的去重逻辑。",
          "错误封装：制造 ObjectBoxException，确认 DatabaseAdapterException 包含 DatabaseOperationContext。",
          "Instrumentation：使用 FakeInstrumentation 验证 onStart/onSuccess/onError 调用与参数。",
          "describe：确认 QueryDescriptor.describe() 内容写入日志并与预期一致。"
        ]
      },
      {
        path: "test/data/database/inmemory_adapter_test.dart",
        purpose: "通过轻量实现校验 DatabaseAdapter 契约，确保后端可替换性。",
        action: "create",
        estimatedLines: 150,
        dependencies: [
          "test/support/in_memory_database_adapter.dart",
          "lib/data/database/query_builder.dart"
        ],
        details: [
          "契约共享：AdapterContractTest 针对 CRUD/事务/监听执行，与 ObjectBoxAdapter 结果一致。",
          "并发：验证 writeTransaction 队列化执行，冲突时仍能保证顺序。",
          "查询：测试 QueryDescriptor 在 InMemoryAdapter 中的 filter/sort/limit/offset 行为。",
          "日志：确认 instrumentation 回调被触发并记录正确的 entity/count。",
          "回归：对比 ObjectBoxAdapter 输出，确保 describe/instrumentation 格式一致。"
        ],
        note: "与 ObjectBoxAdapter 共用一套契约测试基类。"
      },
      {
        path: "test/data/repositories/objectbox_task_repository_test.dart",
        purpose: "使用 mock adapter 验证 listAll、watchInbox、findBySlug 等方法行为及错误抛出。",
        action: "create",
        estimatedLines: 180,
        dependencies: [
          "lib/data/repositories/objectbox/objectbox_task_repository.dart"
        ],
        details: [
          "列表：mock adapter 返回实体，断言 Task 转换结果、排序与分页。",
          "监听：模拟 watchList 推送多个快照，验证仓储过滤、节流、排序逻辑。",
          "错误：当 adapter 抛 DatabaseAdapterException 时，仓储应追加 context 并 rethrow。",
          "导入：验证 batchUpdate/upsertTasks 对 slugToId、projectId、milestoneId 的处理。",
          "跨实现：在 InMemoryAdapter 上复用测试，确保行为一致。"
        ]
      },
      {
        path: "integration_test/seed_import_visibility_test.dart",
        purpose: "真实环境执行种子导入，验证导入计数、任务列表可见、watch 流触发。",
        action: "create",
        estimatedLines: 220,
        dependencies: [
          "lib/core/services/seed_import_service.dart",
          "lib/data/repositories/objectbox/objectbox_task_repository.dart"
        ],
        details: [
          "全新导入：重置数据库 → 执行 importIfNeeded → 验证任务数量、UI 展示。",
          "缺失修复：手动删除部分任务 → 再次导入 → 确认补齐并记录 instrumentation 日志。",
          "失败回滚：模拟写入异常，确认数据回滚且产生错误提示。",
          "日志校验：解析 describe()/instrumentation 输出，确保包含 QueryDescriptor 与耗时。",
          "watch 验证：监听 watchInbox 流，确保导入后推送一次最新任务列表。"
        ]
      }
    ],
    support: [
      {
        path: "test/support/in_memory_database_adapter.dart",
        purpose: "提供轻量内存版适配器，验证抽象充分性并为未来 Drift 实现打样。",
        action: "create",
        estimatedLines: 140,
        dependencies: [
          "lib/data/database/database_adapter.dart",
          "lib/data/database/query_builder.dart"
        ],
        details: [
          "存储结构：按类型维护 Map<String, Map<String, dynamic>>，支持基本 CRUD 操作。",
          "事务模拟：使用同步锁/队列保证 writeTransaction 顺序执行，可注入故障点。",
          "查询执行：解析 QueryDescriptor，支持常用比较、排序、分页。",
          "watch 实现：通过 StreamController 推送变更，支持 triggerImmediately 与取消订阅。",
          "诊断输出：模拟 instrumentation 回调，记录操作上下文以便对照 ObjectBoxAdapter。"
        ],
        note: "仅用于单元测试与实验环境，不参与生产构建。"
      }
    ],
    documentation: [
      {
        path: "documents/spec/251025-种子导入/02_acceptance_tests.md",
        purpose: "补充导入后任务展示的验收场景与回归步骤。",
        action: "modify",
        estimatedLines: 40,
        dependencies: [],
        details: [
          "新增场景：首启导入、缺失数据重导、导入失败回滚、重复导入幂等验证、不同语言种子校验。",
          "步骤说明：记录环境准备、执行命令、应观察的日志与 UI 结果。",
          "指标：明确成功判定（任务数量、导入耗时、日志字段完整性）。",
          "回归：列出需执行的自动化测试脚本与截图/录像要求。"
        ],
        note: "对齐新的日志与验证流程。"
      },
      {
        path: "documents/project/refactor_rules.yaml",
        purpose: "记录数据层抽象约束、日志要求与测试准则。",
        action: "modify",
        estimatedLines: 30,
        dependencies: [],
        details: [
          "抽象约束：禁止业务层直接访问 Store/Box，所有调用经 Repository/Service。",
          "适配器要求：新增实现需通过 AdapterContractTest，并在 PR 中附带结果。",
          "日志规范：所有数据层写操作必须走 instrumentation，记录 operation/entity/count/duration。",
          "迁移策略：保留 DatabaseAdapter 接口稳定性，禁止嵌入 ObjectBox 特定类型。"
        ]
      }
    ]
  },

  modifications: [
    {
      file: "lib/data/repositories/task_repository.dart",
      purpose: "确保接口覆盖新的抽象能力，标注哪些方法有默认实现或已弃用。",
      changes: [
        "新增文档注释与使用约束",
        "确认所有方法均有实现计划或替代方案"
      ],
      estimatedLines: 40,
      details: [
        "补充方法注释：说明返回的 Stream/Future 行为、排序规则、分页参数。",
        "标记未实现接口的默认行为或迁移计划，避免上层调用 Unimplemented 方法。",
        "新增契约说明：强调所有实现必须通过 AdapterContractTest。",
        "根据新的抽象接口添加必要的 default implementation 或 TODO。"
      ]
    },
    {
      file: "lib/data/database/query_builder.dart",
      purpose: "适配新的 ObjectBoxQueryBuilder，扩展谓词与排序枚举。",
      changes: [
        "新增条件类型定义",
        "扩展比较器/过滤器签名"
      ],
      estimatedLines: 60,
      details: [
        "定义 FieldDescriptor、OrderDescriptor、CompositeCondition 等结构。",
        "支持 equals、notEquals、greaterThan、lessThan、between、contains、startsWith 等操作。",
        "提供 QueryDescriptor.describe() / toJson() 方法，便于日志与测试。",
        "为 InMemoryAdapter 与未来 DriftAdapter 提供统一的 DSL 解析入口。"
      ]
    },
    {
      file: "documents/spec/iteration_template.yaml",
      purpose: "如需在 YAML 迭代模板中同步新的抽象说明，保持 JSON5 与 YAML 一致。",
      changes: [
        "新增数据层抽象步骤条目"
      ],
      estimatedLines: 10,
      details: [
        "在模板中增加数据层抽象/仓储改造的示例字段与描述。",
        "同步 instrumentation、契约测试等注意事项。",
        "提示在文档中列出当前阶段与迁移阶段任务的区分。"
      ],
      note: "仅在需要时执行。"
    }
  ],

  implementationSteps: [
    {
      step: 1,
      title: "现状审计与基线验证",
      description: "梳理当前 ObjectBox 调用点、导入流程日志与测试缺口，建立失败复现基线。",
      tasks: [
        {
          task: "全量搜寻直接使用 Store/Box 的代码，记录迁移清单。",
          file: "lib/",
          action: "grep \"Store\" & \"Box\" 引用，生成列表",
          details: [
            "应用入口：`lib/main.dart` 中 `_openObjectBoxStore` 与 `store` 初始化需要改为通过 DatabaseAdapter 提供的工厂方法。",
            "适配器层：`lib/data/database/objectbox_adapter.dart::_box` 当前直接返回 `store.box<E>()`，后续迁移至统一 CRUD 接口。",
            "仓储层：以下文件直接调用 `store.box` 或持有 `Box<T>`，需替换为 BaseRepository + DatabaseAdapter 封装：",
            "  - `lib/data/repositories/objectbox/objectbox_task_repository.dart`（任务与日志 Box）",
            "  - `lib/data/repositories/objectbox/objectbox_task_template_repository.dart`",
            "  - `lib/data/repositories/objectbox/objectbox_milestone_repository.dart`",
            "  - `lib/data/repositories/objectbox/objectbox_focus_session_repository.dart`",
            "  - `lib/data/repositories/objectbox/objectbox_project_repository.dart`（含 ProjectLog）",
            "  - `lib/data/repositories/objectbox/objectbox_seed_repository.dart`",
            "  - `lib/data/repositories/objectbox/objectbox_tag_repository.dart`",
            "  - `lib/data/repositories/objectbox/objectbox_preference_repository.dart`",
            "查询构建：`lib/data/database/objectbox_query_builder.dart` 仍通过 `Box.getAll()` 过滤，需要列入迁移任务。"
          ]
        },
        {
          task: "执行现有种子导入流程，收集任务缺失的日志与数据库快照。",
          command: "flutter test integration_test/seed_import_existing_test.dart",
          note: "若测试不存在则记录手动步骤。"
        },
        {
          task: "梳理 ObjectBoxQueryBuilder 现有限制，提出扩展需求列表。",
          file: "lib/data/database/objectbox_query_builder.dart"
        }
      ],
      estimatedTime: "0.5 days"
    },
    {
      step: 2,
      title: "补全 DatabaseAdapter 与 QueryBuilder",
      description: "根据官方实践补足事务、CRUD、watch 能力，引入 describe 与 instrumentation。",
      tasks: [
        {
          task: "扩展 DatabaseAdapter 接口，补充 CRUD 与计数抽象。",
          file: "lib/data/database/database_adapter.dart"
        },
        {
          task: "重写 ObjectBoxAdapter，利用 store.runInTransaction 与 query().watch()。",
          file: "lib/data/database/objectbox_adapter.dart",
          note: "所有操作记录 DatabaseOperationContext 日志。"
        },
        {
          task: "实现新的 ObjectBoxQueryBuilder，将谓词映射到 Condition。",
          file: "lib/data/database/objectbox_query_builder.dart",
          action: "新增 describe()、explain() 帮助调试"
        }
      ],
      estimatedTime: "1.5 days"
    },
    {
      step: 3,
      title: "仓储基类与任务仓储改造",
      description: "建立 BaseObjectBoxRepository，先解决任务仓储关键方法，确保导入后可见。",
      tasks: [
        {
          task: "创建 BaseObjectBoxRepository，封装实体转换与日志。",
          file: "lib/data/repositories/base_objectbox_repository.dart",
          details: [
            "集中管理依赖：统一注入 DatabaseAdapter 与 DatabaseInstrumentation，并在构造函数中校验必需参数。",
            "封装事务：提供 withRead/withWrite helper，内部调用 adapter.readTransaction/writeTransaction 并处理异常。",
            "转换模板：定义 toEntity/toDomain、mapEntities 等模板方法，子类实现字段映射即可。",
            "公共工具：将当前各仓储的 `_findById`、日志加载等通用逻辑迁移到基类或 mixin。",
            "日志包装：helper 自动构建 DatabaseOperationContext（repository、method、ids/count），统一调用 instrumentation。"
          ]
        },
        {
          task: "实现 taskRepository 的 listAll、watchInbox、watchSection、findBySlug、listRoots、listChildren。",
          file: "lib/data/repositories/objectbox/objectbox_task_repository.dart",
          note: "确保查询使用新的 QueryBuilder，并添加 describe 输出。",
          details: [
            "替换 `Stream.periodic` 轮询方案，改用 DatabaseAdapter.watchList 与 QueryDescriptor 映射。",
            "移除 `_taskBox`、`_taskLogBox`、`_findById` 等直接依赖 Box 的方法，改为 BaseRepository helper + adapter CRUD。",
            "补齐历史上抛出 Unimplemented 的方法（watchInbox/watchSection/watchQuickTasks/watchMilestones/watchTasksByProjectId/watchTasksByMilestoneId/watchTaskById/watchTaskTree）。",
            "在 create/update/adjustTemplateLock/batchUpdate/upsert 等写操作中调用 adapter.put/putMany，并记录 instrumentation。",
            "导入相关逻辑输出 QueryDescriptor.describe() 与 DatabaseOperationContext，调试缺失任务时可直接定位。"
          ]
        },
        {
          task: "为 seed import service 增加导入前后计数比对与失败回滚日志。",
          file: "lib/core/services/seed_import_service.dart",
          details: [
            "导入前：调用仓储统计任务/项目数量，记录 QueryDescriptor.describe() 与种子版本，生成 baseline。",
            "导入中：通过 adapter.writeTransaction + putMany 批量写入，捕获异常时回滚并输出 DatabaseOperationContext。",
            "导入后：再次获取任务/项目列表，与种子数据对比，若不一致触发补写或报警。",
            "日志：使用 objectbox_diagnostics 输出每一步耗时、受影响实体数量、seedSlug 列表等调试信息。",
            "监控钩子：预留未来 DriftAdapter 复用的 hook，确保不同后端同样运行这些校验。"
          ]
        }
      ],
      estimatedTime: "1.5 days"
    },
    {
      step: 4,
      title: "可观测性与诊断工具",
      description: "引入 instrumentation hook、结构化日志工具，并在导入流程接入。",
      tasks: [
        {
          task: "实现 objectbox_diagnostics.dart，提供计时器、操作上下文、结构化输出。",
          file: "lib/core/utils/objectbox_diagnostics.dart"
        },
        {
          task: "在 DatabaseAdapter/ObjectBoxAdapter 中注入可选 instrumentation。",
          file: "lib/data/database/objectbox_adapter.dart"
        },
        {
          task: "更新导入流程日志，输出操作描述与查询条件 describe。",
          file: "lib/core/services/seed_import_service.dart"
        }
      ],
      estimatedTime: "0.5 days"
    },
    {
      step: 5,
      title: "测试编写与验收文档更新",
      description: "围绕新抽象与导入流程补充单元、集成测试，并更新验收用例与团队规范。",
      tasks: [
        {
          task: "编写 objectbox_adapter 与 query_builder 单测，覆盖异常路径。",
          file: "test/data/database/objectbox_adapter_test.dart"
        },
        {
          task: "编写 task_repository 单测，验证分页、watch、find 行为。",
          file: "test/data/repositories/objectbox_task_repository_test.dart"
        },
        {
          task: "新增种子导入集成测试，确认任务导入数量与 UI 列表一致。",
          file: "integration_test/seed_import_visibility_test.dart"
        },
        {
          task: "更新验收测试文档与 refactor 规则。",
          file: "documents/spec/251025-种子导入/02_acceptance_tests.md"
        }
      ],
      estimatedTime: "1 day"
    },
    {
      step: 6,
      title: "Drift 兼容前置准备（当前阶段即可执行）",
      description: "在不引入 Drift 依赖的前提下，为未来切换做结构性准备，也让 ObjectBox 阶段受益。",
      tasks: [
        {
          task: "新增 FieldCondition/QueryDescriptor 等中间 DSL，统一描述字段与操作，兼容 ObjectBox 与未来 SQL。",
          file: "lib/data/database/query_builder.dart",
          note: "保持现有链式 API，对上层调用透明。"
        },
        {
          task: "实现 InMemoryDatabaseAdapter，并在仓储单测中接入，确保仓储仅依赖抽象接口。",
          file: "test/support/in_memory_database_adapter.dart"
        },
        {
          task: "更新 refactor_rules.yaml，禁止业务层直接持有 Store/Box，强调通过 DatabaseAdapter 访问。",
          file: "documents/project/refactor_rules.yaml"
        },
        {
          task: "在仓储基类中加入 adapter 注入校验与事务封装说明，确保未来替换实现无需修改业务代码。",
          file: "lib/data/repositories/base_objectbox_repository.dart"
        }
      ],
      estimatedTime: "0.5 days"
    },
    {
      step: 7,
      title: "Drift 专项筹备（迁移窗口前执行）",
      description: "待确认切换到 Drift 的具体时间后，集中推进与 SQL 相关的工作，避免提前投入浪费。",
      tasks: [
        {
          task: "基于当前模型绘制 Drift schema 草图，定义表、索引与关联映射。",
          file: "documents/spec/未来待建文档",
          note: "同步记录迁移策略与兼容性要求。"
        },
        {
          task: "梳理 drift_dev 等依赖的 build_runner 配置，评估与现有代码生成冲突。",
          file: "pubspec.yaml",
          action: "准备但不启用依赖，记录注释说明"
        },
        {
          task: "实现最小 DriftAdapter 原型（导入 + listAll），在独立分支跑契约测试与导入集成测试。",
          file: "lib/data/database/drift_adapter.dart",
          note: "用于评估性能与实现难度，暂不合入主干。"
        }
      ],
      estimatedTime: "待定"
    }
  ],

  technicalDetails: {
    keyDecisions: {
      objectboxTransactions: {
        recommendation: "使用 Store.runInTransaction / Store.runAsync 包裹 DatabaseAdapter 事务接口。",
        reason: "保证写入原子性并与官方实践一致，避免并发安全隐患。",
        alternative: "继续直接执行 async 回调，但无法保证事务语义。"
      },
      queryBuilderMapping: {
        recommendation: "将函数式谓词映射为 ObjectBox Condition，通过中间 DSL 描述 field + operator。",
        reason: "复用 existing DatabaseQueryBuilder API，同时获得 ObjectBox 查询性能。",
        alternative: "重写仓储直接使用原生 QueryBuilder，但会破坏抽象层。"
      },
      instrumentation: {
        recommendation: "引入可注入的 DatabaseInstrumentation，记录操作名称、耗时、影响条目数。",
        reason: "导入异常需清晰日志，便于 AI 与人工分析。",
        alternative: "仅靠 debugPrint，难以结构化分析。"
      },
      driftCompatibility: {
        recommendation: "保持 DatabaseAdapter/QueryBuilder API 的存储无关性，并通过 InMemory/Drift 原型验证抽象充分。",
        reason: "未来切换 Drift 时可复用业务层与测试资产，当前阶段也能提高可测试性。",
        alternative: "在仓储中直接依赖 ObjectBox Store/Box，迁移时需大规模重写。"
      },
      driftTimeline: {
        recommendation: "当前聚焦抽象层、契约测试、InMemoryAdapter；涉及 Drift schema/依赖的任务放入 Step 7，仅在确认迁移窗口后执行。",
        reason: "避免过早投入造成返工，同时确保现在的改造也提升 ObjectBox 阶段质量。",
        alternative: "立即推进所有 Drift 相关工作，风险是需求变化导致重复劳动。"
      }
    },
    codeStandards: {
      errorHandling: {
        rule: "所有 Adapter 层异常统一包装为 DatabaseAdapterException，并包含 operation/entity/context。",
        location: "lib/data/database/database_adapter.dart",
        example: "throw DatabaseAdapterException('put failed', DatabaseErrorContext(...))",
        forbidden: "直接 rethrow ObjectBoxError 给上层。"
      },
      asyncUsage: {
        rule: "避免在事务中使用长时间 await；如需 IO，先收集数据后提交。",
        location: "lib/data/database/objectbox_adapter.dart"
      },
      adapterUsage: {
        rule: "仓储与服务层必须通过 DatabaseAdapter/Repository 接口访问持久化层，禁止直接持有 Store/Box。",
        location: "documents/project/refactor_rules.yaml",
        example: "final tasks = await taskRepository.listAll();",
        forbidden: "store.box<TaskEntity>().getAll() 在业务层出现。"
      },
      contractTests: {
        rule: "新增或修改适配器实现时，必须通过统一的 Adapter 契约测试基类（ObjectBox/InMemory/未来 Drift 共用）。",
        location: "test/data/database/",
        example: "AdapterContractTest.run(adapterFactory)",
        forbidden: "仅对单个适配器编写孤立单测而未覆盖契约。"
      }
    },
    performance: {
      optimization: [
        "watchList 使用 query.watch(triggerImmediately: true) + debounce 控制频率",
        "批量导入优先使用 box.putMany，避免单条写入"
      ]
    },
    security: {
      concerns: [
        "确保导入日志不包含用户隐私，仅记录种子版本与操作结果"
      ]
    }
  },

  dependencies: {
    dataLayer: [
      "lib/data/database/database_adapter.dart",
      "lib/data/database/objectbox_adapter.dart",
      "lib/data/database/objectbox_query_builder.dart",
      "lib/data/database/inmemory_adapter.dart",
      "lib/data/models/task.dart",
      "lib/data/objectbox/task_entity.dart",
      "lib/data/repositories/objectbox/objectbox_task_repository.dart"
    ],
    serviceLayer: [
      "lib/core/services/seed_import_service.dart"
    ],
    providerLayer: [
      "lib/core/providers/repository_providers.dart"
    ],
    uiLayer: [
      "lib/presentation/tasks/ 相关任务列表页面用于验证"
    ],
    documentationLayer: [
      "documents/spec/251025-种子导入/02_acceptance_tests.md",
      "documents/project/refactor_rules.yaml"
    ]
  },

  testing: {
    unitTests: [
      {
        file: "test/data/database/objectbox_adapter_test.dart",
        description: "验证 DatabaseAdapter 的事务、watch、describe 输出与异常封装。",
        testCases: [
          {
            group: "transactions",
            cases: [
              {
                name: "writeTransaction 成功提交 putMany",
                test: "Given 模拟 Box, When 执行 writeTransaction putMany, Then 成功返回并记录 instrumentation。"
              },
              {
                name: "writeTransaction 捕获 ObjectBoxError",
                test: "When Box.put 抛出 ObjectBoxException, Then 捕获并抛出 DatabaseAdapterException，包含 operation 与 entity 信息。"
              }
            ]
          },
          {
            group: "watchList",
            cases: [
              {
                name: "watchList 初次触发并响应新增",
                test: "Given 模拟 query.watch, When 数据变更, Then Stream 立即推送初始与变更列表。"
              }
            ]
          }
        ]
      },
      {
        file: "test/data/database/inmemory_adapter_test.dart",
        description: "确保 InMemoryAdapter 与 ObjectBoxAdapter 共享统一契约，支撑后端可替换性验证。",
        testCases: [
          {
            group: "contract",
            cases: [
              {
                name: "契约测试在 InMemoryAdapter 上通过",
                test: "Given AdapterContractTest, When 以 InMemoryAdapter 运行所有用例, Then 结果与 ObjectBoxAdapter 保持一致。"
              },
              {
                name: "watchList 与 CRUD 行为与真实实现对齐",
                test: "When 执行 create → update → watch, Then 事件序列与 ObjectBoxAdapter 相同。"
              }
            ]
          }
        ]
      },
      {
        file: "test/data/repositories/objectbox_task_repository_test.dart",
        description: "确保任务仓储使用新抽象正确查询、监听，并在导入后能返回任务数据。",
        testCases: [
          {
            group: "listAndFind",
            cases: [
              {
                name: "listAll 返回转换后的任务列表",
                test: "When adapter 查询返回 TaskEntity 列表, Then 仓储转成 Task 并附带日志。"
              },
              {
                name: "findBySlug 找不到时返回 null",
                test: "When adapter.describe 返回空结果, Then 仓储记录调试日志并返回 null。"
              }
            ]
          },
          {
            group: "watchers",
            cases: [
              {
                name: "watchInbox 过滤状态为 inbox 的任务",
                test: "Given mock watchList 回调, When 触发数据流, Then 仅包含 inbox 状态任务。"
              }
            ]
          }
        ]
      }
    ],
    integrationTests: [
      {
        file: "integration_test/seed_import_visibility_test.dart",
        description: "真实运行种子导入流程，验证任务数量与 UI 展示一致。",
        testCases: [
          {
            group: "seedImport",
            cases: [
              {
                name: "首次导入生成任务并可见",
                test: "步骤：清空数据库 → 调用 importIfNeeded → 等待 watchInbox 首次推送 → 验证任务数量与种子文件一致。"
              },
              {
                name: "重复导入检测缺失数据并重新导入",
                test: "步骤：预先记录版本 → 手动删除 Task → 再次 importIfNeeded → 期待 describe() 日志提示缺失并重新写入后任务恢复。"
              }
            ]
          }
        ]
      }
    ],
    widgetTests: [
      {
        file: "test/presentation/tasks/task_list_visibility_test.dart",
        description: "验证任务列表在新 watch 数据流下正确渲染。",
        testCases: [
          {
            group: "taskList",
            cases: [
              {
                name: "任务列表接收导入数据后展示",
                test: "模拟仓储 watchSection 返回任务 → pump widget → 断言列表项数量。"
              }
            ]
          }
        ]
      }
    ]
  },

  risks: [
    {
      risk: "watchList 改造可能引入性能瓶颈或重复触发，导致 UI 频繁刷新。",
      mitigation: "加入节流与去重逻辑；在集成测试与性能日志中监控触发频率。",
      priority: "high",
      check: "观察 instrumentation 中 watch emissions 次数是否异常。",
      enforcement: "在 PR 审查中必须附带 watch 频率统计。"
    },
    {
      risk: "扩展 QueryBuilder 时字段映射不完整，导致查询遗漏任务。",
      mitigation: "为每个字段新增单测覆盖；describe() 输出在调试日志中比对。",
      priority: "high",
      check: "单测验证所有字段均可生成 condition。",
      enforcement: "CI 中新增 list/find 单测必须通过。"
    },
    {
      risk: "InMemoryAdapter 或未来 DriftAdapter 未同步契约测试，导致行为与 ObjectBoxAdapter 不一致。",
      mitigation: "建立共享 AdapterContractTest，所有适配器在 CI 中执行；变更时必须更新契约用例。",
      priority: "medium",
      check: "CI 中 adapter_contract_test 任务需保持通过并覆盖多实现。",
      enforcement: "PR 模板要求附带契约测试结果链接。"
    },
    {
      risk: "Seed 导入流程中新增校验可能影响首启性能。",
      mitigation: "在 instrumentation 中记录导入耗时，必要时懒加载描述。",
      priority: "medium",
      check: "监控导入耗时是否超过 1.5s。",
      enforcement: "在 release 前进行真机性能抽样。"
    }
  ],

  verification: {
    codeQuality: [
      "运行 flutter analyze 确保无 lint",
      "运行 flutter test --coverage 并检查新增代码覆盖率 ≥80%",
      "执行 dart format . --line-length 100"
    ],
    functionality: [
      "执行 integration_test/seed_import_visibility_test.dart，确认任务可见",
      "人工验证应用首启任务列表展示正常",
      "检查日志输出包含 describe() 与 instrumentation 字段",
      "在 ObjectBox 与 InMemory Adapter 下分别运行仓储单测，确认行为一致",
      "验证 writeTransaction 仍保持原子性：导入任务写入失败时不应留下部分数据"
    ],
    performance: [
      "统计导入流程耗时，目标首启 <1.5s，重复导入 <0.8s"
    ],
    compatibility: [
      "在 iOS Simulator 与 Android Emulator 各运行一次导入流程",
      "验证中文与英文种子文件均导入成功"
    ]
  }
}

