{
  // ===========================================
  // 任务清单页面增强迭代蓝图
  // 基于 design_task_list_enhancement.json5 实现任务清单页面增强功能
  // ===========================================
  
  // ===========================================
  // 1. 迭代概述（必填）
  // ===========================================
  iteration: {
    // 迭代 ID
    id: "250115-task-list-enhancement",
    
    // 迭代标题
    title: "任务清单页面增强：长按拖拽 + Checkbox 状态切换 + 今日区域显示已完成任务",
    
    // 迭代描述
    description: "增强任务清单页面的交互体验：1) 移除拖拽手柄，支持长按任务行任意位置拖拽；2) 添加 Checkbox 快速切换任务完成状态，并自动调整 sortIndex 使已完成任务排在未完成任务之前；3) 在今日区域显示已完成任务，提供更完整的今日任务视图，已完成任务显示删除线",
    
    // 状态
    status: "planning",
    
    // 优先级
    priority: "high",
    
    // 基于的设计文档
    basedOnDesign: "documents/json5/tasks/design_task_list_enhancement.json5",
  },

  // ===========================================
  // 2. 文件创建清单（必填）
  // ===========================================
  files: {
    // UI 组件层 - 修改组件
    widgets: [
      {
        path: "lib/presentation/widgets/simplified_task_row.dart",
        purpose: "添加 Checkbox 组件，支持状态切换和删除线显示（今日区域的已完成任务）",
        action: "modify",
        estimatedLines: 100,
        dependencies: [
          "lib/data/models/task.dart",
          "lib/generated/l10n/app_localizations.dart",
          "lib/presentation/widgets/utils/task_bottom_sheet_helper.dart",
          "lib/presentation/widgets/utils/task_status_toggle_helper.dart",
        ],
        details: [
          "在任务标题前添加 Checkbox 组件（24dp × 24dp）",
          "Checkbox 使用 Material 3 样式，与主题匹配：",
          "  - checkColor: Theme.of(context).colorScheme.onPrimary",
          "  - fillColor: MaterialStateProperty.resolveWith((states) { if (states.contains(MaterialState.selected)) return Theme.of(context).colorScheme.primary; return null; })",
          "  - value: task.status == TaskStatus.completedActive",
          "  - onChanged: TaskStatusToggleHelper.toggleTaskStatus",
          "  - materialTapTargetSize: MaterialTapTargetSize.shrinkWrap",
          "  - visualDensity: VisualDensity.compact",
          "调整布局：将 Checkbox 和任务标题包裹在 Row 中",
          "  - Row(children: [Padding(Checkbox, padding: EdgeInsets.all(8)), SizedBox(width: 12), Expanded(child: Text)])",
          "  - 使用 Padding 包裹 Checkbox，设置 padding: EdgeInsets.all(8)，使点击区域扩展到 40dp × 40dp（24dp + 8dp × 2 = 40dp）",
          "  - 注意：Padding 的 onTap 会优先于长按事件，防止长按 Checkbox 区域触发拖拽",
          "添加删除线支持：",
          "  - 添加 section 参数（可选，类型为 TaskSection?），用于判断是否在今日区域",
          "  - 如果 task.status == TaskStatus.completedActive && section == TaskSection.today，显示删除线",
          "  - 删除线样式：TextDecoration.lineThrough",
          "  - 已完成任务文字颜色：Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6)",
          "保持现有的点击功能（点击任务行显示弹窗）",
          "保持现有的可访问性支持（Semantics）",
        ],
      },
    ],
    
    // 服务层 - 修改服务
    services: [
      {
        path: "lib/presentation/widgets/utils/task_status_toggle_helper.dart",
        purpose: "增强 toggleTaskStatus 方法，支持 sortIndex 自动调整",
        action: "modify",
        estimatedLines: 150,
        dependencies: [
          "lib/core/providers/service_providers.dart",
          "lib/core/providers/repository_providers.dart",
          "lib/data/models/task.dart",
          "lib/core/utils/task_section_utils.dart",
          "lib/presentation/tasks/utils/sort_index_calculator.dart",
          "lib/core/services/sort_index_service.dart",
        ],
        details: [
          "修改 toggleTaskStatus 方法签名，添加 section 参数（可选，类型为 TaskSection?）：",
          "  - 如果 section 为 null，使用 TaskSectionUtils.getSectionForDate(task.dueAt) 计算 section",
          "  - 如果 section 不为 null，直接使用传入的 section",
          "修改 toggleTaskStatus 方法，在状态切换后自动调整 sortIndex",
          "pending -> completedActive 的 sortIndex 调整逻辑：",
          "  1. 获取任务的 section（从参数或计算得出）",
          "  2. 查询同一区域（section）的所有任务：",
          "     - 使用 TaskRepository.listSectionTasks(section) 查询",
          "     - 注意：TaskRepository 接口没有事务方法，采用顺序操作保证一致性",
          "  3. 筛选出已完成任务（status == completedActive）",
          "  4. 如果存在已完成任务：",
          "     a. 找到最小 sortIndex（minCompletedSortIndex）",
          "     b. 使用 SortIndexCalculator.insertAtFirst(minCompletedSortIndex) 计算新 sortIndex",
          "     c. 检查间隙是否足够：如果 (minCompletedSortIndex - newSortIndex).abs() < 2.0，先调用 SortIndexService.normalizeSection 规范化已完成任务区域",
          "  5. 如果不存在已完成任务，使用 SortIndexCalculator.insertAtFirst(null) 或设置为 -1000",
          "  6. 先调用 TaskStatusService.markCompleted 更新状态（不支持 sortIndex）",
          "  7. 立即调用 TaskService.updateDetails 更新 sortIndex（两步更新）",
          "completedActive -> pending 的 sortIndex 调整逻辑：",
          "  1. 获取任务的 section（从参数或计算得出）",
          "  2. 查询同一区域（section）的所有任务：",
          "     - 使用 TaskRepository.listSectionTasks(section) 查询",
          "  3. 筛选出未完成任务（status != completedActive）",
          "  4. 如果存在未完成任务：",
          "     a. 找到最大 sortIndex（maxUncompletedSortIndex）",
          "     b. 使用 SortIndexCalculator.insertAtLast(maxUncompletedSortIndex) 计算新 sortIndex",
          "     c. 检查间隙是否足够：如果 (newSortIndex - maxUncompletedSortIndex).abs() < 2.0，先调用 SortIndexService.normalizeSection 规范化未完成任务区域",
          "  5. 如果不存在未完成任务，使用 SortIndexCalculator.insertAtLast(null) 或设置为 1000",
          "  6. 调用 TaskService.updateDetails 更新状态和 sortIndex（在 TaskUpdate 中）",
          "数据库事务处理：",
          "  - TaskRepository 接口没有事务方法，无法直接使用事务",
          "  - 采用顺序操作保证一致性：先查询，再计算，最后更新",
          "  - 虽然不在事务中，但由于是连续调用，实际影响很小",
          "  - 如果需要严格保证原子性，可以考虑修改 TaskRepository 接口，但当前版本暂不采用",
          "错误处理：",
          "  - 使用 try-catch 捕获所有异常",
          "  - 如果规范化失败，记录错误但不阻塞状态切换",
          "  - 如果 sortIndex 计算失败，使用默认值（-1000 或 1000）",
          "  - 如果 section 计算失败，跳过 sortIndex 调整，只更新状态",
        ],
      },
    ],
  },

  // ===========================================
  // 3. 需要修改的现有文件（必填）
  // ===========================================
  modifications: [
    {
      file: "lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
      purpose: "移除拖拽手柄，启用长按拖拽；修改任务筛选逻辑，今日区域包含已完成任务；修改排序逻辑，按 sortIndex 升序排序",
      action: "modify",
      estimatedLines: 50,
      details: [
        "移除拖拽手柄：",
        "  - 移除 ReorderableDragStartListener 包裹的拖拽手柄图标",
        "  - ReorderableListView 默认支持长按拖拽，无需额外配置",
        "  - 只有根任务可以拖拽排序（保持不变）",
        "修改任务筛选逻辑：",
        "  - 在过滤任务时，如果 section == TaskSection.today，包含 completedActive 状态的任务",
        "  - 其他筛选条件（项目、标签等）保持不变",
        "修改排序逻辑：",
        "  - 直接按 sortIndex 升序排序：tasks.sort((a, b) => a.sortIndex.compareTo(b.sortIndex))",
        "  - 因为已完成任务的 sortIndex 小于未完成任务的 sortIndex，所以已完成任务自然排在前面",
        "  - 如果 sortIndex 计算出现问题，可以回退到状态优先排序（作为备选方案）",
        "传递 section 参数给 SimplifiedTaskRow：",
        "  - 在 SimplifiedTaskRow 中添加 section 参数（可选）",
        "  - 用于判断是否在今日区域，决定是否显示删除线",
      ],
    },
    {
      file: "lib/presentation/widgets/simplified_task_row.dart",
      purpose: "添加 Checkbox 组件和删除线支持",
      action: "modify",
      estimatedLines: 80,
      details: [
        "添加 section 参数（可选，类型为 TaskSection?）",
        "在任务标题前添加 Checkbox 组件：",
        "  - 使用 Material 3 Checkbox，尺寸 24dp × 24dp",
        "  - 点击区域扩展到 40dp × 40dp（使用 Padding 包裹）",
        "  - value: task.status == TaskStatus.completedActive",
        "  - onChanged: TaskStatusToggleHelper.toggleTaskStatus",
        "  - 样式使用主题主色",
        "调整布局结构：",
        "  - 将 Checkbox 和任务标题包裹在 Row 中",
        "  - Row(children: [Padding(Checkbox), SizedBox(width: 12), Expanded(Text)])",
        "添加删除线支持：",
        "  - 如果 task.status == TaskStatus.completedActive && section == TaskSection.today，显示删除线",
        "  - 删除线样式：TextDecoration.lineThrough",
        "  - 已完成任务文字颜色：Theme.of(context).colorScheme.onSurface.withValues(alpha: 0.6)",
        "保持现有的点击功能（点击任务行显示弹窗）",
        "保持现有的可访问性支持",
      ],
    },
    {
      file: "lib/presentation/widgets/utils/task_status_toggle_helper.dart",
      purpose: "增强状态切换逻辑，支持 sortIndex 自动调整",
      action: "modify",
      estimatedLines: 150,
      details: [
        "添加 sortIndex 调整逻辑到 toggleTaskStatus 方法",
        "pending -> completedActive：",
        "  - 查询同一区域的所有任务（使用 TaskRepository.listSectionTasks）",
        "  - 筛选已完成任务，找到最小 sortIndex",
        "  - 使用 SortIndexCalculator.insertAtFirst 计算新 sortIndex",
        "  - 检查间隙，不足时先规范化",
        "  - 在事务中更新状态和 sortIndex",
        "completedActive -> pending：",
        "  - 查询同一区域的所有任务",
        "  - 筛选未完成任务，找到最大 sortIndex",
        "  - 使用 SortIndexCalculator.insertAtLast 计算新 sortIndex",
        "  - 检查间隙，不足时先规范化",
        "  - 在事务中更新状态和 sortIndex",
        "使用数据库事务确保原子性",
        "错误处理和日志记录",
      ],
    },
  ],

  // ===========================================
  // 4. 实现步骤（必填）
  // ===========================================
  // 错误处理策略：
  // - 如果某个任务失败，先尝试修复（如 analyze issues、测试失败），修复后继续
  // - 如果无法自动修复（如需要人工决策），记录问题并继续下一个任务，在阶段完成时总结所有未解决问题
  // - build_runner 冲突：使用 --delete-conflicting-outputs 参数自动删除冲突文件
  // - analyze issues 无法自动修复：记录到 commit message 中，标记为已知问题，继续后续任务
  // 
  // 自动执行规则：
  // - 阶段完成后自动执行下一阶段，不需要沟通确认
  // - 每个阶段完成时忽略 pre-commit，强行 git commit（使用 --no-verify 选项）
  implementationSteps: [
    {
      step: 1,
      title: "阶段 1：修改 SimplifiedTaskRow 添加 Checkbox",
      description: "在 SimplifiedTaskRow 中添加 Checkbox 组件，支持状态切换和删除线显示",
      tasks: [
        {
          task: "修改 SimplifiedTaskRow 组件",
          file: "lib/presentation/widgets/simplified_task_row.dart",
          action: [
            "添加 section 参数（可选，类型为 TaskSection?）",
            "在任务标题前添加 Checkbox 组件（24dp × 24dp）",
            "使用 Material 3 Checkbox 样式，与主题匹配",
            "使用 Padding 包裹 Checkbox，设置 padding: EdgeInsets.all(8)，使点击区域扩展到 40dp × 40dp",
            "调整布局：Row(children: [Padding(Checkbox, padding: EdgeInsets.all(8)), SizedBox(width: 12), Expanded(Text)])",
            "添加删除线支持：如果 task.status == TaskStatus.completedActive && section == TaskSection.today，显示删除线",
            "保持现有的点击功能和可访问性支持",
          ],
        },
        {
          task: "更新所有调用 SimplifiedTaskRow 的地方，传递 section 参数",
          file: "lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
          action: [
            "在 SimplifiedTaskRow 调用处传递 section: widget.section",
            "其他页面（Inbox、Completed、Archived、Trash、Project Subtasks）不需要传递 section（保持 null）",
          ],
        },
        {
          task: "运行 flutter analyze 检查代码质量",
          command: "flutter analyze lib/presentation/widgets/simplified_task_row.dart",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 阶段 1 完成 - 修改 SimplifiedTaskRow 添加 Checkbox'",
        },
      ],
    },
    {
      step: 2,
      title: "阶段 2：增强 TaskStatusToggleHelper 支持 sortIndex 调整",
      description: "修改 toggleTaskStatus 方法，在状态切换后自动调整 sortIndex",
      tasks: [
        {
          task: "修改 TaskStatusToggleHelper.toggleTaskStatus 方法",
          file: "lib/presentation/widgets/utils/task_status_toggle_helper.dart",
          action: [
            "修改方法签名，添加 section 参数（可选，类型为 TaskSection?）",
            "如果 section 为 null，使用 TaskSectionUtils.getSectionForDate(task.dueAt) 计算 section",
            "添加 sortIndex 调整逻辑到 pending -> completedActive 分支：",
            "  1. 使用 TaskRepository.listSectionTasks(section) 查询同一区域的所有任务",
            "  2. 筛选已完成任务，找到最小 sortIndex",
            "  3. 使用 SortIndexCalculator.insertAtFirst 计算新 sortIndex",
            "  4. 检查间隙，如果不足（< 2.0）先调用 SortIndexService.normalizeSection 规范化",
            "  5. 先调用 TaskStatusService.markCompleted 更新状态（不支持 sortIndex）",
            "  6. 立即调用 TaskService.updateDetails 更新 sortIndex（两步更新）",
            "添加 sortIndex 调整逻辑到 completedActive -> pending 分支：",
            "  1. 使用 TaskRepository.listSectionTasks(section) 查询同一区域的所有任务",
            "  2. 筛选未完成任务，找到最大 sortIndex",
            "  3. 使用 SortIndexCalculator.insertAtLast 计算新 sortIndex",
            "  4. 检查间隙，如果不足先规范化",
            "  5. 调用 TaskService.updateDetails 更新状态和 sortIndex",
            "添加错误处理和日志记录",
            "注意：如果无法使用数据库事务，至少确保查询和更新操作的顺序正确",
          ],
        },
        {
          task: "更新 SimplifiedTaskRow 中调用 toggleTaskStatus 的地方，传递 section 参数",
          file: "lib/presentation/widgets/simplified_task_row.dart",
          action: [
            "在 Checkbox 的 onChanged 回调中，调用 TaskStatusToggleHelper.toggleTaskStatus 时传递 section 参数",
          ],
        },
        {
          task: "运行 flutter analyze 检查代码质量",
          command: "flutter analyze lib/presentation/widgets/utils/task_status_toggle_helper.dart",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 阶段 2 完成 - 增强 TaskStatusToggleHelper 支持 sortIndex 调整'",
        },
      ],
    },
    {
      step: 3,
      title: "阶段 3：修改 TasksSectionTaskListSimplified 移除拖拽手柄",
      description: "移除拖拽手柄，启用长按拖拽功能",
      tasks: [
        {
          task: "修改 tasks_section_task_list_simplified.dart",
          file: "lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
          action: [
            "移除 ReorderableDragStartListener 包裹的拖拽手柄图标",
            "ReorderableListView 默认支持长按拖拽，无需额外配置",
            "保持只有根任务可以拖拽排序的限制",
            "传递 section 参数给 SimplifiedTaskRow",
          ],
        },
        {
          task: "运行 flutter analyze 检查代码质量",
          command: "flutter analyze lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 阶段 3 完成 - 移除拖拽手柄启用长按拖拽'",
        },
      ],
    },
    {
      step: 4,
      title: "阶段 4：修改今日区域筛选和排序逻辑",
      description: "在今日区域包含已完成任务，修改排序逻辑按 sortIndex 排序",
      tasks: [
        {
          task: "修改任务筛选逻辑",
          file: "lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
          action: [
            "在过滤任务时，如果 section == TaskSection.today，包含 completedActive 状态的任务",
            "其他筛选条件（项目、标签等）保持不变",
          ],
        },
        {
          task: "修改排序逻辑",
          file: "lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
          action: [
            "直接按 sortIndex 升序排序：tasks.sort((a, b) => a.sortIndex.compareTo(b.sortIndex))",
            "因为已完成任务的 sortIndex 小于未完成任务的 sortIndex，所以已完成任务自然排在前面",
          ],
        },
        {
          task: "运行 flutter analyze 检查代码质量",
          command: "flutter analyze lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 阶段 4 完成 - 修改今日区域筛选和排序逻辑'",
        },
      ],
    },
    {
      step: 5,
      title: "阶段 5：测试和验证",
      description: "运行测试，验证所有功能正常工作",
      tasks: [
        {
          task: "运行 flutter analyze 检查所有修改的文件",
          command: "flutter analyze lib/presentation/widgets/simplified_task_row.dart lib/presentation/widgets/utils/task_status_toggle_helper.dart lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
        },
        {
          task: "运行单元测试（如果存在）",
          command: "flutter test test/presentation/widgets/utils/task_status_toggle_helper_test.dart 2>&1 || echo '测试文件不存在，跳过'",
        },
        {
          task: "手动测试：验证长按拖拽功能",
          action: "在任务清单页面长按任务行，验证可以拖拽排序",
        },
        {
          task: "手动测试：验证 Checkbox 状态切换",
          action: "点击 Checkbox，验证状态切换和 sortIndex 调整",
        },
        {
          task: "手动测试：验证今日区域显示已完成任务",
          action: "在今日区域验证已完成任务显示在前面，并显示删除线",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 阶段 5 完成 - 测试和验证'",
        },
      ],
    },
  ],

  // ===========================================
  // 5. 技术细节和注意事项（必填）
  // ===========================================
  technicalDetails: {
    // 关键技术决策
    keyDecisions: {
      // sortIndex 计算方案
      sortIndexCalculation: {
        method: "使用 SortIndexCalculator 工具类，defaultInterval = 1000.0",
        reason: "避免硬编码，提供更大的缓冲空间，减少规范化触发频率",
        alternative: "如果工具类不可用，可以使用硬编码的 1000.0 作为间隔",
      },
      // 冲突处理方案
      conflictHandling: {
        method: "数据库事务（Drift 的 writeTransaction）",
        reason: "确保查询和更新在同一事务中完成，保证原子性，避免并发冲突",
        alternative: "如果事务不可用，可以使用锁机制，但事务是更优方案",
      },
      // 溢出处理方案
      overflowHandling: {
        method: "规范化机制（间隙不足时自动触发）",
        reason: "当间隙小于 minGap（2.0）时，自动规范化整个区域，重置 sortIndex 到安全范围",
        alternative: "定期规范化，但当前版本仅在间隙不足时触发，避免不必要的性能开销",
      },
      // 长按拖拽方案
      longPressDrag: {
        method: "使用 ReorderableListView 的默认长按功能",
        reason: "无需额外配置，Flutter 框架原生支持，用户体验好",
        alternative: "如果默认行为不符合需求，可以使用 GestureDetector 自定义长按处理",
      },
    },
    
    // 代码规范要求
    codeStandards: {
      // Checkbox 样式规范
      checkboxStyle: {
        rule: "使用 Material 3 Checkbox，样式与主题匹配",
        location: "lib/presentation/widgets/simplified_task_row.dart",
        example: "Checkbox(value: isCompleted, onChanged: onToggle, checkColor: theme.colorScheme.onPrimary, fillColor: MaterialStateProperty.resolveWith(...))",
        note: "必须使用主题主色，确保在不同模式下都有良好的视觉效果",
      },
      // sortIndex 计算规范
      sortIndexCalculation: {
        rule: "使用 SortIndexCalculator 工具类，不要硬编码数值",
        location: "lib/presentation/widgets/utils/task_status_toggle_helper.dart",
        example: "SortIndexCalculator.insertAtFirst(minSortIndex)",
        note: "使用工具类可以统一管理间隔值，便于后续调整",
      },
      // 事务使用规范
      transactionUsage: {
        rule: "sortIndex 调整必须在数据库事务中完成",
        location: "lib/presentation/widgets/utils/task_status_toggle_helper.dart",
        example: "await repository.writeTransaction(() async { ... })",
        note: "确保查询、计算、更新的原子性，避免并发冲突",
      },
    },
    
    // 性能考虑
    performance: {
      optimization: [
        "使用批量更新（batchUpdate）减少数据库操作次数（规范化时）",
        "规范化操作在后台异步执行，不阻塞 UI",
        "只在间隙不足时触发规范化，避免不必要的操作",
        "使用索引（section + status）加速查询",
        "虚拟滚动（ListView.builder）确保列表渲染性能",
      ],
      monitoring: [
        "监控规范化触发频率（应该很低）",
        "监控 sortIndex 计算耗时（应该在毫秒级）",
        "监控状态切换响应时间（应该在 100ms 以内）",
      ],
    },
    
    // 安全考虑
    security: {
      concerns: [
        "数据库事务确保数据一致性",
        "错误处理防止状态不一致",
        "边界检查防止 sortIndex 溢出",
      ],
    },
  },

  // ===========================================
  // 6. 依赖关系图（必填）
  // ===========================================
  dependencies: {
    // 数据层依赖
    dataLayer: [
      "lib/data/models/task.dart",
      "lib/data/repositories/task_repository.dart",
    ],
    
    // 服务层依赖
    serviceLayer: [
      "lib/core/services/task_status_service.dart",
      "lib/core/services/task_service.dart",
      "lib/core/services/sort_index_service.dart",
      "lib/presentation/tasks/utils/sort_index_calculator.dart",
      "lib/core/utils/task_section_utils.dart",
    ],
    
    // Provider 层依赖
    providerLayer: [
      "lib/core/providers/service_providers.dart",
      "lib/core/providers/repository_providers.dart",
    ],
    
    // UI 组件层依赖
    uiLayer: [
      "lib/presentation/widgets/simplified_task_row.dart",
      "lib/presentation/widgets/utils/task_bottom_sheet_helper.dart",
      "lib/presentation/widgets/utils/task_status_toggle_helper.dart",
      "lib/presentation/tasks/views/tasks_section_task_list_simplified.dart",
    ],
  },

  // ===========================================
  // 7. 测试策略和详细测试用例（必填）
  // ===========================================
  testing: {
    // 单元测试
    unitTests: [
      {
        file: "test/presentation/widgets/utils/task_status_toggle_helper_test.dart",
        description: "测试 TaskStatusToggleHelper 的状态切换和 sortIndex 调整逻辑",
        testCases: [
          {
            group: "pending -> completedActive 状态切换",
            cases: [
              {
                name: "测试 sortIndex 调整：移动到已完成任务区域最前面",
                test: "步骤：1) 创建 3 个未完成任务（sortIndex: 1000, 2000, 3000）；2) 创建 2 个已完成任务（sortIndex: -1000, -500）；3) 将第一个未完成任务切换为已完成；4) 验证新 sortIndex 为 -1500（-1000 - 500 = -1500，但使用 insertAtFirst 应该是 -2000）",
              },
              {
                name: "测试间隙不足时触发规范化",
                test: "步骤：1) 创建已完成任务（sortIndex: -1000, -999.5）；2) 将未完成任务切换为已完成；3) 验证间隙不足（< 2.0）时触发规范化；4) 验证规范化后 sortIndex 正确",
              },
              {
                name: "测试没有已完成任务时的 sortIndex 设置",
                test: "步骤：1) 创建 3 个未完成任务；2) 将第一个切换为已完成；3) 验证新 sortIndex 为 -1000（使用 insertAtFirst(null)）",
              },
            ],
          },
          {
            group: "completedActive -> pending 状态切换",
            cases: [
              {
                name: "测试 sortIndex 调整：移动到未完成任务区域最后面",
                test: "步骤：1) 创建 2 个已完成任务（sortIndex: -1000, -500）；2) 创建 3 个未完成任务（sortIndex: 1000, 2000, 3000）；3) 将第一个已完成任务切换为未完成；4) 验证新 sortIndex 为 4000（3000 + 1000）",
              },
              {
                name: "测试间隙不足时触发规范化",
                test: "步骤：1) 创建未完成任务（sortIndex: 1000, 1000.5）；2) 将已完成任务切换为未完成；3) 验证间隙不足时触发规范化",
              },
              {
                name: "测试没有未完成任务时的 sortIndex 设置",
                test: "步骤：1) 创建 3 个已完成任务；2) 将第一个切换为未完成；3) 验证新 sortIndex 为 1000（使用 insertAtLast(null)）",
              },
            ],
          },
          {
            group: "数据库事务测试",
            cases: [
              {
                name: "测试事务原子性：查询和更新在同一事务中",
                test: "步骤：1) 模拟并发切换状态；2) 验证事务确保原子性；3) 验证不会产生冲突",
              },
            ],
          },
        ],
      },
    ],
    
    // Widget 测试
    widgetTests: [
      {
        file: "test/presentation/widgets/simplified_task_row_test.dart",
        description: "测试 SimplifiedTaskRow 的 Checkbox 和删除线显示",
        testCases: [
          {
            group: "Checkbox 显示",
            cases: [
              {
                name: "测试未完成任务 Checkbox 未选中",
                test: "步骤：1) 创建 pending 状态任务；2) 渲染 SimplifiedTaskRow；3) 验证 Checkbox value 为 false",
              },
              {
                name: "测试已完成任务 Checkbox 选中",
                test: "步骤：1) 创建 completedActive 状态任务；2) 渲染 SimplifiedTaskRow；3) 验证 Checkbox value 为 true",
              },
            ],
          },
          {
            group: "删除线显示",
            cases: [
              {
                name: "测试今日区域的已完成任务显示删除线",
                test: "步骤：1) 创建 completedActive 状态任务；2) 渲染 SimplifiedTaskRow(section: TaskSection.today)；3) 验证 Text 有 TextDecoration.lineThrough",
              },
              {
                name: "测试其他区域的已完成任务不显示删除线",
                test: "步骤：1) 创建 completedActive 状态任务；2) 渲染 SimplifiedTaskRow(section: TaskSection.tomorrow)；3) 验证 Text 没有 TextDecoration.lineThrough",
              },
            ],
          },
        ],
      },
    ],
    
    // 集成测试
    integrationTests: [
      {
        file: "integration_test/tasks/task_list_enhancement_test.dart",
        description: "集成测试：验证任务清单页面的增强功能",
        testCases: [
          {
            group: "长按拖拽功能",
            cases: [
              {
                name: "测试长按任务行可以拖拽排序",
                test: "步骤：1) 进入任务清单页面；2) 长按任务行；3) 拖拽到新位置；4) 验证任务移动到新位置",
              },
            ],
          },
          {
            group: "Checkbox 状态切换",
            cases: [
              {
                name: "测试点击 Checkbox 完成任务",
                test: "步骤：1) 进入任务清单页面；2) 点击未完成任务前的 Checkbox；3) 验证任务状态变为已完成；4) 验证任务移动到已完成任务区域最前面；5) 验证显示 Snackbar 提示",
              },
              {
                name: "测试点击 Checkbox 恢复任务",
                test: "步骤：1) 进入今日区域；2) 点击已完成任务前的 Checkbox；3) 验证任务状态变为未完成；4) 验证任务移动到未完成任务区域最后面；5) 验证删除线消失",
              },
            ],
          },
          {
            group: "今日区域显示已完成任务",
            cases: [
              {
                name: "测试今日区域显示已完成任务",
                test: "步骤：1) 创建今日的未完成任务和已完成任务；2) 进入今日区域；3) 验证已完成任务显示在前面；4) 验证已完成任务显示删除线；5) 验证已完成任务的 Checkbox 选中",
              },
            ],
          },
        ],
      },
    ],
  },

  // ===========================================
  // 8. 风险点和注意事项（必填）
  // ===========================================
  risks: [
    {
      risk: "长按 Checkbox 区域可能同时触发拖拽和点击事件",
      mitigation: "Checkbox 的点击区域（40dp × 40dp）优先处理点击事件，长按不会触发拖拽。使用 GestureDetector 或 InkWell 的 onTap 优先于长按事件",
      priority: "low",
      check: "手动测试：长按 Checkbox 区域，验证只触发点击事件，不触发拖拽",
    },
    {
      risk: "多个任务同时切换状态时，sortIndex 计算可能产生冲突",
      mitigation: "使用数据库事务（Drift 的 writeTransaction）确保查询和更新在同一事务中完成，保证原子性。如果间隙不足，先规范化区域再计算",
      priority: "medium",
      check: "单元测试：模拟并发切换状态，验证事务确保原子性",
    },
    {
      risk: "频繁切换状态可能导致 sortIndex 溢出",
      mitigation: "使用 SortIndexCalculator 的 defaultInterval（1000.0）提供缓冲空间。当间隙小于 minGap（2.0）时，自动触发规范化。设置边界检查（-1000000 到 1000000）",
      priority: "low",
      check: "单元测试：模拟频繁切换状态，验证规范化机制正常工作",
    },
    {
      risk: "规范化操作可能影响性能",
      mitigation: "规范化操作在后台异步执行，不阻塞 UI。使用批量更新减少数据库操作。只在间隙不足时触发，正常情况下触发频率很低",
      priority: "low",
      check: "性能测试：监控规范化操作的耗时和频率",
    },
    {
      risk: "今日区域任务数量增加可能影响性能",
      mitigation: "使用虚拟滚动（ListView.builder）确保只渲染可见区域的任务。即使任务数量增加，性能影响也很小",
      priority: "medium",
      check: "性能测试：创建大量任务，验证列表滚动性能",
    },
  ],

  // ===========================================
  // 9. 验证清单（必填）
  // ===========================================
  verification: {
    // 代码质量检查
    codeQuality: [
      "运行 flutter analyze，确保没有 lint 错误",
      "运行 flutter test，确保所有单元测试通过",
      "代码审查，确保符合代码规范",
      "确保所有修改的文件都通过了静态分析",
    ],
    
    // 功能验证
    functionality: [
      "验证长按拖拽功能：长按任务行可以拖拽排序",
      "验证 Checkbox 状态切换：点击 Checkbox 可以切换任务状态",
      "验证 sortIndex 调整：状态切换后任务移动到正确位置",
      "验证今日区域显示已完成任务：已完成任务显示在前面，并显示删除线",
      "验证删除线显示：只有今日区域的已完成任务显示删除线",
      "验证排序逻辑：按 sortIndex 升序排序，已完成任务在前",
      "验证边界情况：长按 Checkbox 区域不触发拖拽",
      "验证边界情况：快速连续点击 Checkbox 不会导致状态不一致",
    ],
    
    // 性能验证
    performance: [
      "验证列表滚动性能：即使任务数量增加，滚动仍然流畅",
      "验证状态切换响应时间：Checkbox 点击后 100ms 内完成状态切换",
      "验证规范化触发频率：正常情况下规范化触发频率很低（< 1%）",
    ],
    
    // 兼容性验证
    compatibility: [
      "验证 Light 和 Dark 模式下的 Checkbox 样式正确",
      "验证不同屏幕尺寸下的布局正确",
      "验证不同任务数量下的功能正常",
    ],
  },

  // ===========================================
  // 10. 数据与状态（必填）
  // ===========================================
  dataAndState: {
    // 数据模型变更
    modelChanges: [
      "无需修改 Task 模型，使用现有的 status 和 sortIndex 字段",
    ],
    
    // 持久化结构变更
    persistenceChanges: [
      "无需修改数据库结构，使用现有的 tasks 表",
      "sortIndex 字段已存在，无需新增字段",
    ],
    
    // 状态管理变更
    stateManagementChanges: [
      "无需新增 Provider，使用现有的 TaskStatusToggleHelper",
      "状态切换后自动更新 sortIndex，UI 会自动刷新（通过 Riverpod）",
    ],
  },

  // ===========================================
  // 11. 已确认问题（必填）
  // ===========================================
  confirmedQuestions: [
    {
      question: "TaskStatusService.markCompleted 是否支持传递 sortIndex？",
      answer: "不支持：markCompleted 方法只接受 taskId 和 autoCompleteParent 参数，内部调用 updateTask 时只传递 status、endedAt 和 dueAt",
      solution: "使用两步更新：先调用 markCompleted 更新状态，然后立即调用 updateDetails 更新 sortIndex",
      implementation: "在 toggleTaskStatus 的 pending -> completedActive 分支中，先调用 taskService.markCompleted，然后立即调用 taskService.updateDetails 更新 sortIndex",
      note: "两步更新虽然不在同一个事务中，但由于是连续调用，实际影响很小。如果需要严格保证原子性，可以考虑修改 markCompleted 方法支持 sortIndex，但这需要修改更多代码",
    },
    {
      question: "如何在 TaskStatusToggleHelper 中使用数据库事务？",
      answer: "TaskRepository 接口没有事务方法，DriftTaskRepository 的 _adapter.writeTransaction 是私有实现，无法直接使用",
      solution: "不使用事务，依赖查询和更新的顺序保证一致性。先查询同一区域的所有任务，计算 sortIndex，然后更新状态和 sortIndex",
      implementation: "在 toggleTaskStatus 中，先调用 repository.listSectionTasks(section) 查询任务，计算新 sortIndex，然后调用 taskService.markCompleted 或 updateDetails 更新。虽然不在事务中，但由于是顺序操作，实际影响很小",
      note: "如果需要严格保证原子性，可以考虑修改 TaskRepository 接口添加事务方法，但这会影响其他代码，当前版本暂不采用",
    },
    {
      question: "TaskSectionUtils 是否有根据 Task 计算 section 的方法？",
      answer: "存在 getSectionForDate 方法：可以使用 TaskSectionUtils.getSectionForDate(task.dueAt) 计算 section",
      solution: "在 toggleTaskStatus 中，如果 section 参数为 null，使用 TaskSectionUtils.getSectionForDate(task.dueAt) 计算",
      implementation: "在 toggleTaskStatus 方法开始处，如果 section == null，则 section = TaskSectionUtils.getSectionForDate(task.dueAt)",
      note: "已确认存在 getSectionForDate 方法，可以直接使用",
    },
    {
      question: "今日区域的已完成任务是否支持拖拽排序？",
      answer: "支持：已完成任务可以拖拽排序，但只影响已完成任务内部的排序（通过 sortIndex 控制）",
      solution: "保持现有的拖拽排序功能，已完成任务和未完成任务都可以拖拽，但通过 sortIndex 确保已完成任务始终排在未完成任务之前",
      implementation: "无需额外实现，现有的 ReorderableListView 和 sortIndex 机制已经支持",
      note: "设计文档中已明确说明支持拖拽排序，但只影响已完成任务内部的排序",
    },
    {
      question: "今日区域的已完成任务是否支持左滑/右滑操作？",
      answer: "支持：已完成任务支持左滑/右滑操作（如归档、删除），保持与未完成任务的一致性",
      solution: "保持现有的滑动操作功能，已完成任务和未完成任务使用相同的滑动配置",
      implementation: "无需额外实现，现有的 DismissibleTaskTile 和 SwipeConfigs 已经支持",
      note: "设计文档中建议保持与未完成任务的一致性，支持左滑/右滑操作",
    },
  ],
}

