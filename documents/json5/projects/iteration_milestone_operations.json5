{
  // ===========================================
  // 里程碑操作确认弹窗迭代蓝图
  // 基于 design_milestone_operations.json5 实现里程碑删除操作的两次确认弹窗
  // ===========================================
  
  // ===========================================
  // 1. 迭代概述（必填）
  // ===========================================
  iteration: {
    // 迭代 ID
    id: "250127-milestone-operations-dialog",
    
    // 迭代标题
    title: "里程碑删除操作：两次确认弹窗",
    
    // 迭代描述
    description: "实现里程碑删除操作的两次确认弹窗，与项目删除操作保持一致的交互体验。第一次确认询问是否一起处理关联任务，第二次确认显示最终操作信息。支持获取里程碑下的活跃任务数量，使用 Material Design 3 设计规范，包含图标容器、富文本强调、流畅动画等现代化UI元素",
    
    // 状态
    status: "planning",
    
    // 优先级
    priority: "high",
    
    // 基于的设计文档
    basedOnDesign: "documents/json5/projects/design_milestone_operations.json5",
    
    // 预估时间
    estimatedTime: "4-6 小时",
  },

  // ===========================================
  // 2. 文件创建清单（必填）
  // ===========================================
  files: {
    // Widget 组件
    widgets: [
      {
        path: "lib/presentation/tasks/milestones/widgets/milestone_card_dialogs.dart",
        purpose: "里程碑操作确认弹窗组件，实现两次确认弹窗逻辑",
        action: "create",
        estimatedLines: 250,
        dependencies: [
          "lib/core/providers/service_providers.dart",
          "lib/data/models/milestone.dart",
          "lib/data/models/task.dart",
          "lib/generated/l10n/app_localizations.dart",
          "lib/presentation/tasks/projects/widgets/project_card_dialogs.dart",
        ],
        details: [
          "MilestoneActionConfirmResult 类：操作确认结果，包含 includeSubItems 字段",
          "confirmMilestoneDelete 函数：统一的两次确认弹窗入口",
          "  - 获取里程碑下的任务列表（通过 TaskRepository.listTasksByMilestoneId）",
          "  - 统计活跃任务数量（pending、doing、paused 状态）",
          "  - 如果没有活跃任务，跳过第一次确认，直接进入第二次确认",
          "  - 如果有活跃任务，显示第一次确认弹窗",
          "_showFirstConfirmDialog 函数：第一次确认弹窗",
          "  - 显示里程碑标题和活跃任务数量",
          "  - 三个按钮：取消、否、是（使用 spaceBetween 对齐）",
          "  - 使用 Text.rich 实现富文本强调（里程碑标题和任务数量）",
          "_showSecondConfirmDialog 函数：第二次确认弹窗",
          "  - 根据第一次选择显示不同文案",
          "  - 显示图标容器（删除图标，errorContainer 背景）",
          "  - 两个按钮：取消、确定（右对齐）",
          "  - 确定按钮使用错误色（FilledButton.styleFrom(backgroundColor: error)）",
          "图标容器实现：",
          "  - 使用 Container 包裹 Icon，圆形背景（errorContainer）",
          "  - 图标：Icons.delete_outline_rounded，40dp 尺寸",
          "  - 容器：56dp 圆形，居中显示在标题上方",
          "  - 添加缩放+淡入动画（延迟100ms，250ms时长）",
          "富文本强调实现：",
          "  - 使用 Text.rich 和 TextSpan",
          "  - 里程碑标题和任务数量使用主色调加粗（FontWeight.w600）",
          "  - 其他文本使用默认样式",
          "动画实现：",
          "  - 弹窗使用 Material Design 3 默认动画（scale_and_fade）",
          "  - 图标容器使用 AnimatedScale + AnimatedOpacity",
          "  - 动画曲线：Curves.easeOutCubic",
          "错误处理：",
          "  - 数据获取失败时显示错误提示",
          "  - 使用 try-catch 捕获异常",
          "  - 超时处理：3秒超时机制",
        ],
      },
    ],
    
    // 服务层（可选，如果需要添加辅助方法）
    services: [
      {
        path: "lib/core/services/milestone_service.dart",
        purpose: "在 MilestoneService 中添加获取里程碑下活跃任务数量的辅助方法（可选）",
        action: "modify",
        estimatedLines: 20,
        dependencies: [
          "lib/data/repositories/task_repository.dart",
        ],
        details: [
          "hasActiveTasks 方法（可选）：检查里程碑下是否有活跃任务",
          "  - 参数：milestoneId",
          "  - 返回：bool",
          "  - 实现：获取里程碑下的任务，检查是否有 pending、doing、paused 状态的任务",
          "  - 注意：如果弹窗中直接获取任务列表，此方法可以省略",
        ],
        note: "此方法可选，如果弹窗中直接通过 TaskRepository 获取任务列表并统计，可以不需要此方法",
      },
    ],
    
    // 多语言文件
    localization: [
      {
        path: "lib/l10n/app_zh_CN.arb",
        purpose: "添加中文简体文案",
        action: "modify",
        estimatedLines: 30,
        dependencies: [],
        details: [
          "添加 commonYes 和 commonNo 键（如果不存在）",
          "添加里程碑删除相关的所有文案键：",
          "  - milestoneDeleteFirstConfirmTitle: 删除里程碑",
          "  - milestoneDeleteFirstConfirmMessage: 带占位符的消息（里程碑标题、任务数量）",
          "  - milestoneDeleteSecondConfirmTitle: 确认删除",
          "  - milestoneDeleteSecondConfirmMessageWithTasks: 包含任务的确认消息",
          "  - milestoneDeleteSecondConfirmMessageWithoutTasks: 不包含任务的确认消息",
          "  - milestoneDeleteSecondConfirmMessageNoActiveTasks: 无活跃任务时的确认消息",
          "  - milestoneDeleteConfirmButton: 确定删除",
          "所有占位符使用 @ 注释定义类型（String 或 int）",
        ],
      },
      {
        path: "lib/l10n/app_en.arb",
        purpose: "添加英文文案",
        action: "modify",
        estimatedLines: 30,
        dependencies: [],
        details: [
          "添加对应的英文翻译",
          "保持与中文文案相同的键名和占位符结构",
        ],
      },
      {
        path: "lib/l10n/app_zh_HK.arb",
        purpose: "添加繁体中文文案",
        action: "modify",
        estimatedLines: 30,
        dependencies: [],
        details: [
          "添加对应的繁体中文翻译",
          "保持与中文简体文案相同的键名和占位符结构",
        ],
      },
    ],
  },

  // ===========================================
  // 3. 需要修改的现有文件（必填）
  // ===========================================
  modifications: [
    {
      file: "lib/presentation/tasks/milestones/milestone_card.dart",
      purpose: "更新删除里程碑的调用，使用新的两次确认弹窗",
      estimatedLines: 30,
      changes: [
        "导入新的弹窗组件：milestone_card_dialogs.dart",
        "修改 _deleteMilestone 方法：",
        "  - 移除旧的简单确认弹窗代码",
        "  - 调用 confirmMilestoneDelete 函数",
        "  - 根据返回结果执行删除操作",
        "  - 保持错误处理和 SnackBar 提示逻辑",
      ],
    },
  ],

  // ===========================================
  // 4. 实现步骤（必填）
  // ===========================================
  // 注意：阶段完成后自动执行下一阶段，不需要沟通确认
  // AI 开发将完成所有功能，按顺序执行所有阶段
  // 每个阶段完成时忽略 pre-commit，强行 git commit（使用 --no-verify 选项）
  // 
  // 错误处理策略：
  // - 如果某个任务失败，先尝试修复（如 analyze issues、测试失败），修复后继续
  // - 如果无法自动修复（如需要人工决策），记录问题并继续下一个任务，在阶段完成时总结所有未解决问题
  // - build_runner 冲突：使用 --delete-conflicting-outputs 参数自动删除冲突文件
  // - analyze issues 无法自动修复：记录到 commit message 中，标记为已知问题，继续后续任务
  implementationSteps: [
    {
      step: 1,
      title: "阶段 1：添加多语言文案",
      description: "在三个多语言文件中添加里程碑删除操作相关的所有文案键",
      tasks: [
        {
          task: "检查 app_zh_CN.arb 中是否已有 commonYes 和 commonNo 键",
          file: "lib/l10n/app_zh_CN.arb",
          action: "如果不存在，添加这两个键",
        },
        {
          task: "在 app_zh_CN.arb 中添加里程碑删除相关的所有文案键",
          file: "lib/l10n/app_zh_CN.arb",
          action: [
            "添加 milestoneDeleteFirstConfirmTitle: 删除里程碑",
            "添加 milestoneDeleteFirstConfirmMessage: 里程碑「{milestoneTitle}」下还有 {taskCount} 个活跃任务。\\n\\n您想将它们一起删除吗？",
            "添加 @milestoneDeleteFirstConfirmMessage 注释，定义 placeholders（milestoneTitle: String, taskCount: int）",
            "添加 milestoneDeleteSecondConfirmTitle: 确认删除",
            "添加 milestoneDeleteSecondConfirmMessageWithTasks: 您将永久删除里程碑「{milestoneTitle}」。所有任务将保留，但不再关联到此里程碑。\\n\\n此操作无法撤销。",
            "添加 @milestoneDeleteSecondConfirmMessageWithTasks 注释，定义 placeholders（milestoneTitle: String）",
            "添加 milestoneDeleteSecondConfirmMessageWithoutTasks: 您将永久删除里程碑「{milestoneTitle}」，但保留所有任务。任务将不再关联到此里程碑。\\n\\n此操作无法撤销。",
            "添加 @milestoneDeleteSecondConfirmMessageWithoutTasks 注释，定义 placeholders（milestoneTitle: String）",
            "添加 milestoneDeleteSecondConfirmMessageNoActiveTasks: 您将永久删除里程碑「{milestoneTitle}」，但保留所有任务。任务将不再关联到此里程碑。\\n\\n此操作无法撤销。",
            "添加 @milestoneDeleteSecondConfirmMessageNoActiveTasks 注释，定义 placeholders（milestoneTitle: String）",
            "添加 milestoneDeleteConfirmButton: 确定删除",
          ],
        },
        {
          task: "在 app_en.arb 中添加对应的英文翻译",
          file: "lib/l10n/app_en.arb",
          action: [
            "添加 commonYes: Yes（如果不存在）",
            "添加 commonNo: No（如果不存在）",
            "添加所有里程碑删除相关的英文翻译，保持相同的键名和占位符结构",
          ],
        },
        {
          task: "在 app_zh_HK.arb 中添加对应的繁体中文翻译",
          file: "lib/l10n/app_zh_HK.arb",
          action: [
            "添加 commonYes: 是（如果不存在）",
            "添加 commonNo: 否（如果不存在）",
            "添加所有里程碑删除相关的繁体中文翻译，保持相同的键名和占位符结构",
          ],
        },
        {
          task: "运行 flutter gen-l10n 生成本地化代码",
          command: "flutter gen-l10n",
          action: "生成多语言代码，确保新的文案键可用",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 添加里程碑删除操作的多语言文案'",
          action: "提交阶段 1 的所有更改，忽略 pre-commit 钩子",
        },
      ],
    },
    {
      step: 2,
      title: "阶段 2：创建里程碑操作确认弹窗组件",
      description: "创建 milestone_card_dialogs.dart 文件，实现两次确认弹窗逻辑",
      tasks: [
        {
          task: "创建 milestone_card_dialogs.dart 文件",
          file: "lib/presentation/tasks/milestones/widgets/milestone_card_dialogs.dart",
          action: [
            "创建文件目录结构（如果不存在）",
            "添加必要的导入：flutter/material.dart, flutter_riverpod, service_providers, models, l10n",
            "定义 MilestoneActionConfirmResult 类（类似 ProjectActionConfirmResult）",
            "实现 confirmMilestoneDelete 主函数：",
            "  - 参数：context, ref, milestone",
            "  - 使用 try-catch 包裹整个函数体，捕获异常",
            "  - 获取 TaskRepository（通过 ref.read(taskRepositoryProvider.future)）",
            "  - 使用 Future.timeout 包裹 TaskRepository.listTasksByMilestoneId 调用，超时时间 3 秒",
            "  - 统计活跃任务（pending、doing、paused 状态）",
            "  - 如果没有活跃任务，跳过第一次确认，直接调用 _showSecondConfirmDialog（includeSubItems: false）",
            "  - 如果有活跃任务，调用 _showFirstConfirmDialog",
            "  - 如果 _showFirstConfirmDialog 返回 null（用户取消），返回 null",
            "  - 如果 _showFirstConfirmDialog 返回 bool，调用 _showSecondConfirmDialog（includeSubItems: 返回值）",
            "  - 如果 _showSecondConfirmDialog 返回 null（用户取消），返回 null",
            "  - 如果 _showSecondConfirmDialog 返回 true，返回 MilestoneActionConfirmResult（includeSubItems: 第一次选择的值）",
            "  - 异常处理：捕获 TimeoutException 和其他异常，显示 SnackBar 错误提示，返回 null",
            "实现 _showFirstConfirmDialog 函数：",
            "  - 使用 showDialog 显示 AlertDialog",
            "  - 标题：l10n.milestoneDeleteFirstConfirmTitle",
            "  - 内容：使用 Text.rich 实现富文本，强调里程碑标题和任务数量",
            "  - 三个按钮：取消（pop null）、否（pop false）、是（pop true）",
            "  - 按钮顺序：在 actions 数组中按顺序添加（取消、否、是），AlertDialog 会自动从右到左排列",
            "  - 按钮对齐：使用 actionsAlignment: MainAxisAlignment.spaceBetween（Flutter 3.13+支持）",
            "  - 如果 Flutter 版本不支持 actionsAlignment，使用自定义 actions 布局：",
            "    * 将 actions 设为空数组",
            "    * 在 content 下方添加自定义按钮行（Row + MainAxisAlignment.spaceBetween）",
            "  - 返回 bool?（true=是, false=否, null=取消）",
            "实现 _showSecondConfirmDialog 函数：",
            "  - 参数：context, l10n, milestone, includeSubItems",
            "  - 使用 showDialog 显示 AlertDialog",
            "  - 使用 Column 包裹整个内容区域（图标容器 + 标题 + 内容）",
            "  - 图标容器：位于 Column 顶部，居中显示（Center widget）",
            "  - 图标容器：56dp 圆形，errorContainer 背景，40dp 删除图标",
            "  - 标题：l10n.milestoneDeleteSecondConfirmTitle，位于图标容器下方（间距16dp）",
            "  - 内容：根据 includeSubItems 选择不同的文案，位于标题下方（间距16dp）",
            "  - 两个按钮：取消（pop false）、确定删除（pop true）",
            "  - 确定按钮使用错误色（FilledButton.styleFrom(backgroundColor: error)）",
            "  - 按钮右对齐（AlertDialog 默认，或使用 actionsAlignment: MainAxisAlignment.end）",
            "实现图标容器 Widget：",
            "  - 创建独立的 _buildIconContainer 方法",
            "  - 使用 Container 包裹 Icon（Icons.delete_outline_rounded）",
            "  - 圆形背景（BoxDecoration + shape: BoxShape.circle + color: errorContainer）",
            "  - 尺寸：56dp x 56dp（width 和 height 都设为 56）",
            "  - 图标颜色：onErrorContainer，尺寸：40dp",
            "  - 使用 AnimatedScale 和 AnimatedOpacity 包裹 Container 实现动画",
            "  - 动画延迟100ms，时长250ms，曲线 Curves.easeOutCubic",
            "  - 初始状态：scale 0.8，opacity 0.0",
            "  - 最终状态：scale 1.0，opacity 1.0",
            "实现富文本强调：",
            "  - 创建 _buildRichText 方法，参数：milestoneTitle, taskCount",
            "  - 使用 Text.rich 和 TextSpan.children 构建富文本",
            "  - 创建 emphasisStyle：TextStyle(color: colorScheme.primary, fontWeight: FontWeight.w600)",
            "  - 文本结构：",
            "    * TextSpan(text: '里程碑「') - 普通文本",
            "    * TextSpan(text: milestoneTitle, style: emphasisStyle) - 强调里程碑标题",
            "    * TextSpan(text: '」下还有 ') - 普通文本",
            "    * TextSpan(text: '$taskCount', style: emphasisStyle) - 强调任务数量",
            "    * TextSpan(text: ' 个活跃任务。\\n\\n您想将它们一起删除吗？') - 普通文本",
            "  - 使用 l10n.milestoneDeleteFirstConfirmMessage 获取基础文本，然后手动构建 TextSpan",
            "  - 或者直接使用占位符替换后的文本，然后手动解析并应用样式",
            "数据获取超时处理：",
            "  - 在 confirmMilestoneDelete 函数中，使用 Future.timeout 包裹数据获取操作",
            "  - 超时时间：3秒（Duration(seconds: 3)）",
            "  - 超时处理：显示错误提示（SnackBar），返回 null（取消操作）",
            "  - 错误处理：使用 try-catch 捕获异常，显示错误提示，返回 null",
          ],
        },
        {
          task: "运行 flutter analyze 检查代码质量",
          command: "flutter analyze",
          action: "检查是否有 lint 错误，修复所有错误",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 实现里程碑删除操作的两次确认弹窗组件'",
          action: "提交阶段 2 的所有更改，忽略 pre-commit 钩子",
        },
      ],
    },
    {
      step: 3,
      title: "阶段 3：更新里程碑卡片删除操作",
      description: "修改 milestone_card.dart，使用新的两次确认弹窗",
      tasks: [
        {
          task: "更新 milestone_card.dart 的导入",
          file: "lib/presentation/tasks/milestones/milestone_card.dart",
          action: "添加导入：import '../widgets/milestone_card_dialogs.dart';",
        },
        {
          task: "修改 _deleteMilestone 方法",
          file: "lib/presentation/tasks/milestones/milestone_card.dart",
          action: [
            "移除旧的 showDialog 代码",
            "调用 confirmMilestoneDelete(context, ref, milestone)",
            "检查返回结果：",
            "  - 如果为 null，直接返回（用户取消）",
            "  - 如果为 MilestoneActionConfirmResult，继续执行删除",
            "保持现有的删除逻辑和错误处理",
            "保持 SnackBar 提示逻辑",
            "注意：无论用户选择是否包含任务，实际删除操作都是删除里程碑（任务会保留，但 milestoneId 会被设为 null）",
          ],
        },
        {
          task: "运行 flutter analyze 检查代码质量",
          command: "flutter analyze",
          action: "检查是否有 lint 错误，修复所有错误",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 更新里程碑卡片使用新的两次确认弹窗'",
          action: "提交阶段 3 的所有更改，忽略 pre-commit 钩子",
        },
      ],
    },
    {
      step: 4,
      title: "阶段 4：编写单元测试",
      description: "为里程碑操作确认弹窗编写单元测试",
      tasks: [
        {
          task: "创建 milestone_card_dialogs_test.dart 测试文件",
          file: "test/presentation/tasks/milestones/widgets/milestone_card_dialogs_test.dart",
          action: [
            "创建测试文件（如果目录不存在，先创建）",
            "编写测试用例：",
            "  - 测试有活跃任务时的两次确认流程",
            "  - 测试无活跃任务时的简化流程（跳过第一次确认）",
            "  - 测试用户取消操作",
            "  - 测试富文本强调是否正确",
            "  - 测试图标容器是否正确显示",
            "  - 测试按钮点击行为",
            "使用 mock 模拟 TaskRepository 和 MilestoneService",
            "使用 WidgetTester 测试弹窗显示和交互",
          ],
        },
        {
          task: "运行单元测试",
          command: "flutter test test/presentation/tasks/milestones/widgets/milestone_card_dialogs_test.dart",
          action: "运行测试，确保所有测试通过",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'test: 添加里程碑删除操作弹窗的单元测试'",
          action: "提交阶段 4 的所有更改，忽略 pre-commit 钩子",
        },
      ],
    },
    {
      step: 5,
      title: "阶段 5：编写集成测试",
      description: "为里程碑删除操作编写集成测试",
      tasks: [
        {
          task: "更新或创建集成测试",
          file: "integration_test/user_operations_integration_test.dart",
          action: [
            "查找现有的里程碑删除测试（test_project_007）",
            "更新测试用例，验证两次确认弹窗的交互：",
            "  - 测试有活跃任务时的两次确认流程",
            "  - 测试无活跃任务时的简化流程",
            "  - 测试用户取消操作",
            "  - 验证删除后任务保留但 milestoneId 为 null",
            "使用真实的数据库和服务（不使用 mock）",
            "使用 WidgetTester 模拟用户交互（点击按钮）",
          ],
        },
        {
          task: "运行集成测试",
          command: "flutter test integration_test/user_operations_integration_test.dart --tags milestone",
          action: "运行集成测试，确保所有测试通过（如果测试时间较长，可以设置超时）",
        },
        {
          task: "阶段完成：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'test: 更新里程碑删除操作的集成测试'",
          action: "提交阶段 5 的所有更改，忽略 pre-commit 钩子",
        },
      ],
    },
    {
      step: 6,
      title: "阶段 6：代码质量检查和最终验证",
      description: "运行所有测试和代码质量检查，确保功能完整",
      tasks: [
        {
          task: "运行 flutter analyze",
          command: "flutter analyze",
          action: "检查所有 lint 错误，修复所有错误和警告",
        },
        {
          task: "运行所有单元测试",
          command: "flutter test",
          action: "运行所有单元测试，确保没有回归",
        },
        {
          task: "运行 flutter test --coverage 生成测试覆盖率报告",
          command: "flutter test --coverage",
          action: "生成测试覆盖率报告，确保新代码有足够的测试覆盖",
        },
        {
          task: "手动测试验证",
          action: [
            "在应用中手动测试里程碑删除操作：",
            "  - 测试有活跃任务的里程碑删除",
            "  - 测试无活跃任务的里程碑删除",
            "  - 测试取消操作",
            "  - 验证弹窗样式和动画",
            "  - 验证删除后任务的状态（milestoneId 应为 null）",
          ],
        },
        {
          task: "最终提交：忽略 pre-commit，强行 git commit",
          command: "git add -A && git commit --no-verify -m 'feat: 完成里程碑删除操作的两次确认弹窗实现'",
          action: "提交所有最终更改，忽略 pre-commit 钩子",
        },
      ],
    },
  ],

  // ===========================================
  // 5. 技术细节和注意事项（必填）
  // ===========================================
  technicalDetails: {
    // 关键技术决策
    keyDecisions: {
      // 数据获取方式
      dataFetching: {
        method: "在弹窗函数中直接通过 TaskRepository.listTasksByMilestoneId 获取任务列表",
        reason: "避免在 MilestoneService 中添加额外方法，保持服务层简洁。弹窗需要实时数据，直接获取更合适",
        alternative: "在 MilestoneService 中添加 hasActiveTasks 方法（可选）",
      },
      
      // 弹窗实现方式
      dialogImplementation: {
        method: "使用 Flutter 的 AlertDialog，自定义 content 和 actions",
        reason: "与现有项目操作弹窗保持一致，使用 Material Design 3 的对话框主题",
        alternative: "使用自定义 Dialog Widget（不推荐，会增加复杂度）",
        note: "AlertDialog 的 actions 数组从右到左排列，所以代码中按钮顺序应为：取消、否、是",
      },
      
      // 按钮对齐方式
      buttonAlignment: {
        method: "使用 actionsAlignment 参数（Flutter 3.13+）或自定义布局",
        reason: "Flutter 3.13+ 支持 actionsAlignment 参数，可以直接设置 spaceBetween",
        implementation: [
          "如果 Flutter 版本 >= 3.13：使用 actionsAlignment: MainAxisAlignment.spaceBetween",
          "如果 Flutter 版本 < 3.13：使用自定义布局（将 actions 设为空，在 content 下方添加 Row）",
        ],
        fallback: "使用自定义布局：在 content 下方添加 Row，使用 MainAxisAlignment.spaceBetween",
      },
      
      // 图标容器实现
      iconContainer: {
        method: "使用 Container + Icon，添加 AnimatedScale 和 AnimatedOpacity，使用 Column 包裹",
        reason: "简单直接，符合 Material Design 3 规范，动画流畅。使用 Column 可以灵活控制布局",
        layout: [
          "使用 Column 包裹图标容器、标题和内容",
          "图标容器位于 Column 顶部，使用 Center 居中",
          "标题位于图标容器下方，间距 16dp",
          "内容位于标题下方，间距 16dp",
        ],
        alternative: "使用 AnimatedContainer（不推荐，性能较差）",
      },
      
      // 富文本实现
      richText: {
        method: "使用 Text.rich 和 TextSpan.children，手动构建文本结构",
        reason: "Flutter 标准方式，性能好，易于维护。可以精确控制每个部分的样式",
        implementation: [
          "使用 l10n.milestoneDeleteFirstConfirmMessage 获取基础文本（带占位符）",
          "手动替换占位符，然后使用 TextSpan.children 构建富文本结构",
          "为里程碑标题和任务数量创建 emphasisStyle（主色调 + FontWeight.w600）",
          "其他文本使用默认样式",
        ],
        alternative: "使用多个 Text Widget（不推荐，布局复杂，性能较差）",
      },
      
      // 超时机制
      timeoutHandling: {
        method: "使用 Future.timeout 包裹数据获取操作",
        reason: "防止数据获取时间过长，提供良好的用户体验",
        implementation: [
          "在 confirmMilestoneDelete 函数中，使用 Future.timeout 包裹 TaskRepository.listTasksByMilestoneId 调用",
          "超时时间：Duration(seconds: 3)",
          "超时处理：捕获 TimeoutException，显示 SnackBar 错误提示，返回 null",
          "其他异常：使用 try-catch 捕获，显示 SnackBar 错误提示，返回 null",
        ],
        userFeedback: "使用 ScaffoldMessenger.of(context).showSnackBar 显示错误提示",
      },
    },
    
    // 代码规范要求
    codeStandards: {
      // 类型安全
      typeSafety: {
        rule: "所有函数必须有明确的返回类型，使用强类型",
        location: "milestone_card_dialogs.dart",
        example: "Future<MilestoneActionConfirmResult?> confirmMilestoneDelete(...)",
        note: "遵循 Flutter 和 Dart 的类型安全最佳实践",
      },
      
      // 错误处理
      errorHandling: {
        rule: "所有异步操作必须使用 try-catch 处理错误",
        location: "confirmMilestoneDelete 函数",
        example: "try { ... } catch (e, stackTrace) { debugPrint('Error: $e'); return null; }",
        note: "错误时返回 null，表示用户取消操作",
      },
      
      // 可访问性
      accessibility: {
        rule: "按钮必须有足够的点击区域（最小48x48dp），使用语义化标签",
        location: "弹窗按钮",
        example: "使用 FilledButton 和 TextButton，它们默认符合可访问性要求",
        note: "Material Design 3 的按钮组件默认符合可访问性标准",
      },
    },
    
    // 性能考虑
    performance: {
      optimization: [
        "任务列表获取使用 listTasksByMilestoneId，只获取该里程碑下的任务，避免加载所有任务",
        "图标容器动画使用 AnimatedScale 和 AnimatedOpacity，性能优于 AnimatedContainer",
        "富文本使用 Text.rich，性能优于多个 Text Widget",
        "弹窗使用 Material Design 3 默认动画，已优化性能",
      ],
      monitoring: [
        "监控弹窗打开时间（应该在100ms以内）",
        "监控数据获取时间（应该在50ms以内）",
      ],
    },
    
    // 安全考虑
    security: {
      concerns: [
        "删除操作需要两次确认，防止误操作",
        "所有用户输入（里程碑标题）在显示前需要转义（Flutter Text Widget 自动处理）",
        "数据库操作使用事务，确保数据一致性",
      ],
    },
  },

  // ===========================================
  // 6. 依赖关系图（必填）
  // ===========================================
  dependencies: {
    // 数据层依赖
    dataLayer: [
      "lib/data/models/milestone.dart - 里程碑模型",
      "lib/data/models/task.dart - 任务模型和 TaskStatus 枚举",
      "lib/data/repositories/task_repository.dart - 任务仓库接口",
    ],
    
    // Repository 层依赖
    repositoryLayer: [
      "lib/data/repositories/drift/drift_task_repository.dart - 任务仓库实现（通过接口）",
    ],
    
    // 服务层依赖
    serviceLayer: [
      "lib/core/providers/service_providers.dart - 服务 Provider（TaskRepository, MilestoneService）",
    ],
    
    // UI 组件层依赖
    uiLayer: [
      "lib/presentation/tasks/milestones/milestone_card.dart - 里程碑卡片（调用弹窗）",
      "lib/presentation/tasks/projects/widgets/project_card_dialogs.dart - 项目操作弹窗（参考实现）",
    ],
    
    // 本地化依赖
    localizationLayer: [
      "lib/generated/l10n/app_localizations.dart - 生成的本地化类",
      "lib/l10n/app_zh_CN.arb - 中文简体文案",
      "lib/l10n/app_en.arb - 英文文案",
      "lib/l10n/app_zh_HK.arb - 繁体中文文案",
    ],
  },

  // ===========================================
  // 7. 测试策略和详细测试用例（必填）
  // ===========================================
  testing: {
    // 单元测试
    unitTests: [
      {
        file: "test/presentation/tasks/milestones/widgets/milestone_card_dialogs_test.dart",
        description: "测试里程碑删除操作确认弹窗的交互逻辑",
        testCases: [
          {
            group: "confirmMilestoneDelete 函数测试",
            cases: [
              {
                name: "有活跃任务时显示两次确认",
                test: "创建里程碑和活跃任务 → 调用 confirmMilestoneDelete → 验证第一次确认弹窗显示 → 选择"是" → 验证第二次确认弹窗显示 → 确认删除 → 验证返回结果",
              },
              {
                name: "无活跃任务时跳过第一次确认",
                test: "创建里程碑但无活跃任务 → 调用 confirmMilestoneDelete → 验证直接显示第二次确认弹窗 → 确认删除 → 验证返回结果",
              },
              {
                name: "用户取消第一次确认",
                test: "显示第一次确认弹窗 → 点击取消 → 验证返回 null",
              },
              {
                name: "用户取消第二次确认",
                test: "显示第二次确认弹窗 → 点击取消 → 验证返回 null",
              },
              {
                name: "数据获取失败处理",
                test: "模拟 TaskRepository 抛出异常 → 调用 confirmMilestoneDelete → 验证返回 null 或显示错误",
              },
            ],
          },
          {
            group: "弹窗 UI 测试",
            cases: [
              {
                name: "第一次确认弹窗显示正确",
                test: "显示第一次确认弹窗 → 验证标题、内容、按钮都正确显示 → 验证富文本强调正确应用",
              },
              {
                name: "第二次确认弹窗显示图标容器",
                test: "显示第二次确认弹窗 → 验证图标容器显示 → 验证图标容器动画",
              },
              {
                name: "第二次确认弹窗按钮样式正确",
                test: "显示第二次确认弹窗 → 验证确定按钮使用错误色 → 验证按钮对齐方式",
              },
            ],
          },
        ],
      },
    ],
    
    // Widget 测试
    widgetTests: [
      {
        file: "test/presentation/tasks/milestones/milestone_card_test.dart",
        description: "测试里程碑卡片删除操作的集成（如果文件存在）",
        testCases: [
          {
            group: "删除操作集成测试",
            cases: [
              {
                name: "点击删除按钮触发确认弹窗",
                test: "显示里程碑卡片 → 点击菜单中的删除 → 验证确认弹窗显示",
              },
              {
                name: "确认删除后执行删除操作",
                test: "触发删除 → 确认删除 → 验证里程碑被删除 → 验证 SnackBar 显示",
              },
            ],
          },
        ],
        note: "如果 milestone_card_test.dart 不存在，可以创建或更新现有的测试文件",
      },
    ],
    
    // 集成测试
    integrationTests: [
      {
        file: "integration_test/user_operations_integration_test.dart",
        description: "更新现有的里程碑删除集成测试，验证两次确认流程",
        testCases: [
          {
            group: "里程碑删除操作集成测试",
            cases: [
              {
                name: "删除有活跃任务的里程碑",
                test: "创建项目和里程碑 → 创建活跃任务 → 删除里程碑 → 验证两次确认弹窗 → 确认删除 → 验证里程碑被删除 → 验证任务保留但 milestoneId 为 null",
              },
              {
                name: "删除无活跃任务的里程碑",
                test: "创建项目和里程碑（无活跃任务）→ 删除里程碑 → 验证直接显示第二次确认 → 确认删除 → 验证里程碑被删除",
              },
              {
                name: "取消删除操作",
                test: "触发删除 → 在第一次或第二次确认时取消 → 验证里程碑未被删除",
              },
            ],
          },
        ],
      },
    ],
  },

  // ===========================================
  // 8. 风险点和注意事项（必填）
  // ===========================================
  risks: [
    {
      risk: "数据获取性能问题",
      mitigation: "使用 listTasksByMilestoneId 只获取该里程碑下的任务，避免加载所有任务。如果任务数量很大，可以考虑添加缓存或限制",
      priority: "medium",
      check: "测试删除有大量任务的里程碑时的性能",
    },
    {
      risk: "多语言占位符处理错误",
      mitigation: "严格按照 Flutter intl 包的占位符格式定义，使用 @ 注释定义类型。运行 flutter gen-l10n 验证生成代码正确",
      priority: "high",
      check: "运行 flutter gen-l10n 后检查生成的代码，验证占位符方法签名正确",
      enforcement: "在阶段 1 完成后必须运行 flutter gen-l10n 并验证",
    },
    {
      risk: "动画性能问题",
      mitigation: "使用 AnimatedScale 和 AnimatedOpacity，避免使用 AnimatedContainer。动画时长控制在250ms以内",
      priority: "low",
      check: "在低端设备上测试动画流畅度",
    },
    {
      risk: "与项目操作弹窗不一致",
      mitigation: "参考 project_card_dialogs.dart 的实现，保持相同的代码结构和样式。使用相同的按钮样式和对齐方式。注意按钮顺序：AlertDialog 的 actions 从右到左排列，代码中顺序应为：取消、否、是",
      priority: "high",
      check: "对比项目操作弹窗和里程碑操作弹窗的视觉效果和交互行为",
      enforcement: "代码审查时重点检查一致性",
    },
    {
      risk: "按钮对齐方式实现错误",
      mitigation: "优先使用 actionsAlignment 参数（Flutter 3.13+），如果不支持则使用自定义布局（Row + MainAxisAlignment.spaceBetween）。确保三个按钮分散对齐，两个按钮右对齐",
      priority: "medium",
      check: "测试不同 Flutter 版本的按钮对齐效果，确保符合设计文档要求",
      enforcement: "在实现时检查 Flutter 版本，选择合适的实现方式",
    },
    {
      risk: "图标容器布局不正确",
      mitigation: "使用 Column 包裹图标容器、标题和内容，确保图标容器位于顶部居中。使用 Center widget 包裹图标容器，设置正确的间距（16dp）",
      priority: "medium",
      check: "测试图标容器的位置和间距，确保符合设计文档要求",
      enforcement: "代码审查时检查布局结构",
    },
    {
      risk: "富文本实现复杂或性能问题",
      mitigation: "使用 Text.rich 和 TextSpan.children 手动构建文本结构，避免使用多个 Text Widget。为强调部分创建 emphasisStyle，其他部分使用默认样式",
      priority: "low",
      check: "测试富文本的显示效果和性能，确保文本正确强调且无性能问题",
      enforcement: "代码审查时检查富文本实现方式",
    },
    {
      risk: "数据获取超时或异常处理不当",
      mitigation: "使用 Future.timeout 包裹数据获取操作，超时时间 3 秒。捕获 TimeoutException 和其他异常，显示 SnackBar 错误提示，返回 null 取消操作。确保用户能够看到错误信息",
      priority: "medium",
      check: "测试数据获取超时和异常情况，确保错误提示正确显示",
      enforcement: "代码审查时检查异常处理逻辑",
    },
    {
      risk: "删除操作后任务状态不正确",
      mitigation: "根据数据库外键约束，删除里程碑时任务的 milestoneId 会自动设为 null。不需要额外处理。但需要在测试中验证",
      priority: "high",
      check: "集成测试中验证删除里程碑后任务的 milestoneId 为 null",
      enforcement: "必须通过集成测试验证",
    },
  ],

  // ===========================================
  // 9. 验证清单（必填）
  // ===========================================
  verification: {
    // 代码质量检查
    codeQuality: [
      "运行 flutter analyze，确保没有 lint 错误",
      "运行 flutter test，确保所有单元测试通过",
      "运行 flutter test --coverage，确保新代码有足够的测试覆盖（目标：80%以上）",
      "代码审查，确保符合代码规范和设计文档",
    ],
    
    // 功能验证
    functionality: [
      "验证有活跃任务时的两次确认流程正常工作",
      "验证无活跃任务时跳过第一次确认",
      "验证用户取消操作时不会执行删除",
      "验证删除后任务保留但 milestoneId 为 null",
      "验证弹窗样式符合 Material Design 3 规范",
      "验证图标容器动画流畅",
      "验证富文本强调正确显示",
      "验证按钮对齐和样式正确",
      "验证多语言文案正确显示",
    ],
    
    // 性能验证
    performance: [
      "弹窗打开时间 < 100ms",
      "数据获取时间 < 50ms",
      "动画流畅，无卡顿",
    ],
    
    // 兼容性验证
    compatibility: [
      "在不同屏幕尺寸上测试（小屏、大屏）",
      "在 Light 和 Dark 模式下测试",
      "测试系统字体缩放（TextScaler）",
      "测试键盘导航（Tab、Enter、ESC）",
    ],
    
    // 可访问性验证
    accessibility: [
      "按钮点击区域 >= 48x48dp",
      "颜色对比度符合 WCAG AA 标准（Material 3 自动保证）",
      "文本大小符合最小可读性要求",
    ],
  },

  // ===========================================
  // 10. 数据与状态（必填）
  // ===========================================
  dataAndState: {
    // 数据模型变更
    modelChanges: [
      "无数据模型变更，使用现有的 Milestone 和 Task 模型",
    ],
    
    // 持久化结构变更
    persistenceChanges: [
      "无持久化结构变更，删除操作使用现有的 MilestoneRepository.delete 方法",
      "数据库外键约束（Task → Milestone 为 SET NULL）会自动处理任务关联",
    ],
    
    // 状态管理变更
    stateManagementChanges: [
      "无状态管理变更，弹窗使用本地状态（showDialog 的返回值）",
      "使用 Riverpod 的 service_providers 获取服务实例",
    ],
  },

  // ===========================================
  // 11. 重构和复用计划（必填）
  // ===========================================
  refactoringAndReuse: {
    // 当前问题分析
    currentIssues: [
      "项目操作弹窗（project_card_dialogs.dart）和里程碑操作弹窗会有大量重复代码",
      "两次确认流程逻辑重复（数据获取、统计、弹窗显示）",
      "按钮构建逻辑重复（三个按钮的 spaceBetween 布局、两个按钮的右对齐）",
      "图标容器实现重复（56dp 圆形、动画效果）",
      "富文本强调实现重复（Text.rich 构建逻辑）",
      "错误处理和超时机制重复",
    ],
    
    // 重构目标
    refactoringGoals: [
      "提取通用的两次确认弹窗基类或工具函数",
      "提取可复用的 UI 组件（图标容器、富文本构建器）",
      "减少代码重复，提高可维护性",
      "保持向后兼容，不影响现有功能",
    ],
    
    // 重构方案
    refactoringPlan: {
      // 方案1：提取通用组件（推荐，分阶段实施）
      approach1: {
        name: "提取通用组件（分阶段）",
        description: "先实现里程碑弹窗，然后提取公共逻辑到通用组件",
        phases: [
          {
            phase: "阶段 1：实现里程碑弹窗（当前迭代）",
            tasks: [
              "创建 milestone_card_dialogs.dart，参考 project_card_dialogs.dart 的实现",
              "实现里程碑删除的两次确认弹窗",
              "保持与项目操作弹窗一致的代码结构，便于后续提取",
            ],
            note: "在当前迭代中，先实现功能，保持代码结构一致，为后续重构做准备",
          },
          {
            phase: "阶段 2：提取通用组件（后续迭代）",
            tasks: [
              "创建 lib/presentation/widgets/confirmation_dialogs/ 目录",
              "提取通用组件：",
              "  - confirmation_dialog_icon_container.dart：图标容器组件（带动画）",
              "  - confirmation_dialog_rich_text_builder.dart：富文本构建工具",
              "  - confirmation_dialog_buttons.dart：按钮布局组件",
              "  - two_step_confirmation_dialog.dart：两次确认弹窗基类或工具函数",
              "重构 project_card_dialogs.dart 使用通用组件",
              "重构 milestone_card_dialogs.dart 使用通用组件",
              "确保向后兼容，所有测试通过",
            ],
            estimatedTime: "2-3 小时",
            priority: "medium",
            note: "在里程碑弹窗实现完成后，可以安排一个专门的重构迭代",
          },
        ],
        benefits: [
          "不影响当前迭代进度",
          "先验证功能正确性，再优化代码结构",
          "降低重构风险",
        ],
        risks: [
          "可能会产生一些临时重复代码",
          "需要后续重构迭代",
        ],
      },
      
      // 方案2：立即提取通用组件（不推荐）
      approach2: {
        name: "立即提取通用组件",
        description: "在实现里程碑弹窗的同时提取通用组件",
        tasks: [
          "创建通用组件目录和文件",
          "提取图标容器、富文本构建器等组件",
          "同时重构项目操作弹窗和实现里程碑弹窗",
        ],
        benefits: [
          "避免代码重复",
          "一次性完成重构",
        ],
        risks: [
          "增加当前迭代复杂度",
          "可能影响项目操作弹窗的稳定性",
          "需要同时修改多个文件，风险较高",
        ],
        recommendation: "不推荐，风险较高，建议采用方案1",
      },
    },
    
    // 可复用的组件清单
    reusableComponents: [
      {
        component: "图标容器（IconContainer）",
        location: "lib/presentation/widgets/confirmation_dialogs/confirmation_dialog_icon_container.dart",
        purpose: "通用的图标容器组件，支持不同图标、颜色和动画",
        parameters: [
          "icon: IconData - 图标",
          "backgroundColor: Color - 背景色（如 errorContainer）",
          "iconColor: Color - 图标颜色（如 onErrorContainer）",
          "size: double - 容器尺寸（默认 56）",
          "iconSize: double - 图标尺寸（默认 40）",
          "animationDelay: Duration - 动画延迟（默认 100ms）",
          "animationDuration: Duration - 动画时长（默认 250ms）",
        ],
        usage: "项目删除、里程碑删除等需要图标容器的场景",
      },
      {
        component: "富文本构建器（RichTextBuilder）",
        location: "lib/presentation/widgets/confirmation_dialogs/confirmation_dialog_rich_text_builder.dart",
        purpose: "通用的富文本构建工具，支持强调特定文本",
        parameters: [
          "baseText: String - 基础文本（带占位符）",
          "placeholders: Map<String, String> - 占位符映射",
          "emphasisKeys: List<String> - 需要强调的占位符键",
          "emphasisStyle: TextStyle - 强调样式",
        ],
        usage: "需要强调关键信息的弹窗文案",
      },
      {
        component: "按钮布局组件（ConfirmationDialogButtons）",
        location: "lib/presentation/widgets/confirmation_dialogs/confirmation_dialog_buttons.dart",
        purpose: "通用的按钮布局组件，支持不同的按钮配置",
        parameters: [
          "buttons: List<ConfirmationButton> - 按钮列表",
          "alignment: MainAxisAlignment - 对齐方式（spaceBetween 或 end）",
          "onCancel: VoidCallback? - 取消回调",
          "onConfirm: VoidCallback? - 确认回调",
        ],
        usage: "所有确认弹窗的按钮区域",
      },
      {
        component: "两次确认弹窗工具类（TwoStepConfirmationDialog）",
        location: "lib/presentation/widgets/confirmation_dialogs/two_step_confirmation_dialog.dart",
        purpose: "通用的两次确认弹窗工具类，封装通用逻辑",
        parameters: [
          "context: BuildContext",
          "firstConfirmConfig: FirstConfirmConfig - 第一次确认配置",
          "secondConfirmConfig: SecondConfirmConfig - 第二次确认配置",
          "dataLoader: Future<ConfirmationData> Function() - 数据加载函数",
          "skipFirstIfEmpty: bool - 如果数据为空是否跳过第一次确认",
        ],
        usage: "项目操作、里程碑操作等需要两次确认的场景",
        note: "这是一个更高级的重构方案，需要仔细设计接口，确保灵活性",
      },
    ],
    
    // 重构时机建议
    refactoringTiming: {
      currentIteration: {
        action: "不进行重构，先实现功能",
        reason: "降低风险，确保功能正确性，保持迭代进度",
        note: "在实现时保持代码结构一致，为后续重构做准备",
      },
      nextIteration: {
        action: "安排专门的重构迭代",
        reason: "在功能验证通过后，进行代码优化",
        estimatedTime: "2-3 小时",
        priority: "medium",
        tasks: [
          "提取通用组件",
          "重构项目操作弹窗",
          "重构里程碑操作弹窗",
          "更新测试用例",
          "确保所有测试通过",
        ],
      },
    },
    
    // 代码重复度评估
    codeDuplicationAssessment: {
      estimatedDuplication: "约 60-70%",
      duplicatedAreas: [
        "两次确认流程逻辑：约 80% 重复",
        "按钮构建逻辑：约 90% 重复",
        "图标容器实现：约 100% 重复",
        "富文本强调实现：约 70% 重复",
        "错误处理逻辑：约 80% 重复",
      ],
      impact: "如果不重构，后续添加新的操作类型（如任务删除）时，会继续产生重复代码",
      recommendation: "在里程碑弹窗实现完成后，尽快安排重构迭代",
    },
  },

  // ===========================================
  // 12. 文档同步（必填）
  // ===========================================
  documentation: {
    // 需要更新的文档
    updates: [
      {
        file: "documents/json5/projects/design_milestone_operations.json5",
        action: "无需更新，设计文档已完成",
      },
      {
        file: "README.md",
        action: "如果 README 中有功能列表，可以添加里程碑删除操作的说明（可选）",
      },
    ],
    
    // API 文档（如果适用）
    apiDocumentation: [
      {
        component: "confirmMilestoneDelete 函数",
        description: "里程碑删除操作的两次确认弹窗入口函数",
        parameters: [
          "context: BuildContext - 构建上下文",
          "ref: WidgetRef - Riverpod 引用",
          "milestone: Milestone - 要删除的里程碑",
        ],
        returns: "Future<MilestoneActionConfirmResult?> - 确认结果，包含 includeSubItems 字段；null 表示用户取消",
        example: "final result = await confirmMilestoneDelete(context, ref, milestone);",
      },
    ],
  },
}

