{
  // 导入导出功能迭代计划文档
  // 详细描述实现步骤、文件创建、代码结构和技术细节
  
  // ===========================================
  // 1. 迭代概述
  // ===========================================
  iteration: {
    id: "251215-export-import",
    title: "数据导入导出功能实现",
    description: "实现项目、里程碑和任务的导入导出功能，支持跨设备数据同步，使用业务ID（UUID v4）进行冲突检测和合并",
    status: "planning",
    estimatedTime: "3-4 days",
    priority: "high",
  },

  // ===========================================
  // 2. 文件创建清单
  // ===========================================
  files: {
    // 数据模型
    models: [
      {
        path: "lib/data/models/export_data.dart",
        purpose: "导出数据模型定义（JSON序列化）",
        estimatedLines: 150,
        dependencies: [
          "lib/data/models/task.dart",
          "lib/data/models/project.dart",
          "lib/data/models/milestone.dart",
        ],
        note: "包含 ExportData 类和序列化方法",
      },
    ],
    
    // 服务层
    services: [
      {
        path: "lib/core/services/export_service.dart",
        purpose: "导出服务：收集数据、序列化、打包ZIP",
        estimatedLines: 200,
        dependencies: [
          "lib/data/repositories/task_repository.dart",
          "lib/data/repositories/project_repository.dart",
          "lib/data/repositories/milestone_repository.dart",
          "lib/data/models/export_data.dart",
          "archive 包（ZIP压缩）",
          "path_provider 包（临时目录）",
        ],
      },
      {
        path: "lib/core/services/import_service.dart",
        purpose: "导入服务：解压ZIP、解析JSON、导入数据、冲突处理",
        estimatedLines: 300,
        dependencies: [
          "lib/data/repositories/task_repository.dart",
          "lib/data/repositories/project_repository.dart",
          "lib/data/repositories/milestone_repository.dart",
          "lib/core/services/project_service.dart",
          "lib/core/services/milestone_service.dart",
          "lib/core/services/task_service.dart",
          "lib/data/models/export_data.dart",
          "archive 包（ZIP解压）",
        ],
      },
    ],
    
    // UI 组件
    widgets: [
      {
        path: "lib/presentation/navigation/widgets/export_import_section.dart",
        purpose: "导出导入功能UI组件（设置页面使用）",
        estimatedLines: 150,
        dependencies: [
          "lib/core/services/export_service.dart",
          "lib/core/services/import_service.dart",
          "share_plus 包（文件分享）",
          "file_picker 包（文件选择）",
        ],
      },
    ],
    
    // 工具函数
    utils: [
      {
        path: "lib/core/utils/id_generator.dart",
        purpose: "UUID v4 生成工具（统一ID生成）",
        estimatedLines: 50,
        dependencies: [
          "uuid 包",
        ],
        note: "统一所有业务ID的生成方式，确保使用UUID v4",
      },
      {
        path: "lib/core/utils/uuid_validator.dart",
        purpose: "UUID格式验证工具（可选）",
        estimatedLines: 30,
        dependencies: [],
        note: "用于导入时验证UUID格式，可以使用 uuid 包的验证功能或正则表达式",
      },
    ],
    
    // 测试文件
    tests: [
      {
        path: "test/core/services/export_service_test.dart",
        purpose: "导出服务单元测试",
        estimatedLines: 150,
        dependencies: [],
      },
      {
        path: "test/core/services/import_service_test.dart",
        purpose: "导入服务单元测试（包含冲突处理测试）",
        estimatedLines: 200,
        dependencies: [],
      },
      {
        path: "test/presentation/navigation/widgets/export_import_section_test.dart",
        purpose: "导出导入UI组件Widget测试",
        estimatedLines: 100,
        dependencies: [],
      },
      {
        path: "integration_test/export_import_test.dart",
        purpose: "导入导出集成测试（完整流程）",
        estimatedLines: 150,
        dependencies: [],
      },
    ],
  },

  // ===========================================
  // 3. 需要修改的现有文件
  // ===========================================
  modifications: [
    {
      file: "pubspec.yaml",
      purpose: "添加依赖：uuid、archive、file_picker",
      changes: [
        "添加 uuid: ^4.0.0 到 dependencies",
        "添加 archive: ^3.4.0 到 dependencies",
        "添加 file_picker: ^6.0.0 到 dependencies",
        "确认 share_plus 和 path_provider 已存在",
      ],
      estimatedLines: 5,
    },
    {
      file: "lib/core/services/project_service_helpers.dart",
      purpose: "修改项目ID生成逻辑，使用UUID v4",
      changes: [
        "导入 id_generator.dart",
        "修改 generateProjectId 方法，使用 UUID v4 生成",
        "移除原有的时间戳+随机数生成逻辑",
      ],
      estimatedLines: 10,
    },
    {
      file: "lib/core/services/milestone_service.dart",
      purpose: "修改里程碑ID生成逻辑，使用UUID v4",
      changes: [
        "导入 id_generator.dart",
        "修改 _generateMilestoneId 方法，使用 UUID v4 生成",
        "移除原有的时间戳+随机数生成逻辑",
      ],
      estimatedLines: 10,
    },
    {
      file: "lib/data/repositories/task_repository_helpers.dart",
      purpose: "修改任务ID生成逻辑，使用UUID v4",
      changes: [
        "导入 id_generator.dart",
        "修改 _generateTaskId 方法，使用 UUID v4 生成",
        "删除 _getMaxSequenceInSecond 方法（不再需要）",
        "删除 _parseTaskId 方法（不再需要）",
      ],
      estimatedLines: 10,
    },
    {
      file: "lib/core/services/seed_import_service.dart",
      purpose: "修改种子导入中的里程碑ID生成，使用UUID v4",
      changes: [
        "导入 id_generator.dart",
        "修改里程碑ID生成逻辑（第158-159行），使用 UUID v4",
        "移除原有的时间戳+随机数生成逻辑",
      ],
      estimatedLines: 5,
      note: "任务ID会自动使用新的UUID v4生成逻辑（通过createTask调用）",
    },
    {
      file: "lib/data/repositories/task_repository.dart",
      purpose: "添加 findByTaskId 方法和 createTaskWithId 方法",
      changes: [
        "在 TaskRepository 抽象类中添加 findByTaskId(String taskId) 方法",
        "在 TaskRepositoryQueries mixin 中实现 findByTaskId",
        "在 TaskRepository 抽象类中添加 createTaskWithId(TaskDraft draft, String taskId) 方法",
        "在 TaskRepositoryMutationsCore mixin 中实现 createTaskWithId",
      ],
      estimatedLines: 30,
      note: "createTaskWithId 用于导入时保持原有的 taskId",
    },
    {
      file: "lib/data/isar/task_entity.dart",
      purpose: "为 taskId 添加索引以提高查询性能",
      changes: [
        "在 taskId 字段上添加 @Index() 注解",
        "运行 build_runner 重新生成代码",
      ],
      estimatedLines: 2,
    },
    {
      file: "lib/data/repositories/project_repository.dart",
      purpose: "添加 createProjectWithId 方法",
      changes: [
        "在 ProjectRepository 抽象类中添加 createProjectWithId(ProjectDraft draft, String projectId) 方法",
        "在 IsarProjectRepository 中实现 createProjectWithId",
      ],
      estimatedLines: 20,
      note: "用于导入时保持原有的 projectId",
    },
    {
      file: "lib/data/repositories/milestone_repository.dart",
      purpose: "添加 createMilestoneWithId 方法和 listAll 方法",
      changes: [
        "在 MilestoneRepository 抽象类中添加 createMilestoneWithId(MilestoneDraft draft, String milestoneId) 方法",
        "在 IsarMilestoneRepository 中实现 createMilestoneWithId",
        "在 MilestoneRepository 抽象类中添加 listAll() 方法",
        "在 IsarMilestoneRepository 中实现 listAll（查询所有里程碑，不过滤状态）",
      ],
      estimatedLines: 30,
      note: "createMilestoneWithId 用于导入时保持原有的 milestoneId，listAll 用于导出时查询所有里程碑",
    },
    {
      file: "lib/presentation/navigation/settings_controls.dart",
      purpose: "在设置页面添加导出导入功能区域",
      changes: [
        "导入 export_import_section.dart",
        "在 Timer 区之后添加 ExportImportSection 组件",
        "使用 _SettingCard 包装",
      ],
      estimatedLines: 15,
    },
    {
      file: "lib/l10n/app_en.arb",
      purpose: "添加导出导入相关的英文翻译",
      changes: [
        "添加 settingsExportImport: 'Export & Import'",
        "添加 settingsExport: 'Export Data'",
        "添加 settingsExportDescription: 'Export projects, milestones and tasks'",
        "添加 settingsImport: 'Import Data'",
        "添加 settingsImportDescription: 'Import data from file'",
        "添加 settingsExportSuccess: 'Export successful'",
        "添加 settingsExportError: 'Export failed'",
        "添加 settingsImportSuccess: 'Import successful'",
        "添加 settingsImportError: 'Import failed'",
        "添加 settingsImportComplete: 'Import Complete'",
        "添加 settingsImportProjects: 'Projects'",
        "添加 settingsImportMilestones: 'Milestones'",
        "添加 settingsImportTasks: 'Tasks'",
        "添加 commonCreated: 'Created'",
        "添加 commonUpdated: 'Updated'",
        "添加 commonSkipped: 'Skipped'",
        "添加 settingsImportErrors: 'Errors'",
        "添加 settingsImportConflictTitle: 'Data Conflict'",
        "添加 settingsImportConflictMessage: 'Found {count} conflicts, will update based on timestamp'",
        "添加 @settingsImportConflictMessage 的 placeholders 定义",
        "添加 settingsImportInvalidFile: 'Invalid file format'",
        "添加 settingsImportFileNotFound: 'File not found'",
        "添加 settingsImportOrphanedData: 'Some data references are missing'",
        "添加 settingsImportUUIDValidationError: 'Invalid ID format in import file'",
      ],
      estimatedLines: 25,
      note: "需要按字母顺序插入",
    },
    {
      file: "lib/l10n/app_zh_CN.arb",
      purpose: "添加导出导入相关的中文（简体）翻译",
      changes: [
        "添加所有对应的中文翻译键",
        "settingsExportImport: '导出和导入'",
        "settingsExport: '导出数据'",
        "settingsExportDescription: '导出项目、里程碑和任务'",
        "settingsImport: '导入数据'",
        "settingsImportDescription: '从文件导入数据'",
        "settingsExportSuccess: '导出成功'",
        "settingsExportError: '导出失败'",
        "settingsImportSuccess: '导入成功'",
        "settingsImportError: '导入失败'",
        "settingsImportComplete: '导入完成'",
        "settingsImportProjects: '项目'",
        "settingsImportMilestones: '里程碑'",
        "settingsImportTasks: '任务'",
        "commonCreated: '已创建'",
        "commonUpdated: '已更新'",
        "commonSkipped: '已跳过'",
        "settingsImportErrors: '错误'",
        "settingsImportConflictTitle: '数据冲突'",
        "settingsImportConflictMessage: '发现 {count} 个冲突，将根据时间戳决定是否更新'",
        "settingsImportInvalidFile: '无效的文件格式'",
        "settingsImportFileNotFound: '文件未找到'",
        "settingsImportOrphanedData: '部分数据引用缺失'",
        "settingsImportUUIDValidationError: '导入文件中的ID格式无效'",
      ],
      estimatedLines: 25,
      note: "需要按字母顺序插入",
    },
    {
      file: "lib/l10n/app_zh.arb",
      purpose: "添加导出导入相关的中文（繁体）翻译",
      changes: [
        "添加所有对应的繁体中文翻译键",
      ],
      estimatedLines: 25,
      note: "需要按字母顺序插入",
    },
    {
      file: "lib/l10n/app_zh_HK.arb",
      purpose: "添加导出导入相关的中文（香港繁体）翻译",
      changes: [
        "添加所有对应的香港繁体中文翻译键",
      ],
      estimatedLines: 25,
      note: "需要按字母顺序插入",
    },
  ],

  // ===========================================
  // 4. 实现步骤（按顺序）
  // ===========================================
  implementationSteps: [
    {
      step: 1,
      title: "准备阶段：依赖和ID生成工具",
      description: "添加依赖并创建统一的ID生成工具",
      tasks: [
        {
          task: "添加依赖到 pubspec.yaml",
          file: "pubspec.yaml",
          action: "添加 uuid、archive、file_picker 依赖",
        },
        {
          task: "运行 flutter pub get",
          command: "flutter pub get",
        },
        {
          task: "创建 id_generator.dart",
          file: "lib/core/utils/id_generator.dart",
          action: "实现 UUID v4 生成函数",
          details: [
            "使用 uuid 包生成 UUID v4",
            "提供 generateId() 函数返回 String",
          ],
        },
      ],
      estimatedTime: "30 minutes",
    },
    
    {
      step: 2,
      title: "修改ID生成逻辑：使用UUID v4",
      description: "将所有业务ID生成改为使用UUID v4",
      tasks: [
        {
          task: "修改项目ID生成",
          file: "lib/core/services/project_service_helpers.dart",
          action: "修改 generateProjectId 使用 UUID v4",
        },
        {
          task: "修改里程碑ID生成",
          file: "lib/core/services/milestone_service.dart",
          action: "修改 _generateMilestoneId 使用 UUID v4",
        },
        {
          task: "修改任务ID生成",
          file: "lib/data/repositories/task_repository_helpers.dart",
          action: "修改 _generateTaskId 使用 UUID v4，删除不再需要的辅助方法",
        },
        {
          task: "修改种子导入中的里程碑ID生成",
          file: "lib/core/services/seed_import_service.dart",
          action: "修改里程碑ID生成使用 UUID v4",
        },
        {
          task: "运行测试确保ID生成正常",
          command: "flutter test",
        },
      ],
      estimatedTime: "1 hour",
    },
    
    {
      step: 3,
      title: "数据模型：创建导出数据模型",
      description: "定义导出数据的JSON结构",
      tasks: [
        {
          task: "创建 export_data.dart",
          file: "lib/data/models/export_data.dart",
          action: "实现导出数据模型",
          structure: {
            version: "1.0",
            exportedAt: "ISO 8601 时间戳",
            projects: "List<Project>",
            milestones: "List<Milestone>",
            tasks: "List<Task>",
          },
          methods: [
            "toJson() - 序列化为JSON（手动实现，排除 Isar id 字段）",
            "fromJson(Map<String, dynamic>) - 从JSON反序列化（手动实现）",
            "辅助方法：_projectToJson, _milestoneToJson, _taskToJson",
            "辅助方法：_projectFromJson, _milestoneFromJson, _taskFromJson",
          ],
          serialization: {
            projects: "手动序列化 Project 模型的所有字段（排除 id）",
            milestones: "手动序列化 Milestone 模型的所有字段（排除 id）",
            tasks: "手动序列化 Task 模型的所有字段（排除 id, projectIsarId, milestoneIsarId）",
            logs: "序列化日志列表（ProjectLogEntry, MilestoneLogEntry, TaskLogEntry）",
            dateTime: "DateTime 序列化为 ISO 8601 字符串",
            enums: "TaskStatus 序列化为字符串（name）",
          },
        },
      ],
      estimatedTime: "1.5 hours",
    },
    
    {
      step: 4,
      title: "Repository扩展：添加查询和创建方法",
      description: "添加基于业务ID的查询和创建方法",
      tasks: [
        {
          task: "为 taskId 添加索引",
          file: "lib/data/isar/task_entity.dart",
          action: "在 taskId 字段添加 @Index()",
        },
        {
          task: "运行 build_runner",
          command: "flutter pub run build_runner build --delete-conflicting-outputs",
        },
        {
          task: "添加 findByTaskId 方法",
          file: "lib/data/repositories/task_repository.dart",
          action: "在抽象类和实现中添加方法",
        },
        {
          task: "添加 createTaskWithId 方法",
          file: "lib/data/repositories/task_repository.dart",
          action: "支持导入时指定 taskId",
        },
        {
          task: "添加 createProjectWithId 方法",
          file: "lib/data/repositories/project_repository.dart",
          action: "支持导入时指定 projectId",
        },
        {
          task: "添加 createMilestoneWithId 和 listAll 方法",
          file: "lib/data/repositories/milestone_repository.dart",
          action: "支持导入时指定 milestoneId，支持导出时查询所有里程碑",
        },
      ],
      estimatedTime: "2 hours",
    },
    
    {
      step: 5,
      title: "导出服务：实现数据收集和打包",
      description: "实现导出功能，收集数据并打包为ZIP",
      tasks: [
        {
          task: "创建 export_service.dart",
          file: "lib/core/services/export_service.dart",
          action: "实现导出服务",
          features: [
            "collectExportData() - 收集所有需要导出的数据",
            "过滤规则：排除 pseudoDeleted 状态，包含 trashed 状态",
            "exportToZip() - 序列化为JSON并打包为ZIP",
            "文件名格式：yymmddhhmm.flow.grano",
            "使用 archive 包创建ZIP文件",
            "使用 path_provider 获取临时目录",
          ],
          dataCollection: {
            projects: "使用 projectRepository.listAll() 查询所有项目，过滤排除 pseudoDeleted",
            milestones: "使用 milestoneRepository.listAll() 查询所有里程碑，过滤排除 pseudoDeleted",
            tasks: "使用 taskRepository.listAll() 查询所有任务，过滤包含 trashed，排除 pseudoDeleted",
          },
        },
        {
          task: "添加 Provider",
          file: "lib/core/providers/service_providers.dart",
          action: "添加 exportServiceProvider 和 importServiceProvider",
          details: [
            "exportServiceProvider: 依赖 taskRepository, projectRepository, milestoneRepository",
            "importServiceProvider: 依赖 taskRepository, projectRepository, milestoneRepository, projectService, milestoneService, taskService",
          ],
        },
      ],
      estimatedTime: "2.5 hours",
    },
    
    {
      step: 6,
      title: "导入服务：实现数据解析和导入",
      description: "实现导入功能，包括冲突检测和合并",
      tasks: [
        {
          task: "创建 import_service.dart",
          file: "lib/core/services/import_service.dart",
          action: "实现导入服务",
          features: [
            "importFromZip(File) - 解压ZIP并解析JSON",
            "UUID格式验证：验证所有业务ID为有效的UUID v4格式",
            "冲突检测：使用业务ID（projectId/milestoneId/taskId）判断",
            "时间戳比较：使用 updatedAt 决定是否更新",
            "关系映射：建立业务ID到本地Isar ID的映射",
            "Isar ID设置：导入后设置 projectIsarId 和 milestoneIsarId",
            "两轮导入：第一轮导入实体，第二轮建立父子关系",
            "返回 ImportResult 统计信息",
          ],
          importStrategy: {
            projects: "使用 projectId 判断，不存在则创建（使用 createProjectWithId），存在则比较 updatedAt 决定是否更新",
            milestones: "使用 milestoneId 判断，通过 projectId 查找关联项目，设置 projectIsarId，不存在则创建（使用 createMilestoneWithId），存在则比较 updatedAt",
            tasks: "使用 taskId 判断，通过 projectId/milestoneId 查找关联并设置 projectIsarId/milestoneIsarId，不存在则创建（使用 createTaskWithId），存在则比较 updatedAt 决定是否更新，更新时需要重新设置 projectIsarId/milestoneIsarId（因为 update 方法不会自动设置），两轮处理父子关系",
          },
          conflictResolution: {
            notExists: "创建新实体（保持原有的 createdAt 和 updatedAt）",
            existsAndNewer: "更新本地数据（更新所有字段，但保持原有的 createdAt，使用导入数据的 updatedAt）",
            existsAndOlder: "跳过（保持本地数据不变）",
            sameTimestamp: "跳过（避免重复处理）",
          },
          fieldHandling: {
            createdAt: "导入时保持原有的 createdAt（不修改）",
            updatedAt: "导入时使用导入数据的 updatedAt（用于冲突判断）",
            logs: "导入时合并日志（追加导入数据的日志到现有日志）",
            templateLockCount: "导入时保持导入数据的值（如果导入数据有值）",
          },
        },
      ],
      estimatedTime: "4 hours",
    },
    
    {
      step: 7,
      title: "UI组件：导出导入功能界面",
      description: "创建设置页面的导出导入UI组件",
      tasks: [
        {
          task: "创建 export_import_section.dart",
          file: "lib/presentation/navigation/widgets/export_import_section.dart",
          action: "实现UI组件",
          features: [
            "导出按钮：触发导出，使用 share_plus 分享文件",
            "导入按钮：使用 file_picker 选择文件，触发导入",
            "显示加载状态",
            "显示成功/失败提示",
            "导入完成后显示统计信息对话框",
          ],
          ui: {
            export: "ListTile with upload icon",
            import: "ListTile with download icon",
            loading: "CircularProgressIndicator",
            result: "AlertDialog with statistics",
          },
        },
        {
          task: "集成到设置页面",
          file: "lib/presentation/navigation/settings_controls.dart",
          action: "添加 ExportImportSection 组件",
        },
      ],
      estimatedTime: "2 hours",
    },
    
    {
      step: 8,
      title: "本地化：添加翻译",
      description: "添加所有语言的翻译键",
      tasks: [
        {
          task: "添加英文翻译",
          file: "lib/l10n/app_en.arb",
          action: "添加所有导出导入相关的翻译键",
        },
        {
          task: "添加简体中文翻译",
          file: "lib/l10n/app_zh_CN.arb",
          action: "添加所有导出导入相关的翻译键",
        },
        {
          task: "添加繁体中文翻译",
          file: "lib/l10n/app_zh.arb",
          action: "添加所有导出导入相关的翻译键",
        },
        {
          task: "添加香港繁体中文翻译",
          file: "lib/l10n/app_zh_HK.arb",
          action: "添加所有导出导入相关的翻译键",
        },
        {
          task: "运行代码生成",
          command: "flutter gen-l10n",
        },
      ],
      estimatedTime: "1 hour",
    },
    
    {
      step: 9,
      title: "测试：单元测试",
      description: "编写单元测试覆盖核心逻辑",
      tasks: [
        {
          task: "创建 export_service_test.dart",
          file: "test/core/services/export_service_test.dart",
          action: "测试导出服务",
          testGroups: [
            "数据收集测试（过滤规则）",
            "JSON序列化测试",
            "ZIP打包测试",
            "文件名格式测试",
          ],
        },
        {
          task: "创建 import_service_test.dart",
          file: "test/core/services/import_service_test.dart",
          action: "测试导入服务",
          testGroups: [
            "ZIP解压和JSON解析测试",
            "冲突检测测试",
            "时间戳比较测试",
            "关系映射测试",
            "两轮导入测试",
            "孤立数据处理测试",
            "错误处理测试",
            "Isar ID映射测试（projectIsarId, milestoneIsarId）",
            "UUID格式验证测试",
          ],
        },
      ],
      estimatedTime: "3 hours",
    },
    
    {
      step: 10,
      title: "测试：Widget测试",
      description: "编写Widget测试覆盖UI组件",
      tasks: [
        {
          task: "创建 export_import_section_test.dart",
          file: "test/presentation/navigation/widgets/export_import_section_test.dart",
          action: "测试UI组件",
          testGroups: [
            "组件渲染测试",
            "导出按钮交互测试",
            "导入按钮交互测试",
            "加载状态显示测试",
            "结果对话框显示测试",
          ],
        },
      ],
      estimatedTime: "1.5 hours",
    },
    
    {
      step: 11,
      title: "测试：集成测试",
      description: "编写集成测试覆盖完整流程",
      tasks: [
        {
          task: "创建 export_import_test.dart",
          file: "integration_test/export_import_test.dart",
          action: "测试完整导入导出流程",
          testGroups: [
            "完整导出导入流程测试",
            "跨设备冲突处理测试",
            "大量数据导入导出测试",
            "损坏文件处理测试",
          ],
        },
      ],
      estimatedTime: "2 hours",
    },
    
    {
      step: 12,
      title: "代码检查和优化",
      description: "代码质量检查和优化",
      tasks: [
        {
          task: "运行 flutter analyze",
          command: "flutter analyze",
          action: "检查代码质量，修复所有错误和警告",
        },
        {
          task: "运行 flutter test",
          command: "flutter test",
          action: "运行所有测试，确保通过",
        },
        {
          task: "代码格式检查",
          command: "dart format . --line-length 100",
          action: "格式化代码",
        },
      ],
      estimatedTime: "1 hour",
    },
  ],

  // ===========================================
  // 5. 技术细节和注意事项
  // ===========================================
  technicalDetails: {
    // ID生成策略
    idGeneration: {
      method: "UUID v4",
      library: "uuid 包",
      reason: "确保跨设备唯一性，避免ID冲突",
      implementation: "统一使用 id_generator.dart 中的 generateId() 函数",
      affected: [
        "projectId - 项目业务ID",
        "milestoneId - 里程碑业务ID",
        "taskId - 任务业务ID",
      ],
      note: "所有业务ID都使用UUID v4，不需要考虑老数据兼容（会清空重建）",
    },
    
    // 导出数据格式
    exportFormat: {
      fileExtension: ".flow.grano",
      fileNameFormat: "yymmddhhmm.flow.grano",
      example: "2412151430.flow.grano",
      compression: "ZIP",
      innerFile: "data.json",
      jsonStructure: {
        version: "1.0",
        exportedAt: "ISO 8601 时间戳",
        projects: "List<Project> (不包含 Isar id，只包含业务ID)",
        milestones: "List<Milestone> (不包含 Isar id，只包含业务ID)",
        tasks: "List<Task> (不包含 Isar id，只包含业务ID)",
      },
      serialization: {
        method: "手动实现 toJson/fromJson（模型没有 json_serializable）",
        excludeFields: ["id (Isar id)", "projectIsarId", "milestoneIsarId (对于任务)"],
        includeFields: ["所有业务字段", "业务ID (projectId/milestoneId/taskId)"],
      },
    },
    
    // 数据过滤规则
    dataFiltering: {
      export: {
        projects: "排除 status == pseudoDeleted",
        milestones: "排除 status == pseudoDeleted",
        tasks: "包含 status == trashed，排除 status == pseudoDeleted",
      },
      import: {
        validation: "验证JSON结构完整性",
        orphaned: "孤立数据（引用的项目/里程碑不存在）记录错误并跳过",
      },
    },
    
    // 冲突处理策略
    conflictResolution: {
      detection: "使用业务ID（projectId/milestoneId/taskId）判断是否存在",
      comparison: "使用 updatedAt 时间戳比较新旧",
      rules: {
        notExists: "创建新实体（使用 createXxxWithId 保持原有ID）",
        existsAndNewer: "更新本地数据（使用 update 方法）",
        existsAndOlder: "跳过（保持本地数据不变）",
        sameTimestamp: "跳过（避免重复处理）",
      },
      note: "所有更新操作都使用业务ID查找，然后使用Isar ID更新",
    },
    
    // 关系处理
    relationshipHandling: {
      importOrder: [
        "第一轮：导入项目",
        "第二轮：导入里程碑（需要项目ID映射）",
        "第三轮：导入任务（需要项目/里程碑ID映射，不设置父任务关系）",
        "第四轮：建立任务父子关系（通过 taskId 查找父任务）",
      ],
      mapping: {
        projects: "projectId (导出) -> projectId (本地) -> Isar id",
        milestones: "milestoneId (导出) -> milestoneId (本地) -> Isar id, projectId -> projectIsarId 映射",
        tasks: "taskId (导出) -> taskId (本地) -> Isar id, projectId -> projectIsarId, milestoneId -> milestoneIsarId, parentTaskId -> parentTaskId (Isar id) 映射",
      },
      isarIdSetting: {
        milestones: "导入里程碑后，通过 projectId 查找项目的 Isar id，设置 projectIsarId（创建时设置，更新时也需要重新设置）",
        tasks: "导入任务后，通过 projectId/milestoneId 查找项目/里程碑的 Isar id，设置 projectIsarId/milestoneIsarId（创建时设置，更新时也需要重新设置，因为 update 方法不会自动设置）",
        parentTasks: "第二轮导入时，通过 parentTaskId (taskId) 查找父任务的 Isar id，设置 parentTaskId (Isar id)",
        note: "注意：TaskRepository.updateTask 方法在更新 projectId/milestoneId 时不会自动设置 projectIsarId/milestoneIsarId，导入时需要手动查找并设置",
      },
    },
    
    // 文件操作
    fileOperations: {
      export: {
        method: "share_plus 包",
        platforms: [
          "iOS: ShareSheet",
          "Android: Share Intent",
          "Desktop: 文件保存对话框",
        ],
        tempLocation: "path_provider 临时目录",
      },
      import: {
        method: "file_picker 包",
        platforms: [
          "iOS: 文件选择器",
          "Android: 文件选择器",
          "Desktop: 文件选择对话框",
        ],
        validation: "验证文件扩展名为 .flow.grano",
        permissions: {
          android: "可能需要 READ_EXTERNAL_STORAGE 权限（Android 10以下）",
          ios: "需要配置 Info.plist 中的文件访问权限",
          note: "file_picker 包通常会自动处理权限，但需要确认",
        },
      },
    },
    
    // 性能考虑
    performance: {
      largeData: "对于大量数据（1000+任务），使用流式处理或分批导入",
      indexing: "taskId 添加索引以提高查询性能",
      memory: "ZIP文件在内存中处理，注意大文件的内存占用",
    },
    
    // 错误处理
    errorHandling: {
      export: {
        dataCollection: "捕获异常，显示错误提示",
        serialization: "验证数据完整性",
        zipCreation: "捕获IO异常",
      },
      import: {
        fileRead: "验证文件存在和可读",
        zipExtraction: "验证ZIP格式",
        jsonParsing: "验证JSON格式和结构",
        dataValidation: "验证业务ID格式（UUID v4格式）",
        uuidValidation: "验证 projectId/milestoneId/taskId 是否为有效的UUID v4格式",
        importProcess: "记录所有错误，继续处理其他数据",
        isarIdMapping: "导入后需要设置 projectIsarId 和 milestoneIsarId（通过业务ID查找），创建和更新时都需要设置",
      },
    },
  },

  // ===========================================
  // 6. 依赖关系图
  // ===========================================
  dependencies: {
    // 数据层
    dataLayer: [
      "lib/data/models/task.dart",
      "lib/data/models/project.dart",
      "lib/data/models/milestone.dart",
      "lib/data/models/export_data.dart (新建)",
      "lib/data/repositories/task_repository.dart",
      "lib/data/repositories/project_repository.dart",
      "lib/data/repositories/milestone_repository.dart",
    ],
    
    // 服务层
    serviceLayer: [
      "lib/core/services/export_service.dart (新建)",
      "lib/core/services/import_service.dart (新建)",
      "lib/core/services/project_service.dart",
      "lib/core/services/milestone_service.dart",
      "lib/core/services/task_service.dart",
    ],
    
    // 工具层
    utilsLayer: [
      "lib/core/utils/id_generator.dart (新建)",
      "lib/core/utils/uuid_validator.dart (可选，用于验证UUID格式)",
    ],
    
    // UI组件层
    uiLayer: [
      "lib/presentation/navigation/widgets/export_import_section.dart (新建)",
      "lib/presentation/navigation/settings_controls.dart",
    ],
    
    // 外部依赖
    externalDependencies: [
      "uuid: ^4.0.0",
      "archive: ^3.4.0",
      "file_picker: ^6.0.0",
      "share_plus: (已存在)",
      "path_provider: (已存在)",
    ],
  },

  // ===========================================
  // 7. 测试策略和详细测试用例
  // ===========================================
  testing: {
    // 单元测试
    unitTests: [
      {
        file: "test/core/services/export_service_test.dart",
        description: "导出服务单元测试",
        testCases: [
          {
            group: "数据收集",
            cases: [
              {
                name: "应该收集所有非伪删除的项目",
                test: "创建多个项目（包含 pseudoDeleted），验证只导出非伪删除的项目",
              },
              {
                name: "应该收集所有非伪删除的里程碑",
                test: "创建多个里程碑（包含 pseudoDeleted），验证只导出非伪删除的里程碑",
              },
              {
                name: "应该收集所有任务（包含 trashed，排除 pseudoDeleted）",
                test: "创建多个任务（包含 trashed 和 pseudoDeleted），验证导出包含 trashed，排除 pseudoDeleted",
              },
            ],
          },
          {
            group: "JSON序列化",
            cases: [
              {
                name: "应该正确序列化为JSON",
                test: "验证导出的JSON包含所有必需字段",
              },
              {
                name: "JSON应该不包含 Isar id",
                test: "验证导出的JSON中不包含 id 字段（只包含业务ID）",
              },
            ],
          },
          {
            group: "ZIP打包",
            cases: [
              {
                name: "应该正确创建ZIP文件",
                test: "验证ZIP文件包含 data.json",
              },
              {
                name: "文件名格式应该正确",
                test: "验证文件名格式为 yymmddhhmm.flow.grano",
              },
            ],
          },
        ],
      },
      {
        file: "test/core/services/import_service_test.dart",
        description: "导入服务单元测试",
        testCases: [
          {
            group: "ZIP解压和JSON解析",
            cases: [
              {
                name: "应该正确解压ZIP文件",
                test: "验证能正确读取 data.json",
              },
              {
                name: "应该正确解析JSON",
                test: "验证能正确解析为 ExportData 对象",
              },
              {
                name: "应该验证UUID格式",
                test: "导入包含无效UUID格式的数据，验证抛出异常或记录错误",
              },
              {
                name: "损坏的ZIP文件应该抛出异常",
                test: "使用损坏的ZIP文件，验证抛出异常",
              },
              {
                name: "无效的JSON应该抛出异常",
                test: "使用无效的JSON，验证抛出异常",
              },
            ],
          },
          {
            group: "冲突检测",
            cases: [
              {
                name: "不存在的项目应该创建",
                test: "导入不存在的项目，验证创建新项目",
              },
              {
                name: "存在的项目且导入数据更新应该更新",
                test: "导入已存在的项目（updatedAt 更新），验证更新本地数据",
              },
              {
                name: "存在的项目且本地数据更新应该跳过",
                test: "导入已存在的项目（本地 updatedAt 更新），验证跳过",
              },
              {
                name: "相同时间戳应该跳过",
                test: "导入已存在的项目（updatedAt 相同），验证跳过",
              },
            ],
          },
          {
            group: "关系映射",
            cases: [
              {
                name: "里程碑应该正确关联项目",
                test: "导入里程碑，验证通过 projectId 找到关联项目",
              },
              {
                name: "任务应该正确关联项目和里程碑",
                test: "导入任务，验证通过 projectId/milestoneId 找到关联",
              },
              {
                name: "任务应该正确建立父子关系",
                test: "导入父子任务，验证第二轮导入后建立父子关系",
              },
              {
                name: "导入后应该正确设置 projectIsarId 和 milestoneIsarId",
                test: "导入任务后，验证 projectIsarId 和 milestoneIsarId 正确设置",
              },
              {
                name: "导入里程碑后应该正确设置 projectIsarId",
                test: "导入里程碑后，验证 projectIsarId 正确设置",
              },
            ],
          },
          {
            group: "孤立数据处理",
            cases: [
              {
                name: "引用的项目不存在应该记录错误",
                test: "导入里程碑（引用的项目不存在），验证记录错误并跳过",
              },
              {
                name: "引用的里程碑不存在应该记录错误",
                test: "导入任务（引用的里程碑不存在），验证记录错误并跳过",
              },
              {
                name: "引用的父任务不存在应该记录错误",
                test: "导入任务（引用的父任务不存在），验证记录错误并跳过",
              },
            ],
          },
        ],
      },
    ],
    
    // Widget测试
    widgetTests: [
      {
        file: "test/presentation/navigation/widgets/export_import_section_test.dart",
        description: "导出导入UI组件Widget测试",
        testCases: [
          {
            group: "组件渲染",
            cases: [
              {
                name: "应该正确渲染导出和导入按钮",
                test: "验证两个 ListTile 存在",
              },
            ],
          },
          {
            group: "导出功能",
            cases: [
              {
                name: "点击导出按钮应该触发导出",
                test: "点击导出按钮，验证调用导出服务",
              },
              {
                name: "导出成功应该显示成功提示",
                test: "导出成功，验证显示 SnackBar",
              },
              {
                name: "导出失败应该显示错误提示",
                test: "导出失败，验证显示错误 SnackBar",
              },
            ],
          },
          {
            group: "导入功能",
            cases: [
              {
                name: "点击导入按钮应该打开文件选择器",
                test: "点击导入按钮，验证调用 file_picker",
              },
              {
                name: "导入成功应该显示统计对话框",
                test: "导入成功，验证显示 AlertDialog with statistics",
              },
              {
                name: "导入失败应该显示错误提示",
                test: "导入失败，验证显示错误 SnackBar",
              },
            ],
          },
        ],
      },
    ],
    
    // 集成测试
    integrationTests: [
      {
        file: "integration_test/export_import_test.dart",
        description: "导入导出集成测试",
        testCases: [
          {
            group: "完整流程",
            cases: [
              {
                name: "导出后导入应该正确恢复数据",
                test: "创建数据 → 导出 → 清空数据库 → 导入 → 验证数据恢复",
              },
              {
                name: "跨设备导入应该正确处理冲突",
                test: "设备A导出 → 设备B修改数据 → 设备B导入 → 验证冲突处理正确",
              },
            ],
          },
          {
            group: "大量数据",
            cases: [
              {
                name: "大量数据导入导出应该正常",
                test: "创建1000+任务 → 导出 → 导入 → 验证所有数据正确",
              },
            ],
          },
          {
            group: "边界情况",
            cases: [
              {
                name: "空数据导出导入应该正常",
                test: "空数据库 → 导出 → 导入 → 验证不报错",
              },
              {
                name: "损坏文件应该正确处理",
                test: "使用损坏的ZIP文件导入，验证显示错误提示",
              },
            ],
          },
        ],
      },
    ],
  },

  // ===========================================
  // 8. 风险点和注意事项
  // ===========================================
  risks: [
    {
      risk: "大量数据导入可能导致性能问题",
      mitigation: "使用分批处理，显示进度，优化查询",
      priority: "medium",
    },
    {
      risk: "跨设备时间戳不同步可能导致冲突判断错误",
      mitigation: "使用 updatedAt 比较，允许小的时间差（如1秒）",
      priority: "low",
    },
    {
      risk: "孤立数据可能导致数据不完整",
      mitigation: "记录所有错误，允许用户查看和手动修复",
      priority: "medium",
    },
    {
      risk: "ZIP文件损坏或格式错误",
      mitigation: "添加文件验证，提供清晰的错误提示",
      priority: "medium",
    },
    {
      risk: "导入时 Isar ID 映射错误",
      mitigation: "仔细处理 projectIsarId 和 milestoneIsarId 的设置，确保通过业务ID正确查找",
      priority: "high",
    },
    {
      risk: "JSON序列化/反序列化错误",
      mitigation: "手动实现序列化，仔细处理所有字段，特别是 DateTime 和枚举类型",
      priority: "medium",
    },
    {
      risk: "UUID格式验证遗漏",
      mitigation: "导入时验证所有业务ID的UUID格式，无效格式记录错误",
      priority: "medium",
    },
  ],

  // ===========================================
  // 9. 后续优化（不在本次迭代中）
  // ===========================================
  futureEnhancements: [
    "支持增量导入（只导入变更的数据）",
    "支持导入预览（显示将要导入的数据）",
    "支持选择性导入（用户选择要导入的项目/任务）",
    "支持导入历史记录",
    "支持自动备份和恢复",
    "支持云同步（基于导入导出）",
  ],
}

