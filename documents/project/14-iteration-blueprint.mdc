# 14-iteration-blueprint.mdc - 迭代蓝图规则

## 触发条件
- design 文档完成并获得用户确认后，立即进入迭代蓝图阶段。
- 迭代蓝图专注于规划代码实现范围、数据模型调整、测试策略与文档同步，作为进入 plan 或实现阶段的前置条件。

## 输出要求
- **文档模板**：`documents/templates/iteration_template.json5`。
- **存放路径**：`documents/json5/<module>/iteration.json5` 或 `documents/json5/<module>/<slug>-iteration.json5`。
  - `<module>` 应与对应的 design 文档保持一致。
  - 如果同一模块需要多个迭代文档，可使用 `iteration_<slug>.json5` 或 `<slug>-iteration.json5` 命名。
- **文档格式**：**JSON5**（支持注释的 JSON 格式）。
- 与对应的 design 文档保持一一对应关系（模块与 slug 建议一致）。

## 内容要点

### 1. 迭代概述（必填）
- **迭代 ID**：格式 `YYMMDD-<module>-<slug>`，示例："251105-pomodoro-timer-page"
- **迭代标题**：简洁描述迭代内容
- **迭代描述**：详细说明本次迭代要实现的功能和目标
- **状态**：planning, in_progress, completed, cancelled
- **优先级**：high, medium, low
- **基于的设计文档**：引用对应的 design 文档路径

### 2. 文件创建清单（必填）
- **按功能模块分类**：根据实际项目调整分类名称（如 dataAdapters, repositories, services, widgets, pages, models 等）
- **每个文件必须包含**：
  - `path`：文件路径
  - `purpose`：文件用途说明
  - `action`：create 或 modify
  - `estimatedLines`：预估代码行数
  - `dependencies`：依赖的其他文件（数组）
  - `details`：**详细实现说明（数组格式，必填）**，列出所有实现细节、方法、错误处理、性能优化等

### 3. 需要修改的现有文件（可选）
- **每个修改项包含**：
  - `file`：文件路径
  - `purpose`：修改目的
  - `changes`：具体修改内容列表（数组）
  - `estimatedLines`：预估代码行数

### 4. 实现步骤（必填）
- **格式要求**：
  - 使用 `// ===========================================` 分隔主要章节
  - 在 `implementationSteps` 前添加错误处理策略说明
  - 明确说明：阶段完成后自动执行下一阶段，不需要沟通确认
  - 每个阶段完成时忽略 pre-commit，强行 git commit（使用 --no-verify 选项）
- **每个步骤包含**：
  - `step`：步骤序号
  - `title`：步骤标题
  - `description`：步骤描述
  - `tasks`：任务列表（数组）
- **每个任务可以包含**：
  - `task`：任务描述
  - `file`：相关文件（可选）
  - `command`：命令执行（可选，如 "flutter pub get"）
  - `action`：具体操作说明（可以是字符串或数组）
    - **字符串格式**：简单操作说明
    - **数组格式**：复杂流程，每个步骤一行（如 analyze 修复流程）
- **错误处理策略**（必须在 implementationSteps 前说明）：
  - 如果某个任务失败，先尝试修复（如 analyze issues、测试失败），修复后继续
  - 如果无法自动修复（如需要人工决策），记录问题并继续下一个任务，在阶段完成时总结所有未解决问题
  - build_runner 冲突：使用 --delete-conflicting-outputs 参数自动删除冲突文件
  - analyze issues 无法自动修复：记录到 commit message 中，标记为已知问题，继续后续任务

### 5. 技术细节和注意事项（必填）
- **keyDecisions**：关键技术决策
  - 每个决策包含：recommendation（推荐方案）、reason（选择理由）、alternative（备选方案）
- **codeStandards**：代码规范要求
  - 每个规范包含：rule（规则描述）、location（文件路径）、example（正确示例）、note（注意事项）
- **performance**（可选）：
  - `optimization`：优化措施列表
  - `monitoring`：性能监控列表
- **security**（可选）：安全考虑列表

### 6. 依赖关系图（可选）
- 按层级组织：dataLayer, repositoryLayer, serviceLayer, providerLayer, uiLayer, configLayer 等
- 每个层级列出相关文件路径

### 7. 测试策略和详细测试用例（必填）
- **unitTests**：单元测试列表
- **widgetTests**：Widget 测试列表
- **integrationTests**：集成测试列表
- 每个测试文件包含：
  - `file`：测试文件路径
  - `description`：测试描述
  - `testCases`：测试用例列表
    - `group`：测试组名称
    - `cases`：具体测试用例数组
      - `name`：测试用例名称
      - `test`：测试步骤描述

### 8. 风险点和注意事项（必填）
- 每个风险包含：
  - `risk`：风险描述
  - `mitigation`：缓解措施
  - `priority`：high, medium, low
  - `check`：检查项（可选）
  - `enforcement`：强制执行措施（可选）

### 9. 验证清单（必填）
- **codeQuality**：代码质量检查列表
- **functionality**：功能验证列表
- **performance**（可选）：性能验证列表
- **compatibility**（可选）：兼容性验证列表

### 10. 数据与状态（可选，但建议包含）
- **modelChanges**：数据模型变更列表
- **persistenceChanges**：持久化结构变更列表
- **stateManagementChanges**：状态管理变更列表

## 执行流程
1. **对齐设计**：阅读已确认的 design 文档，提炼实现重点与约束。
2. **拆解范围**：枚举代码、数据、依赖、配置的具体改动项。
3. **规划测试**：根据需求场景制定测试覆盖策略，注明测试位置与方式。
4. **输出文档**：
   - 参考 `documents/templates/iteration_template.json5` 的结构框架。
   - 使用 JSON5 格式，充分利用注释说明每个字段的含义。
   - 使用 `// ===========================================` 分隔主要章节。
   - 确保内容结构化、可执行。
   - **重要**：files 中的每个文件必须包含 `details` 数组，详细列出所有实现细节。
   - **重要**：tasks 中的 `action` 可以是字符串或数组，数组用于复杂流程。
   - **重要**：implementationSteps 前必须说明错误处理策略和自动执行规则。
5. **用户确认**：向用户呈现蓝图摘要，确认内容准确后再进入 plan/实现阶段。

## 与后续流程的衔接
- iteration 蓝图确认后，方可启动 plan 文档或 step/实现流程。
- 若后续需求变更影响设计或范围，需同时更新 design 与 iteration 文档保持一致。

## 注意事项
- 与 `documents/project/rules.yaml` 保持同步，规则更新需双向维护。
- 所有内容使用中文描述，专业名词可附英文注释。
- JSON5 文档应充分利用注释，详细说明实现细节和技术决策。
- 使用 `// ===========================================` 分隔主要章节，保持结构清晰。
- **文件分类**：files 部分按功能模块分类（如 dataAdapters, repositories, services 等），而不是按文件类型（theme, utils 等）。
- **详细实现**：每个文件的 `details` 数组必须详细列出所有实现细节、方法、错误处理、性能优化等。
- **复杂流程**：对于复杂流程（如 analyze 修复流程），使用数组格式的 `action`，每个步骤一行。
- **错误处理**：必须在 implementationSteps 前说明错误处理策略。
- **自动执行**：明确说明阶段完成后自动执行下一阶段，不需要沟通确认。
- 若蓝图信息不完整或存在风险未评估，应暂停并与用户沟通补全后再确认。
- 参考现有 `documents/json5/` 下的迭代文档（如 `documents/json5/database/drift-migration-iteration.json5`），保持风格和结构一致性。
