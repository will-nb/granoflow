meta:
  version: 1
  type: plan
  iteration: "YYMMDD-N"
  generated_at: "YYYY-MM-DD HH:MM:SS"
  based_on_preview: "YYMMDD-N-preview.yaml"

summary:
  objective: "基于preview文档的具体实施计划"
  preview_reference: "documents/plan/YYMMDD-N-preview.yaml"

# 1. 实现规范YAML生成/修改计划
yaml_specification_updates:
  description: "根据preview文档生成或修改对应的实现规范YAML文件"
  
  updates:
    - file: "documents/architecture/widgets/component_name.yaml"
      action: "create|modify"
      based_on: "preview中的new_files或modified_files"
      changes:
        - field: "字段路径"
          value: "新值"
          source: "preview中的具体位置"
        - field: "字段路径"
          value: "新值"
          source: "preview中的具体位置"
    
    - file: "documents/architecture/pages/page_name.yaml"
      action: "create|modify"
      based_on: "preview中的页面修改"
      changes:
        - field: "字段路径"
          value: "新值"
          source: "preview中的具体位置"

# 2. 验收测试用例计划
testing_plan:
  description: "详细的测试用例计划，区分现有测试修改和新测试创建"
  
  existing_tests:
    description: "需要修改的现有测试用例"
    tests:
      - file: "test/path/to/existing_test.dart"
        test_name: "test_existing_functionality"
        modification_type: "modify"
        reason: "根据preview变更需要修改测试逻辑"
        current_expectation: "当前测试期望"
        new_expectation: "修改后的测试期望"
        implementation: |
          // 修改后的测试代码
        validation_points:
          - "验证点1: 确保测试通过"
          - "验证点2: 确保覆盖新功能"
  
  new_tests:
    description: "需要新建的测试用例"
    tests:
      - file: "test/path/to/new_test.dart"
        test_name: "test_new_functionality"
        test_type: "unit_test|widget_test|integration_test"
        description: "测试新功能的具体行为"
        expectation: "期望的测试结果"
        implementation: |
          // 新建的测试代码
        validation_points:
          - "验证点1: 确保测试通过"
          - "验证点2: 确保覆盖所有场景"
  
  configuration_tests:
    description: "配置相关测试（theme、文字、环境变量等）"
    tests:
      - test_name: "test_theme_configuration"
        description: "验证主题配置与YAML文件一致"
        validation_method: "读取documents/config/theme.yaml进行验证"
        expectation: "配置值不是硬编码，且与YAML文件内容一致"
        implementation: |
          // 读取YAML文件并验证配置
        yaml_files:
          - "documents/config/theme.yaml"
          - "documents/config/l10n.yaml"
      
      - test_name: "test_localization_consistency"
        description: "验证本地化文字与YAML文件一致"
        validation_method: "读取lib/l10n/app_*.arb文件进行验证"
        expectation: "文字内容不是硬编码，且与arb文件内容一致"
        implementation: |
          // 读取arb文件并验证文字内容
        yaml_files:
          - "lib/l10n/app_en.arb"
          - "lib/l10n/app_zh_Hans.arb"
          - "lib/l10n/app_zh_Hant.arb"

# 3. 实现代码计划
implementation_plan:
  description: "具体的代码实现计划"
  
  code_changes:
    - file: "lib/path/to/file.dart"
      action: "create|modify"
      based_on: "preview中的具体设计"
      changes:
        - type: "class_creation|method_implementation|property_addition"
          description: "具体变更描述"
          implementation: |
            // 具体实现代码
        - type: "import_addition"
          description: "添加必要的导入"
          implementation: |
            import 'package:flutter/material.dart';
            import 'relative/path/to/dependency.dart';
  
  dependencies:
    - package: "package:flutter/material.dart"
      reason: "UI组件依赖"
    - package: "package:flutter_riverpod/flutter_riverpod.dart"
      reason: "状态管理依赖"
    - file: "lib/core/providers/app_providers.dart"
      reason: "应用状态提供者"

# 4. 执行状态跟踪（统一版）
execution_tracking:
  description: "类似todolist的执行状态跟踪机制"
  overall_status: "pending"  # pending|in_progress|completed|failed|skipped
  current_phase: "yaml_updates"  # yaml_updates|testing|implementation|validation|pre_commit
  completed_phases: []
  failed_phases: []
  skipped_phases: []
  phases:
    - name: "yaml_updates"
      description: "实现规范YAML更新阶段"
      status: "pending"
      tasks:
        - task: "更新widgets YAML文件"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "更新pages YAML文件"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "更新架构索引文件"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
    - name: "testing"
      description: "测试用例创建/修改阶段"
      status: "pending"
      tasks:
        - task: "创建/修改单元测试"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "创建/修改组件测试"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "创建/修改集成测试"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
    - name: "implementation"
      description: "代码实现阶段"
      status: "pending"
      tasks:
        - task: "实现新组件"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "修改现有组件"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "更新页面逻辑"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
    - name: "validation"
      description: "验证阶段"
      status: "pending"
      tasks:
        - task: "运行所有测试"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "检查测试覆盖率"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "验证配置一致性"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
    - name: "pre_commit"
      description: "pre-commit检查阶段"
      status: "pending"
      tasks:
        - task: "运行pre-commit检查"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "处理pre-commit错误"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []
        - task: "记录pre-commit结果"
          status: "pending"
          retry_count: 0
          max_retries: 3
          failure_reasons: []

# 跳过记录格式
skip_records:
  - task_id: "TASK-XXX"
    task_name: "任务名称"
    skip_reason: "跳过原因"
    attempts:
      - attempt: 1
        approach: "第一次解决方式"
        failure_manifestation: "失败表现"
        excluded_possibilities: "排除的可能性"
      - attempt: 2
        approach: "第二次解决方式"
        failure_manifestation: "失败表现"
        excluded_possibilities: "排除的可能性"
      - attempt: 3
        approach: "第三次解决方式"
        failure_manifestation: "失败表现"
        excluded_possibilities: "排除的可能性"
    final_conclusion: "最终结论和跳过原因"

# 4. 执行状态跟踪
execution_tracking:
  description: "类似todolist的执行状态跟踪机制"
  
  overall_status: "pending"  # pending|in_progress|completed|failed
  current_phase: "yaml_updates"  # yaml_updates|testing|implementation|validation|pre_commit
  
  phases:
    - name: "yaml_updates"
      description: "实现规范YAML更新阶段"
      status: "pending"
      tasks:
        - task: "更新widgets YAML文件"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "更新pages YAML文件"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "更新架构索引文件"
          status: "pending"
          retry_count: 0
          failure_reasons: []
    
    - name: "testing"
      description: "测试用例创建/修改阶段"
      status: "pending"
      tasks:
        - task: "创建/修改单元测试"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "创建/修改组件测试"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "创建/修改集成测试"
          status: "pending"
          retry_count: 0
          failure_reasons: []
    
    - name: "implementation"
      description: "代码实现阶段"
      status: "pending"
      tasks:
        - task: "实现新组件"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "修改现有组件"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "更新页面逻辑"
          status: "pending"
          retry_count: 0
          failure_reasons: []
    
    - name: "validation"
      description: "验证阶段"
      status: "pending"
      tasks:
        - task: "运行所有测试"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "检查测试覆盖率"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "验证配置一致性"
          status: "pending"
          retry_count: 0
          failure_reasons: []
    
    - name: "pre_commit"
      description: "pre-commit检查阶段"
      status: "pending"
      tasks:
        - task: "运行pre-commit检查"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "处理pre-commit错误"
          status: "pending"
          retry_count: 0
          failure_reasons: []
        - task: "记录pre-commit结果"
          status: "pending"
          retry_count: 0
          failure_reasons: []
  
  retry_mechanism:
    max_retries: 3
    retry_conditions:
      - "YAML文件格式错误"
      - "测试用例创建失败"
      - "代码实现失败"
      - "测试执行失败"
      - "pre-commit检查失败"
  
  error_logging:
    log_directory: "documents/plan-logs"
    log_filename_format: "plan_error_YYYYMMDD_HHMMSS.json"
    log_format: "json"
    
    log_entry_template:
      timestamp: "YYYY-MM-DD HH:MM:SS"
      phase_name: "当前阶段名称"
      task_name: "当前任务名称"
      error_content: "具体报错内容"
      estimated_cause: "估计的错误原因"
      solution_attempted: "尝试的解决方式"
      failure_manifestation: "失败的具体表现"
      excluded_possibilities: "排除的可能性"
      retry_count: 0
      max_retries: 3
      status: "failed|retrying|skipped"
  
  skip_records: []

# 成功标准
success_criteria:
  - "所有实现规范YAML文件已更新"
  - "所有测试用例已创建/修改并通过"
  - "所有代码已实现并通过测试"
  - "配置验证测试通过，确保无硬编码"
  - "pre-commit检查通过"
  - "所有阶段状态为completed或skipped"