meta:
  id: "251031-tasks-dnd-due-date-sync"
  title: "任务层级拖拽与截止时间联动"
  status: draft
  owner: "AI Assistant"

background:
  problem: |
    当前任务拖拽场景存在以下缺口：
    1. 任务在 Inbox 与 Tasks 页面间的拖拽仅修改父子结构，未统一处理移入/移出行为，体验不一致。
    2. 拖拽排序不会同步更新任务的截止日期，导致任务出现于新区域但仍保留旧日期，破坏“区域=日期范围”的心智模型。
    3. 跨区域拖拽缺乏明确规则，用户难以通过拖拽快速调整任务排期。
    4. 缺少对三层层级与拖拽拦截的统一提醒，仍可能出现超深层级或错误操作。
    5. Inbox 与 Tasks 页面拖拽高亮与拦截提示实现分散，颜色、动画与日志策略存在细微差异，用户感知不一致，维护成本高。
  goal: |
    - 对任务拖拽的“移入父任务”“移出父任务”建立一致体验，并提供明确的视觉与日志反馈。
    - 拖拽排序时自动更新截止日期，使任务显示区域与日期保持同步。
    - 基于日期规则支持跨区域拖拽，用户可通过拖拽完成排期调整。
    - 保持三层层级限制，向用户提供一致的拦截提示与底部提醒。

user_flows:
  - name: "移入父任务流程"
    steps:
      - "用户在 Inbox 或 Tasks 页面长按任务 A 并拖拽到任务 B 上方"
      - "系统高亮任务 B，提示将成为父任务"
      - "松手后，系统校验层级、锁定状态、循环引用等规则"
      - "校验通过：A 成为 B 的子任务，继承 B 所在分区和排序上下文；页面更新并输出成功提醒"
      - "校验失败：保持原位置，底部提醒说明原因"

  - name: "移出父任务流程"
    steps:
      - "用户长按子任务 A，拖拽到根级插入线或“移出父任务”区域"
      - "系统显示根级插入占位或顶部移出区域高亮"
      - "松手后，系统清除 A 的 parentId，并为目标位置计算新的 sortIndex 与截止日期"
      - "界面更新 A 为根任务，提醒成功；若因层级限制失败则展示拦截提示"

  - name: "同分区排序与截止日期继承"
    steps:
      - "用户在 Tasks 某分区内拖拽任务 A 到任务 B 之后"
      - "系统预览插入线并提示将复制 B 的日期"
      - "松手后，系统将 A 的 sortIndex 调整到 B 后，同时将 dueDate 设置为 B 的 dueDate"
      - "界面刷新排序，SnackBar 或底部提醒确认操作"

  - name: "跨分区拖拽与日期对齐"
    steps:
      - "用户将任务 A 从一个分区拖拽到另一个分区的顶部或最后"
      - "系统提示目标分区日期范围，并在拖拽占位上展示预期日期"
      - "松手后，系统根据目标分区规则（顶部=分区起始日，尾部=分区默认日或末任务日）更新 dueDate"
      - "任务移动到新分区，显示成功提示；若分区受限或层级冲突则展示拦截信息"

ui_behavior:
  layout: |
    - Inbox 与 Tasks 页面维持既有结构：分区列表 + 可展开的父子节点。
    - 各分区顶部/间隔位置保留 DragTarget 插入线；顶部追加“移出父任务”通道。
    - 拖拽时提供浮动预览，展示任务标题与拖拽手柄。
  components:
    - name: "TaskTileContent"
      purpose: "任务卡片主体，承载拖拽源与拖拽目标行为"
      interactions: ["长按拖拽", "拖入高亮", "拦截提示"]
    - name: "TaskDragIntentTarget（新共享组件）"
      purpose: "统一 Inbox / Tasks 的拖拽接受与高亮逻辑，通过配置决定插入类型"
      interactions: ["渲染一致的 hover 颜色", "调用共享校验", "分发底部提醒/日志"]
    - name: "TasksPageDragTarget"
      purpose: "Tasks 页面各分区插入线/首尾目标"
      interactions: ["接受跨区域拖拽", "计算排序+截止日期", "展示拦截提醒"]
    - name: "InboxDragTarget"
      purpose: "Inbox 根级插入/提升区域"
      interactions: ["子任务提升为根", "展示底部提醒"]
    - name: "DragToRemoveHandler"
      purpose: "清除父子关系的统一入口"
      interactions: ["拖拽移出", "校验层级", "展示成功/失败提示"]
    - name: "SnackBar / BottomReminder"
      purpose: "在成功、拦截或失败时提供明确反馈"
      interactions: ["自动弹出", "展示多语言提示"]
    - name: "[DnD] 调试日志"
      purpose: "记录拖拽事件上下文，方便排查"
      interactions: ["onWillAccept", "onAccept", "blockReason"]
  states:
    - condition: "拖拽悬停有效目标"
      appearance: "目标任务或插入线高亮（继承 Inbox 配色与动画），底部展示预计操作（成为子任务/移动到某日期）"
    - condition: "触发层级或锁定拦截"
      appearance: "底部提醒展示对应多语言文案，同时 `[DnD]` 日志写入 block 原因"
    - condition: "跨分区成功"
      appearance: "任务移动到新分区，截止日期更新，提示成功"
    - condition: "移出父任务成功"
      appearance: "任务回到根级，底部提示已移出，日志确认 parentId=null"
    - condition: "目标任务无截止日期"
      appearance: "系统提示将沿用分区默认日期，并在底部提醒中说明"

open_issues:
  - "目标任务无 dueDate 时的继承策略是否使用分区默认日期还是保留原值？需要产品确认。"
  - "跨分区拖拽到含模板锁定任务的情况是否允许？若禁止需增加专用文案。"
  - "三层层级限制触发时，是否需要在提示中展示当前深度信息？"
  - "是否需要在拖拽预览中显示任务原所属分区以增强可理解性？"
  - "任务跨分区后，如果分区由状态字段决定（非纯日期），是否需要同步更新 status？"
  - "统一拖拽组件后，Inbox 与 Tasks 的调色板/动画需再次验收，是否需要设计审核？"

