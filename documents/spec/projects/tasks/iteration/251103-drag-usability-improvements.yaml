meta:
  id: "251103-drag-usability-improvements"
  title: "拖拽功能可用性改进：增大目标区域、清理遗留代码、优化手势识别与边界处理"
  based_on: "基于综合集成测试日志分析发现的问题"
  status: draft
  owner: "开发团队"
  created_at: "2025-11-03"

background:
  problem: |
    综合集成测试发现拖拽功能存在严重的可用性问题：
    1. **插入目标区域过小**：当前只有8像素，用户很难准确拖拽到目标区域
    2. **拖拽手势识别不稳定**：零偏移量问题导致拖拽意图未被识别
    3. **边界处理不当**：拖拽自己时仍尝试提升独立任务
    4. **长按延迟可能过长**：响应性不足
    5. **遗留代码问题**：存在未使用的插入线相关代码（常量、主题颜色、注释），容易引起混淆
    6. **容错机制缺失**：与设计文档不一致，缺少16像素容错区间

  goal: |
    1. 将插入目标区域从8像素增加到34像素（符合设计文档）
    2. 添加16像素容错区间常量，支持移动让位动画
    3. 清理所有插入线相关的遗留代码（常量、主题颜色、未使用的注释）
    4. 确保拖拽排序只使用移动让位效果，不渲染插入线
    5. 优化拖拽手势识别，降低延迟提高响应性
    6. 修复边界问题，避免无效操作
    7. 增强调试日志，便于问题定位

scope:
  includes:
    - "拖拽常量定义（DragConstants）"
    - "拖拽主题定义（DragTheme）"
    - "拖拽目标组件（StandardDragTarget）"
    - "拖拽手势组件（StandardDraggable）"
    - "Inbox 拖拽处理逻辑"
    - "Tasks 页面拖拽处理逻辑"
    - "位置检测逻辑（TaskDragPositionDetector）"
  excludes:
    - "不涉及拖拽数据结构变更"
    - "不涉及拖拽业务逻辑重构"
    - "不涉及任务数据结构变更"

changes:
  code_updates:
    - file: "lib/core/constants/drag_constants.dart"
      type: modify
      intent: "增大插入目标区域、添加容错区间常量、清理插入线遗留代码"
      details:
        - 删除未使用的常量：`insertionLineHeight`、`insertionLineBlurRadius`、`insertionLineSpreadRadius`
        - 添加 `insertionToleranceZone = 16.0` 常量（上下各16像素容错区间，用于移动让位动画）
        - 将 `insertionTargetHeight` 从 8.0 改为 34.0（2像素基础 + 32像素容错 = 支持让位动画的容错区域）
        - 保持 `taskSurfaceExclusionZone = 16.0` 不变
        - 更新注释，明确说明使用移动让位动画而非插入线
        - 添加注释说明常量用途和计算方式

    - file: "lib/core/theme/drag_theme.dart"
      type: modify
      intent: "清理未使用的插入线颜色定义"
      details:
        - 删除 `insertionLineBetweenColor` 字段和相关逻辑
        - 删除 `insertionLineSectionColor` 字段和相关逻辑
        - 更新 `copyWith` 方法，移除相关参数
        - 更新 `lerp` 方法，移除相关逻辑
        - 更新 `_defaultLight` 方法，移除相关颜色初始化
        - 更新 `fromScheme` 方法，移除插入线颜色计算
        - 更新注释，明确说明不再支持插入线

    - file: "lib/presentation/common/drag/standard_drag_target.dart"
      type: modify
      intent: "清理插入线相关注释，确保只使用移动让位效果"
      details:
        - 更新注释，移除"插入线"相关描述
        - 更新 `_buildDefaultInsertionLine` 方法名或注释，明确这是容错区域而非插入线
        - 确保方法只返回透明 Container，不渲染任何视觉元素
        - 更新 `showWhenIdle` 参数注释，移除插入线相关说明

    - file: "lib/presentation/common/drag/task_drag_position_detector.dart"
      type: modify
      intent: "更新位置检测逻辑和注释，移除插入线相关描述"
      details:
        - 更新注释中的"插入线"描述，改为"插入容错区间"
        - 确保 `_isInInsertionZone` 方法正确使用新的 `insertionTargetHeight` (34像素)
        - 更新注释，明确说明容错区间用于支持移动让位动画

    - file: "lib/presentation/common/drag/standard_draggable.dart"
      type: modify
      intent: "降低长按延迟，提高拖拽响应性"
      details:
        - 在 `LongPressDraggable` 中添加 `delay` 参数，设置为 300ms（默认约500ms）
        - 添加注释说明延迟选择的原因

    - file: "lib/presentation/inbox/views/inbox_task_list.dart"
      type: modify
      intent: "修复边界问题并优化拖拽偏移量处理"
      details:
        - 在 `onDragEnd` 回调中添加早期退出条件：
          * 如果偏移量为0.0（可能是点击），不触发提升独立
          * 检查是否有最小移动距离（如2像素）才认为是有效拖拽
        - 添加更详细的调试日志，记录 `canAccept` 失败的原因
        - 在尝试提升独立前检查是否拖拽自己
        - 更新注释，移除插入线相关描述

    - file: "lib/presentation/inbox/inbox_drag_target.dart"
      type: modify
      intent: "增强 canAccept 调试日志"
      details:
        - 在 `_canAcceptDrop` 方法中添加详细日志
        - 记录任务状态、目标类型、before/after任务信息
        - 更新注释，移除插入线相关描述

    - file: "lib/presentation/tasks/views/tasks_section_task_list.dart"
      type: modify
      intent: "应用相同的边界修复和优化"
      details:
        - 在 `onDragEnd` 中添加与 Inbox 相同的边界检查
        - 确保使用新的插入目标高度
        - 更新注释，移除插入线相关描述

  data_model:
    - entity: "无数据模型变更"
      change: "此改进仅涉及UI交互和常量配置，不涉及数据模型"

  tests:
    - type: integration
      focus: "验证改进后的拖拽功能可用性"
      files:
        - "integration_test/comprehensive_drag_test.dart"
      updates:
        - 更新测试中的预期值（如插入目标高度相关断言）
        - 添加针对容错区间的测试用例
        - 添加边界情况测试（零偏移量、拖拽自己等）
        - 验证长按延迟改进后的响应性
        - 验证移动让位动画正常工作
        - 验证没有插入线被渲染

    - type: unit
      focus: "验证常量更新后相关计算逻辑"
      files:
        - "test/presentation/common/drag/standard_drag_target_test.dart（如存在）"
      updates:
        - 如有相关单元测试，更新预期值
        - 验证未使用的常量已被删除

  documentation:
    - path: "documents/spec/projects/tasks/design/251201-unified-drag-system.yaml"
      update_type: modify
      note: "更新设计文档，移除插入线相关描述，明确只使用移动让位动画"

risks:
  - name: "插入目标区域增大可能影响视觉效果"
    mitigation: |
      1. 新高度（34像素）符合设计文档规范，用于支持移动让位动画
      2. 容错区间是透明的，不影响视觉（只影响命中区域）
      3. 不渲染插入线，只使用让位动画，视觉更清晰
      4. 如需要可以进一步调整

  - name: "长按延迟降低可能导致误触发"
    mitigation: |
      1. 300ms是一个平衡值，既提高响应性又避免误触发
      2. 可以进一步测试和调整
      3. 用户可以通过实际使用反馈进一步优化

  - name: "边界检查可能过于严格，阻止合法操作"
    mitigation: |
      1. 最小移动距离（2像素）是一个很小的阈值
      2. 仅阻止明显的无效操作（零偏移、拖拽自己）
      3. 可以通过日志观察实际行为，必要时调整阈值

  - name: "删除插入线相关代码可能影响其他地方"
    mitigation: |
      1. 先通过 grep 搜索确保没有地方使用这些常量/颜色
      2. 删除前先运行测试，确保没有破坏性影响
      3. 保留在单独的提交中，便于回滚

  - name: "代码变更可能影响现有功能"
    mitigation: |
      1. 变更主要集中在常量定义和注释清理，影响范围可控
      2. 保留向后兼容的常量值计算方式
      3. 全面运行集成测试验证
      4. 手动测试关键拖拽场景

verification:
  checklist:
    - "运行 flutter analyze 确保无编译错误"
    - "运行现有拖拽相关测试（integration_test/comprehensive_drag_test.dart）"
    - "手动测试 Inbox 页面拖拽功能："
      - "测试在两个任务之间插入"
      - "测试拖拽到列表开头"
      - "测试拖拽到列表末尾"
      - "测试移入任务（成为子任务）"
      - "测试提升独立任务"
      - "验证只看到让位动画，没有插入线"
    - "手动测试 Tasks 页面拖拽功能："
      - "测试跨区移动"
      - "测试同一分区内排序"
      - "验证只看到让位动画，没有插入线"
    - "验证边界情况："
      - "拖拽自己到自己（应该被阻止）"
      - "微小移动（应该被识别为拖拽）"
      - "零偏移量（应该不触发提升独立）"
    - "检查日志输出，确认调试信息正确"
    - "验证插入目标区域大小符合预期（34像素容错区间）"
    - "验证拖拽响应性（延迟感觉）"
    - "验证没有插入线相关的视觉元素出现"
    - "确认所有插入线相关的常量/颜色已从代码中移除"

implementation_notes: |
  1. **优先级顺序**：
     a. 首先更新常量（DragConstants）- 影响最大
     b. 清理遗留代码（DragTheme、注释）- 避免混淆
     c. 然后更新使用常量的组件
     d. 最后修复边界问题和添加日志

  2. **清理步骤**：
     a. 先搜索确认没有地方使用插入线相关常量/颜色
     b. 删除未使用的代码
     c. 更新所有相关注释
     d. 确保代码编译通过

  3. **测试策略**：
     - 先更新常量，运行现有测试看是否有破坏
     - 清理遗留代码，确保没有编译错误
     - 逐个应用修复，每步都进行手动验证
     - 最后运行完整集成测试

  4. **回滚方案**：
     - 如果新常量导致问题，可以回滚到8像素
     - 如果长按延迟导致误触发，可以提高到400ms
     - 所有变更都保留在单独提交中，便于回滚

  5. **后续优化**：
     - 根据用户反馈进一步调整阈值
     - 考虑添加用户可配置的拖拽灵敏度设置
     - 继续优化日志，帮助诊断问题
     - 确保设计文档与代码实现保持一致

