meta:
  id: "251103-unify-tasks-drag-state"
  title: "统一 Tasks 页面拖拽状态管理：移除按 section 的状态，支持跨区域拖拽"
  based_on: "基于跨区域拖拽失效问题的分析和简化方案讨论"
  status: draft
  owner: "开发团队"
  created_at: "2025-11-03"
  estimated_effort: "8-12小时"

background:
  problem: |
    当前 Tasks 页面存在两个拖拽状态提供者：
    
    1. **全局状态** `tasksDragProvider`：
       - 由 `TasksPageDragHandler` 设置，记录 `draggedTask` 和 `isDragging`
       - 功能简单，只记录基本拖拽信息
    
    2. **按 section 状态** `tasksSectionDragProvider(section)`：
       - 每个 section 独立管理拖拽状态
       - 包含 `hoveredInsertionIndex`、`hoveredTaskId`、位置信息等详细状态
       - 用于计算插入目标高度、让位动画等
    
    **核心问题**：
    - 跨区域拖拽时，目标区域的 `tasksSectionDragProvider(targetSection).isDragging` 是 `false`
    - 导致插入目标高度计算返回 `null`，虽然默认高度理论上足够，但可能影响跨区域拖拽的检测
    - 两个状态不同步，增加维护复杂度
    
    **设计问题**：
    - 任务虽然按 section 分组显示，但截止日期（dueAt）是连贯的时间线
    - 区域之间的时间界限应该视为一个日期节点，统一列入计算
    - 当前按 section 分别管理拖拽状态，不符合数据模型的实际结构

  goal: |
    统一 Tasks 页面的拖拽状态管理，实现：
    1. **单一状态源**：移除 `tasksSectionDragProvider`，统一使用全局 `tasksDragProvider`
    2. **跨区域支持**：所有 section 共享同一个拖拽状态，自然支持跨区域拖拽
    3. **统一插入位置计算**：区域边界和任务一样视为插入点，统一计算全局插入索引
    4. **简化逻辑**：减少状态同步问题，降低维护成本
    5. **保持 Inbox 独立**：不影响 Inbox 的独立拖拽系统（`inboxDragProvider`）

solution:
  approach: |
    核心策略：扩展全局 `tasksDragProvider`，包含所有必要的拖拽状态字段，移除按 section 的拖拽状态提供者。
    
    **状态统一**：
    - 扩展 `TasksDragState`，包含 `TasksSectionDragState` 的所有字段
    - 所有 section 共享同一个全局拖拽状态
    - 插入位置使用全局索引计算（跨 section）
    
    **插入位置计算**：
    - 所有任务在时间线上统一排序，区域边界视为特殊插入点
    - 计算跨 section 的全局插入索引
    - 插入目标根据全局索引计算高度和位置

scope:
  includes:
    - "Tasks 页面的拖拽状态管理（tasksDragProvider）"
    - "Tasks 页面的插入目标计算逻辑"
    - "Tasks 页面的让位动画逻辑"
    - "Tasks 页面的拖拽处理组件（TasksPageDragHandler）"
    - "Tasks Section 任务列表组件（TasksSectionTaskList）"
  excludes:
    - "Inbox 页面的拖拽系统（保持独立，使用 inboxDragProvider）"
    - "任务数据模型和业务逻辑"
    - "拖拽 UI 组件本身（TaskDragIntentTarget、StandardDraggable）"

changes:
  code_updates:
    - file: "lib/core/providers/tasks_drag_provider.dart"
      type: modify
      intent: "扩展 TasksDragState，包含所有拖拽状态字段（hoveredInsertionIndex、hoveredTaskId、位置信息等），扩展 TasksDragNotifier 添加相应的方法"
      details:
        - 扩展 `TasksDragState` 类，添加以下字段：
          - `int? hoveredInsertionIndex`：当前悬停的插入位置索引（全局索引）
          - `int? hoveredTaskId`：当前悬停的任务 ID
          - `int? committedInsertionIndex`：已提交的插入位置索引（让位动画触发时的位置）
          - `Offset? dragStartPosition`：拖拽起始位置（全局坐标）
          - `Offset? currentDragPosition`：当前拖拽位置（全局坐标）
          - `double? horizontalOffset`：水平位移
          - `double? verticalOffset`：垂直位移
          - `bool? isDraggedTaskHiddenFromExpansion`：被拖拽的子任务是否已移出扩展区
        - 扩展 `TasksDragNotifier`，添加以下方法：
          - `void startDrag(Task task, Offset startPosition)`：开始拖拽（带位置信息）
          - `void updateDragPosition(Offset position)`：更新拖拽位置
          - `void updateInsertionHover(int? insertionIndex)`：更新插入位置悬停状态
          - `void updateTaskSurfaceHover(int? taskId)`：更新任务表面悬停状态
          - `void setDraggedTaskHidden(bool? hidden)`：设置被拖拽任务隐藏状态
          - `void clearHover()`：清除所有悬停状态

    - file: "lib/presentation/tasks/views/tasks_section_task_list.dart"
      type: modify
      intent: "移除 tasksSectionDragProvider 的使用，改为使用全局 tasksDragProvider，更新所有拖拽状态访问和更新逻辑"
      details:
        - 移除所有 `tasksSectionDragProvider(widget.section)` 的引用
        - 改为使用 `tasksDragProvider`
        - 更新 `_calculateInsertionTargetHeight` 方法，使用全局拖拽状态
        - 更新 `onDragStarted`、`onDragUpdate`、`onDragEnd` 回调，使用全局拖拽状态
        - 更新插入目标的 `onHover` 回调，更新全局插入位置索引
        - 更新让位动画计算逻辑，使用全局插入索引

    - file: "lib/presentation/tasks/tasks_drag_handler.dart"
      type: modify
      intent: "更新 TasksPageDragHandler，使用扩展后的全局拖拽状态，传递位置信息"
      details:
        - 更新 `startDrag` 调用，传递 `Offset.zero` 作为初始位置（后续由 `onDragUpdate` 更新）
        - 可选：在 `onDragUpdate` 中更新拖拽位置（如果需要）

    - file: "lib/core/providers/tasks_section_drag_provider.dart"
      type: delete
      intent: "移除不再需要的按 section 拖拽状态提供者"

    - file: "lib/presentation/tasks/views/tasks_section_task_list.dart"
      type: modify
      intent: "更新导入语句，移除 tasks_section_drag_provider 的导入"

  data_model:
    - entity: "TasksDragState"
      change: "扩展状态类，添加 hoveredInsertionIndex、hoveredTaskId、位置信息等字段"
    - entity: "TasksDragNotifier"
      change: "扩展状态管理器，添加拖拽位置更新、插入位置悬停等方法"

  tests:
    - type: integration
      focus: "验证跨区域拖拽功能是否正常工作（从今天拖到本周等）"
      location: "integration_test/cross_section_drag_test.dart"
      notes: "需要更新测试以使用全局拖拽状态"
    
    - type: integration
      focus: "验证同区域内拖拽排序功能不受影响"
      location: "integration_test/tasks_drag_test.dart"
    
    - type: unit
      focus: "验证 TasksDragState 的状态更新逻辑"
      location: "test/core/providers/tasks_drag_provider_test.dart"
      notes: "可能需要创建新的测试文件"

  documentation:
    - path: "documents/architecture/providers/tasks_drag_provider.yaml"
      update_type: modify
      notes: "更新 provider 架构文档，反映统一后的拖拽状态管理"

risks:
  - name: "状态计算复杂度增加"
    mitigation: |
      全局插入索引的计算可能比 section 内的索引复杂。需要：
      1. 定义清晰的全局索引计算规则（考虑区域边界）
      2. 添加充分的日志和调试信息
      3. 逐步迁移，先完成状态统一，再优化索引计算
  
  - name: "性能影响"
    mitigation: |
      全局状态可能触发更多重建。需要：
      1. 使用 `ref.read` 而非 `ref.watch` 在不需要重建的地方
      2. 优化状态更新逻辑，减少不必要的通知
      3. 性能测试验证
  
  - name: "插入位置计算错误"
    mitigation: |
      跨 section 的插入位置计算可能出错。需要：
      1. 明确定义全局索引和 section 内索引的映射关系
      2. 添加边界情况的测试（空 section、单任务 section 等）
      3. 保留详细日志便于调试
  
  - name: "向后兼容性"
    mitigation: |
      移除 `tasksSectionDragProvider` 可能影响其他代码。需要：
      1. 全局搜索所有使用 `tasksSectionDragProvider` 的地方
      2. 确保没有遗漏的引用
      3. 运行完整的测试套件验证

verification:
  checklist:
    - "运行 `flutter analyze` 确保没有编译错误"
    - "运行所有单元测试：`flutter test test/`"
    - "运行集成测试：`flutter test integration_test/cross_section_drag_test.dart`"
    - "手动测试：在同区域内拖拽排序，验证功能正常"
    - "手动测试：跨区域拖拽（从今天拖到本周），验证功能正常"
    - "手动测试：拖拽到区域边界，验证插入位置正确"
    - "检查日志：确认拖拽状态更新和插入位置计算正确"
    - "性能测试：拖拽响应时间无明显增加"
    - "验证 Inbox 拖拽功能不受影响"

implementation_phases:
  phase_1_extend_state:
    name: "扩展全局拖拽状态"
    description: "扩展 TasksDragState 和 TasksDragNotifier，添加所有必要的字段和方法"
    steps:
      - "扩展 TasksDragState 类，添加所有字段"
      - "扩展 TasksDragNotifier，添加所有方法"
      - "更新 copyWith、==、hashCode 等方法"
      - "运行单元测试验证状态更新逻辑"

  phase_2_update_tasks_section_task_list:
    name: "更新 TasksSectionTaskList 使用全局状态"
    description: "移除 tasksSectionDragProvider 的使用，改为使用全局 tasksDragProvider"
    steps:
      - "移除 tasksSectionDragProvider 的导入"
      - "将所有 ref.watch/ref.read(tasksSectionDragProvider(section)) 改为 ref.watch/ref.read(tasksDragProvider)"
      - "更新 onDragStarted 回调，使用全局状态"
      - "更新 onDragUpdate 回调，更新全局拖拽位置"
      - "更新插入目标的 onHover 回调，更新全局插入索引"
      - "更新 _calculateInsertionTargetHeight 方法，使用全局状态"
      - "更新让位动画计算逻辑"

  phase_3_update_drag_handler:
    name: "更新拖拽启动组件"
    description: "更新 TasksPageDragHandler 使用扩展后的全局状态"
    steps:
      - "更新 startDrag 调用，传递初始位置"
      - "可选：在 onDragUpdate 中更新拖拽位置"

  phase_4_remove_section_provider:
    name: "移除按 section 的拖拽状态提供者"
    description: "删除 tasksSectionDragProvider 相关代码"
    steps:
      - "全局搜索 tasksSectionDragProvider 的所有引用"
      - "确认没有遗漏的引用"
      - "删除 lib/core/providers/tasks_section_drag_provider.dart 文件"
      - "从相关导入中移除"

  phase_5_testing:
    name: "测试和验证"
    description: "运行测试套件，手动验证功能"
    steps:
      - "运行 flutter analyze"
      - "运行单元测试"
      - "运行集成测试"
      - "手动测试跨区域拖拽"
      - "手动测试同区域拖拽"
      - "验证 Inbox 功能不受影响"

