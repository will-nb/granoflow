meta:
  id: "251201-unified-drag-system"
  title: "统一拖拽系统：同时支持列表排序和任务移入"
  status: draft
  owner: "开发团队"
  created_at: "2025-11-01"
  estimated_effort: "11-16小时"
  design_doc: "251201-unified-drag-system"

background:
  problem: |
    当前拖拽系统存在手势冲突问题：
    
    1. **排序功能**（使用 ReorderableListView）：
       - 通过 `ReorderableDragStartListener` 启动拖拽，传递索引数据
       - 显示相邻任务让位动画
       - 工作正常
    
    2. **移入功能**（使用 DragTarget）：
       - 通过 `StandardDraggable` 的 `LongPressDraggable<Task>` 启动拖拽，传递 Task 数据
       - 显示目标任务变色（hover 效果）
       - **当前失效**：`ReorderableDragStartListener` 优先捕获手势，阻止 `LongPressDraggable<Task>` 启动
    
    3. **冲突根源**：
       - `ReorderableDragStartListener` 包裹整个 item，优先捕获长按手势
       - 一旦被捕获，启动 ReorderableListView 的内部拖拽系统（传递索引）
       - `StandardDraggable` 的 `LongPressDraggable<Task>` 无法启动
       - `DragTarget<Task>` 收不到 Task 数据，只能收到索引数据
       - 结果：排序功能正常，移入功能完全失效

  goal: |
    实现统一拖拽系统，在一个长按拖拽中同时支持：
    1. **列表内排序**：在两个任务之间显示插入位置，相邻任务让位
    2. **任务移入**：在目标任务上显示变色高亮，使其成为子任务
    3. **智能判断**：根据拖拽位置自动判断用户意图（排序 vs 移入）
    4. **统一视觉反馈**：同时显示两种动画，让用户清楚看到两种可能
    5. **最终决策**：松手时根据当前位置决定执行排序还是移入操作

solution:
  approach: |
    核心策略：移除 `ReorderableDragStartListener`，完全使用 `StandardDraggable` 的 `LongPressDraggable<Task>` 启动拖拽。
    
    在拖拽过程中，根据鼠标位置动态判断用户意图：
    - 在两个任务之间（插入容错区间内，上下各 16 像素）→ 显示排序动画
    - 在任务中间区域（排除上下边缘 16 像素）→ 显示移入动画
    松手时根据当前位置执行对应操作。
  
  key_changes:
    - "移除 `ReorderableListView.onReorder`，改用自定义排序处理"
    - "移除 `ReorderableDragStartListener`，改用 `StandardDraggable` 启动拖拽"
    - "在任务之间添加插入目标（DragTarget），容错区间上下各 16 像素"
    - "实现位置检测逻辑：判断鼠标是在插入区间还是任务表面"
    - "实现视觉反馈系统：同时显示插入线和任务变色"
    - "实现相邻任务让位动画（使用 AnimatedList 或手动偏移）"

implementation:
  phase_1_constants:
    name: "更新拖拽常量定义"
    description: |
      更新 `DragConstants` 类，添加统一拖拽系统需要的常量：
      - 插入容错区间：上下各 16 像素
      - 插入目标总高度：34 像素（2 像素插入线 + 上下各 16 像素容错）
      - 任务表面排除区：上下各 16 像素
    
    steps:
      - file: "lib/core/constants/drag_constants.dart"
        action: "modify"
        changes:
          - 添加 `insertionToleranceZone = 16.0`（插入容错区间，上下各 16 像素）
          - 添加 `insertionTargetHeight = 34.0`（插入目标总高度：2 像素插入线 + 上下各 32 像素容错）
          - 添加 `taskSurfaceExclusionZone = 16.0`（任务表面排除区，上下各 16 像素，判定为插入）
          - 更新 `insertionHitHeight` 为 1.0（保持透明命中区）
          - 保持 `insertionLineHeight = 2.0`（插入线可见高度）

  phase_2_position_detector:
    name: "实现位置检测工具类"
    description: |
      创建 `TaskDragPositionDetector` 类，用于检测鼠标位置并判断用户意图：
      - 检查鼠标是否在插入容错区间内
      - 检查鼠标是否在任务中间区域
      - 实现优先级判断（插入优先于移入）
    
    steps:
      - file: "lib/presentation/common/drag/task_drag_position_detector.dart"
        action: "create"
        content: |
          创建新的工具类，包含：
          - `class TaskDragPositionDetector`：位置检测工具类
          - `enum DragIntent`：拖拽意图枚举（sorting, dragIn, none）
          - `DragIntent detectIntent(Offset globalPosition, ...)`：检测拖拽意图
          - `InsertionPosition? findInsertionPosition(...)`：查找插入位置
          - `Task? findTaskSurface(...)`：查找任务表面
          
          使用 RenderBox 的坐标转换方法进行位置检测

  phase_3_drag_state_manager:
    name: "实现拖拽状态管理器"
    description: |
      创建 `UnifiedDragStateManager` 类，用于管理统一拖拽的状态：
      - 跟踪当前拖拽的任务
      - 跟踪当前悬停的插入位置
      - 跟踪当前悬停的任务表面
      - 提供状态变更通知（使用 ChangeNotifier 或 Riverpod）
    
    steps:
      - file: "lib/presentation/common/drag/unified_drag_state_manager.dart"
        action: "create"
        content: |
          创建状态管理器类，包含：
          - `class UnifiedDragStateManager extends ChangeNotifier`
          - `Task? draggedTask`：当前拖拽的任务
          - `int? hoveredInsertionIndex`：当前悬停的插入位置索引
          - `int? hoveredTaskId`：当前悬停的任务 ID
          - `void startDrag(Task task)`：开始拖拽
          - `void updateHover(...)`：更新悬停状态
          - `void endDrag()`：结束拖拽
          - `DragIntent get currentIntent`：获取当前拖拽意图

  phase_4_insertion_targets:
    name: "实现插入目标组件"
    description: |
      修改 `TaskDragIntentTarget`，添加插入目标支持：
      - 在两个任务之间添加插入目标（DragTarget）
      - 容错区间：上下各 16 像素（总共 34 像素）
      - 显示插入线视觉反馈（2 像素高亮线）
      - 处理插入位置的悬停状态
    
    steps:
      - file: "lib/presentation/common/drag/task_drag_intent_target.dart"
        action: "modify"
        changes:
          - 确保 `insertion` 样式支持自定义容错区间
          - 修改 `_buildInsertion` 方法，使用 `DragConstants.insertionTargetHeight`
          - 更新插入线的高度和容错区间的计算
          - 确保插入目标可以接收 `Task` 数据

  phase_5_remove_reorderable_listener:
    name: "移除 ReorderableDragStartListener"
    description: |
      在 `InboxTaskList` 和 `TaskSectionTaskModeList` 中：
      - 移除 `ReorderableDragStartListener` 包裹
      - 移除 `ReorderableListView.onReorder` 回调
      - 改用 `StandardDraggable` 启动拖拽（已在 `TaskTileContent` 中）
    
    steps:
      - file: "lib/presentation/inbox/views/inbox_task_list.dart"
        action: "modify"
        changes:
          - 移除 `ReorderableDragStartListener` 包裹
          - 移除 `onReorder` 回调（暂时保留 `_handleReorder` 方法，后续用于自定义排序）
          - 直接返回 `TaskDragIntentTarget.surface` 包裹的 `InboxTaskTile`
      
      - file: "lib/presentation/tasks/views/task_section_list.dart"
        action: "modify"
        changes:
          - 移除 `ReorderableDragStartListener` 包裹
          - 移除 `onReorder` 回调（暂时保留 `_handleReorder` 方法）
          - 直接返回 `TaskDragIntentTarget.surface` 包裹的 `TaskWithParentChain`

  phase_6_insertion_targets_layout:
    name: "在列表中布局插入目标"
    description: |
      在 `InboxTaskList` 和 `TaskSectionTaskModeList` 中：
      - 在两个任务之间添加 `TaskDragIntentTarget.insertion`
      - 插入目标应该使用 `Column` 或自定义布局包裹任务和插入目标
      - 确保插入目标的容错区间正确设置（上下各 16 像素）
    
    steps:
      - file: "lib/presentation/inbox/views/inbox_task_list.dart"
        action: "modify"
        changes:
          - 修改 `itemBuilder`，在任务之间添加插入目标
          - 使用 `Column` 或自定义布局包裹插入目标和任务
          - 插入目标放置在任务之前（或之后），容错区间为上下各 16 像素
          - 示例结构：
            ```dart
            Column(
              children: [
                TaskDragIntentTarget.insertion(
                  meta: TaskDragIntentMeta(...),
                  index: index,
                  onPerform: (draggedTask, ...) => _handleReorder(...),
                ),
                TaskDragIntentTarget.surface(
                  meta: TaskDragIntentMeta(...),
                  child: InboxTaskTile(...),
                ),
              ],
            )
            ```
      
      - file: "lib/presentation/tasks/views/task_section_list.dart"
        action: "modify"
        changes:
          - 同样的修改，在任务之间添加插入目标

  phase_7_position_detection_integration:
    name: "集成位置检测逻辑"
    description: |
      在 `InboxTaskList` 和 `TaskSectionTaskModeList` 中：
      - 使用 `TaskDragPositionDetector` 检测鼠标位置
      - 使用 `UnifiedDragStateManager` 管理拖拽状态
      - 在拖拽过程中更新悬停状态（插入位置或任务表面）
      - 在松手时根据当前位置执行对应操作
    
    steps:
      - file: "lib/presentation/inbox/views/inbox_task_list.dart"
        action: "modify"
        changes:
          - 添加 `UnifiedDragStateManager` 的状态监听
          - 在 `StandardDraggable` 的拖拽回调中，使用 `TaskDragPositionDetector` 检测位置
          - 根据检测结果更新 `UnifiedDragStateManager` 的状态
          - 在插入目标的 `onAccept` 中调用 `_handleReorder`
          - 在任务表面的 `onAccept` 中调用 `TaskDragIntentHelper.handleDropOnTask`
      
      - file: "lib/presentation/tasks/views/task_section_list.dart"
        action: "modify"
        changes:
          - 同样的修改，集成位置检测逻辑

  phase_8_visual_feedback:
    name: "实现视觉反馈系统"
    description: |
      实现统一的视觉反馈：
      - 插入线：在插入容错区间内显示 2 像素高亮线
      - 任务变色：在任务中间区域显示半透明主题色背景
      - 相邻任务让位：使用 AnimatedList 或手动计算位置偏移
      - 确保两种动画可以同时显示且不冲突
    
    steps:
      - file: "lib/presentation/inbox/views/inbox_task_list.dart"
        action: "modify"
        changes:
          - 使用 `UnifiedDragStateManager` 的状态来控制视觉反馈
          - 监听 `hoveredInsertionIndex`，显示对应的插入线
          - 监听 `hoveredTaskId`，显示对应任务的变色效果
          - 实现相邻任务让位动画（使用 `AnimatedContainer` 或 `AnimatedPositioned`）
      
      - file: "lib/presentation/tasks/views/task_section_list.dart"
        action: "modify"
        changes:
          - 同样的修改，实现视觉反馈
      
      - file: "lib/presentation/common/drag/task_drag_intent_target.dart"
        action: "modify"
        changes:
          - 确保 `_buildSurface` 方法根据 `UnifiedDragStateManager` 的状态显示 hover 效果
          - 确保 `_buildInsertion` 方法根据状态显示插入线

  phase_9_custom_sorting_logic:
    name: "实现自定义排序逻辑"
    description: |
      实现自定义排序处理，替代 `ReorderableListView.onReorder`：
      - 在插入目标的 `onAccept` 中调用 `_handleReorder`
      - 使用 `TaskDragPositionDetector` 确定插入位置
      - 计算新的 `sortIndex` 并更新任务
      - 保持原有的排序逻辑不变
    
    steps:
      - file: "lib/presentation/inbox/views/inbox_task_list.dart"
        action: "modify"
        changes:
          - 修改 `_handleReorder` 方法，接受拖拽任务和插入位置索引
          - 使用 `TaskDragPositionDetector` 确定插入位置（before/after）
          - 计算新的 `sortIndex`（使用 `calculateSortIndex`）
          - 调用 `TaskService.updateDetails` 更新任务
      
      - file: "lib/presentation/tasks/views/task_section_list.dart"
        action: "modify"
        changes:
          - 同样的修改，实现自定义排序逻辑

  phase_10_remove_reorderable_listview:
    name: "移除 ReorderableListView，改用普通 ListView"
    description: |
      由于不再使用 `ReorderableListView` 的排序功能，可以改用普通的 `ListView.builder`：
      - 移除 `ReorderableListView.builder`，改用 `ListView.builder` 或 `Column`
      - 移除 `proxyDecorator`（或保留用于视觉反馈）
      - 移除 `buildDefaultDragHandles` 参数
      - 保留 `shrinkWrap` 和 `physics` 参数
    
    steps:
      - file: "lib/presentation/inbox/views/inbox_task_list.dart"
        action: "modify"
        changes:
          - 将 `ReorderableListView.builder` 改为 `ListView.builder` 或 `Column`
          - 移除 `onReorder`、`buildDefaultDragHandles` 参数
          - 保留或移除 `proxyDecorator`（如果需要保留拖拽视觉反馈，可以保留）
      
      - file: "lib/presentation/tasks/views/task_section_list.dart"
        action: "modify"
        changes:
          - 同样的修改，改用普通 ListView

  phase_11_yielding_animation:
    name: "实现相邻任务让位动画"
    description: |
      实现相邻任务让位动画（yielding animation）：
      - 当鼠标悬停在插入位置时，相邻任务平滑移动，为插入位置腾出空间
      - 使用 `AnimatedList` 或手动计算位置偏移
      - 动画时长：300ms，缓动曲线：easeOutCubic
      - 与插入线视觉反馈同步
    
    steps:
      - file: "lib/presentation/inbox/views/inbox_task_list.dart"
        action: "modify"
        changes:
          - 使用 `AnimatedList` 或 `Stack` + `AnimatedPositioned` 实现让位动画
          - 根据 `UnifiedDragStateManager.hoveredInsertionIndex` 计算相邻任务的偏移量
          - 使用 `AnimatedContainer` 或 `AnimatedPositioned` 平滑过渡
          - 动画时长：300ms，缓动曲线：Curves.easeOutCubic
      
      - file: "lib/presentation/tasks/views/task_section_list.dart"
        action: "modify"
        changes:
          - 同样的修改，实现让位动画

  phase_12_testing:
    name: "测试与优化"
    description: |
      进行全面测试和优化：
      - 单元测试：位置检测逻辑
      - 单元测试：决策逻辑（排序 vs 移入）
      - 集成测试：完整拖拽流程
      - 性能测试：动画流畅度
      - 用户体验测试：容错区间是否足够
      - 边界情况测试：快速拖拽、边界拖拽等
    
    steps:
      - file: "test/unit/common/drag/task_drag_position_detector_test.dart"
        action: "create"
        content: |
          创建单元测试，测试：
          - 插入位置检测
          - 任务表面检测
          - 优先级判断
          - 边界情况（边界坐标、重叠区域等）
      
      - file: "test/integration/tasks/unified_drag_test.dart"
        action: "create"
        content: |
          创建集成测试，测试：
          - 完整拖拽排序流程
          - 完整拖拽移入流程
          - 边界情况（快速拖拽、边界拖拽等）
          - 视觉反馈（插入线、任务变色、让位动画）

risks:
  - |
    **性能风险**：
    - 实时位置检测可能影响性能（特别是任务列表很长时）
    - 缓解：使用节流（throttle）限制检测频率，或使用 RenderBox 的高效坐标转换
  
  - |
    **用户体验风险**：
    - 容错区间可能仍然太小或太大
    - 缓解：先实现 16 像素，根据用户反馈调整
  
  - |
    **动画冲突**：
    - 同时显示插入线和任务变色可能导致视觉混乱
    - 缓解：插入线和任务变色使用不同颜色，或根据优先级隐藏其中一个
  
  - |
    **坐标转换复杂性**：
    - 需要准确转换全局坐标到相对坐标
    - 缓解：使用 Flutter 提供的 RenderBox.localToGlobal 和 globalToLocal 方法

rollback_plan:
  - |
    如果统一拖拽系统实现失败或用户体验不佳，可以回滚到当前状态：
    1. 恢复 `ReorderableDragStartListener` 包裹
    2. 恢复 `ReorderableListView.onReorder` 回调
    3. 移除插入目标组件
    4. 移除位置检测逻辑
    5. 保留 `TaskDragIntentTarget.surface` 在外层的结构（因为这是修复拖拽移入功能的关键）

success_criteria:
  - |
    **功能完整性**：
    - ✅ 列表内排序功能正常工作
    - ✅ 拖拽移入功能正常工作
    - ✅ 两种功能在同一个拖拽手势中可用
    - ✅ 根据拖拽位置自动判断用户意图
  
  - |
    **用户体验**：
    - ✅ 容错区间足够大，用户可以轻松操作
    - ✅ 视觉反馈清晰，用户可以清楚看到两种可能
    - ✅ 动画流畅，无卡顿或延迟
    - ✅ 边界情况处理得当（快速拖拽、边界拖拽等）
  
  - |
    **代码质量**：
    - ✅ 代码结构清晰，易于维护
    - ✅ 性能良好，不影响列表滚动和渲染
    - ✅ 测试覆盖完整，包括单元测试和集成测试

