meta:
  id: "250105-project-page-redesign"
  title: "项目页面重新设计迭代蓝图"
  based_on: "documents/spec/projects/design/250105-project-page-redesign.yaml"
  status: draft
  owner: "AI Assistant"
  created_at: "2025-01-05"

scope:
  includes:
    - "项目页面状态筛选功能"
    - "项目卡片操作菜单（编辑、状态变更）"
    - "项目编辑功能（Bottom Sheet）"
    - "项目状态变更功能（完成/归档/删除/恢复）"
    - "里程碑管理功能（添加/编辑/删除）"
    - "项目卡片状态标识显示"
    - "项目页面布局重构（CustomScrollView + Slivers）"
  excludes:
    - "暂停项目功能（保持现有实现）"
    - "项目搜索功能（后续优化）"
    - "批量操作功能（后续优化）"
    - "项目排序功能（后续优化）"

changes:
  code_updates:
    # 新增文件
    - file: "lib/core/providers/project_filter_providers.dart"
      type: create
      intent: "项目状态筛选Provider，定义ProjectFilterStatus枚举和projectFilterStatusProvider"
    
    - file: "lib/presentation/tasks/projects/widgets/project_status_filter.dart"
      type: create
      intent: "项目状态筛选器组件，使用水平滚动的FilterChip"
    
    - file: "lib/presentation/tasks/projects/widgets/project_edit_sheet.dart"
      type: create
      intent: "项目编辑Bottom Sheet，复用ProjectCreationSheet的设计"
    
    - file: "lib/presentation/tasks/projects/widgets/milestone_edit_sheet.dart"
      type: create
      intent: "里程碑编辑Bottom Sheet，复用MilestoneDraftTile的设计"
    
    # 修改文件 - 数据层
    - file: "lib/data/repositories/project_repository.dart"
      type: modify
      intent: "添加watchProjectsByStatus方法，支持按状态筛选项目"
    
    - file: "lib/core/services/project_service.dart"
      type: modify
      intent: "添加completeProject、trashProject、restoreProject方法，完善状态变更功能"
    
    - file: "lib/core/services/milestone_service.dart"
      type: modify
      intent: "添加create、update方法，支持里程碑的添加和编辑"
    
    # 修改文件 - Provider层
    - file: "lib/core/providers/task_query_providers.dart"
      type: modify
      intent: "添加projectsByStatusProvider，根据筛选状态返回对应项目列表，或修改projectsDomainProvider支持状态筛选"
    
    - file: "lib/core/providers/app_providers.dart"
      type: modify
      intent: "导出project_filter_providers.dart中的Provider"
    
    # 修改文件 - UI层
    - file: "lib/presentation/projects/projects_page.dart"
      type: modify
      intent: "保持现有结构，使用ProjectsDashboard"
    
    - file: "lib/presentation/tasks/projects/projects_dashboard.dart"
      type: modify
      intent: "重构为CustomScrollView + Slivers布局，添加状态筛选器，集成新的Provider"
    
    - file: "lib/presentation/tasks/projects/project_card.dart"
      type: modify
      intent: "添加操作菜单按钮（PopupMenuButton），添加状态标识显示，增强展开区域支持里程碑操作"
    
    - file: "lib/presentation/tasks/projects/widgets/project_details.dart"
      type: create
      intent: "提取项目详情组件，包含里程碑列表和添加按钮"
    
    - file: "lib/presentation/tasks/milestones/milestone_card.dart"
      type: modify
      intent: "添加长按菜单支持，添加编辑/删除操作"
    
    # 测试文件
    - file: "test/presentation/projects/projects_page_test.dart"
      type: modify
      intent: "更新测试以覆盖新的状态筛选和操作菜单功能"
    
    - file: "test/core/services/project_service_test.dart"
      type: modify
      intent: "添加completeProject、trashProject、restoreProject方法的测试"
    
    - file: "test/core/services/milestone_service_test.dart"
      type: create
      intent: "创建里程碑服务测试，覆盖create、update、delete方法"

  data_model:
    - entity: "ProjectRepository"
      change: "新增方法watchProjectsByStatus(ProjectFilterStatus status)，返回按状态筛选的项目流"
      impact: "需要在IsarProjectRepository中实现状态筛选逻辑，复用现有的_isActiveProjectStatus辅助方法"
    
    - entity: "ProjectService"
      change: "新增方法completeProject、trashProject、restoreProject，完善状态变更功能"
      impact: "需要更新ProjectUpdate，添加日志记录，触发指标重新计算"
    
    - entity: "MilestoneService"
      change: "新增方法createMilestone、updateMilestone，支持里程碑的创建和编辑"
      impact: "MilestoneRepository已有create和update方法，MilestoneService需要添加对应的业务逻辑方法，包括日志记录和验证"

  state_management:
    - provider: "projectFilterStatusProvider"
      type: create
      location: "lib/core/providers/project_filter_providers.dart"
      intent: "StateProvider<ProjectFilterStatus>，管理当前选中的项目状态筛选"
      default: "ProjectFilterStatus.active"
    
    - provider: "projectsByStatusProvider"
      type: create
      location: "lib/core/providers/task_query_providers.dart"
      intent: "StreamProvider<List<Project>>，根据projectFilterStatusProvider返回对应状态的项目列表"
      dependencies: ["projectFilterStatusProvider", "projectServiceProvider"]
      note: "替换或补充现有的projectsDomainProvider，后者只返回活跃项目"

  tests:
    - type: unit
      focus: "ProjectRepository的状态筛选逻辑（_isActiveProjectStatus、状态判断）"
      files: ["test/data/repositories/project_repository_test.dart"]
    
    - type: unit
      focus: "ProjectService的状态变更方法（completeProject、trashProject、restoreProject）"
      files: ["test/core/services/project_service_test.dart"]
    
    - type: unit
      focus: "MilestoneService的CRUD方法（create、update、delete）"
      files: ["test/core/services/milestone_service_test.dart"]
    
    - type: widget
      focus: "ProjectStatusFilter组件的筛选功能"
      files: ["test/presentation/tasks/projects/widgets/project_status_filter_test.dart"]
    
    - type: widget
      focus: "ProjectCard的操作菜单和状态标识显示"
      files: ["test/presentation/tasks/projects/project_card_test.dart"]
    
    - type: widget
      focus: "ProjectsDashboard的布局和状态筛选集成"
      files: ["test/presentation/projects/projects_page_test.dart"]
    
    - type: integration
      focus: "项目状态筛选的端到端流程"
      files: ["integration_test/projects_status_filter_test.dart"]
    
    - type: integration
      focus: "项目编辑和状态变更的完整流程"
      files: ["integration_test/project_operations_test.dart"]
    
    - type: integration
      focus: "里程碑CRUD操作的完整流程"
      files: ["integration_test/milestone_operations_test.dart"]

  documentation:
    - path: "documents/architecture/repositories/project_repository.yaml"
      update_type: modify
      description: "更新ProjectRepository的抽象方法定义，添加watchProjectsByStatus方法"
    
    - path: "documents/architecture/services/project_service.yaml"
      update_type: modify
      description: "更新ProjectService的方法定义，添加状态变更方法"
    
    - path: "documents/architecture/services/milestone_service.yaml"
      update_type: modify
      description: "更新MilestoneService的方法定义，添加create和update方法"
    
    - path: "documents/architecture/pages/projects_page.yaml"
      update_type: modify
      description: "更新项目页面的架构文档，反映新的状态筛选和操作功能"

risks:
  - name: "状态筛选逻辑可能与现有_isActiveProjectStatus逻辑冲突"
    mitigation: "仔细设计状态筛选逻辑，确保与现有逻辑兼容，可能需要重构_isActiveProjectStatus为更通用的状态判断方法"
  
  - name: "项目状态变更后列表刷新可能不及时"
    mitigation: "使用StreamProvider自动响应状态变化，确保UI及时更新；在状态变更操作后显式刷新Provider"
  
  - name: "里程碑编辑Sheet与创建Sheet代码重复"
    mitigation: "提取公共逻辑到共享组件或工具类，复用MilestoneDraftTile的设计"
  
  - name: "项目编辑Sheet与创建Sheet代码重复"
    mitigation: "提取公共逻辑，创建共享的Form组件，ProjectCreationSheet和ProjectEditSheet复用"
  
  - name: "操作菜单项过多可能导致菜单过长"
    mitigation: "根据项目状态动态显示菜单项，只显示当前状态可用的操作；考虑使用分组菜单"
  
  - name: "状态变更操作的确认对话框可能影响用户体验"
    mitigation: "区分危险操作和非危险操作，危险操作（删除、归档）需要确认，非危险操作（完成、恢复）不需要确认"

verification:
  checklist:
    - "运行 flutter analyze 确保无静态分析错误"
    - "运行 flutter test 确保所有单元测试和组件测试通过"
    - "运行 flutter test integration_test/ 确保集成测试通过"
    - "手动测试状态筛选功能：切换不同状态，验证项目列表正确更新"
    - "手动测试项目编辑功能：编辑标题、描述、截止日期，验证保存成功"
    - "手动测试状态变更功能：完成、归档、删除、恢复项目，验证状态正确变更"
    - "手动测试里程碑管理：添加、编辑、删除里程碑，验证操作成功"
    - "验证空状态显示：各状态筛选下无项目时显示空状态提示"
    - "验证错误处理：网络错误、数据错误等异常情况的处理"
    - "验证滑动操作：保持现有的滑动归档和暂停功能正常工作"
    - "验证操作菜单：各状态下的菜单项正确显示"
    - "验证状态标识：已完成、已归档、回收站项目的视觉标识正确"
    - "验证响应式布局：不同屏幕尺寸下布局正常"
    - "验证键盘适配：编辑Sheet在键盘弹出时正确调整高度"

implementation_phases:
  phase_1:
    title: "数据层和状态管理"
    duration: "1-2天"
    priority: "high"
    tasks:
      - "创建ProjectFilterStatus枚举（all/active/completed/archived/trash）"
      - "创建projectFilterStatusProvider（StateProvider）"
      - "在ProjectRepository接口和实现中添加watchProjectsByStatus方法"
      - "实现状态筛选逻辑（复用_isActiveProjectStatus，扩展为按状态筛选）"
      - "在ProjectService中添加completeProject、trashProject、restoreProject方法"
      - "在MilestoneService中添加createMilestone、updateMilestone方法（包装Repository方法，添加日志）"
      - "创建projectsByStatusProvider，根据筛选状态返回项目列表"
      - "编写数据层和Service层的单元测试"

  phase_2:
    title: "状态筛选器组件"
    duration: "1天"
    priority: "high"
    tasks:
      - "创建ProjectStatusFilter组件，使用FilterChip实现水平滚动筛选"
      - "集成projectFilterStatusProvider"
      - "实现筛选状态切换逻辑"
      - "编写组件测试"

  phase_3:
    title: "项目卡片增强"
    duration: "2-3天"
    priority: "high"
    tasks:
      - "在ProjectCard中添加PopupMenuButton操作菜单（右上角）"
      - "实现菜单项根据项目状态动态显示（编辑/完成/归档/删除/恢复）"
      - "添加项目状态标识显示（已完成：删除线+灰色，已归档：灰色，回收站：红色+标签）"
      - "提取ProjectDetails组件（从ProjectCard中提取展开区域）"
      - "在ProjectDetails中添加里程碑操作按钮（添加里程碑）"
      - "保持现有滑动操作功能（右滑归档，左滑暂停）"
      - "编写组件测试"

  phase_4:
    title: "项目编辑功能"
    duration: "1-2天"
    priority: "high"
    tasks:
      - "创建ProjectEditSheet组件，复用ProjectCreationSheet设计"
      - "实现数据预填充逻辑"
      - "集成编辑功能到操作菜单"
      - "编写组件测试"

  phase_5:
    title: "状态变更功能"
    duration: "1-2天"
    priority: "high"
    tasks:
      - "实现完成项目功能（操作菜单）"
      - "实现删除项目功能（操作菜单，需要确认）"
      - "实现恢复项目功能（操作菜单，仅回收站状态）"
      - "保持现有归档功能（滑动操作和菜单操作）"
      - "实现状态变更后的列表刷新逻辑"
      - "编写集成测试"

  phase_6:
    title: "里程碑管理功能"
    duration: "2-3天"
    priority: "high"
    tasks:
      - "在ProjectDetails中添加'添加里程碑'按钮（TextButton.icon，底部）"
      - "创建MilestoneEditSheet组件，复用MilestoneDraftTile设计（无标签选择）"
      - "实现里程碑添加功能（调用MilestoneService.createMilestone）"
      - "在MilestoneCard中添加长按菜单（编辑/删除）"
      - "实现里程碑编辑功能（调用MilestoneService.updateMilestone）"
      - "实现里程碑删除功能（调用MilestoneService.delete，需要确认对话框）"
      - "确保里程碑操作后列表自动刷新"
      - "编写组件测试和集成测试"

  phase_7:
    title: "页面布局重构"
    duration: "1天"
    priority: "medium"
    tasks:
      - "将ProjectsDashboard重构为CustomScrollView + Slivers布局"
      - "集成ProjectStatusFilter到页面顶部"
      - "使用SliverPadding包裹项目列表"
      - "实现空状态显示"
      - "验证布局与完成/归档页面一致"

  phase_8:
    title: "测试和优化"
    duration: "1-2天"
    priority: "medium"
    tasks:
      - "编写完整的单元测试、组件测试和集成测试"
      - "修复所有测试失败和lint错误"
      - "性能优化（如有必要）"
      - "代码审查和重构"
      - "更新架构文档"

dependencies:
  external:
    - "Flutter Material 3组件库（FilterChip、PopupMenuButton等）"
    - "Riverpod状态管理库"
    - "Isar数据库"
  
  internal:
    - "ProjectRepository接口和实现"
    - "ProjectService服务"
    - "MilestoneService服务"
    - "MilestoneRepository接口和实现"
    - "现有项目卡片组件（ProjectCard）"
    - "现有里程碑卡片组件（MilestoneCard）"
    - "现有Bottom Sheet组件（ProjectCreationSheet、MilestoneDraftTile）"

success_criteria:
  - "项目页面支持5种状态筛选（全部/活跃/已完成/已归档/回收站）"
  - "项目卡片支持操作菜单，菜单项根据状态动态显示"
  - "项目编辑功能正常工作，数据保存成功"
  - "项目状态变更功能正常（完成/归档/删除/恢复）"
  - "里程碑添加/编辑/删除功能正常"
  - "所有状态变更后列表自动刷新"
  - "空状态正确显示"
  - "所有测试通过（单元测试、组件测试、集成测试）"
  - "代码质量符合项目规范（lint通过、无静态分析错误）"
  - "用户体验流畅，操作反馈及时"

rollback_plan:
  - "保留现有ProjectsDashboard的备份"
  - "保留现有ProjectCard的备份"
  - "Git分支管理：在新分支上开发，主分支保持稳定"
  - "如果新功能有问题，可以快速回滚到稳定版本"
  - "数据库Schema无变更，无需数据迁移回滚"

