meta:
  id: "251104-rewrite-integration-tests"
  title: "重写拖拽集成测试：适配新的插入间隔线实现"
  based_on: "documents/spec/tasks/inbox/251103-drag-insertion-line-design.md"
  status: draft
  owner: "开发团队"
  created_at: "2025-11-04"

scope:
  includes:
    - "删除旧的集成测试文件（基于旧实现的测试）"
    - "重写新的集成测试（基于插入间隔线实现）"
    - "测试所有拖拽场景（排序、跨区域、层级管理、边缘滚动）"
    - "验证插入间隔线的视觉反馈"
    - "验证任务层级管理规则"
  excludes:
    - "项目和里程碑相关的集成测试（project_milestone_update_test.dart 保留，如果与拖拽无关）"
    - "单元测试和组件测试（这些已经完成）"

changes:
  code_deletions:
    # ============ 删除旧的集成测试 ============
    - file: "integration_test/tasks_drag_test.dart"
      reason: "基于旧的 ListTile/LongPressDraggable 实现，已不再适用"
    
    - file: "integration_test/cross_section_drag_test.dart"
      reason: "基于旧的拖拽实现，查找方式使用 find.byType(ListTile)，需要重写"
    
    - file: "integration_test/cross_section_drag_comprehensive_test.dart"
      reason: "基于旧的拖拽实现，虽然逻辑有价值，但需要适配新的 Widget 结构"
    
    - file: "integration_test/comprehensive_drag_test.dart"
      reason: "最复杂的测试文件，包含大量测试用例，但基于旧的 Widget 查找方式，需要完全重写"

  code_creations:
    # ============ 新的集成测试文件 ============
    - file: "integration_test/tasks_drag_basic_test.dart"
      intent: "基础拖拽功能测试"
      coverage:
        - "验证 StandardDraggable 和 TaskDragIntentTarget 组件存在"
        - "验证任务卡片可以正常显示和拖拽"
        - "验证插入间隔线在悬停时显示"
        - "验证拖拽反馈（任务卡片半透明）"
    
    - file: "integration_test/tasks_cross_section_drag_test.dart"
      intent: "跨区域拖拽测试"
      coverage:
        - "从 overdue 拖拽到 today"
        - "从 today 拖拽到 tomorrow"
        - "从 thisWeek 拖拽到 thisMonth"
        - "从 thisMonth 拖拽到 later"
        - "从 later 拖拽到 today（远距离跨区域）"
        - "验证任务在数据库中的 section 正确更新"
        - "验证任务在 UI 中的 section 正确显示"
        - "验证插入间隔线在目标区域正确显示"
    
    - file: "integration_test/tasks_inbox_reorder_test.dart"
      intent: "Inbox 页面排序测试"
      coverage:
        - "拖拽到列表开头"
        - "拖拽到列表结尾"
        - "拖拽到两个任务之间"
        - "验证 sortIndex 正确更新"
        - "验证任务顺序在 UI 中正确显示"
        - "验证插入间隔线在不同位置显示"
    
    - file: "integration_test/tasks_section_reorder_test.dart"
      intent: "Tasks 页面区域内排序测试"
      coverage:
        - "每个 section 内的排序（overdue, today, tomorrow, thisWeek, thisMonth, later）"
        - "验证 sortIndex 正确更新"
        - "验证任务在同一 section 内的顺序正确"
        - "验证插入间隔线在区域内正确显示"
    
    - file: "integration_test/tasks_hierarchy_management_test.dart"
      intent: "任务层级管理测试"
      coverage:
        - "拖拽根任务时，所有根任务自动收缩"
        - "展开一个根任务时，其他根任务收缩（Tasks 页面）"
        - "展开一个根任务时，其他根任务不收缩（Inbox 页面）"
        - "拖拽子任务到另一个任务上，成为子任务"
        - "拖拽子任务到两个任务之间，成为根任务"
        - "验证三级任务限制（最多三级）"
        - "验证任务层级在数据库和 UI 中正确"
    
    - file: "integration_test/tasks_edge_auto_scroll_test.dart"
      intent: "边缘自动滚动测试"
      coverage:
        - "拖拽到屏幕顶部时自动向上滚动"
        - "拖拽到屏幕底部时自动向下滚动"
        - "拖拽远离边缘时停止滚动"
        - "跨区域拖拽时，目标区域自动滚动到可视区域"
        - "验证滚动后插入间隔线正确显示"
    
    - file: "integration_test/tasks_drag_insertion_line_test.dart"
      intent: "插入间隔线视觉反馈测试"
      coverage:
        - "插入间隔线在未悬停时不可见"
        - "插入间隔线在悬停时显示（3px 高度，带阴影）"
        - "插入间隔线在顶部位置显示"
        - "插入间隔线在中间位置显示"
        - "插入间隔线在底部位置显示"
        - "插入间隔线动画过渡（120ms）"
        - "插入间隔线颜色和样式符合设计规范"
    
    - file: "integration_test/tasks_drag_comprehensive_test.dart"
      intent: "综合拖拽场景测试"
      coverage:
        - "复杂拖拽场景（跨区域 + 层级变化）"
        - "边界情况（空区域、单任务区域、大量任务区域）"
        - "快速连续拖拽（拖拽后立即拖拽另一个任务）"
        - "拖拽取消（拖拽后释放到无效位置）"
        - "验证数据库一致性（拖拽后任务状态正确）"
        - "验证 UI 一致性（拖拽后列表显示正确）"

  helper_utilities:
    - file: "integration_test/helpers/task_drag_test_helper.dart"
      intent: "拖拽测试辅助工具类"
      features:
        - "创建测试任务（按 section）"
        - "查找任务 Widget（使用新的查找方式：find.text 或 find.byKey）"
        - "执行拖拽手势（适配 StandardDraggable）"
        - "验证插入间隔线显示"
        - "验证任务在数据库中的状态"
        - "验证任务在 UI 中的显示"
        - "等待动画完成"
        - "滚动到目标位置"
    
    - file: "integration_test/helpers/task_section_test_helper.dart"
      intent: "任务区域测试辅助工具类"
      features:
        - "为每个 section 创建测试任务"
        - "验证任务在指定 section 中"
        - "查找 section panel"
        - "获取 section 内的任务列表"

  test_data:
    - file: "integration_test/fixtures/task_test_data.dart"
      intent: "测试数据生成器"
      features:
        - "生成测试任务（不同 title、dueAt、parentId）"
        - "生成测试任务列表（用于排序测试）"
        - "生成测试任务层级（用于层级测试）"

  test_strategy:
    widget_finding:
      old_approach:
        - "find.byType(ListTile) - 不再使用"
        - "find.byType(LongPressDraggable) - 不再使用"
        - "find.byType(DragTarget) - 不再使用"
      new_approach:
        - "find.text(task.title) - 通过任务标题查找"
        - "find.byKey(ValueKey('inbox-${task.id}')) - 通过任务 ID 查找（Inbox）"
        - "find.byKey(ValueKey('tasks-section-${task.id}-...')) - 通过任务 ID 查找（Tasks）"
        - "find.byType(StandardDraggable) - 验证拖拽组件存在"
        - "find.byType(TaskDragIntentTarget) - 验证拖拽目标存在"
        - "find.byWidgetPredicate - 查找插入间隔线（Container with specific decoration）"
    
    drag_gesture:
      old_approach:
        - "tester.longPress() - 直接长按"
        - "等待 600ms 触发 LongPressDraggable"
      new_approach:
        - "tester.startGesture() - 开始手势"
        - "等待 300-400ms 触发 StandardDraggable 的长按"
        - "gesture.moveTo() - 移动到目标位置"
        - "gesture.up() - 释放手势"
    
    verification:
      visual:
        - "验证插入间隔线显示（通过 WidgetPredicate 查找 Container with specific decoration）"
        - "验证任务卡片半透明（通过 Opacity widget）"
        - "验证任务在正确的位置显示"
      data:
        - "通过 Repository 验证任务在数据库中的状态"
        - "验证 sortIndex 正确"
        - "验证 dueAt 正确（跨区域拖拽）"
        - "验证 parentId 正确（层级变化）"
      ui:
        - "验证任务在 UI 中的 section 正确"
        - "验证任务在 UI 中的顺序正确"
        - "验证任务在 UI 中的层级正确（缩进）"

risks:
  - name: "新旧 Widget 结构差异较大，测试工具类需要完全重写"
    mitigation: "创建专门的测试辅助工具类，封装新的查找和验证逻辑"
  
  - name: "插入间隔线可能难以通过 Widget 查找验证"
    mitigation: "使用 WidgetPredicate 查找特定样式的 Container，或通过日志验证"
  
  - name: "StandardDraggable 的长按触发时间可能与 LongPressDraggable 不同"
    mitigation: "在测试中调整等待时间，确保能正确触发拖拽"
  
  - name: "跨区域拖拽涉及数据库更新，需要确保测试数据隔离"
    mitigation: "每个测试前清理测试数据，或使用独立的测试数据库"
  
  - name: "边缘自动滚动涉及异步操作，测试可能需要等待"
    mitigation: "使用 pumpAndSettle 和 Future.delayed 确保滚动完成"
  
  - name: "任务层级管理规则在 Inbox 和 Tasks 页面不同，需要分别测试"
    mitigation: "创建独立的测试文件，分别测试 Inbox 和 Tasks 的层级管理"

verification:
  checklist:
    - "删除所有旧的集成测试文件"
    - "创建新的集成测试文件结构"
    - "实现测试辅助工具类"
    - "运行基础拖拽功能测试，验证 StandardDraggable 和 TaskDragIntentTarget 正常工作"
    - "运行跨区域拖拽测试，验证任务能正确移动到不同 section"
    - "运行排序测试，验证 sortIndex 正确更新"
    - "运行层级管理测试，验证根任务收缩和展开规则"
    - "运行边缘自动滚动测试，验证滚动功能正常"
    - "运行插入间隔线测试，验证视觉反馈正确"
    - "运行综合测试，验证复杂场景"
    - "所有测试通过后，验证代码覆盖率 >= 75%"
    - "检查测试执行时间，确保不会太长（每个测试文件 < 30秒）"

  test_commands:
    - "flutter test integration_test/tasks_drag_basic_test.dart"
    - "flutter test integration_test/tasks_cross_section_drag_test.dart"
    - "flutter test integration_test/tasks_inbox_reorder_test.dart"
    - "flutter test integration_test/tasks_section_reorder_test.dart"
    - "flutter test integration_test/tasks_hierarchy_management_test.dart"
    - "flutter test integration_test/tasks_edge_auto_scroll_test.dart"
    - "flutter test integration_test/tasks_drag_insertion_line_test.dart"
    - "flutter test integration_test/tasks_drag_comprehensive_test.dart"
    - "flutter test integration_test/ --coverage"

  success_criteria:
    - "所有新的集成测试都能通过"
    - "测试覆盖所有主要拖拽场景"
    - "测试执行时间合理（每个测试文件 < 30秒）"
    - "代码覆盖率 >= 75%"
    - "测试代码可读性和可维护性良好"

documentation:
  updates:
    - path: "documents/spec/tasks/inbox/251103-drag-insertion-line-design.md"
      update_type: "无需更新"
      note: "设计文档已经描述了新的实现逻辑"
    
    - path: "README.md"
      update_type: "可能更新"
      note: "如果 README 中有集成测试相关说明，需要更新"
    
    - path: "documents/spec/tasks/inbox/251104-rewrite-integration-tests.yaml"
      update_type: "当前文档"
      note: "本文档记录集成测试重写的规划"

dependencies:
  required:
    - "新的拖拽实现已完成（插入间隔线、任务层级管理、边缘自动滚动）"
    - "单元测试已完成（task_list 相关组件）"
    - "设计文档已确认（251103-drag-insertion-line-design.md）"
  
  optional:
    - "如果项目中有测试数据生成工具，可以复用"
    - "如果有测试辅助工具库，可以复用"

notes:
  - "所有旧的集成测试都应该删除，不要保留任何兼容代码"
  - "新的测试应该基于新的实现，使用新的 Widget 查找方式"
  - "测试辅助工具类应该封装常见的操作，减少重复代码"
  - "测试数据应该在每个测试前清理，确保测试隔离"
  - "如果测试失败，应该提供清晰的错误信息，便于调试"
  - "测试应该验证视觉效果（插入间隔线）和数据一致性（数据库状态）"

