meta:
  id: "251201-tasks-inline-edit"
  title: "任务列表内联编辑优化 - 标签和截止日期快速操作"
  status: draft
  owner: "AI Assistant"
  created: "2025-12-01"

background:
  problem: |
    当前的任务列表（Tasks）和收藏夹（Inbox）存在以下交互效率问题：
    1. 修改任务标签需要多步操作：点击任务 → 进入详情页 → 选择标签 → 返回
    2. 标签只读显示，无法快速添加或删除
    3. 截止日期显示冗余："截止日期：明天下午 3:00"，占用空间
    4. 任务信息需要展开/收起才能看到，增加点击次数
    5. 用户无法在列表视图中快速浏览和批量修改任务属性
    6. 不符合现代任务管理应用的"直接操作"设计原则
  
  goal: |
    采用内联编辑（Inline Editing）设计，提升任务列表的操作效率：
    1. 标签可点击删除（× 图标）
    2. 标签可快速添加（下拉菜单，按组显示，同组互斥）
    3. 截止日期简洁显示（图标 + 时间，可点击编辑）
    4. 所有关键信息直接展示在列表项中，减少展开/收起操作
    5. 保留子任务的展开/收起功能（避免列表过长）
    6. 符合 Notion、Linear、ClickUp 等现代应用的交互习惯

user_flows:
  - name: "删除任务标签"
    steps:
      - "用户在任务列表中看到任务，标签已选中（如 [紧急 ×]）"
      - "点击标签右侧的 × 图标"
      - "标签立即从任务中移除，无需确认"
      - "UI 实时更新，标签消失"
      - "如果该标签是唯一的同组标签，[+ 标签 ▼] 按钮出现"
  
  - name: "添加任务标签"
    steps:
      - "用户看到任务的标签行，显示 [紧急 ×] [重要 ×] [+ 标签 ▼]"
      - "点击 [+ 标签 ▼] 按钮"
      - "弹出下拉菜单，按组显示未选择的标签组"
      - "用户选择 '开发' 标签"
      - "下拉菜单关闭，标签立即添加到任务"
      - "标签行更新为 [紧急 ×] [重要 ×] [开发 ×]"
  
  - name: "替换同组标签"
    steps:
      - "用户看到任务标签 [紧急 ×] [重要 ×]"
      - "点击 [+ 标签 ▼]，选择 '不紧急'（与 '紧急' 同组）"
      - "系统自动移除 [紧急]，添加 [不紧急]"
      - "标签行更新为 [不紧急 ×] [重要 ×]"
  
  - name: "编辑截止日期"
    steps:
      - "用户看到截止日期显示：📅 明天 15:00"
      - "点击截止日期文本"
      - "打开日期时间选择器"
      - "用户选择新的日期和时间"
      - "确认后，截止日期立即更新"
  
  - name: "设置截止日期（无截止日期）"
    steps:
      - "用户看到任务没有截止日期，显示 [+ 设置截止日期]"
      - "点击按钮"
      - "打开日期时间选择器"
      - "用户选择日期和时间"
      - "确认后，显示为 📅 XX月XX日 XX:XX"

ui_behavior:
  layout: |
    任务列表项（当前设计）：
    ┌────────────────────────────────────────────┐
    │ ☐ 任务标题                          [▼]    │ ← 需要点击展开
    │   截止日期：明天下午 3:00                   │ ← 冗余文本
    │   [紧急] [重要] [开发]                     │ ← 只读标签
    └────────────────────────────────────────────┘
    
    任务列表项（新设计）：
    ┌────────────────────────────────────────────┐
    │ ☐ 🔧 任务标题                              │ ← 第一行：状态 + 图标 + 标题
    │ [紧急 ×] [重要 ×] [开发 ×] [+ 标签 ▼]      │ ← 第二行：可操作标签
    │ 📅 明天 15:00                              │ ← 第三行：简洁截止日期
    │ ─ ☐ 子任务 1  [▼]                         │ ← 可选展开子任务
    └────────────────────────────────────────────┘
    
    标签下拉菜单（按组显示）：
    ┌────────────────────────────┐
    │ 紧急程度                    │
    │   ○ 紧急                   │
    │   ○ 不紧急                 │
    │                            │
    │ 重要程度                    │
    │   ○ 重要                   │
    │   ○ 不重要                 │
    │                            │
    │ 执行方式                    │
    │   ○ 开发                   │
    │   ○ 设计                   │
    │   ○ 沟通                   │
    │   ...                      │
    └────────────────────────────┘
  
  components:
    - name: "InlineEditableTag"
      purpose: "可删除的标签，显示标签名 + × 图标"
      interactions: ["悬停高亮", "点击 × 删除"]
      design:
        - "基于现有 ModernTag 组件"
        - "右侧添加 × 图标（8x8px）"
        - "悬停时 × 图标高亮"
        - "点击 × 触发删除回调"
        - "删除时有轻微动画（fade out）"
    
    - name: "TagAddButton"
      purpose: "添加标签按钮，打开下拉菜单"
      interactions: ["点击打开菜单", "选择标签", "关闭菜单"]
      design:
        - "圆角按钮，虚线边框"
        - "图标 + 文本：'+ 标签 ▼'"
        - "只在有未选择的标签组时显示"
        - "点击打开 PopupMenuButton（桌面）或 BottomSheet（移动）"
    
    - name: "TagGroupedMenu"
      purpose: "按标签组分组的下拉菜单"
      interactions: ["显示分组标题", "选择标签", "同组互斥"]
      design:
        - "分组标题：灰色小字，不可点击"
        - "标签项：单选，选中后菜单关闭"
        - "只显示未选择的标签组"
        - "同组标签自动替换（无需用户手动删除）"
    
    - name: "InlineDeadlineEditor"
      purpose: "可点击编辑的截止日期显示"
      interactions: ["点击打开日期选择器", "选择日期时间", "更新显示"]
      design:
        - "图标 📅 + 格式化时间文本"
        - "相对时间：'明天'、'后天'、'本周五'"
        - "绝对时间：'12月1日 15:00'、'2025年1月1日'"
        - "过期时：红色背景 + 文本"
        - "无截止日期：显示 [+ 设置截止日期] 按钮"
        - "点击打开 showDateTimePicker"
  
  states:
    - condition: "任务无标签"
      appearance: "只显示 [+ 标签 ▼] 按钮"
    
    - condition: "任务有标签，且所有标签组已选择"
      appearance: "显示所有标签，不显示 [+ 标签 ▼] 按钮"
    
    - condition: "任务有标签，且有未选择的标签组"
      appearance: "显示已选标签 + [+ 标签 ▼] 按钮"
    
    - condition: "标签悬停"
      appearance: "× 图标高亮，标签背景加深 5%"
    
    - condition: "截止日期已过期"
      appearance: "红色背景，白色文字，显示 '⚠ 已逾期'"
    
    - condition: "截止日期临近（24小时内）"
      appearance: "橙色背景，显示 '⏰ 即将到期'"
    
    - condition: "无截止日期"
      appearance: "显示灰色虚线按钮 [+ 设置截止日期]"
    
    - condition: "任务有子任务"
      appearance: "第四行显示子任务（默认收起，可展开）"
    
    - condition: "任务无子任务"
      appearance: "不显示子任务区域"

design_principles:
  interaction:
    - "直接操作（Direct Manipulation）：在列表中直接修改，无需进入详情页"
    - "即时反馈：操作立即生效，无需保存按钮"
    - "可逆操作：删除标签可快速添加回来"
    - "渐进式披露：标签菜单按需显示，不展示已选择的标签组"
    - "视觉连续性：动画过渡，避免突兀的 UI 变化"
  
  visual:
    - "保持项目一致性：使用现有 ModernTag 组件样式"
    - "信息层次清晰：第一行（标题）> 第二行（标签）> 第三行（截止日期）"
    - "减少视觉噪音：去掉冗余文本（如 '截止日期：'）"
    - "图标引导：使用 📅 等 emoji 图标快速识别信息类型"
  
  efficiency:
    - "减少点击次数：从 4-5 次点击减少到 1-2 次"
    - "批量操作友好：用户可以快速浏览和修改多个任务"
    - "键盘友好：支持 Tab 导航和 Enter 确认"
  
  accessibility:
    - "保留 Semantics 标签"
    - "足够大的点击区域（× 图标 44x44 触控区域）"
    - "高对比度模式支持"
    - "屏幕阅读器支持"

technical_scope:
  modified_components:
    - name: "_TaskLeafTile"
      path: "lib/presentation/tasks/task_list_page.dart"
      changes:
        - "移除 ExpansionTile，改为平铺显示"
        - "第一行：Checkbox + 执行方式图标 + 标题"
        - "第二行：InlineEditableTag 列表 + TagAddButton"
        - "第三行：InlineDeadlineEditor"
        - "第四行：子任务列表（保留 ExpansionTile）"
    
    - name: "_TaskTitle"
      path: "lib/presentation/tasks/task_list_page.dart"
      changes:
        - "简化为纯标题显示，移除标签和截止日期"
        - "标签和截止日期移到独立行"
    
    - name: "_TaskHeaderRow"
      path: "lib/presentation/tasks/task_list_page.dart"
      changes:
        - "重构为三行布局"
        - "集成 InlineEditableTag 和 TagAddButton"
        - "集成 InlineDeadlineEditor"
  
  new_components:
    - name: "InlineEditableTag"
      path: "lib/presentation/widgets/inline_editable_tag.dart"
      purpose: "可删除的标签组件，带 × 图标"
    
    - name: "TagAddButton"
      path: "lib/presentation/widgets/tag_add_button.dart"
      purpose: "添加标签按钮，打开分组菜单"
    
    - name: "TagGroupedMenu"
      path: "lib/presentation/widgets/tag_grouped_menu.dart"
      purpose: "按标签组分组的菜单，支持同组互斥"
    
    - name: "InlineDeadlineEditor"
      path: "lib/presentation/widgets/inline_deadline_editor.dart"
      purpose: "可点击编辑的截止日期显示"
  
  i18n_keys:
    - "taskAddTag": "添加标签"
    - "taskSetDeadline": "设置截止日期"
    - "taskDeadlineOverdue": "已逾期"
    - "taskDeadlineSoon": "即将到期"
    - "taskRemoveTag": "移除标签"
    - "taskEditDeadline": "编辑截止日期"
  
  providers:
    - name: "不需要新的 Provider"
      note: "使用现有的 taskServiceProvider 和 tagOptionsProvider"
  
  test_files:
    - "test/presentation/widgets/inline_editable_tag_test.dart"
    - "test/presentation/widgets/tag_add_button_test.dart"
    - "test/presentation/widgets/tag_grouped_menu_test.dart"
    - "test/presentation/widgets/inline_deadline_editor_test.dart"
    - "test/presentation/tasks/task_list_inline_edit_test.dart"

implementation_details:
  tag_operations:
    add:
      - "用户点击 [+ 标签 ▼]"
      - "查询所有可用标签组（urgency, importance, execution, etc.）"
      - "过滤掉已选择的标签组"
      - "显示剩余标签组的菜单"
      - "用户选择标签 → 调用 taskService.addTag(taskId, tagSlug)"
      - "如果该标签与已有标签同组 → 先移除同组标签"
      - "UI 实时更新"
    
    remove:
      - "用户点击标签的 × 图标"
      - "调用 taskService.removeTag(taskId, tagSlug)"
      - "标签从 UI 中淡出（200ms fade animation）"
      - "如果移除后该标签组无标签 → 显示 [+ 标签 ▼]"
  
  deadline_operations:
    set:
      - "用户点击 [+ 设置截止日期]"
      - "打开 showDateTimePicker"
      - "用户选择日期和时间"
      - "调用 taskService.updateDetails(taskId, TaskUpdate(dueAt: dateTime))"
      - "UI 更新为 📅 格式化时间"
    
    edit:
      - "用户点击截止日期文本"
      - "打开 showDateTimePicker，预填充当前日期时间"
      - "用户修改日期和时间"
      - "调用 taskService.updateDetails(taskId, TaskUpdate(dueAt: newDateTime))"
      - "UI 更新"
    
    format:
      - "今天：'今天 HH:mm'"
      - "明天：'明天 HH:mm'"
      - "本周：'周X HH:mm'"
      - "其他：'MM月DD日 HH:mm'"
      - "跨年：'YYYY年MM月DD日 HH:mm'"
  
  tag_grouping:
    logic:
      - "标签按 category 分组（urgency, importance, execution, etc.）"
      - "每个组只能选择一个标签（单选）"
      - "选择新标签时，自动移除同组的旧标签"
    
    menu_structure:
      - "分组标题：Text，灰色，12sp"
      - "标签项：ListTile，18px 高度，带单选圆圈"
      - "选中后：菜单关闭，触发添加操作"
    
    filtering:
      - "查询所有标签组"
      - "过滤掉已有标签的组"
      - "只显示剩余的组"
      - "如果没有剩余组 → 不显示 [+ 标签 ▼]"
  
  animations:
    - name: "tag_fade_out"
      type: "AnimatedOpacity"
      duration: "200ms"
      curve: "easeOut"
      from: "1.0"
      to: "0.0"
    
    - name: "tag_slide_in"
      type: "AnimatedSlide"
      duration: "200ms"
      curve: "easeOut"
      from: "offset(1.0, 0)"
      to: "offset(0, 0)"
    
    - name: "button_hover"
      type: "AnimatedContainer"
      duration: "150ms"
      curve: "easeInOut"
      properties: ["backgroundColor", "borderColor"]

open_issues:
  - question: "标签删除是否需要确认？"
    suggestion: "建议：不需要确认，直接删除。如果误删，用户可以快速添加回来。符合现代 UI 习惯。"
  
  - question: "截止日期是否支持清除（移除截止日期）？"
    suggestion: "建议：支持。在日期选择器中添加 '清除截止日期' 按钮。"
  
  - question: "是否需要批量编辑功能？"
    suggestion: "建议：本次迭代不实现。可在后续迭代中添加多选模式 + 批量操作工具栏。"
  
  - question: "子任务是否也需要内联编辑？"
    suggestion: "建议：是的。子任务也应该支持内联编辑标签和截止日期，保持一致性。"
  
  - question: "收藏夹（Inbox）是否使用相同设计？"
    suggestion: "建议：是的。Inbox 使用相同的内联编辑组件，保持一致的用户体验。"

references:
  design_inspiration:
    - "Notion - 数据库视图的内联编辑"
    - "Linear - Issue 列表的快速标签编辑"
    - "ClickUp - 任务列表的属性快速编辑"
    - "Asana - 任务卡片的标签管理"
  
  existing_components:
    - "lib/presentation/widgets/modern_tag.dart - 标签样式基础"
    - "lib/presentation/widgets/tag_selector.dart - 标签选择逻辑"
    - "lib/core/theme/app_theme.dart - 主题系统"
  
  related_specs:
    - "documents/spec/projects/design/251201-tag-style-unification.yaml - 标签样式统一"
    - "documents/spec/widgets/design/251201-flexible-input-redesign.yaml - 输入框现代化"
