meta:
  id: "251104-code-refactoring-file-size"
  title: "代码文件大小重构 - 按 00-global.mdc 规则拆分超限文件"
  based_on: ".cursor/rules/00-global.mdc"
  status: draft
  owner: "AI Assistant"

scope:
  includes:
    - "P0 优先级文件：违反硬性阈值的所有文件"
    - "P1 优先级文件：超过警告阈值的所有文件"
    - "相关测试文件更新"
    - "相关架构文档更新"
  excludes:
    - "生成的代码文件 (*.g.dart)"
    - "不需要拆分的文件（已在阈值内）"

changes:
  code_updates:
    # ========== P0 优先级文件重构 ==========
    
    # 1. task_service.dart (912行 → 目标: 多个 <400行的文件)
    - file: "lib/core/services/task_service.dart"
      type: split
      intent: "按业务职责拆分为多个服务类"
      split_strategy: "按职责拆分"
      target_files:
        - "lib/core/services/task_crud_service.dart"  # 创建、更新、删除
        - "lib/core/services/task_status_service.dart"  # 状态管理（markInProgress, markCompleted, archive, softDelete）
        - "lib/core/services/task_drag_service.dart"  # 拖拽相关方法
        - "lib/core/services/task_promotion_service.dart"  # 任务提升相关
        - "lib/core/services/task_service.dart"  # 保留核心方法，作为协调器或直接删除
      methods_distribution:
        crud: ["captureInboxTask", "planTask", "updateDetails", "updateTags", "clearTrash"]
        status: ["markInProgress", "markCompleted", "archive", "softDelete"]
        drag: ["handleDragBetweenTasks", "handleDragToSectionFirst", "handleDragToSectionLast", "handleInboxDragBetween", "handleInboxDragToFirst", "handleInboxDragToLast"]
        promotion: ["handlePromoteToIndependent", "promoteSubtaskToRoot"]
        query: ["searchTasksByTitle", "watchQuickTasks", "listTagsByKind", "_getAllDescendantTasks"]

    # 2. project_creation_sheet.dart (683行 → 目标: <500行)
    - file: "lib/presentation/tasks/projects/project_creation_sheet.dart"
      type: split
      intent: "提取子组件到独立文件"
      split_strategy: "按功能拆分"
      target_files:
        - "lib/presentation/tasks/projects/project_creation_sheet.dart"  # 主组件
        - "lib/presentation/tasks/projects/widgets/project_tags_section.dart"  # 标签选择区域
        - "lib/presentation/tasks/projects/widgets/milestone_draft_tile.dart"  # 里程碑草稿项（已存在类，提取为独立文件）
        - "lib/presentation/tasks/projects/models/milestone_draft.dart"  # MilestoneDraft 模型

    # 3. task_tag_filter_strip.dart (592行 → 目标: <500行)
    - file: "lib/presentation/widgets/task_tag_filter_strip.dart"
      type: split
      intent: "提取子组件和逻辑"
      split_strategy: "提取子组件"
      target_files:
        - "lib/presentation/widgets/task_tag_filter_strip.dart"  # 主组件
        - "lib/presentation/widgets/task_tag_filter_strip_item.dart"  # 单个标签过滤项
        - "lib/presentation/widgets/task_tag_filter_strip_logic.dart"  # 过滤逻辑（如果有）

    # 4. custom_date_picker.dart (570行 → 目标: <500行)
    - file: "lib/presentation/widgets/custom_date_picker.dart"
      type: split
      intent: "提取日期选择逻辑组件"
      split_strategy: "提取子组件"
      target_files:
        - "lib/presentation/widgets/custom_date_picker.dart"  # 主组件
        - "lib/presentation/widgets/custom_date_picker_calendar.dart"  # 日历视图组件
        - "lib/presentation/widgets/custom_date_picker_actions.dart"  # 操作按钮组件

    # 5. task_row_content.dart (559行 → 目标: <500行)
    - file: "lib/presentation/widgets/task_row_content.dart"
      type: split
      intent: "提取子组件"
      split_strategy: "提取子组件"
      target_files:
        - "lib/presentation/widgets/task_row_content.dart"  # 主组件
        - "lib/presentation/widgets/task_row_title_editor.dart"  # 标题编辑组件
        - "lib/presentation/widgets/task_row_tags_deadline.dart"  # 标签和截止日期行
        - "lib/presentation/widgets/task_row_project_milestone.dart"  # 项目和里程碑按钮

    # 6. task.dart (330行 → 目标: <300行)
    - file: "lib/data/models/task.dart"
      type: split
      intent: "分离扩展方法或辅助类"
      split_strategy: "按功能拆分"
      target_files:
        - "lib/data/models/task.dart"  # 核心模型定义
        - "lib/data/models/task_extensions.dart"  # 扩展方法（如果有）
        - "lib/data/models/task_update.dart"  # TaskUpdate 类（如果可分离）

    # 7. task_pagination_providers.dart (425行 → 目标: <400行)
    - file: "lib/core/providers/task_pagination_providers.dart"
      type: split
      intent: "按功能模块拆分 Provider"
      split_strategy: "按功能拆分"
      target_files:
        - "lib/core/providers/task_pagination_providers.dart"  # 核心分页逻辑
        - "lib/core/providers/task_pagination_state_providers.dart"  # 状态管理 Provider
        - "lib/core/providers/task_pagination_action_providers.dart"  # 操作 Provider

    # 8. task_repository_mutations.dart (500行 → 目标: 评估是否需要拆分)
    - file: "lib/data/repositories/task_repository_mutations.dart"
      type: review
      intent: "评估是否需要进一步拆分（当前正好达到阈值）"
      action: "评估后决定是否拆分为 *_create.dart, *_update.dart, *_delete.dart"

    # ========== P1 优先级文件重构 ==========

    # 9. task_tree_tile.dart (473行 → 目标: <400行)
    - file: "lib/presentation/tasks/views/task_tree_tile.dart"
      type: split
      intent: "提取子组件"
      split_strategy: "提取子组件"
      target_files:
        - "lib/presentation/tasks/views/task_tree_tile.dart"  # 主组件
        - "lib/presentation/tasks/views/task_tree_tile_content.dart"  # 内容组件
        - "lib/presentation/tasks/views/task_tree_tile_actions.dart"  # 操作组件

    # 10. task_expanded_panel.dart (478行 → 目标: <400行)
    - file: "lib/presentation/widgets/task_expanded_panel.dart"
      type: split
      intent: "提取子组件"
      split_strategy: "提取子组件"
      target_files:
        - "lib/presentation/widgets/task_expanded_panel.dart"  # 主组件
        - "lib/presentation/widgets/task_expanded_panel_header.dart"  # 头部组件
        - "lib/presentation/widgets/task_expanded_panel_body.dart"  # 主体组件

    # 11. swipe_action_handler.dart (428行 → 目标: <400行)
    - file: "lib/presentation/widgets/swipe_action_handler.dart"
      type: split
      intent: "提取子组件和逻辑"
      split_strategy: "提取子组件"
      target_files:
        - "lib/presentation/widgets/swipe_action_handler.dart"  # 主组件
        - "lib/presentation/widgets/swipe_action_handler_logic.dart"  # 处理逻辑

    # 12. tasks_drag_provider.dart (354行 → 目标: <300行)
    - file: "lib/core/providers/tasks_drag_provider.dart"
      type: split
      intent: "按功能拆分 Provider"
      split_strategy: "按功能拆分"
      target_files:
        - "lib/core/providers/tasks_drag_provider.dart"  # 核心逻辑
        - "lib/core/providers/tasks_drag_state_provider.dart"  # 状态管理

    # 13. inbox_drag_provider.dart (323行 → 目标: <300行)
    - file: "lib/core/providers/inbox_drag_provider.dart"
      type: split
      intent: "按功能拆分 Provider"
      split_strategy: "按功能拆分"
      target_files:
        - "lib/core/providers/inbox_drag_provider.dart"  # 核心逻辑
        - "lib/core/providers/inbox_drag_state_provider.dart"  # 状态管理

    # 14. sort_index_service.dart (375行 → 目标: <300行)
    - file: "lib/core/services/sort_index_service.dart"
      type: split
      intent: "按职责拆分服务方法"
      split_strategy: "按功能拆分"
      target_files:
        - "lib/core/services/sort_index_service.dart"  # 核心服务
        - "lib/core/services/sort_index_comparators.dart"  # 比较函数（静态方法）

    # 15. seed_import_service.dart (340行 → 目标: <300行)
    - file: "lib/core/services/seed_import_service.dart"
      type: split
      intent: "按职责拆分服务方法"
      split_strategy: "按功能拆分"
      target_files:
        - "lib/core/services/seed_import_service.dart"  # 核心服务
        - "lib/core/services/seed_import_parser.dart"  # 解析逻辑（如果有）

  tests:
    - type: unit
      focus: "验证拆分后的服务类功能完整性"
      files:
        - "test/core/services/task_service_test.dart"  # 需要更新以适配新的拆分结构
        - "test/core/services/task_crud_service_test.dart"  # 新建
        - "test/core/services/task_status_service_test.dart"  # 新建
        - "test/core/services/task_drag_service_test.dart"  # 新建
        - "test/core/services/task_promotion_service_test.dart"  # 新建
        - "test/presentation/widgets/task_row_content_test.dart"  # 需要更新
        - "test/presentation/tasks/projects/project_creation_sheet_test.dart"  # 需要更新
        - "test/core/providers/task_pagination_providers_test.dart"  # 需要更新
    - type: widget
      focus: "验证拆分后的 Widget 组件渲染和交互"
      files:
        - "test/presentation/widgets/task_row_content_test.dart"
        - "test/presentation/tasks/projects/project_creation_sheet_test.dart"
        - "test/presentation/widgets/task_tag_filter_strip_test.dart"
        - "test/presentation/widgets/custom_date_picker_test.dart"
    - type: integration
      focus: "验证端到端功能未因重构而受影响"
      command: "flutter test integration_test -d macos"

  documentation:
    - path: "documents/architecture/services/task_service.yaml"
      update_type: modify
      reason: "TaskService 已拆分为多个服务类，需要更新架构文档"
    - path: "documents/architecture/providers/task_pagination_providers.yaml"
      update_type: modify
      reason: "Provider 结构已变更"
    - path: "documents/architecture/widgets/task_row_content.yaml"
      update_type: modify
      reason: "Widget 已拆分为多个子组件"
    - path: "documents/architecture/pages/task_list_page.yaml"
      update_type: modify
      reason: "相关组件结构已变更"

risks:
  - name: "服务类拆分可能导致依赖注入链断裂"
    mitigation: "仔细检查所有使用 TaskService 的地方，确保正确注入新的服务类"
    impact: "高"
  - name: "Widget 拆分可能影响状态管理"
    mitigation: "确保状态正确传递，使用 Provider 或回调函数保持状态一致性"
    impact: "中"
  - name: "Provider 拆分可能影响响应式更新"
    mitigation: "确保 Provider 之间的依赖关系正确建立，使用 watch/read 正确消费"
    impact: "中"
  - name: "测试需要大量更新"
    mitigation: "逐步重构，每个文件拆分后立即更新测试，确保测试通过后再继续"
    impact: "高"
  - name: "重构可能导致功能回归"
    mitigation: "运行完整的集成测试套件，确保所有功能正常"
    impact: "高"

verification:
  checklist:
    - "所有文件行数符合阈值要求（P0 文件 < 硬性阈值，P1 文件 < 警告阈值）"
    - "运行 `flutter analyze` 无错误"
    - "运行 `flutter test test/unit` 所有单元测试通过"
    - "运行 `flutter test test/presentation` 所有 Widget 测试通过"
    - "运行 `flutter test integration_test -d macos` 所有集成测试通过"
    - "检查所有导入语句正确更新"
    - "检查所有 Provider 依赖关系正确"
    - "检查所有服务类依赖注入正确"
    - "更新相关架构文档"
    - "验证应用功能正常（手动测试关键流程）"

implementation_order:
  phase_1_p0_critical:
    description: "P0 优先级文件重构（阻止新功能开发）"
    files:
      - "lib/core/services/task_service.dart"
      - "lib/data/repositories/task_repository_mutations.dart"  # 评估
      - "lib/data/models/task.dart"
    priority: "最高"
    estimated_effort: "高"
    
  phase_2_p0_presentation:
    description: "P0 优先级 Widget 文件重构"
    files:
      - "lib/presentation/tasks/projects/project_creation_sheet.dart"
      - "lib/presentation/widgets/task_tag_filter_strip.dart"
      - "lib/presentation/widgets/custom_date_picker.dart"
      - "lib/presentation/widgets/task_row_content.dart"
    priority: "高"
    estimated_effort: "中"
    
  phase_3_p0_providers:
    description: "P0 优先级 Provider 文件重构"
    files:
      - "lib/core/providers/task_pagination_providers.dart"
    priority: "高"
    estimated_effort: "中"
    
  phase_4_p1_services:
    description: "P1 优先级 Service 文件重构"
    files:
      - "lib/core/services/sort_index_service.dart"
      - "lib/core/services/seed_import_service.dart"
    priority: "中"
    estimated_effort: "低"
    
  phase_5_p1_providers:
    description: "P1 优先级 Provider 文件重构"
    files:
      - "lib/core/providers/tasks_drag_provider.dart"
      - "lib/core/providers/inbox_drag_provider.dart"
    priority: "中"
    estimated_effort: "低"
    
  phase_6_p1_widgets:
    description: "P1 优先级 Widget 文件重构"
    files:
      - "lib/presentation/tasks/views/task_tree_tile.dart"
      - "lib/presentation/widgets/task_expanded_panel.dart"
      - "lib/presentation/widgets/swipe_action_handler.dart"
    priority: "中"
    estimated_effort: "中"

success_criteria:
  - "所有 P0 文件行数 < 硬性阈值"
  - "所有 P1 文件行数 < 警告阈值"
  - "所有测试通过"
  - "flutter analyze 无错误"
  - "功能完整性验证通过"
  - "架构文档已更新"

