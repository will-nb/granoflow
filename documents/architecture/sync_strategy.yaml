meta:
  version: 1
  last_updated: 2025-10-23

offline_strategy:
  storage: isar
  sync_trigger:
    - manual_refresh
    - app_resume
    - background_task_every_6h
  conflict_resolution:
    priority: local_wins
    merge_rules:
      task:
        - status: latest_updated_at
        - title: latest_updated_at
        - tags: union
      focus_session:
        - endedAt: latest_updated_at
        - reflectionNote: latest_updated_at
  metrics_pipeline:
    recompute_on: [task, session]
    cache: metric_snapshot
    retry_policy: exponential_backoff

api_contract:
  endpoints:
    - path: /v1/sync/pull
      method: POST
      payload: {deviceId: string, lastSyncAt: timestamp}
      response: {tasks: list, focus_sessions: list, templates: list}
    - path: /v1/sync/push
      method: POST
      payload: {deviceId: string, changes: map}
      response: {status: ok}
  security:
    auth: device_token
    encryption: AES-GCM payload with key derived from device secret
    rate_limit: 60 per hour per device

migration_hooks:
  - description: "在 schema 变更后触发 storage_migrations.md 定义的脚本"
  - description: "同步完成后刷新 Monetization 与 Preference 状态"
