meta:
  name: "FocusSessionRepository"
  type: "repository"
  file_path: "lib/data/repositories/focus_session_repository.dart"
  description: "专注会话数据访问层，负责专注时段的持久化和查询"
  version: "1.0"
  created_date: "251025"
  last_updated: "251025"

repository_definition:
  abstract_class: "FocusSessionRepository"
  implementation_class: "IsarFocusSessionRepository"
  storage_backend: "isar"
  layer: "data_access"
  
abstract_methods:
  - name: "startSession"
    return_type: "Future<FocusSession>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "estimateMinutes"
        type: "int?"
        required: false
      - name: "alarmEnabled"
        type: "bool"
        required: true
    description: "开始专注会话"
    visibility: "public"
    
  - name: "endSession"
    return_type: "Future<void>"
    parameters:
      - name: "sessionId"
        type: "int"
        required: true
      - name: "actualMinutes"
        type: "int"
        required: true
      - name: "transferToTaskId"
        type: "int?"
        required: false
      - name: "reflectionNote"
        type: "String?"
        required: false
    description: "结束专注会话"
    visibility: "public"
    
  - name: "watchActiveSession"
    return_type: "Stream<FocusSession?>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "监听活跃会话"
    visibility: "public"
    
  - name: "listRecentSessions"
    return_type: "Future<List<FocusSession>>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "limit"
        type: "int"
        required: true
    description: "列出最近的会话"
    visibility: "public"
    
  - name: "totalMinutesForTask"
    return_type: "Future<int>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "计算任务总专注时间"
    visibility: "public"
    
implementation_details:
  constructor:
    parameters:
      - name: "_isar"
        type: "Isar"
        required: true
        description: "Isar 数据库实例"
    dependencies:
      - name: "Isar"
        type: "package:isar/isar.dart"
        description: "Isar 数据库依赖"
        
  private_fields:
    - name: "_isar"
      type: "Isar"
      description: "Isar 数据库实例"
      
  private_methods:
    - name: "_toDomain"
      return_type: "FocusSession"
      parameters:
        - name: "entity"
          type: "FocusSessionEntity"
          required: true
      description: "实体转领域模型"
      visibility: "private"
      
    - name: "_toEntity"
      return_type: "FocusSessionEntity"
      parameters:
        - name: "session"
          type: "FocusSession"
          required: true
      description: "领域模型转实体"
      visibility: "private"
      
dependencies:
  - name: "Isar"
    type: "package:isar/isar.dart"
    description: "Isar 数据库依赖"
  - name: "FocusSessionEntity"
    type: "../isar/focus_session_entity.dart"
    description: "专注会话实体类依赖"
  - name: "FocusSession"
    type: "../models/focus_session.dart"
    description: "专注会话领域模型依赖"
    
imports:
  - "dart:async"
  - "package:isar/isar.dart"
  - "../isar/focus_session_entity.dart"
  - "../models/focus_session.dart"
  
responsibilities:
  - "专注会话数据持久化"
  - "专注会话状态管理"
  - "专注时间统计"
  - "会话历史记录"
  
data_operations:
  create:
    - name: "startSession"
      description: "开始专注会话"
      parameters: ["int", "int?", "bool"]
      
  read:
    - name: "listRecentSessions"
      description: "列出最近的会话"
      parameters: ["int", "int"]
    - name: "totalMinutesForTask"
      description: "计算任务总专注时间"
      parameters: ["int"]
      
  update:
    - name: "endSession"
      description: "结束专注会话"
      parameters: ["int", "int", "int?", "String?"]
      
stream_operations:
  - name: "watchActiveSession"
    description: "监听活跃会话"
    return_type: "Stream<FocusSession?>"
    
validation_rules:
  - field: "taskId"
    rule: "positive"
    description: "任务 ID 必须为正数"
  - field: "actualMinutes"
    rule: "non_negative"
    description: "实际分钟数不能为负数"
    
business_rules:
  - name: "session_lifecycle"
    description: "会话生命周期管理"
    implementation: "开始和结束会话的业务逻辑"
  - name: "time_tracking"
    description: "时间跟踪规则"
    implementation: "专注时间计算和统计"
    
testing_strategy:
  unit_tests:
    - name: "test_start_session"
      description: "测试开始会话功能"
    - name: "test_end_session"
      description: "测试结束会话功能"
    - name: "test_watch_active_session"
      description: "测试监听活跃会话功能"
    - name: "test_list_recent_sessions"
      description: "测试列出最近会话功能"
    - name: "test_total_minutes_for_task"
      description: "测试计算任务总专注时间功能"