meta:
  name: "TaskTemplateRepository"
  type: "repository"
  file_path: "lib/data/repositories/task_template_repository.dart"
  description: "任务模板数据访问层，负责任务模板的持久化和查询"
  version: "1.0"
  created_date: "251025"
  last_updated: "251025"

repository_definition:
  abstract_class: "TaskTemplateRepository"
  implementation_class: "IsarTaskTemplateRepository"
  storage_backend: "isar"
  layer: "data_access"
  
abstract_methods:
  - name: "listRecent"
    return_type: "Future<List<TaskTemplate>>"
    parameters:
      - name: "limit"
        type: "int"
        required: true
    description: "列出最近使用的模板"
    visibility: "public"
    
  - name: "search"
    return_type: "Future<List<TaskTemplate>>"
    parameters:
      - name: "query"
        type: "String"
        required: true
      - name: "limit"
        type: "int"
        required: true
    description: "搜索模板"
    visibility: "public"
    
  - name: "createTemplate"
    return_type: "Future<TaskTemplate>"
    parameters:
      - name: "draft"
        type: "TaskTemplateDraft"
        required: true
    description: "创建模板"
    visibility: "public"
    
  - name: "createTemplateWithSeed"
    return_type: "Future<TaskTemplate>"
    parameters:
      - name: "draft"
        type: "TaskTemplateDraft"
        required: true
      - name: "parentId"
        type: "int?"
        required: true
    description: "使用种子数据创建模板"
    visibility: "public"
    
  - name: "updateTemplate"
    return_type: "Future<void>"
    parameters:
      - name: "templateId"
        type: "int"
        required: true
      - name: "payload"
        type: "TaskTemplateUpdate"
        required: true
    description: "更新模板"
    visibility: "public"
    
  - name: "deleteTemplate"
    return_type: "Future<void>"
    parameters:
      - name: "templateId"
        type: "int"
        required: true
    description: "删除模板"
    visibility: "public"
    
  - name: "markUsed"
    return_type: "Future<void>"
    parameters:
      - name: "templateId"
        type: "int"
        required: true
      - name: "usedAt"
        type: "DateTime"
        required: true
    description: "标记模板已使用"
    visibility: "public"
    
  - name: "findBySlug"
    return_type: "Future<TaskTemplate?>"
    parameters:
      - name: "slug"
        type: "String"
        required: true
    description: "根据 slug 查找模板"
    visibility: "public"
    
  - name: "findById"
    return_type: "Future<TaskTemplate?>"
    parameters:
      - name: "id"
        type: "int"
        required: true
    description: "根据 ID 查找模板"
    visibility: "public"
    
implementation_details:
  constructor:
    parameters:
      - name: "_isar"
        type: "Isar"
        required: true
        description: "Isar 数据库实例"
    dependencies:
      - name: "Isar"
        type: "package:isar/isar.dart"
        description: "Isar 数据库依赖"
        
  private_fields:
    - name: "_isar"
      type: "Isar"
      description: "Isar 数据库实例"
      
  private_methods:
    - name: "_toDomain"
      return_type: "TaskTemplate"
      parameters:
        - name: "entity"
          type: "TaskTemplateEntity"
          required: true
      description: "实体转领域模型"
      visibility: "private"
      
    - name: "_toEntity"
      return_type: "TaskTemplateEntity"
      parameters:
        - name: "template"
          type: "TaskTemplate"
          required: true
      description: "领域模型转实体"
      visibility: "private"
      
dependencies:
  - name: "Isar"
    type: "package:isar/isar.dart"
    description: "Isar 数据库依赖"
  - name: "TaskTemplateEntity"
    type: "../isar/task_template_entity.dart"
    description: "任务模板实体类依赖"
  - name: "TaskTemplate"
    type: "../models/task_template.dart"
    description: "任务模板领域模型依赖"
    
imports:
  - "package:collection/collection.dart"
  - "package:isar/isar.dart"
  - "../isar/task_template_entity.dart"
  - "../models/task_template.dart"
  
responsibilities:
  - "任务模板数据持久化"
  - "任务模板搜索和过滤"
  - "任务模板使用统计"
  - "任务模板种子数据管理"
  
data_operations:
  create:
    - name: "createTemplate"
      description: "创建模板"
      parameters: ["TaskTemplateDraft"]
    - name: "createTemplateWithSeed"
      description: "使用种子数据创建模板"
      parameters: ["TaskTemplateDraft", "int?"]
      
  read:
    - name: "listRecent"
      description: "列出最近使用的模板"
      parameters: ["int"]
    - name: "search"
      description: "搜索模板"
      parameters: ["String", "int"]
    - name: "findBySlug"
      description: "根据 slug 查找模板"
      parameters: ["String"]
    - name: "findById"
      description: "根据 ID 查找模板"
      parameters: ["int"]
      
  update:
    - name: "updateTemplate"
      description: "更新模板"
      parameters: ["int", "TaskTemplateUpdate"]
    - name: "markUsed"
      description: "标记模板已使用"
      parameters: ["int", "DateTime"]
      
  delete:
    - name: "deleteTemplate"
      description: "删除模板"
      parameters: ["int"]
      
validation_rules:
  - field: "title"
    rule: "not_empty"
    description: "模板标题不能为空"
  - field: "suggestedEstimateMinutes"
    rule: "positive"
    description: "建议预估分钟数必须为正数"
    
business_rules:
  - name: "template_usage_tracking"
    description: "模板使用跟踪规则"
    implementation: "跟踪模板使用情况"
  - name: "template_search"
    description: "模板搜索规则"
    implementation: "基于标题的模糊搜索"
    
error_handling:
  - exception: "IsarException"
    description: "数据库操作异常"
    handling: "记录日志并重新抛出"
  - exception: "ArgumentError"
    description: "参数错误"
    handling: "验证参数并抛出描述性错误"
    
performance_considerations:
  - operation: "search"
    optimization: "全文搜索索引"
    description: "模板搜索性能优化"
  - operation: "listRecent"
    optimization: "使用索引优化查询"
    description: "最近模板查询性能优化"
    
testing_strategy:
  unit_tests:
    - name: "test_create_template"
      description: "测试创建模板功能"
    - name: "test_create_template_with_seed"
      description: "测试使用种子数据创建模板功能"
    - name: "test_list_recent"
      description: "测试列出最近模板功能"
    - name: "test_search_template"
      description: "测试搜索模板功能"
    - name: "test_update_template"
      description: "测试更新模板功能"
    - name: "test_delete_template"
      description: "测试删除模板功能"
    - name: "test_mark_used"
      description: "测试标记模板已使用功能"
    - name: "test_find_by_slug"
      description: "测试根据 slug 查找模板功能"
    - name: "test_find_by_id"
      description: "测试根据 ID 查找模板功能"
      
  integration_tests:
    - name: "test_repository_integration"
      description: "测试 Repository 集成"
    - name: "test_template_search"
      description: "测试模板搜索功能"
    - name: "test_template_usage_tracking"
      description: "测试模板使用跟踪功能"
      
  mock_strategy:
    - name: "MockTaskTemplateRepository"
      description: "Mock 实现用于测试"