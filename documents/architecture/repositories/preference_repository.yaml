meta:
  name: "PreferenceRepository"
  type: "repository"
  file_path: "lib/data/repositories/preference_repository.dart"
  description: "用户偏好设置数据访问层，负责用户设置的持久化和查询"
  version: "1.0"
  created_date: "251025"
  last_updated: "251025"

repository_definition:
  abstract_class: "PreferenceRepository"
  implementation_class: "IsarPreferenceRepository"
  storage_backend: "isar"
  layer: "data_access"
  
abstract_methods:
  - name: "watch"
    return_type: "Stream<Preference>"
    parameters: []
    description: "监听用户偏好设置"
    visibility: "public"
    
  - name: "load"
    return_type: "Future<Preference>"
    parameters: []
    description: "加载用户偏好设置"
    visibility: "public"
    
  - name: "update"
    return_type: "Future<void>"
    parameters:
      - name: "payload"
        type: "PreferenceUpdate"
        required: true
    description: "更新用户偏好设置"
    visibility: "public"
    
implementation_details:
  constructor:
    parameters:
      - name: "_isar"
        type: "Isar"
        required: true
        description: "Isar 数据库实例"
    dependencies:
      - name: "Isar"
        type: "package:isar/isar.dart"
        description: "Isar 数据库依赖"
        
  private_fields:
    - name: "_isar"
      type: "Isar"
      description: "Isar 数据库实例"
    - name: "_singletonId"
      type: "int"
      description: "单例 ID，值为 1"
      
  private_methods:
    - name: "_toDomain"
      return_type: "Preference"
      parameters:
        - name: "entity"
          type: "PreferenceEntity"
          required: true
      description: "实体转领域模型"
      visibility: "private"
      
    - name: "_toEntity"
      return_type: "PreferenceEntity"
      parameters:
        - name: "preference"
          type: "Preference"
          required: true
      description: "领域模型转实体"
      visibility: "private"
      
    - name: "_ensureEntity"
      return_type: "Future<PreferenceEntity>"
      parameters:
        - name: "entity"
          type: "PreferenceEntity?"
          required: true
      description: "确保实体存在"
      visibility: "private"
      
dependencies:
  - name: "Isar"
    type: "package:isar/isar.dart"
    description: "Isar 数据库依赖"
  - name: "PreferenceEntity"
    type: "../isar/preference_entity.dart"
    description: "偏好设置实体类依赖"
  - name: "Preference"
    type: "../models/preference.dart"
    description: "偏好设置领域模型依赖"
    
imports:
  - "dart:async"
  - "package:flutter/material.dart"
  - "package:isar/isar.dart"
  - "../isar/preference_entity.dart"
  - "../models/preference.dart"
  
responsibilities:
  - "用户偏好设置数据持久化"
  - "用户偏好设置监听"
  - "用户偏好设置更新"
  - "默认设置管理"
  
data_operations:
  create:
    - name: "ensureEntity"
      description: "确保偏好设置实体存在"
      parameters: []
      
  read:
    - name: "load"
      description: "加载用户偏好设置"
      parameters: []
      
  update:
    - name: "update"
      description: "更新用户偏好设置"
      parameters: ["PreferenceUpdate"]
      
stream_operations:
  - name: "watch"
    description: "监听用户偏好设置"
    return_type: "Stream<Preference>"
    
validation_rules:
  - field: "localeCode"
    rule: "not_empty"
    description: "语言代码不能为空"
  - field: "fontScale"
    rule: "positive"
    description: "字体缩放比例必须为正数"
    
business_rules:
  - name: "singleton_preference"
    description: "单例偏好设置规则"
    implementation: "每个用户只能有一个偏好设置"
  - name: "default_preference"
    description: "默认偏好设置规则"
    implementation: "提供合理的默认设置"
    
testing_strategy:
  unit_tests:
    - name: "test_watch_preference"
      description: "测试监听偏好设置功能"
    - name: "test_load_preference"
      description: "测试加载偏好设置功能"
    - name: "test_update_preference"
      description: "测试更新偏好设置功能"