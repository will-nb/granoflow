meta:
  name: "TaskRepository"
  type: "repository"
  file_path: "lib/data/repositories/task_repository.dart"
  description: "任务数据访问层，负责任务的持久化、查询和更新操作"
  version: "2.0"
  created_date: "251025"
  last_updated: "251026"

repository_definition:
  abstract_class: "TaskRepository"
  implementation_class: "IsarTaskRepository"
  storage_backend: "isar"
  layer: "data_access"
  
abstract_methods:
  - name: "watchSection"
    return_type: "Stream<List<Task>>"
    parameters:
      - name: "section"
        type: "TaskSection"
        required: true
    description: "监听指定分区的任务列表"
    visibility: "public"
    
  - name: "watchTaskTree"
    return_type: "Stream<TaskTreeNode>"
    parameters:
      - name: "rootTaskId"
        type: "int"
        required: true
    description: "监听任务树结构"
    visibility: "public"
    
  - name: "watchInbox"
    return_type: "Stream<List<Task>>"
    parameters: []
    description: "监听收集箱任务"
    visibility: "public"
    
  - name: "watchInboxFiltered"
    return_type: "Stream<List<Task>>"
    parameters:
      - name: "contextTag"
        type: "String?"
        required: false
      - name: "priorityTag"
        type: "String?"
        required: false
      - name: "urgencyTag"
        type: "String?"
        required: false
      - name: "importanceTag"
        type: "String?"
        required: false
    description: "监听过滤后的收集箱任务"
    visibility: "public"
    
  - name: "createTask"
    return_type: "Future<Task>"
    parameters:
      - name: "draft"
        type: "TaskDraft"
        required: true
    description: "创建新任务"
    visibility: "public"
    
  - name: "updateTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "payload"
        type: "TaskUpdate"
        required: true
    description: "更新任务"
    visibility: "public"
    
  - name: "moveTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "targetParentId"
        type: "int?"
        required: true
      - name: "targetSection"
        type: "TaskSection"
        required: true
      - name: "sortIndex"
        type: "double"
        required: true
      - name: "dueAt"
        type: "DateTime?"
        required: false
    description: "移动任务"
    visibility: "public"
    
  - name: "markStatus"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "status"
        type: "TaskStatus"
        required: true
    description: "标记任务状态"
    visibility: "public"
    
  - name: "archiveTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "归档任务"
    visibility: "public"
    
  - name: "softDelete"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "软删除任务"
    visibility: "public"
    
  - name: "purgeObsolete"
    return_type: "Future<int>"
    parameters:
      - name: "olderThan"
        type: "DateTime"
        required: true
    description: "清理过期任务"
    visibility: "public"
    
  - name: "adjustTemplateLock"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "delta"
        type: "int"
        required: true
    description: "调整模板锁定"
    visibility: "public"
    
  - name: "findById"
    return_type: "Future<Task?>"
    parameters:
      - name: "id"
        type: "int"
        required: true
    description: "根据 ID 查找任务"
    visibility: "public"
    
  - name: "findBySlug"
    return_type: "Future<Task?>"
    parameters:
      - name: "slug"
        type: "String"
        required: true
    description: "根据 slug 查找任务"
    visibility: "public"
    
  - name: "listRoots"
    return_type: "Future<List<Task>>"
    parameters: []
    description: "列出根任务"
    visibility: "public"
    
  - name: "listChildren"
    return_type: "Future<List<Task>>"
    parameters:
      - name: "parentId"
        type: "int"
        required: true
    description: "列出子任务"
    visibility: "public"
    
  - name: "upsertTasks"
    return_type: "Future<void>"
    parameters:
      - name: "tasks"
        type: "List<Task>"
        required: true
    description: "批量插入或更新任务"
    visibility: "public"
    
  - name: "listAll"
    return_type: "Future<List<Task>>"
    parameters: []
    description: "列出所有任务"
    visibility: "public"
    
  - name: "searchByTitle"
    return_type: "Future<List<Task>>"
    parameters:
      - name: "query"
        type: "String"
        required: true
      - name: "status"
        type: "TaskStatus?"
        required: false
      - name: "limit"
        type: "int"
        required: true
    description: "根据标题搜索任务"
    visibility: "public"
    
implementation_details:
  constructor:
    parameters:
      - name: "_isar"
        type: "Isar"
        required: true
        description: "Isar 数据库实例"
      - name: "clock"
        type: "DateTime Function()?"
        required: false
        description: "时间函数，用于测试"
    dependencies:
      - name: "Isar"
        type: "package:isar/isar.dart"
        description: "Isar 数据库依赖"
        
  private_fields:
    - name: "_isar"
      type: "Isar"
      description: "Isar 数据库实例"
    - name: "_clock"
      type: "DateTime Function()"
      description: "时间函数"
      
  private_methods:
    - name: "_watchQuery"
      return_type: "Stream<T>"
      parameters:
        - name: "query"
          type: "Future<T> Function()"
          required: true
      description: "监听查询结果"
      visibility: "private"
      
    - name: "_fetchSection"
      return_type: "Future<List<Task>>"
      parameters:
        - name: "section"
          type: "TaskSection"
          required: true
      description: "获取分区任务"
      visibility: "private"
      
    - name: "_buildTree"
      return_type: "Future<TaskTreeNode>"
      parameters:
        - name: "rootTaskId"
          type: "int"
          required: true
      description: "构建任务树"
      visibility: "private"
      
    - name: "_toDomain"
      return_type: "Task"
      parameters:
        - name: "entity"
          type: "TaskEntity"
          required: true
      description: "实体转领域模型"
      visibility: "private"
      
    - name: "_toEntity"
      return_type: "TaskEntity"
      parameters:
        - name: "task"
          type: "Task"
          required: true
      description: "领域模型转实体"
      visibility: "private"
      
    - name: "_generateTaskId"
      return_type: "Future<String>"
      parameters:
        - name: "now"
          type: "DateTime"
          required: true
      description: "生成任务 ID (YYYYMMDD-XXXX格式)"
      visibility: "private"
      
    - name: "_getLatestTask"
      return_type: "Future<Task?>"
      parameters: []
      description: "查询最新创建的任务"
      visibility: "private"
      
    - name: "_parseTaskId"
      return_type: "Map<String, dynamic>?"
      parameters:
        - name: "taskId"
          type: "String"
          required: true
      description: "解析taskId格式，提取日期和后缀"
      visibility: "private"
      
dependencies:
  - name: "Isar"
    type: "package:isar/isar.dart"
    description: "Isar 数据库依赖"
  - name: "TaskEntity"
    type: "../isar/task_entity.dart"
    description: "任务实体类依赖"
  - name: "Task"
    type: "../models/task.dart"
    description: "任务领域模型依赖"
    
imports:
  - "dart:async"
  - "package:flutter/foundation.dart"
  - "package:isar/isar.dart"
  - "../isar/task_entity.dart"
  - "../models/task.dart"
  
responsibilities:
  - "任务数据持久化"
  - "任务数据查询和过滤"
  - "任务状态管理"
  - "任务树结构维护"
  - "任务 ID 生成和唯一性保证"
  - "数据事务管理"
  - "数据验证和约束"
  
data_operations:
  create:
    - name: "createTask"
      description: "创建新任务"
      parameters: ["TaskDraft"]
      
  read:
    - name: "findById"
      description: "根据 ID 查找任务"
      parameters: ["int"]
    - name: "findBySlug"
      description: "根据 slug 查找任务"
      parameters: ["String"]
    - name: "listRoots"
      description: "列出根任务"
      parameters: []
    - name: "listChildren"
      description: "列出子任务"
      parameters: ["int"]
    - name: "listAll"
      description: "列出所有任务"
      parameters: []
    - name: "searchByTitle"
      description: "根据标题搜索任务"
      parameters: ["String", "TaskStatus?", "int"]
      
  update:
    - name: "updateTask"
      description: "更新任务"
      parameters: ["int", "TaskUpdate"]
    - name: "moveTask"
      description: "移动任务"
      parameters: ["int", "int?", "TaskSection", "double", "DateTime?"]
    - name: "markStatus"
      description: "标记任务状态"
      parameters: ["int", "TaskStatus"]
    - name: "adjustTemplateLock"
      description: "调整模板锁定"
      parameters: ["int", "int"]
    - name: "upsertTasks"
      description: "批量插入或更新任务"
      parameters: ["List<Task>"]
      
  delete:
    - name: "archiveTask"
      description: "归档任务"
      parameters: ["int"]
    - name: "softDelete"
      description: "软删除任务"
      parameters: ["int"]
    - name: "purgeObsolete"
      description: "清理过期任务"
      parameters: ["DateTime"]
      
stream_operations:
  - name: "watchSection"
    description: "监听指定分区的任务列表"
    return_type: "Stream<List<Task>>"
    
  - name: "watchTaskTree"
    description: "监听任务树结构"
    return_type: "Stream<TaskTreeNode>"
    
  - name: "watchInbox"
    description: "监听收集箱任务"
    return_type: "Stream<List<Task>>"
    
  - name: "watchInboxFiltered"
    description: "监听过滤后的收集箱任务"
    return_type: "Stream<List<Task>>"
    
validation_rules:
  - field: "taskId"
    rule: "unique"
    description: "任务 ID 必须唯一"
  - field: "title"
    rule: "not_empty"
    description: "任务标题不能为空"
  - field: "parentId"
    rule: "valid_reference"
    description: "父任务 ID 必须有效"
    
business_rules:
  - name: "task_id_generation"
    description: "任务 ID 生成规则"
    implementation: "YYYYMMDD-XXXX格式，基于日期的自增ID生成，每日从0001开始，跨天重置"
  - name: "task_id_parsing"
    description: "任务 ID 解析规则"
    implementation: "解析YYYYMMDD-XXXX格式，提取日期和后缀，支持错误处理"
  - name: "task_hierarchy"
    description: "任务层次结构规则"
    implementation: "父子关系维护和验证"
  - name: "task_status_transition"
    description: "任务状态转换规则"
    implementation: "状态转换的业务逻辑验证"
    
error_handling:
  - exception: "IsarException"
    description: "数据库操作异常"
    handling: "记录日志并重新抛出"
  - exception: "ArgumentError"
    description: "参数错误"
    handling: "验证参数并抛出描述性错误"
  - exception: "TaskIdGenerationException"
    description: "任务ID生成异常"
    handling: "处理任务ID生成错误并fallback到默认格式"
  - exception: "TaskIdParseException"
    description: "任务ID解析异常"
    handling: "处理任务ID解析错误并返回null"
    
performance_considerations:
  - operation: "watchSection"
    optimization: "使用索引优化查询"
    description: "分区查询性能优化"
  - operation: "watchTaskTree"
    optimization: "递归查询优化"
    description: "任务树查询性能优化"
  - operation: "searchByTitle"
    optimization: "全文搜索索引"
    description: "标题搜索性能优化"
    
testing_strategy:
  unit_tests:
    - name: "test_create_task"
      description: "测试创建任务功能"
    - name: "test_find_task_by_id"
      description: "测试根据 ID 查找任务"
    - name: "test_update_task"
      description: "测试更新任务功能"
    - name: "test_move_task"
      description: "测试移动任务功能"
    - name: "test_watch_section"
      description: "测试监听分区功能"
    - name: "test_watch_task_tree"
      description: "测试监听任务树功能"
    - name: "test_watch_inbox_filtered"
      description: "测试监听过滤后的收集箱任务功能"
    - name: "test_search_by_title"
      description: "测试根据标题搜索功能"
    - name: "test_archive_task"
      description: "测试归档任务功能"
    - name: "test_soft_delete"
      description: "测试软删除任务功能"
    - name: "test_purge_obsolete"
      description: "测试清理过期任务功能"
    - name: "test_generate_task_id"
      description: "测试任务ID生成功能"
    - name: "test_generate_task_id_format"
      description: "测试任务ID格式验证"
    - name: "test_generate_task_id_increment"
      description: "测试任务ID自增功能"
    - name: "test_generate_task_id_cross_day"
      description: "测试任务ID跨天重置功能"
    - name: "test_parse_task_id"
      description: "测试任务ID解析功能"
    - name: "test_get_latest_task"
      description: "测试获取最新任务功能"
      
  integration_tests:
    - name: "test_repository_integration"
      description: "测试 Repository 集成"
    - name: "test_task_hierarchy_operations"
      description: "测试任务层次结构操作"
    - name: "test_concurrent_operations"
      description: "测试并发操作"
    - name: "test_task_id_generation_integration"
      description: "测试任务ID生成集成"
    - name: "test_task_id_uniqueness"
      description: "测试任务ID唯一性"
      
  mock_strategy:
    - name: "MockTaskRepository"
      description: "Mock 实现用于测试"
    - name: "FakeTaskRepository"
      description: "Fake 实现用于测试"