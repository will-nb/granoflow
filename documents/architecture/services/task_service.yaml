meta:
  name: "TaskService"
  type: "service"
  file_path: "lib/core/services/task_service.dart"
  description: "任务业务逻辑服务，负责任务的核心业务操作和协调"
  version: "1.0"
  created_date: "251025"
  last_updated: "251025"

service_definition:
  name: "TaskService"
  layer: "business_logic"
  pattern: "service"
  singleton: false
  
constructor:
  parameters:
    - name: "taskRepository"
      type: "TaskRepository"
      required: true
      description: "任务数据访问层"
    - name: "tagRepository"
      type: "TagRepository"
      required: true
      description: "标签数据访问层"
    - name: "metricOrchestrator"
      type: "MetricOrchestrator"
      required: true
      description: "指标协调器"
    - name: "clock"
      type: "DateTime Function()?"
      required: false
      description: "时间函数，用于测试"
  dependencies:
    - name: "TaskRepository"
      type: "data/repositories/task_repository.dart"
      description: "任务数据访问层依赖"
    - name: "TagRepository"
      type: "data/repositories/tag_repository.dart"
      description: "标签数据访问层依赖"
    - name: "MetricOrchestrator"
      type: "core/services/metric_orchestrator.dart"
      description: "指标协调器依赖"
      
public_methods:
  - name: "captureInboxTask"
    return_type: "Future<Task>"
    parameters:
      - name: "title"
        type: "String"
        required: true
      - name: "tags"
        type: "List<String>"
        required: false
        default: "const <String>[]"
    description: "捕获收集箱任务"
    visibility: "public"
    async: true
    
  - name: "planTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "dueDateLocal"
        type: "DateTime"
        required: true
      - name: "section"
        type: "TaskSection"
        required: true
    description: "规划任务"
    visibility: "public"
    async: true
    
  - name: "startTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "开始任务"
    visibility: "public"
    async: true
    
  - name: "completeTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "完成任务"
    visibility: "public"
    async: true
    
  - name: "archiveTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "归档任务"
    visibility: "public"
    async: true
    
  - name: "softDeleteTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "软删除任务"
    visibility: "public"
    async: true
    
  - name: "reactivateTask"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
    description: "重新激活任务"
    visibility: "public"
    async: true
    
  - name: "updateTaskTitle"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "title"
        type: "String"
        required: true
    description: "更新任务标题"
    visibility: "public"
    async: true
    
  - name: "updateTaskTags"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "tags"
        type: "List<String>"
        required: true
    description: "更新任务标签"
    visibility: "public"
    async: true
    
  - name: "updateTaskDueDate"
    return_type: "Future<void>"
    parameters:
      - name: "taskId"
        type: "int"
        required: true
      - name: "dueDateLocal"
        type: "DateTime"
        required: true
    description: "更新任务截止日期"
    visibility: "public"
    async: true
    
private_methods:
  - name: "_normalizeDueDate"
    return_type: "DateTime"
    parameters:
      - name: "dueDateLocal"
        type: "DateTime"
        required: true
    description: "标准化截止日期"
    visibility: "private"
    async: false
    
  - name: "_validateTaskOperation"
    return_type: "void"
    parameters:
      - name: "task"
        type: "Task"
        required: true
      - name: "operation"
        type: "String"
        required: true
    description: "验证任务操作"
    visibility: "private"
    async: false
    
fields:
  - name: "_tasks"
    type: "TaskRepository"
    final: true
    description: "任务数据访问层"
  - name: "_tags"
    type: "TagRepository"
    final: true
    description: "标签数据访问层"
  - name: "_metricOrchestrator"
    type: "MetricOrchestrator"
    final: true
    description: "指标协调器"
  - name: "_clock"
    type: "DateTime Function()"
    final: true
    description: "时间函数"
    
imports:
  - "../../data/models/task.dart"
  - "../../data/models/tag.dart"
  - "../../data/repositories/task_repository.dart"
  - "../../data/repositories/tag_repository.dart"
  - "metric_orchestrator.dart"
  
dependencies:
  - name: "TaskRepository"
    type: "data/repositories/task_repository.dart"
    description: "任务数据访问层依赖"
  - name: "TagRepository"
    type: "data/repositories/tag_repository.dart"
    description: "标签数据访问层依赖"
  - name: "MetricOrchestrator"
    type: "core/services/metric_orchestrator.dart"
    description: "指标协调器依赖"
  - name: "Task"
    type: "data/models/task.dart"
    description: "任务领域模型依赖"
  - name: "Tag"
    type: "data/models/tag.dart"
    description: "标签领域模型依赖"
    
responsibilities:
  - "任务业务逻辑处理"
  - "任务状态管理"
  - "任务数据协调"
  - "业务规则执行"
  - "任务验证"
  - "指标更新协调"
  
business_operations:
  create:
    - name: "captureInboxTask"
      description: "捕获收集箱任务"
      parameters: ["String", "List<String>"]
      
  read:
    - name: "getTask"
      description: "获取任务"
      parameters: ["int"]
    - name: "listTasks"
      description: "列出任务"
      parameters: []
    - name: "searchTasks"
      description: "搜索任务"
      parameters: ["String"]
      
  update:
    - name: "planTask"
      description: "规划任务"
      parameters: ["int", "DateTime", "TaskSection"]
    - name: "startTask"
      description: "开始任务"
      parameters: ["int"]
    - name: "completeTask"
      description: "完成任务"
      parameters: ["int"]
    - name: "updateTaskTitle"
      description: "更新任务标题"
      parameters: ["int", "String"]
    - name: "updateTaskTags"
      description: "更新任务标签"
      parameters: ["int", "List<String>"]
    - name: "updateTaskDueDate"
      description: "更新任务截止日期"
      parameters: ["int", "DateTime"]
      
  delete:
    - name: "archiveTask"
      description: "归档任务"
      parameters: ["int"]
    - name: "softDeleteTask"
      description: "软删除任务"
      parameters: ["int"]
    
stream_operations:
  - name: "watchTasks"
    description: "监听任务变化"
    return_type: "Stream<List<Task>>"
    
business_rules:
  - name: "task_status_transition"
    description: "任务状态转换规则"
    implementation: "验证状态转换的合法性"
    validation: "检查当前状态是否允许转换到目标状态"
  - name: "task_editing_permissions"
    description: "任务编辑权限规则"
    implementation: "检查任务是否可编辑"
    validation: "验证任务状态和锁定状态"
  - name: "task_due_date_validation"
    description: "任务截止日期验证规则"
    implementation: "验证截止日期的合理性"
    validation: "检查日期格式和范围"
    
error_handling:
  - exception: "StateError"
    description: "状态错误"
    handling: "验证任务状态并抛出描述性错误"
    recovery: "提供状态修正建议"
  - exception: "ArgumentError"
    description: "参数错误"
    handling: "验证参数并抛出描述性错误"
    recovery: "提供参数修正建议"
  - exception: "RepositoryException"
    description: "数据访问异常"
    handling: "记录日志并重新抛出"
    recovery: "重试机制"
    
validation_rules:
  - field: "title"
    rule: "not_empty"
    description: "任务标题不能为空"
    message: "任务标题不能为空"
  - field: "taskId"
    rule: "positive"
    description: "任务 ID 必须为正数"
    message: "任务 ID 必须为正数"
  - field: "dueDate"
    rule: "future_date"
    description: "截止日期必须是未来日期"
    message: "截止日期必须是未来日期"
    
performance_considerations:
  - operation: "captureInboxTask"
    optimization: "批量操作"
    description: "收集箱任务捕获性能优化"
    caching: "任务列表缓存"
  - operation: "planTask"
    optimization: "索引查询"
    description: "任务规划性能优化"
    caching: "任务状态缓存"
  - operation: "updateTaskTags"
    optimization: "增量更新"
    description: "任务标签更新性能优化"
    caching: "标签映射缓存"
    
transaction_management:
  - operation: "completeTask"
    scope: "任务完成事务"
    rollback: "状态回滚"
    isolation: "read_committed"
  - operation: "archiveTask"
    scope: "任务归档事务"
    rollback: "状态回滚"
    isolation: "read_committed"
    
testing_strategy:
  unit_tests:
    - name: "test_capture_inbox_task"
      description: "测试捕获收集箱任务功能"
    - name: "test_plan_task"
      description: "测试规划任务功能"
    - name: "test_start_task"
      description: "测试开始任务功能"
    - name: "test_complete_task"
      description: "测试完成任务功能"
    - name: "test_archive_task"
      description: "测试归档任务功能"
    - name: "test_soft_delete_task"
      description: "测试软删除任务功能"
    - name: "test_reactivate_task"
      description: "测试重新激活任务功能"
    - name: "test_update_task_title"
      description: "测试更新任务标题功能"
    - name: "test_update_task_tags"
      description: "测试更新任务标签功能"
    - name: "test_update_task_due_date"
      description: "测试更新任务截止日期功能"
    - name: "test_business_rules"
      description: "测试业务规则"
    - name: "test_error_handling"
      description: "测试错误处理"
    - name: "test_validation"
      description: "测试验证逻辑"
      
  integration_tests:
    - name: "test_service_integration"
      description: "测试服务集成"
    - name: "test_repository_coordination"
      description: "测试仓库协调"
    - name: "test_transaction_management"
      description: "测试事务管理"
    - name: "test_metric_orchestrator_coordination"
      description: "测试指标协调器协调"
      
  mock_strategy:
    - name: "MockTaskService"
      description: "Mock 实现用于测试"
    - name: "FakeTaskService"
      description: "Fake 实现用于测试"
      
lifecycle_management:
  - phase: "initialization"
    description: "初始化阶段"
    operations: ["依赖注入", "配置加载", "状态初始化"]
  - phase: "operation"
    description: "运行阶段"
    operations: ["业务处理", "数据协调", "状态管理", "指标更新"]
  - phase: "cleanup"
    description: "清理阶段"
    operations: ["资源释放", "状态重置", "连接关闭"]