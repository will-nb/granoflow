meta:
  name: "MetricOrchestrator"
  type: "service"
  file_path: "lib/core/services/metric_orchestrator.dart"
  description: "指标协调器，负责应用性能指标的协调和计算"
  version: "1.0"
  created_date: "251025"
  last_updated: "251025"

service_definition:
  name: "MetricOrchestrator"
  layer: "business_logic"
  pattern: "orchestrator"
  singleton: false
  
enums:
  - name: "MetricRecomputeReason"
    values: ["task", "session", "seedImport"]
    description: "指标重新计算原因枚举"
    
constructor:
  parameters:
    - name: "metricRepository"
      type: "MetricRepository"
      required: true
      description: "指标数据访问层"
    - name: "taskRepository"
      type: "TaskRepository"
      required: true
      description: "任务数据访问层"
    - name: "focusRepository"
      type: "FocusSessionRepository"
      required: true
      description: "专注会话数据访问层"
  dependencies:
    - name: "MetricRepository"
      type: "data/repositories/metric_repository.dart"
      description: "指标数据访问层依赖"
    - name: "TaskRepository"
      type: "data/repositories/task_repository.dart"
      description: "任务数据访问层依赖"
    - name: "FocusSessionRepository"
      type: "data/repositories/focus_session_repository.dart"
      description: "专注会话数据访问层依赖"
      
public_methods:
  - name: "latest"
    return_type: "Stream<MetricSnapshot?>"
    parameters: []
    description: "获取最新指标"
    visibility: "public"
    async: false
    
  - name: "requestRecompute"
    return_type: "Future<MetricSnapshot>"
    parameters:
      - name: "reason"
        type: "MetricRecomputeReason"
        required: true
    description: "请求重新计算指标"
    visibility: "public"
    async: true
    
  - name: "invalidate"
    return_type: "Future<void>"
    parameters: []
    description: "使指标失效"
    visibility: "public"
    async: true
    
private_methods:
  - name: "_calculateMetrics"
    return_type: "Future<MetricSnapshot>"
    parameters:
      - name: "tasks"
        type: "Iterable<Task>"
        required: true
      - name: "totalFocusMinutes"
        type: "int"
        required: true
    description: "计算指标"
    visibility: "private"
    async: true
    
  - name: "_debounceRecompute"
    return_type: "Future<MetricSnapshot>"
    parameters:
      - name: "action"
        type: "Future<MetricSnapshot> Function()"
        required: true
    description: "防抖重新计算"
    visibility: "private"
    async: true
    
fields:
  - name: "_metricRepository"
    type: "MetricRepository"
    final: true
    description: "指标数据访问层"
  - name: "_taskRepository"
    type: "TaskRepository"
    final: true
    description: "任务数据访问层"
  - name: "_focusRepository"
    type: "FocusSessionRepository"
    final: true
    description: "专注会话数据访问层"
  - name: "_debounce"
    type: "_Debouncer"
    final: true
    description: "防抖器"
    
imports:
  - "dart:async"
  - "../../data/models/metric_snapshot.dart"
  - "../../data/repositories/focus_session_repository.dart"
  - "../../data/repositories/metric_repository.dart"
  - "../../data/repositories/task_repository.dart"
  
dependencies:
  - name: "MetricRepository"
    type: "data/repositories/metric_repository.dart"
    description: "指标数据访问层依赖"
  - name: "TaskRepository"
    type: "data/repositories/task_repository.dart"
    description: "任务数据访问层依赖"
  - name: "FocusSessionRepository"
    type: "data/repositories/focus_session_repository.dart"
    description: "专注会话数据访问层依赖"
  - name: "MetricSnapshot"
    type: "data/models/metric_snapshot.dart"
    description: "指标快照领域模型依赖"
  - name: "Task"
    type: "data/models/task.dart"
    description: "任务领域模型依赖"
    
responsibilities:
  - "指标计算协调"
  - "指标数据管理"
  - "指标更新调度"
  - "指标缓存管理"
  - "指标失效处理"
  - "指标性能优化"
  
business_operations:
  create:
    - name: "requestRecompute"
      description: "请求重新计算指标"
      parameters: ["MetricRecomputeReason"]
      
  read:
    - name: "latest"
      description: "获取最新指标"
      parameters: []
      
  update:
    - name: "invalidate"
      description: "使指标失效"
      parameters: []
    
stream_operations:
  - name: "latest"
    description: "监听最新指标"
    return_type: "Stream<MetricSnapshot?>"
    
business_rules:
  - name: "metric_calculation_orchestration"
    description: "指标计算协调规则"
    implementation: "协调多个数据源的指标计算"
    validation: "验证指标计算的准确性"
  - name: "metric_recompute_scheduling"
    description: "指标重新计算调度规则"
    implementation: "防抖机制避免频繁计算"
    validation: "验证计算调度的合理性"
  - name: "metric_cache_management"
    description: "指标缓存管理规则"
    implementation: "管理指标缓存的生命周期"
    validation: "验证缓存数据的有效性"
    
error_handling:
  - exception: "CalculationException"
    description: "计算异常"
    handling: "记录日志并重新抛出"
    recovery: "重试机制"
  - exception: "RepositoryException"
    description: "数据访问异常"
    handling: "记录日志并重新抛出"
    recovery: "重试机制"
  - exception: "ArgumentError"
    description: "参数错误"
    handling: "验证参数并抛出描述性错误"
    recovery: "提供参数修正建议"
    
validation_rules:
  - field: "reason"
    rule: "valid_enum"
    description: "重新计算原因必须有效"
    message: "重新计算原因必须有效"
  - field: "tasks"
    rule: "not_empty"
    description: "任务列表不能为空"
    message: "任务列表不能为空"
  - field: "totalFocusMinutes"
    rule: "non_negative"
    description: "总专注分钟数不能为负数"
    message: "总专注分钟数不能为负数"
    
performance_considerations:
  - operation: "requestRecompute"
    optimization: "防抖机制"
    description: "指标重新计算性能优化"
    caching: "指标缓存策略"
  - operation: "latest"
    optimization: "流式更新"
    description: "指标监听性能优化"
    caching: "指标快照缓存"
  - operation: "_calculateMetrics"
    optimization: "增量计算"
    description: "指标计算性能优化"
    caching: "计算结果缓存"
    
transaction_management:
  - operation: "requestRecompute"
    scope: "指标计算事务"
    rollback: "计算回滚"
    isolation: "read_committed"
  - operation: "invalidate"
    scope: "指标失效事务"
    rollback: "状态回滚"
    isolation: "read_committed"
    
testing_strategy:
  unit_tests:
    - name: "test_latest"
      description: "测试获取最新指标功能"
    - name: "test_request_recompute"
      description: "测试请求重新计算指标功能"
    - name: "test_invalidate"
      description: "测试使指标失效功能"
    - name: "test_calculate_metrics"
      description: "测试计算指标功能"
    - name: "test_debounce_recompute"
      description: "测试防抖重新计算功能"
    - name: "test_business_rules"
      description: "测试业务规则"
    - name: "test_error_handling"
      description: "测试错误处理"
    - name: "test_validation"
      description: "测试验证逻辑"
      
  integration_tests:
    - name: "test_service_integration"
      description: "测试服务集成"
    - name: "test_repository_coordination"
      description: "测试仓库协调"
    - name: "test_transaction_management"
      description: "测试事务管理"
    - name: "test_metric_calculation_flow"
      description: "测试指标计算流程"
      
  mock_strategy:
    - name: "MockMetricOrchestrator"
      description: "Mock 实现用于测试"
    - name: "FakeMetricOrchestrator"
      description: "Fake 实现用于测试"
      
lifecycle_management:
  - phase: "initialization"
    description: "初始化阶段"
    operations: ["依赖注入", "配置加载", "状态初始化", "防抖器初始化"]
  - phase: "operation"
    description: "运行阶段"
    operations: ["指标计算协调", "缓存管理", "性能优化", "状态管理"]
  - phase: "cleanup"
    description: "清理阶段"
    operations: ["资源释放", "状态重置", "连接关闭", "缓存清理"]